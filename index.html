<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RideSource Staff Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.min.js"></script>
<style>
:root{--navy:#1B2A4A;--red:#C0392B;--light:#EAF0FB;--border:#D0D9EC;--success:#27AE60;--warn:#E67E22;--gray:#F7F9FC;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:Arial,sans-serif;background:#F0F4FA;color:#222;min-height:100vh;}

/* â”€â”€ LANDING â”€â”€ */
.landing-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0f1f3d 0%,#1B2A4A 60%,#2c3e6b 100%);}
.landing-card{background:#fff;border-radius:16px;padding:52px 48px;width:100%;max-width:500px;box-shadow:0 20px 60px rgba(0,0,0,0.4);text-align:center;}
.landing-brand{font-size:32px;font-weight:900;color:var(--navy);letter-spacing:-1px;margin-bottom:4px;}
.landing-brand span{color:var(--red);}
.landing-sub{font-size:13px;color:#888;margin-bottom:28px;letter-spacing:.5px;text-transform:uppercase;}

/* Tab switcher on landing */
.portal-tabs{display:flex;border-radius:10px;overflow:hidden;border:2px solid var(--border);margin-bottom:28px;}
.portal-tab{flex:1;padding:12px;font-size:14px;font-weight:700;cursor:pointer;border:none;background:#f8f9fa;color:#888;transition:all .2s;}
.portal-tab.active{background:var(--navy);color:#fff;}

.landing-title{font-size:18px;font-weight:700;color:var(--navy);margin-bottom:6px;}
.landing-desc{font-size:13px;color:#666;margin-bottom:24px;line-height:1.6;}
.landing-field{width:100%;padding:13px 16px;border:2px solid var(--border);border-radius:8px;font-size:15px;margin-bottom:12px;outline:none;transition:border-color .2s;font-family:Arial,sans-serif;}
.landing-field:focus{border-color:var(--navy);}
.landing-btn{width:100%;padding:14px;background:var(--navy);color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer;transition:background .2s;}
.landing-btn:hover{background:#0f1f3d;}
.error-msg{background:#fdecea;border:1px solid #f5c6c2;border-radius:6px;padding:10px 14px;color:var(--red);font-size:13px;margin-top:8px;display:none;}

/* â”€â”€ SCREENS â”€â”€ */
.screen{display:none;} .screen.active{display:block;}

/* â”€â”€ HEADER â”€â”€ */
.header{background:var(--navy);padding:0 32px;display:flex;align-items:center;justify-content:space-between;height:64px;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.3);}
.brand{font-size:22px;font-weight:800;color:#fff;letter-spacing:-.5px;}
.brand span{color:var(--red);}
.tagline{font-size:11px;color:rgba(255,255,255,.5);letter-spacing:.5px;}
.header-badge{background:var(--red);color:#fff;font-size:11px;font-weight:700;padding:3px 10px;border-radius:12px;letter-spacing:.5px;}
.header-right{display:flex;align-items:center;gap:12px;}
.header-user{font-size:13px;color:rgba(255,255,255,.75);}
.header-user strong{color:#fff;}
.btn-logout{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;}
.btn-logout:hover{background:rgba(255,255,255,.2);}

/* â”€â”€ LAYOUT â”€â”€ */
.portal-layout{display:flex;min-height:calc(100vh - 64px);}
.sidebar{width:240px;background:#fff;border-right:1px solid var(--border);padding:24px 0;flex-shrink:0;position:sticky;top:64px;height:calc(100vh - 64px);overflow-y:auto;}
.sidebar-label{font-size:10px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;padding:8px 16px 4px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 16px;cursor:pointer;font-size:13px;color:#555;font-weight:500;transition:all .15s;margin:1px 8px;border-radius:8px;}
.nav-item:hover{background:var(--light);color:var(--navy);}
.nav-item.active{background:var(--navy);color:#fff;}
.nav-icon{font-size:16px;width:20px;text-align:center;}
.nav-badge{margin-left:auto;background:var(--red);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;}
.nav-item.active .nav-badge{background:rgba(255,255,255,.25);}
.main-content{flex:1;padding:32px;overflow-y:auto;}

/* â”€â”€ PROGRESS â”€â”€ */
.progress-bar-wrap{background:#fff;border:1px solid var(--border);border-radius:10px;padding:16px 20px;margin-bottom:24px;}
.progress-label{font-size:12px;font-weight:600;color:#888;margin-bottom:8px;display:flex;justify-content:space-between;}
.progress-track{height:8px;background:#eee;border-radius:4px;overflow:hidden;}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--navy),#4a7fd4);border-radius:4px;transition:width .5s ease;}

/* â”€â”€ CARDS â”€â”€ */
.card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:28px;margin-bottom:24px;}
.card-title{font-size:18px;font-weight:700;color:var(--navy);margin-bottom:6px;display:flex;align-items:center;gap:10px;}
.card-sub{font-size:13px;color:#888;margin-bottom:20px;}

/* â”€â”€ DOC READER â”€â”€ */
.doc-reader{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden;}
.doc-nav{background:var(--navy);padding:16px 24px;display:flex;align-items:center;justify-content:space-between;}
.doc-nav-title{color:#fff;font-size:15px;font-weight:700;}
.doc-nav-progress{color:rgba(255,255,255,.65);font-size:12px;}
.doc-tabs{display:flex;background:var(--gray);border-bottom:1px solid var(--border);overflow-x:auto;}
.doc-tab{padding:12px 20px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;color:#777;border-bottom:3px solid transparent;transition:all .15s;}
.doc-tab:hover{color:var(--navy);}
.doc-tab.active{color:var(--navy);border-bottom-color:var(--navy);background:#fff;}
.doc-tab.completed{color:var(--success);}
.doc-tab.completed::before{content:'âœ“ ';}
.doc-body{padding:36px 48px;min-height:500px;max-height:70vh;overflow-y:auto;font-size:14px;line-height:1.75;}
.doc-body h1{font-size:22px;color:var(--navy);margin:28px 0 10px;padding-bottom:8px;border-bottom:2px solid var(--red);}
.doc-body h2{font-size:17px;color:var(--navy);margin:20px 0 8px;font-weight:700;}
.doc-body h3{font-size:15px;color:#444;margin:16px 0 6px;font-weight:700;}
.doc-body p{margin-bottom:12px;color:#333;}
.doc-body ul{margin:8px 0 12px 24px;}
.doc-body li{margin-bottom:4px;color:#333;}
.doc-body table{width:100%;border-collapse:collapse;margin:12px 0;}
.doc-body th{background:var(--navy);color:#fff;padding:8px 12px;font-size:13px;text-align:left;}
.doc-body td{padding:8px 12px;border-bottom:1px solid #eee;font-size:13px;}
.doc-body .callout{background:var(--light);border-left:4px solid var(--navy);border-radius:0 8px 8px 0;padding:14px 18px;margin:16px 0;}
.doc-body .callout strong{color:var(--navy);display:block;margin-bottom:4px;}
.doc-body .warn-box{background:#fff3cd;border-left:4px solid var(--warn);border-radius:0 8px 8px 0;padding:12px 16px;margin:12px 0;}
.doc-footer{padding:16px 24px;background:var(--gray);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.doc-footer-note{font-size:12px;color:#888;}

/* â”€â”€ BUTTONS â”€â”€ */
.btn-primary{background:var(--navy);color:#fff;border:none;padding:10px 22px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:background .2s;}
.btn-primary:hover{background:#0f1f3d;}
.btn-primary:disabled{background:#aaa;cursor:not-allowed;}
.btn-secondary{background:transparent;color:var(--navy);border:2px solid var(--navy);padding:9px 20px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-secondary:hover{background:var(--light);}
.btn{padding:9px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s;}
.btn-red{background:var(--red);color:#fff;}
.btn-red:hover{background:#a93226;}
.btn-green{background:var(--success);color:#fff;}
.btn-sm{padding:6px 12px;font-size:12px;}

/* â”€â”€ SIG â”€â”€ */
.sig-block{background:#fff;border:2px solid var(--navy);border-radius:12px;padding:32px;margin-top:24px;}
.sig-block h3{font-size:17px;color:var(--navy);margin-bottom:6px;}
.sig-block p{font-size:13px;color:#666;margin-bottom:20px;line-height:1.6;}
.sig-options{display:flex;flex-direction:column;gap:14px;margin-bottom:24px;}
.sig-option{display:flex;align-items:flex-start;gap:12px;padding:16px;border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all .2s;}
.sig-option:hover{border-color:var(--navy);background:var(--light);}
.sig-option.selected{border-color:var(--navy);background:var(--light);}
.sig-option input[type="radio"]{margin-top:2px;accent-color:var(--navy);transform:scale(1.2);}
.sig-option label{cursor:pointer;font-size:14px;line-height:1.5;}
.sig-option label strong{display:block;color:var(--navy);margin-bottom:3px;}
.sig-field{margin-bottom:16px;}
.sig-field label{display:block;font-size:12px;font-weight:700;color:#555;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;}
.sig-field input{width:100%;padding:11px 14px;border:2px solid var(--border);border-radius:8px;font-size:15px;font-style:italic;outline:none;transition:border-color .2s;}
.sig-field input:focus{border-color:var(--navy);}
.sig-legal{font-size:11px;color:#999;line-height:1.5;margin-bottom:20px;padding:12px;background:var(--gray);border-radius:6px;border:1px solid var(--border);}

/* â”€â”€ POLICY â”€â”€ */
.policy-list{display:flex;flex-direction:column;gap:12px;}
.policy-item{display:flex;align-items:center;gap:14px;padding:16px 18px;border:1px solid var(--border);border-radius:10px;background:#fff;}
.policy-item.signed{background:#f0faf4;border-color:#a8d5b5;}
.policy-check{width:28px;height:28px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px;}
.policy-item.signed .policy-check{background:var(--success);border-color:var(--success);color:#fff;}
.policy-info{flex:1;}
.policy-name{font-size:14px;font-weight:700;color:var(--navy);margin-bottom:2px;}
.policy-desc{font-size:12px;color:#888;}
.policy-time{font-size:11px;color:#aaa;}
.policy-btn{padding:8px 16px;font-size:13px;font-weight:600;border-radius:6px;cursor:pointer;border:none;}
.policy-btn-read{background:var(--navy);color:#fff;}
.policy-btn-done{background:var(--success);color:#fff;cursor:default;}

/* â”€â”€ MODALS â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:200;display:none;align-items:center;justify-content:center;padding:24px;}
.modal-overlay.open{display:flex;}
.modal{background:#fff;border-radius:16px;padding:32px;width:100%;max-width:700px;max-height:90vh;overflow-y:auto;position:relative;}
.modal-close{position:absolute;top:16px;right:20px;background:none;border:none;font-size:22px;cursor:pointer;color:#aaa;}
.modal-close:hover{color:#333;}
.modal h3{font-size:20px;color:var(--navy);margin-bottom:8px;}
.modal p{font-size:14px;color:#666;margin-bottom:16px;line-height:1.6;}
.modal-body{max-height:50vh;overflow-y:auto;border:1px solid var(--border);border-radius:8px;padding:20px 24px;margin-bottom:20px;font-size:13px;line-height:1.7;color:#444;background:var(--gray);}

/* â”€â”€ WELCOME DASH â”€â”€ */
.welcome-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:24px;}
.stat-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:20px;display:flex;align-items:center;gap:16px;}
.stat-icon{width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;}
.stat-val{font-size:24px;font-weight:800;color:var(--navy);}
.stat-label{font-size:12px;color:#888;font-weight:500;}
.checklist{list-style:none;}
.checklist li{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #f0f0f0;font-size:14px;}
.checklist li:last-child{border-bottom:none;}
.checklist-item{display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid #f0f0f0;font-size:13px;line-height:1.6;}
.checklist-item:last-of-type{border-bottom:none;}
.check-box{font-size:18px;color:var(--navy);flex-shrink:0;margin-top:1px;}
.check-dot{width:20px;height:20px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;}
.check-dot.done{background:var(--success);color:#fff;}
.check-dot.pending{background:#eee;color:#aaa;}

/* â”€â”€ SUCCESS â”€â”€ */
.success-banner{background:linear-gradient(135deg,#1a6b3a,#27AE60);color:#fff;border-radius:12px;padding:32px;text-align:center;margin-bottom:24px;}
.success-banner .big-check{font-size:48px;margin-bottom:12px;}
.success-banner h2{font-size:24px;margin-bottom:8px;}
.success-banner p{font-size:14px;opacity:.85;}

/* â”€â”€ PORTAL SECTION â”€â”€ */
.portal-section{display:none;}

/* â”€â”€ ADMIN â”€â”€ */
.admin-section{display:none;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:20px;}
.admin-stat-card{background:#fff;border:1px solid var(--border);border-radius:10px;padding:18px;display:flex;align-items:center;gap:14px;}
.admin-stat-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.admin-stat-val{font-size:26px;font-weight:800;color:var(--navy);}
.admin-stat-label{font-size:11px;color:#888;font-weight:500;}
.data-table{width:100%;border-collapse:collapse;}
.data-table th{background:var(--navy);color:#fff;padding:10px 14px;text-align:left;font-size:12px;font-weight:700;letter-spacing:.3px;}
.data-table td{padding:10px 14px;font-size:13px;border-bottom:1px solid #f0f0f0;}
.data-table tr:hover td{background:var(--gray);}
.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;}
.badge-pending{background:#fff3cd;color:#856404;}
.badge-approved{background:#d4edda;color:#155724;}
.badge-denied{background:#f8d7da;color:#721c24;}
.badge-flag{background:#fdecea;color:var(--red);}
.badge-warning{background:#fef3e8;color:var(--warn);}
.template-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-bottom:20px;}
.template-card{background:#fff;border:1px solid var(--border);border-radius:10px;padding:18px;cursor:pointer;transition:all .2s;}
.template-card:hover{border-color:var(--navy);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.08);}
.template-icon{font-size:28px;margin-bottom:10px;}
.template-name{font-size:14px;font-weight:700;color:var(--navy);margin-bottom:4px;}
.template-desc{font-size:12px;color:#888;line-height:1.5;}
.form-field{margin-bottom:14px;}
.form-field label{display:block;font-size:11px;font-weight:700;color:#555;text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px;}
.form-field input,.form-field select,.form-field textarea{width:100%;padding:10px 13px;border:2px solid var(--border);border-radius:8px;font-size:13px;outline:none;transition:border-color .2s;font-family:Arial,sans-serif;}
.form-field input:focus,.form-field select:focus,.form-field textarea:focus{border-color:var(--navy);}
.form-field textarea{min-height:100px;resize:vertical;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.warning-employee{background:#fff;border:1px solid var(--border);border-radius:10px;padding:16px 18px;display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.preview-box{background:var(--gray);border:1px solid var(--border);border-radius:8px;padding:20px 24px;margin:14px 0;font-size:13px;line-height:1.8;white-space:pre-wrap;font-family:Arial,sans-serif;max-height:350px;overflow-y:auto;}

@media(max-width:768px){.sidebar{display:none;}.main-content{padding:16px;}.doc-body{padding:20px;}}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â• LANDING â•â•â•â•â•â•â•â• -->
<div id="screen-landing" class="screen active">
  <div class="landing-wrap">
    <div class="landing-card">
      <div class="landing-brand">Ride<span>Source</span> Inc.</div>
      <div class="landing-sub">Reliable Safe Transportation</div>

      <div class="portal-tabs">
        <button class="portal-tab active" id="tab-emp" onclick="switchLanding('employee')">ğŸ‘¤ Employee Portal</button>
        <button class="portal-tab" id="tab-adm" onclick="switchLanding('admin')">ğŸ”’ Admin Portal</button>
      </div>

      <!-- Employee login -->
      <div id="landing-employee">
        <div class="landing-title">Welcome!</div>
        <div class="landing-desc">Complete your onboarding, review company policies, and sign your acknowledgments â€” all in one place.</div>
        <input class="landing-field" id="login-name" type="text" placeholder="Your Full Name" autocomplete="name">
        <input class="landing-field" id="login-email" type="email" placeholder="Your Email Address" autocomplete="email">
        <select class="landing-field" id="login-county">
          <option value="">Select Your County</option>
          <option>Androscoggin</option><option>Aroostook</option><option>Cumberland</option>
          <option>Franklin</option><option>Hancock</option><option>Kennebec</option>
          <option>Knox</option><option>Lincoln</option><option>Oxford</option>
          <option>Penobscot</option><option>Piscataquis</option><option>Sagadahoc</option>
          <option>Somerset</option><option>Waldo</option><option>Washington</option><option>York</option>
        </select>
        <button class="landing-btn" onclick="startPortal()">Enter Employee Portal â†’</button>
        <div class="error-msg" id="login-error">Please fill in all fields to continue.</div>
      </div>

      <!-- Admin login -->
      <div id="landing-admin" style="display:none;">
        <div class="landing-title">Admin &amp; Manager Access</div>
        <div class="landing-desc">Supervisors and HR staff only. Enter your name and admin password to continue.</div>
        <input class="landing-field" id="admin-name" type="text" placeholder="Your Full Name">
        <input class="landing-field" id="admin-pass" type="password" placeholder="Admin Password" onkeydown="if(event.key==='Enter')adminLogin()">
        <button class="landing-btn" onclick="adminLogin()">Enter Admin Portal â†’</button>
        <div class="error-msg" id="admin-error">Incorrect password or missing name. Please try again.</div>
      </div>

    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• EMPLOYEE PORTAL â•â•â•â•â•â•â•â• -->
<div id="screen-portal" class="screen">
  <div class="header">
    <div>
      <div class="brand">Ride<span>Source</span> Inc.</div>
      <div class="tagline">Employee Portal</div>
    </div>
    <div class="header-right">
      <div class="header-user">Welcome, <strong id="display-name"></strong></div>
      <button class="btn-logout" onclick="logout()">Sign Out</button>
    </div>
  </div>
  <div class="portal-layout">
    <div class="sidebar">
      <div style="padding:0 8px;">
        <div class="sidebar-label">Overview</div>
        <div class="nav-item active" onclick="showSection('dashboard')" id="nav-dashboard"><span class="nav-icon">ğŸ </span>Dashboard</div>
        <div class="sidebar-label">Documents</div>
        <div class="nav-item" onclick="showSection('training')" id="nav-training"><span class="nav-icon">ğŸ“‹</span>Driver Training Guide<span class="nav-badge" id="badge-training">!</span></div>
        <div class="nav-item" onclick="showSection('handbook')" id="nav-handbook"><span class="nav-icon">ğŸ“–</span>Employee Handbook<span class="nav-badge" id="badge-handbook">!</span></div>
        <div class="sidebar-label">Actions</div>
        <div class="nav-item" onclick="showSection('policies')" id="nav-policies"><span class="nav-icon">âœï¸</span>Policy Sign-Offs<span class="nav-badge" id="badge-policies">0/7</span></div>
        <div class="nav-item" onclick="showSection('timeoff')" id="nav-timeoff"><span class="nav-icon">ğŸ“…</span>Request Time Off</div>
      </div>
    </div>
    <div class="main-content">

      <!-- DASHBOARD -->
      <div id="section-dashboard" class="portal-section" style="display:block;">
        <div class="progress-bar-wrap">
          <div class="progress-label"><span>Onboarding Progress</span><span id="progress-pct">0%</span></div>
          <div class="progress-track"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
        </div>
        <div class="welcome-grid">
          <div class="stat-card"><div class="stat-icon" style="background:var(--light);">ğŸ“„</div><div><div class="stat-val" id="stat-docs">0/2</div><div class="stat-label">Documents Read</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:#e8f8ee;">âœï¸</div><div><div class="stat-val" id="stat-sigs">0/7</div><div class="stat-label">Policies Signed</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:#fef3e8;">â³</div><div><div class="stat-val" id="stat-remaining">9</div><div class="stat-label">Items Remaining</div></div></div>
        </div>
        <div class="card">
          <div class="card-title">ğŸ“ Your Onboarding Checklist</div>
          <ul class="checklist" id="dash-checklist"></ul>
        </div>
      </div>

      <!-- TRAINING -->
      <div id="section-training" class="portal-section">
        <div class="card-title" style="font-size:22px;color:var(--navy);margin-bottom:4px;">ğŸ“‹ Driver Training Guide</div>
        <p style="color:#888;font-size:14px;margin-bottom:20px;">Version 2.1 Â· February 2026 Â· Read all sections before proceeding to the handbook.</p>
        <div class="doc-reader">
          <div class="doc-nav">
            <div class="doc-nav-title">RideSource Driver Training Guide</div>
            <div class="doc-nav-progress" id="training-progress-label">Section 1 of 7</div>
          </div>
          <div class="doc-tabs" id="training-tabs"></div>
          <div class="doc-body" id="training-body" onscroll="checkScroll('training')"></div>
          <div class="doc-footer">
            <div class="doc-footer-note" id="training-scroll-note">ğŸ“– Scroll to the bottom of this section to continue.</div>
            <div style="display:flex;gap:8px;">
              <button class="btn-secondary" id="training-prev" onclick="changeSection('training',-1)" style="padding:8px 16px;font-size:13px;" disabled>â† Previous</button>
              <button class="btn-primary" id="training-next" onclick="changeSection('training',1)" style="padding:8px 16px;font-size:13px;" disabled>Next Section â†’</button>
            </div>
          </div>
        </div>
        <div id="training-complete-banner" style="display:none;margin-top:20px;" class="success-banner">
          <div class="big-check">âœ…</div>
          <h2>Training Guide Complete!</h2>
          <p>Great work. Continue to the Employee Handbook next.</p>
          <button class="btn-primary" style="margin-top:12px;background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.5);" onclick="showSection('handbook')">Go to Employee Handbook â†’</button>
        </div>
      </div>

      <!-- HANDBOOK -->
      <div id="section-handbook" class="portal-section">
        <div class="card-title" style="font-size:22px;color:var(--navy);margin-bottom:4px;">ğŸ“– Employee Handbook</div>
        <p style="color:#888;font-size:14px;margin-bottom:20px;">Version 2.0 Â· February 2026 Â· Read all sections before proceeding to policy sign-offs.</p>
        <div class="doc-reader">
          <div class="doc-nav">
            <div class="doc-nav-title">RideSource Employee Handbook</div>
            <div class="doc-nav-progress" id="handbook-progress-label">Section 1 of 11</div>
          </div>
          <div class="doc-tabs" id="handbook-tabs"></div>
          <div class="doc-body" id="handbook-body" onscroll="checkScroll('handbook')"></div>
          <div class="doc-footer">
            <div class="doc-footer-note" id="handbook-scroll-note">ğŸ“– Scroll to the bottom of this section to continue.</div>
            <div style="display:flex;gap:8px;">
              <button class="btn-secondary" id="handbook-prev" onclick="changeSection('handbook',-1)" style="padding:8px 16px;font-size:13px;" disabled>â† Previous</button>
              <button class="btn-primary" id="handbook-next" onclick="changeSection('handbook',1)" style="padding:8px 16px;font-size:13px;" disabled>Next Section â†’</button>
            </div>
          </div>
        </div>
        <div id="handbook-sig" style="display:none;" class="sig-block">
          <h3>ğŸ“ Handbook Acknowledgment</h3>
          <p>You've completed the Employee Handbook. Please review the options below and provide your electronic signature to complete this step.</p>
          <div class="sig-options">
            <div class="sig-option" id="opt-print" onclick="selectHandbookOpt('print')">
              <input type="radio" name="hb-opt" value="print" id="rb-print">
              <label for="rb-print"><strong>â˜ I would like to receive a printed copy of this handbook.</strong>By signing below, I acknowledge that I have read and understand the RideSource Employee Handbook and request that a printed copy be provided to me.</label>
            </div>
            <div class="sig-option" id="opt-digital" onclick="selectHandbookOpt('digital')">
              <input type="radio" name="hb-opt" value="digital" id="rb-digital">
              <label for="rb-digital"><strong>â˜ I acknowledge receipt and understanding â€” no printed copy requested.</strong>By signing below, I acknowledge that I have received, read, and understand the policies contained in the RideSource Employee Handbook, and I do not request a printed copy at this time.</label>
            </div>
          </div>
          <div class="sig-field"><label>Electronic Signature (type your full legal name)</label><input type="text" id="hb-sig-input" placeholder="Type your full name to sign..."></div>
          <div class="sig-legal">By typing your name above, you are providing an electronic signature that is legally binding under the Electronic Signatures in Global and National Commerce Act (E-SIGN Act) and Maine law.</div>
          <button class="btn-primary" onclick="submitHandbookSig()" id="hb-submit-btn" disabled>Submit Acknowledgment</button>
        </div>
      </div>

      <!-- POLICIES -->
      <div id="section-policies" class="portal-section">
        <div class="card-title" style="font-size:22px;color:var(--navy);margin-bottom:4px;">âœï¸ Policy Acknowledgments</div>
        <p style="color:#888;font-size:14px;margin-bottom:20px;">Read and sign each policy below. All must be completed before your onboarding is finalized.</p>
        <div class="policy-list" id="policy-list"></div>
        <div id="all-signed-banner" style="display:none;margin-top:24px;" class="success-banner">
          <div class="big-check">ğŸ‰</div>
          <h2>All Policies Signed!</h2>
          <p>Congratulations â€” your onboarding acknowledgments are complete. Your supervisor has been notified. Welcome to the RideSource team!</p>
          <button class="btn-primary" style="margin-top:16px;font-size:15px;padding:12px 28px;" onclick="generateCertificate()">ğŸ“„ Get Your Certificate of Completion</button>
        </div>
      </div>

      <!-- TIME OFF -->
      <div id="section-timeoff" class="portal-section">
        <div class="card-title" style="font-size:22px;color:var(--navy);margin-bottom:4px;">ğŸ“… Request Time Off</div>
        <p style="color:#888;font-size:14px;margin-bottom:24px;">Submit a time off request below. Your supervisor will be notified and will approve or deny within a reasonable timeframe.</p>
        <div class="card">
          <div class="card-sub">Select a request type to get started.</div>
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:24px;">
            <button class="req-type-btn btn-secondary" onclick="selectReqType('Full Day Off')">â˜€ï¸ Full Day Off</button>
            <button class="req-type-btn btn-secondary" onclick="selectReqType('Multiple Days')">ğŸ“† Multiple Days</button>
            <button class="req-type-btn btn-secondary" onclick="selectReqType('Start Late')">â° Start Late</button>
            <button class="req-type-btn btn-secondary" onclick="selectReqType('End Early')">ğŸšª End Early</button>
            <button class="req-type-btn btn-secondary" onclick="selectReqType('Mid-Day Appointment')">ğŸ¥ Mid-Day Appointment</button>
          </div>
          <div id="req-form" style="display:none;">
            <div id="req-fields"></div>
            <div class="sig-field"><label>Reason (optional)</label><input type="text" id="req-reason" placeholder="Brief reason for your request..." style="width:100%;padding:11px 14px;border:2px solid var(--border);border-radius:8px;font-size:14px;outline:none;"></div>
            <button class="btn-primary" onclick="submitTimeOff()" style="margin-top:8px;">Submit Request</button>
          </div>
          <div id="req-success" style="display:none;" class="success-banner">
            <div>âœ…</div><h2 style="font-size:18px;margin-top:8px;">Request Submitted!</h2>
            <p>Your supervisor has been notified. You'll receive an email when a decision is made.</p>
            <button class="btn-primary" style="margin-top:12px;background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.5);" onclick="resetTimeOff()">Submit Another Request</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• ADMIN PORTAL â•â•â•â•â•â•â•â• -->
<div id="screen-admin" class="screen">
  <div class="header">
    <div><div class="brand">Ride<span>Source</span> Inc.</div><div class="tagline">Admin &amp; Manager Portal</div></div>
    <div class="header-right">
      <div class="header-badge">ADMIN</div>
      <span style="color:rgba(255,255,255,.7);font-size:13px;" id="admin-display"></span>
      <button class="btn-logout" onclick="adminLogout()">Sign Out</button>
    </div>
  </div>
  <div class="portal-layout">
    <div class="sidebar">
      <div style="padding:0 8px;">
        <div class="sidebar-label">Overview</div>
        <div class="nav-item active" onclick="showAdmin('dashboard')" id="nav-adm-dashboard"><span class="nav-icon">ğŸ“Š</span>Dashboard</div>
        <div class="sidebar-label">Reference</div>
        <div class="nav-item" onclick="showAdmin('manager-guide')" id="nav-adm-manager-guide"><span class="nav-icon">ğŸ“˜</span>Manager Guide</div>
        <div class="nav-item" onclick="showAdmin('handbook-ref')" id="nav-adm-handbook-ref"><span class="nav-icon">ğŸ“–</span>Employee Handbook</div>
        <div class="sidebar-label">HR Tools</div>
        <div class="nav-item" onclick="showAdmin('templates')" id="nav-adm-templates"><span class="nav-icon">ğŸ“„</span>HR Templates</div>
        <div class="nav-item" onclick="showAdmin('warnings')" id="nav-adm-warnings"><span class="nav-icon">âš ï¸</span>Attendance Warnings<span class="nav-badge" id="badge-flags">0</span></div>
        <div class="nav-item" onclick="showAdmin('onboarding-tracker')" id="nav-adm-onboarding-tracker"><span class="nav-icon">âœ…</span>Onboarding Tracker</div>
        <div class="sidebar-label">Time Off</div>
        <div class="nav-item" onclick="showAdmin('requests')" id="nav-adm-requests"><span class="nav-icon">ğŸ“…</span>Pending Requests<span class="nav-badge" id="badge-requests">0</span></div>
        <div class="nav-item" onclick="showAdmin('callouts')" id="nav-adm-callouts"><span class="nav-icon">ğŸ“</span>Call-Out Log</div>
        <div class="nav-item" onclick="showAdmin('calendar')" id="nav-adm-calendar"><span class="nav-icon">ğŸ—“ï¸</span>Team Calendar</div>
      </div>
    </div>
    <div class="main-content">

      <!-- ADMIN DASHBOARD -->
      <div id="section-adm-dashboard" class="admin-section" style="display:block;">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">Admin Dashboard</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Welcome back, <strong id="dash-admin-name"></strong>. Here's your team at a glance.</p>
        <div class="stats-grid" id="dash-stats"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="card"><div class="card-title">â³ Pending Time Off Requests</div><div id="dash-pending-list" style="font-size:13px;color:#888;">Loading...</div></div>
          <div class="card"><div class="card-title">ğŸš© Attendance Flags</div><div id="dash-flags-list" style="font-size:13px;color:#888;">Loading...</div></div>
        </div>
      </div>

      <!-- MANAGER GUIDE -->
      <div id="section-adm-manager-guide" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">ğŸ“˜ Supervisor &amp; Manager Guide</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Version 1.0 Â· February 2026 Â· Confidential â€” For supervisors, managers &amp; HR only.</p>
        <div class="doc-reader">
          <div class="doc-nav"><div class="doc-nav-title">RideSource Supervisor &amp; Manager Guide</div></div>
          <div class="doc-tabs" id="mgr-tabs"></div>
          <div class="doc-body" id="mgr-body"></div>
          <div class="doc-footer">
            <div style="font-size:12px;color:#888;">Confidential â€” Management Use Only</div>
            <div style="display:flex;gap:8px;"><button class="btn btn-secondary btn-sm" onclick="changeMgrSection(-1)">â† Previous</button><button class="btn btn-primary btn-sm" onclick="changeMgrSection(1)">Next â†’</button></div>
          </div>
        </div>
      </div>

      <!-- HANDBOOK REF -->
      <div id="section-adm-handbook-ref" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">ğŸ“– Employee Handbook Reference</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Read-only reference copy. Direct employees to the Employee Portal for sign-off.</p>
        <div class="card" style="padding:16px 20px;background:var(--light);border-color:#b8ccf0;">
          <p style="font-size:13px;color:var(--navy);font-weight:600;">ğŸ“Œ Handbook Signature Requests</p>
          <p style="font-size:12px;color:#555;margin-top:4px;">Employees who requested a printed copy of the handbook are listed below.</p>
          <div id="print-requests-list" style="margin-top:12px;font-size:13px;color:#888;">Loading...</div>
        </div>
        <div class="doc-reader" style="margin-top:16px;">
          <div class="doc-nav"><div class="doc-nav-title">Employee Handbook v3.0 â€” Reference Copy</div></div>
          <div class="doc-tabs" id="hb-ref-tabs"></div>
          <div class="doc-body" id="hb-ref-body"></div>
          <div class="doc-footer">
            <div style="font-size:12px;color:#888;">Read-only reference</div>
            <div style="display:flex;gap:8px;"><button class="btn btn-secondary btn-sm" onclick="changeHbRefSection(-1)">â† Previous</button><button class="btn btn-primary btn-sm" onclick="changeHbRefSection(1)">Next â†’</button></div>
          </div>
        </div>
      </div>

      <!-- HR TEMPLATES -->
      <div id="section-adm-templates" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">ğŸ“„ HR Templates</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Fill out any template below and download it as a professional Word document (.docx).</p>
        <div style="font-size:12px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Hiring</div>
        <div class="template-grid" style="margin-bottom:24px;">
          <div class="template-card" onclick="openTemplate('welcome')"><div class="template-icon">ğŸ‰</div><div class="template-name">Welcome Aboard Letter</div><div class="template-desc">New hire welcome letter with training instructions and first day details.</div></div>
          <div class="template-card" onclick="openTemplate('rejection')"><div class="template-icon">ğŸ“¨</div><div class="template-name">Letter of Rejection</div><div class="template-desc">Professional rejection letter for applicants not selected.</div></div>
          <div class="template-card" onclick="openTemplate('interview')"><div class="template-icon">ğŸ—£ï¸</div><div class="template-name">Interview Questions Form</div><div class="template-desc">Standardized driver interview form with hire decision.</div></div>
        </div>
        <div style="font-size:12px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">New Employee Forms</div>
        <div class="template-grid" style="margin-bottom:24px;">
          <div class="template-card" onclick="openTemplate('driverinfo')"><div class="template-icon">ğŸªª</div><div class="template-name">Driver Info Form</div><div class="template-desc">New driver candidate information â€” name, license, contact details.</div></div>
          <div class="template-card" onclick="openTemplate('emergency')"><div class="template-icon">ğŸš¨</div><div class="template-name">Emergency Contact Form</div><div class="template-desc">Employee emergency contacts with signature block.</div></div>
          <div class="template-card" onclick="openTemplate('consent')"><div class="template-icon">ğŸ“‹</div><div class="template-name">Consent for Certification Release</div><div class="template-desc">Authorization for release of training certifications.</div></div>
        </div>
        <div style="font-size:12px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Separation &amp; HR</div>
        <div class="template-grid">
          <div class="template-card" onclick="openTemplate('resignation')"><div class="template-icon">ğŸ“</div><div class="template-name">Voluntary Resignation Acknowledgment</div><div class="template-desc">Formal acknowledgment with off-boarding checklist.</div></div>
          <div class="template-card" onclick="openTemplate('warn-standard')"><div class="template-icon">âš ï¸</div><div class="template-name">Attendance Warning â€” Standard</div><div class="template-desc">Written attendance warning for general call-out and absence concerns.</div></div>
          <div class="template-card" onclick="openTemplate('warn-callout')"><div class="template-icon">ğŸ“µ</div><div class="template-name">Attendance Warning â€” Call-Out After Trip</div><div class="template-desc">Warning for call-outs received after a manifest has been finalized.</div></div>
          <div class="template-card" onclick="openTemplate('warn-final')"><div class="template-icon">ğŸš¨</div><div class="template-name">Final Written Warning</div><div class="template-desc">Last step before termination.</div></div>
        </div>
      </div>

      <!-- ATTENDANCE WARNINGS -->
      <div id="section-adm-warnings" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">âš ï¸ Attendance Warning Generator</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">The system automatically detects employees with attendance concerns.</p>
        <div class="card" style="background:var(--light);border-color:#b8ccf0;padding:14px 18px;margin-bottom:16px;">
          <p style="font-size:13px;color:var(--navy);font-weight:600;">ğŸ“Š How Auto-Detection Works</p>
          <p style="font-size:12px;color:#555;margin-top:4px;">RideSource policy flags employees with 3+ call-outs in any 30-day period.</p>
        </div>
        <div id="flagged-employees" style="margin-bottom:20px;"><p style="font-size:13px;color:#888;">Loading attendance data...</p></div>
        <div class="card">
          <div class="card-title">ğŸ” Manual Warning Lookup</div>
          <div class="card-sub">Search any employee to review their call-out history and generate a warning.</div>
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-field"><label>Employee Name</label><input type="text" id="manual-name" placeholder="Enter employee name..."></div>
            <div class="form-field"><label>County</label>
              <select id="manual-county">
                <option value="">All Counties</option>
                <option>Androscoggin</option><option>Aroostook</option><option>Cumberland</option>
                <option>Franklin</option><option>Hancock</option><option>Kennebec</option>
                <option>Knox</option><option>Lincoln</option><option>Oxford</option>
                <option>Penobscot</option><option>Piscataquis</option><option>Sagadahoc</option>
                <option>Somerset</option><option>Waldo</option><option>Washington</option><option>York</option>
              </select>
            </div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="manualLookup()">Search Call-Out History</button>
          <div id="manual-results" style="margin-top:14px;"></div>
        </div>
      </div>

      <!-- ONBOARDING TRACKER -->
      <div id="section-adm-onboarding-tracker" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">âœ… Onboarding Tracker</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Track which employees have completed their policy acknowledgments and handbook signature.</p>
        <div id="onboarding-data" style="font-size:13px;color:#888;">Loading...</div>
      </div>

      <!-- PENDING REQUESTS -->
      <div id="section-adm-requests" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">ğŸ“… Time Off Requests</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Review and approve or deny employee time off requests.</p>
        <div id="requests-table">Loading...</div>
      </div>

      <!-- CALL-OUT LOG -->
      <div id="section-adm-callouts" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">ğŸ“ Call-Out Log</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Log employee call-outs. This data powers the attendance warning system automatically.</p>
        <div class="card" style="margin-bottom:16px;">
          <div class="card-title">Log a New Call-Out</div>
          <div class="form-row">
            <div class="form-field"><label>Employee Name</label><input type="text" id="co-name" placeholder="Full name..."></div>
            <div class="form-field"><label>County</label>
              <select id="co-county">
                <option value="">Select county</option>
                <option>Androscoggin</option><option>Aroostook</option><option>Cumberland</option>
                <option>Franklin</option><option>Hancock</option><option>Kennebec</option>
                <option>Knox</option><option>Lincoln</option><option>Oxford</option>
                <option>Penobscot</option><option>Piscataquis</option><option>Sagadahoc</option>
                <option>Somerset</option><option>Waldo</option><option>Washington</option><option>York</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field"><label>Call-Out Date</label><input type="date" id="co-date"></div>
            <div class="form-field"><label>Reason</label>
              <select id="co-reason"><option>Sick</option><option>Family Emergency</option><option>Weather</option><option>No reason provided</option><option>Other</option></select>
            </div>
          </div>
          <div class="form-field"><label>Notes</label><input type="text" id="co-notes" placeholder="Optional notes..."></div>
          <button class="btn btn-primary" onclick="logCallOut()">Log Call-Out</button>
          <span id="co-msg" style="font-size:13px;color:var(--success);margin-left:12px;display:none;">âœ“ Call-out logged!</span>
        </div>
        <div class="card"><div class="card-title">Recent Call-Outs</div><div id="callout-table">Loading...</div></div>
      </div>

      <!-- CALENDAR -->
      <div id="section-adm-calendar" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">ğŸ—“ï¸ Team Calendar</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Approved time off and call-outs, color-coded by county.</p>
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <button class="btn btn-secondary btn-sm" onclick="changeMonth(-1)">â† Previous</button>
            <div style="font-size:16px;font-weight:700;color:var(--navy);" id="cal-title"></div>
            <button class="btn btn-secondary btn-sm" onclick="changeMonth(1)">Next â†’</button>
          </div>
          <div id="cal-grid"></div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:16px;" id="cal-legend"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Policy Modal -->
<div class="modal-overlay" id="policy-modal">
  <div class="modal">
    <button class="modal-close" onclick="closePolicyModal()">âœ•</button>
    <h3 id="modal-title">Policy Title</h3>
    <p id="modal-desc">Please read the policy below, then provide your signature.</p>
    <div class="modal-body" id="modal-body" onscroll="checkModalScroll()"></div>
    <div class="sig-field"><label>Electronic Signature (type your full legal name)</label><input type="text" id="modal-sig" placeholder="Type your full name to sign..." oninput="checkModalSig()"></div>
    <div class="sig-legal">By typing your name, you are providing a legally binding electronic signature (E-SIGN Act) confirming you have read and agree to this policy.</div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
      <button class="btn-secondary" onclick="closePolicyModal()">Cancel</button>
      <button class="btn-primary" id="modal-sign-btn" onclick="signPolicy()" disabled>Sign &amp; Acknowledge</button>
    </div>
  </div>
</div>

<!-- HR Template Modal -->
<div class="modal-overlay" id="template-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('template-modal')">âœ•</button>
    <h3 id="tmpl-title">Template</h3>
    <p id="tmpl-desc">Fill in the fields below, then download your Word document.</p>
    <div id="tmpl-form"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
      <button class="btn btn-secondary" onclick="closeModal('template-modal')">Cancel</button>
      <button class="btn btn-primary" id="tmpl-download-btn" onclick="downloadTemplate()">â¬‡ï¸ Download Word Doc</button>
    </div>
  </div>
</div>

<!-- Warning Modal -->
<div class="modal-overlay" id="warning-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('warning-modal')">âœ•</button>
    <h3 id="warn-modal-title">Attendance Warning</h3>
    <p id="warn-modal-desc">Review and edit the warning below before generating.</p>
    <div id="warn-form"></div>
    <div class="preview-box" id="warn-preview" style="display:none;"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;">
      <button class="btn btn-secondary" onclick="closeModal('warning-modal')">Cancel</button>
      <button class="btn btn-red" onclick="generateWarning()">Generate Warning Letter</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL='https://iasphxpahlmjwkapyxrs.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlhc3BoeHBhaGxtandrYXB5eHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNDIyNDYsImV4cCI6MjA4NjkxODI0Nn0.ntQxEiEJqZOvXjfX58I-PPQ2ZOoAT_RgLyf3aWMeXds';
const EMAILJS_SERVICE_ID='ridesource_calendar';
const EMAILJS_PUBLIC_KEY='AoArkSo12DpQtsvZZ';
const SUPERVISOR_EMAIL='tiffanyb@ridesourcemaine.com';
const PORTAL_URL='https://ridesourcecalendar-hub.github.io/ridesource-onboarding/index.html';
const ADMIN_PASSWORD='RideSource2026!';

const {createClient}=supabase;
const db=createClient(SUPABASE_URL,SUPABASE_KEY);
if(typeof emailjs!=='undefined'){emailjs.init({publicKey:EMAILJS_PUBLIC_KEY});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LANDING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchLanding(mode){
  document.getElementById('landing-employee').style.display=mode==='employee'?'block':'none';
  document.getElementById('landing-admin').style.display=mode==='admin'?'block':'none';
  document.getElementById('tab-emp').classList.toggle('active',mode==='employee');
  document.getElementById('tab-adm').classList.toggle('active',mode==='admin');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EMPLOYEE AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let user=null;
let trainingSection=0,handbookSection=0;
let trainingSectionRead={},handbookSectionRead={};
let trainingComplete=false,handbookComplete=false;
let handbookSigChoice=null,currentPolicyIndex=null,modalScrolled=false;
let currentReqType=null;

function startPortal(){
  const name=document.getElementById('login-name').value.trim();
  const email=document.getElementById('login-email').value.trim();
  const county=document.getElementById('login-county').value;
  if(!name||!email||!county){document.getElementById('login-error').style.display='block';return;}
  document.getElementById('login-error').style.display='none';
  user={name,email,county};
  document.getElementById('display-name').textContent=name;
  document.getElementById('screen-landing').classList.remove('active');
  document.getElementById('screen-portal').classList.add('active');
  loadSavedState();
  buildTraining();
  buildHandbook();
  buildPolicies();
  updateDashboard();
}

function logout(){
  saveState();
  user=null;trainingSection=0;handbookSection=0;
  trainingSectionRead={};handbookSectionRead={};
  trainingComplete=false;handbookComplete=false;handbookSigChoice=null;
  document.getElementById('screen-portal').classList.remove('active');
  document.getElementById('screen-landing').classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let adminName='';
let mgrSection=0,hbRefSection=0;
let calYear=new Date().getFullYear(),calMonth=new Date().getMonth();
let warningData=null;

function adminLogin(){
  const name=document.getElementById('admin-name').value.trim();
  const pass=document.getElementById('admin-pass').value;
  if(pass!==ADMIN_PASSWORD||!name){document.getElementById('admin-error').style.display='block';return;}
  document.getElementById('admin-error').style.display='none';
  adminName=name;
  document.getElementById('admin-display').textContent=name;
  document.getElementById('dash-admin-name').textContent=name.split(' ')[0];
  document.getElementById('screen-landing').classList.remove('active');
  document.getElementById('screen-admin').classList.add('active');
  buildMgrGuide();buildHbRef();
  loadDashboard();loadRequests();loadCallOuts();loadFlags();loadOnboarding();renderCalendar();
}

function adminLogout(){
  document.getElementById('screen-admin').classList.remove('active');
  document.getElementById('screen-landing').classList.add('active');
  document.getElementById('admin-pass').value='';
  switchLanding('admin');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSection(id){
  document.querySelectorAll('.portal-section').forEach(el=>el.style.display='none');
  document.querySelectorAll('#screen-portal .nav-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('section-'+id).style.display='block';
  document.getElementById('nav-'+id).classList.add('active');
}

function showAdmin(id){
  document.querySelectorAll('.admin-section').forEach(el=>el.style.display='none');
  document.querySelectorAll('#screen-admin .nav-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('section-adm-'+id).style.display='block';
  document.getElementById('nav-adm-'+id).classList.add('active');
}

function closeModal(id){document.getElementById(id).classList.remove('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveState(){
  if(!user)return;
  const k='rs_'+user.email;
  localStorage.setItem(k,JSON.stringify({trainingSectionRead,handbookSectionRead,trainingComplete,handbookComplete,signedPolicies:getSignedPolicies(),handbookSigChoice}));
}
function loadSavedState(){
  const k='rs_'+user.email;
  const d=JSON.parse(localStorage.getItem(k)||'{}');
  trainingSectionRead=d.trainingSectionRead||{};
  handbookSectionRead=d.handbookSectionRead||{};
  trainingComplete=d.trainingComplete||false;
  handbookComplete=d.handbookComplete||false;
  handbookSigChoice=d.handbookSigChoice||null;
}
function getSignedPolicies(){
  const s={};
  POLICIES.forEach(p=>{const el=document.getElementById('pol-'+p.id);if(el&&el.dataset.signed==='1')s[p.id]=true;});
  return s;
}

const POLICIES = [
  {
    id: 'at_will',
    name: 'At-Will Employment Policy',
    desc: 'Confirms your employment relationship with RideSource',
    content: `<h2>At-Will Employment</h2>
<p>Employment at RideSource Inc. is at-will. This means that either you or RideSource may end the employment relationship at any time, with or without cause, provided there is no violation of applicable federal or state law.</p>
<p>No manager, supervisor, or representative of RideSource has authority to enter into any employment agreement other than at-will. Only the owner(s) of RideSource Inc. may authorize any written exception to this policy.</p>
<p>This handbook does not create and is not intended to create a promise or representation of continued employment.</p>`
  },
  {
    id: 'hipaa',
    name: 'HIPAA & Confidentiality Policy',
    desc: 'Protects client health information â€” critical for NEMT operations',
    content: `<h2>HIPAA & Confidentiality</h2>
<p>All passenger information is strictly confidential. This includes names, addresses, phone numbers, destinations, family information, and any personal circumstances including health information and immigration status.</p>
<p>All communications â€” written or otherwise â€” that include any rider, provider, address, trip, or company information are considered protected under HIPAA.</p>
<h3>Your Obligations</h3>
<ul>
<li>Protect all Protected Health Information (PHI) at all times</li>
<li>Never discuss client information in public settings</li>
<li>Secure all paperwork and electronic devices</li>
<li>Never discuss one client's information with another client</li>
<li>Report suspected privacy breaches to your supervisor immediately</li>
</ul>
<div class="callout"><strong>âš ï¸ Important</strong>Confidentiality violations may result in immediate termination. This obligation continues after your employment ends.</div>`
  },
  {
    id: 'conduct',
    name: 'Employee Code of Conduct',
    desc: 'Professional standards, HIPAA compliance, safety, and ethics â€” RideSource policy packet',
    content: `<h2>Transportation Employee Policy Packet</h2>
<p style="font-size:12px;color:#888;margin-bottom:16px;">Non-Emergency Medical Transportation (NEMT) Â· DHHS & CDS Transportation Services Â· Effective February 21, 2026</p>

<h1>1. Purpose & Scope</h1>
<p>This policy packet establishes professional, safety, compliance, and conduct standards for all employees of RideSource Inc. providing Non-Emergency Medical Transportation (NEMT), Maine DHHS transportation services, and Maine Child Development Services (CDS) transportation.</p>
<p>All employees are required to comply with these policies as a condition of employment.</p>

<h1>2. Regulatory Compliance â€“ State of Maine</h1>
<p>RideSource Inc. operates in accordance with applicable Maine laws and regulations, including but not limited to:</p>
<ul>
<li>Maine Department of Health and Human Services (DHHS) requirements</li>
<li>MaineCare Benefits Manual transportation provisions</li>
<li>HIPAA Privacy & Security Rule (45 CFR Parts 160 & 164)</li>
<li>Maine Mandatory Reporting laws (22 M.R.S. Â§4011-A; 22 M.R.S. Â§3477)</li>
<li>Maine Motor Vehicle statutes (Title 29-A)</li>
<li>MaineCare fraud prevention and billing integrity standards</li>
</ul>
<p>All transportation staff must maintain required driver licensing, maintain current vehicle registration and insurance, comply with MaineCare documentation requirements, report suspected abuse or neglect as mandated reporters, and cooperate with DHHS, CDS, and MaineCare audits.</p>
<div class="callout"><strong>Important</strong>Failure to comply with regulatory requirements may result in disciplinary action and potential legal consequences.</div>

<h1>3. Professional Conduct & Communication Policy</h1>
<p>Employees of RideSource Inc. represent the organization at all times during client transport.</p>
<h2>3.1 Professional Expectations</h2>
<p>Employees must maintain a respectful, calm, and professional demeanor; use appropriate and courteous language; maintain client dignity at all times; protect confidentiality; and maintain appropriate professional boundaries.</p>
<h2>3.2 Appropriate Conversation Topics</h2>
<ul>
<li>Appointment details and schedules</li>
<li>Travel-related information</li>
<li>Neutral topics (weather, traffic, general daily activities)</li>
<li>Supportive and encouraging conversation</li>
</ul>
<h2>3.3 Prohibited Topics & Conduct</h2>
<p>Employees must <strong>NOT</strong>:</p>
<ul>
<li>Complain about RideSource Inc., coworkers, supervisors, pay, policies, or facilities</li>
<li>Discuss internal agency matters</li>
<li>Discuss politics or express political opinions</li>
<li>Discuss religion or engage in religious debate</li>
<li>Engage in controversial or discriminatory discussions</li>
<li>Gossip about clients, staff, or community members</li>
<li>Share personal contact information</li>
<li>Connect with clients on social media</li>
<li>Form dual or personal relationships with clients</li>
</ul>
<p>Employees must redirect inappropriate conversations professionally.</p>

<h1>4. Confidentiality & HIPAA Compliance</h1>
<p>RideSource Inc. complies fully with HIPAA and Maine confidentiality laws. Employees must protect all Protected Health Information (PHI), avoid discussing client information in public, secure all paperwork and electronic devices, never discuss one client with another client, and immediately report suspected privacy breaches.</p>
<div class="callout"><strong>âš ï¸ Zero Tolerance</strong>Confidentiality violations may result in immediate termination. This obligation continues after your employment ends.</div>

<h1>5. Documentation & Billing Integrity</h1>
<p>RideSource Inc. maintains strict compliance with MaineCare transportation billing standards. Employees must accurately record trip times, mileage, and services; complete required documentation promptly; never falsify signatures, mileage, or service details; and cooperate with audits and record reviews.</p>
<div class="callout"><strong>Important</strong>Fraudulent documentation may result in termination and legal referral.</div>

<h1>6. Driver Code of Ethics</h1>
<p>All RideSource Inc. transportation employees commit to:</p>
<ul>
<li><strong>Safety First</strong> â€” Follow Maine traffic laws, never drive distracted or impaired, ensure seatbelt compliance</li>
<li><strong>Professionalism</strong> â€” Maintain respectful communication, avoid prohibited discussions, represent the organization positively</li>
<li><strong>Confidentiality</strong> â€” Protect client privacy at all times</li>
<li><strong>Accountability</strong> â€” Document accurately and report incidents immediately</li>
</ul>

<h1>7. Vehicle Cleanliness & Appearance Policy</h1>
<h2>7.1 Vehicle Standards</h2>
<p>All RideSource Inc. vehicles must be clean inside and outside, free of trash and debris, free of strong odors, properly maintained, and equipped with required safety equipment. Drivers must inspect vehicles prior to each shift and report maintenance concerns immediately.</p>
<h2>7.2 Driver Appearance</h2>
<p>Drivers must dress professionally, maintain good hygiene, wear identification badges, and avoid clothing with offensive language or imagery.</p>

<h1>8. Safety Standards</h1>
<p>RideSource Inc. prioritizes client safety. Employees must avoid distracted driving, not use handheld cell phones while driving, not conduct personal errands during transport, follow defensive driving practices, and immediately report accidents or incidents.</p>

<h1>9. Disciplinary Action Policy</h1>
<p>RideSource Inc. utilizes progressive discipline:</p>
<ul>
<li><strong>Level 1</strong> â€” Verbal Warning</li>
<li><strong>Level 2</strong> â€” Written Warning</li>
<li><strong>Level 3</strong> â€” Final Warning or Suspension</li>
<li><strong>Level 4</strong> â€” Termination</li>
</ul>
<p>Immediate termination may occur for: HIPAA violations, falsification of records, impaired driving, harassment or discrimination, or serious safety violations. RideSource Inc. reserves the right to bypass progressive steps based on severity.</p>

<h1>10. Supervisor Investigation Procedures</h1>
<p>When an incident occurs, supervisors will follow a documented investigation process including: complaint documentation, addressing safety concerns, obtaining statements, reviewing documentation and GPS/logs, reviewing camera footage if applicable, identifying the relevant policy section, assessing mandatory reporting obligations, making a determination, assigning corrective action, and filing documentation securely.</p>

<h1>11. Client Grievance Procedure</h1>
<p>Clients may file complaints by phone, in writing, by email, or in person. Complaints should include the client name, date of incident, description, and staff involved if known. RideSource will log complaints within 1 business day, assign a supervisor, complete the investigation within 5â€“10 business days, document findings, and notify the client of the outcome.</p>
<div class="callout"><strong>Non-Retaliation</strong>RideSource Inc. prohibits retaliation against clients or staff who file complaints in good faith.</div>`
  },
  {
    id: 'safety',
    name: 'Safety & Vehicle Policy',
    desc: 'Driving safety, vehicle inspection, and emergency procedures',
    content: `<h2>Safety & Vehicle Policy</h2>
<p>RideSource Inc. prioritizes the safety of every client and every employee. Safety is not optional â€” it is the foundation of everything we do.</p>
<h3>Driving Safety</h3>
<ul>
<li>Avoid all forms of distracted driving</li>
<li>Never use a handheld cell phone while driving â€” hands-free only</li>
<li>Never drive over the speed limit</li>
<li>Ensure all passengers are properly secured before moving the vehicle</li>
<li>Never transport a child without an appropriate car seat</li>
</ul>
<h3>Vehicle Inspection</h3>
<ul>
<li>Complete a pre-trip and post-trip inspection every shift</li>
<li>Report all mechanical issues or damage immediately</li>
<li>Do not operate a vehicle you believe is unsafe</li>
<li>Vehicles must be left with at least one-half tank of fuel</li>
</ul>
<h3>Incident Reporting</h3>
<p>All accidents, near-misses, and passenger incidents must be reported to your supervisor immediately, regardless of how minor they appear.</p>`
  },
  {
    id: 'attendance',
    name: 'Attendance & Punctuality Policy',
    desc: 'Call-out procedures, time off requests, and no-call/no-show policy',
    content: `<h2>Attendance & Punctuality</h2>
<p>Reliable attendance and punctuality are essential to RideSource's ability to provide dependable service. Passengers depend on us to be on time â€” and that starts with every employee.</p>
<h3>Call-Out Procedure</h3>
<p>If you are unable to report to work or will be late, you must notify your supervisor as early as possible and no later than <strong>one hour before</strong> your scheduled start time.</p>
<h3>No-Call / No-Show Policy</h3>
<ul>
<li>First offense â€” Verbal warning; written record placed in your file</li>
<li>Second offense â€” Written warning</li>
<li>Third offense â€” Final warning; continued issues may result in termination</li>
</ul>
<h3>Time Off Requests</h3>
<p>All planned time off must be submitted a minimum of <strong>two weeks in advance</strong> through the RideSource Staff Portal. Unexcused absences may result in disciplinary action.</p>
<div class="callout"><strong>Job Abandonment</strong>Employees who fail to report or contact their supervisor for three consecutive workdays are considered to have voluntarily abandoned their position and are ineligible for rehire.</div>`
  },
  {
    id: 'drug_free',
    name: 'Drug-Free Workplace Policy',
    desc: 'Substance use, testing requirements, and employee assistance',
    content: `<h2>Drug-Free Workplace</h2>
<p>RideSource is committed to a safe and productive work environment free from the influence of alcohol and drugs. The use, possession, sale, or distribution of alcohol or controlled substances on duty, on company property, or in company vehicles is strictly prohibited.</p>
<h3>Work Rules</h3>
<ul>
<li>Using, possessing, or distributing illegal drugs or paraphernalia at any time on duty is prohibited</li>
<li>Being under the influence of alcohol or any illegal substance while on duty is prohibited</li>
<li>The presence of any detectable amount of illegal drugs in your system while performing company business is prohibited</li>
</ul>
<h3>Required Testing</h3>
<ul>
<li><strong>Pre-employment</strong> â€” May be required before beginning work</li>
<li><strong>Reasonable suspicion</strong> â€” Based on supervisor observations of apparent impairment</li>
<li><strong>Post-accident</strong> â€” Required when an employee causes or contributes to an accident</li>
</ul>
<p>Employees who refuse to cooperate with required testing will be terminated.</p>`
  },
  {
    id: 'non_compete',
    name: 'Non-Compete & Separation Policy',
    desc: 'Post-employment obligations and return of company property',
    content: `<h2>Non-Compete & Separation Policy</h2>
<h3>Non-Compete Agreement</h3>
<p>For a period of <strong>24 months</strong> following the end of employment, former employees may not engage â€” directly or indirectly â€” in the same or similar activities as those performed for RideSource in any business operating within <strong>50 miles</strong> of a RideSource office.</p>
<h3>Resignation</h3>
<p>Employees who choose to resign are asked to provide at least <strong>two weeks' written notice</strong> to allow for a smooth transition. If less notice is provided, the employee may be deemed ineligible for rehiring.</p>
<h3>Return of Property</h3>
<p>Upon separation, employees must return all company property â€” including keys, access cards, uniforms, Bluetooth devices, and any company-owned equipment â€” on or before their last day. Failure to return company property may result in deductions from the final paycheck.</p>
<div class="callout"><strong>Post-Employment Confidentiality</strong>Your confidentiality obligations under Section 3.2 of the Employee Handbook remain in full effect after your employment ends.</div>`
  }
];

const TRAINING_SECTIONS = [
  { title: 'Welcome', content: `<h1>Welcome to RideSource!</h1>
<p>We are excited to have you on board. This guide walks you through everything from your first day of online training to your first day driving solo. Your trainer will work through the hands-on sections with you step by step.</p>
<div class="callout"><strong>Your Training Journey at a Glance</strong>
<table style="width:100%;font-size:13px;margin-top:8px;border-collapse:collapse;">
<tr style="background:#dde8f7;"><th style="padding:6px 10px;text-align:left;">Stage</th><th style="padding:6px 10px;text-align:left;">Timing</th><th style="padding:6px 10px;text-align:left;">What Happens</th></tr>
<tr><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Online Training</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Days 1â€“2 (at home)</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">PASS, Defensive Driving, and Online CPR/AED/First Aid â€” completed at your own pace, unpaid</td></tr>
<tr><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Hands-On: Day 3</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Day 3 (at office/in vehicle)</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Ride with seasoned driver â€” observe, learn vehicle basics and daily routine</td></tr>
<tr><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Hands-On: Day 4</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Day 4 (in vehicle)</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Ride with seasoned driver â€” continue observing, begin operating the Android dispatch device</td></tr>
<tr><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Hands-On: Day 5</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Day 5 (in vehicle)</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">You drive â€” seasoned driver observes. Company phone issued. Keys (FT) or key storage orientation (PT)</td></tr>
<tr><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Office Day</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Day 6 â€” Following Monday</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">In-office: policies, handbook, badge photo, timesheet, time off, fuel card & protocols</td></tr>
<tr><td style="padding:6px 10px;">Solo</td><td style="padding:6px 10px;">Day 7+</td><td style="padding:6px 10px;">You are on the road independently!</td></tr>
</table>
</div>
<p>Your online training courses will be ordered by HR and sent to you before your start date. These are completed at home, at your own pace. <strong>RideSource covers the cost of all courses.</strong></p>` },

  { title: 'Days 1â€“2: Online Training', content: `<h1>Days 1â€“2 â€” Online Training (At Home)</h1>
<p>Complete all three courses on Days 1 and 2. Days 3, 4, and 5 will be your hands-on vehicle training â€” with the expectation that you will be ready to be on the road independently the following week.</p>
<h2>Required Courses</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>PASS Training</strong><br>Complete the full PASS course online. Certificate of completion required.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Defensive Driving</strong><br>Complete the full Defensive Driving course online. Certificate of completion required.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Online CPR / AED / First Aid</strong><br>Complete the online First Aid, CPR, and AED course. Certificate of completion required.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Submit all three certificates to your supervisor</strong><br>Email or bring printed copies on Day 3.</div></div>
<div class="callout" style="border-left-color:var(--warn);background:#fff8ee;"><strong>&#9888; In-Person CPR/AED Certification â€” Required Within 60 Days of Hire</strong><br>This is separate from the online course and must be completed in person. HR will schedule your hands-on CPR session. Watch for that communication.</div>` },

  { title: 'Day 3: Vehicle & Ride-Along', content: `<h1>Day 3 â€” Vehicle Basics &amp; Ride-Along (Observe)</h1>
<p>Today you ride as a passenger with your trainer. Your job is to observe, ask questions, and get comfortable with the vehicle and the daily routine. <strong>You will not operate any equipment today.</strong></p>
<h2>Vehicle Familiarization</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Pre-trip inspection procedure and vehicle walk-around</strong><br>Step-by-step walkthrough of the daily pre-trip inspection checklist, exterior points: lights, tires, body condition, fuel level.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Interior layout &amp; controls</strong><br>Driver seat adjustment, mirrors, dashboard, safety equipment locations.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Wheelchair lift / ramp operation (if needed)</strong><br>How to safely deploy and stow the lift or ramp.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Safety equipment locations</strong><br>First aid kit, fire extinguisher, emergency exits.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Fuel card &amp; fueling procedure</strong><br>Where to fuel, how to use the fuel card, what to record.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Car seats â€” front facing and booster seat locations and securement</strong><br>Where to store these, how to determine safe installation, when to use.</div></div>
<h2>Daily Routine &amp; Operations</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Manifest review</strong><br>How to read your daily manifest â€” passenger info, pickup times, vehicle assignment.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Key storage procedure (Part-Time)</strong><br>How to locate your assigned vehicle on the manifest and retrieve the correct key.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Vehicle keys (Full-Time)</strong><br>Full-time drivers are assigned a dedicated vehicle and take keys home.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Dispatch communication</strong><br>How to communicate with dispatch while on route â€” including no-shows, cancellations, etc.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Passenger pick-up &amp; drop-off procedures</strong><br>Proper greeting, boarding assistance, safety protocols, and documentation.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Incident &amp; accident awareness</strong><br>What to watch for; who to call and what to document if something happens.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>End-of-day procedures</strong><br>Return route, vehicle check-in, paperwork, and key return (PT).</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>After hours assistance â€” On-Call procedure and numbers</strong><br>When to call, who to call, and what you should call for.</div></div>` },

  { title: 'Day 4: Android Device', content: `<h1>Day 4 â€” Android Dispatch Device Training (Ride-Along)</h1>
<p>Today you ride as a passenger again with your trainer. In addition to continuing to observe daily operations, you will begin hands-on training with the Android dispatch device.</p>
<h2>Android Device â€” Dispatch Software Training</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Device overview</strong><br>Hardware basics: powering on/off, charging, care and handling of the company device.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Logging in to the dispatch app</strong><br>Username, password, and what to do if you have login issues.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Viewing your manifest on the device</strong><br>How your daily route and passenger list appear in the app.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Starting your route</strong><br>How to start or preview your route.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Passenger status updates</strong><br>Marking pick-ups, drop-offs, no-shows, and exceptions in real time.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Communicating with Dispatch</strong><br>Relaying information regarding trips, member information, cancellations, no-shows, etc.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>GPS &amp; navigation features</strong><br>How the app integrates with navigation; what to do if routing is incorrect.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Completing end-of-route closeout</strong><br>How to properly close out your route at the end of the day.</div></div>
<div class="callout"><strong>Technical Issues</strong>If you experience a network outage or technical issue with the dispatch app, contact your supervisor immediately so that IT and billing can be notified and the issue documented.</div>` },

  { title: 'Day 5: Solo Evaluation', content: `<h1>Day 5 â€” Solo Drive with Observer</h1>
<p>Today you are in the driver's seat. Your trainer rides along to observe and support â€” but <strong>you</strong> are running the route and operating the Android device. This is your final hands-on evaluation before going solo.</p>
<h2>Driving Evaluation</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Pre-trip inspection completed independently</strong><br>Driver performs full pre-trip without prompting.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Manifest reviewed and route understood before departure</strong><br>Driver confirms all stops, times, and passenger notes.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Android device operated throughout the route</strong><br>All pick-ups, drop-offs, and status updates logged correctly in real time.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Passenger boarding &amp; safety protocols followed</strong><br>Proper greeting, assistance, securement, and documentation observed.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Dispatch communication handled appropriately</strong><br>Driver contacts dispatch correctly when needed.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Safe and professional driving demonstrated</strong><br>Defensive driving techniques, speed, following distance, and demeanor.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>End-of-route closeout completed</strong><br>Route closed out correctly in the app; vehicle returned and secured.</div></div>
<h2>Day 5 Equipment Issuance</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Company phone issued &amp; set up</strong><br>Driver's name, login credentials, and dispatch app installed and tested.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Full-Time drivers: Vehicle keys issued</strong><br>Assigned vehicle confirmed; driver authorized to take vehicle home.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Part-Time drivers: Vehicle key storage and orientation</strong><br>Location of key board confirmed; how to identify assigned vehicle on manifest reviewed.</div></div>` },

  { title: 'Day 6: Office & Policies', content: `<h1>Day 6 â€” Office Orientation Session</h1>
<p>Report to the office at your scheduled arrival time. This session covers the administrative side of your role â€” policies, systems, and everything you need to know to manage your employment at RideSource.</p>
<h2>Policies &amp; Handbook</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Employee Handbook review</strong><br>Walk through key sections with HR; opportunity to ask questions.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>At-Will Employment</strong><br>Understanding what this means for both you and RideSource.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Attendance &amp; Punctuality Standards</strong><br>Expectations, call-in procedures, and how attendance patterns are monitored.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Code of Business Conduct &amp; Ethics</strong><br>Professional standards, conflict of interest, and gifts policy.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Confidentiality &amp; Information Security</strong><br>Protecting client and company information; social media guidelines.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Anti-Harassment Policy</strong><br>Zero tolerance; definitions, reporting steps, and your protections.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Drug &amp; Alcohol-Free Workplace</strong><br>Policy, testing, and consequences.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Workplace Safety &amp; Emergency Procedures</strong><br>Your responsibilities; who to call; incident reporting.</div></div>
<h2>Digital Signature Tracker â€” Policy Acknowledgments</h2>
<p>Your Supervisor will walk you through the Digital Signature Tracker. You will read and acknowledge each of the following policies before leaving today.</p>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>1. Handbook Receipt &amp; Acknowledgment</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>2. Fingerprinting, Background and Motor Vehicle Check Consent</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>3. Client Confidentiality Agreement</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>4. Sexual Harassment Policy</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>5. Drug Free Workplace</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>6. Company Vehicle Use</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>7. Personal Appearance</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>8. Attendance and Punctuality</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>9. Passenger Interaction and Service Standards</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>10. Cell Phone and Distracted Driving Policy</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>11. Accident and Incident Reporting Policy</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>12. Social Media and Public Communications Policy</div></div>
<h2>Administrative Setup</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Badge ID photo taken</strong><br>HR will photograph you for your RideSource employee ID badge.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Timesheet process reviewed</strong><br>How to log your hours, timesheet deadlines, and approval process.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Time Off Request Portal walkthrough</strong><br>How to submit planned time off â€” accessible from the portal sidebar.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Call-out procedure</strong><br>For unplanned absences â€” call your supervisor directly; manager logs the call-out on your behalf.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Fuel card issued &amp; protocols reviewed</strong><br>How to use your fuel card, what to record, and what is not permitted.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Pay schedule &amp; direct deposit confirmed</strong><br>Pay periods, paydays, and how to view your pay stub.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Benefits overview</strong><br>Health, dental, vision, 401(k), EAP â€” enrollment windows and next steps.</div></div>
<div class="callout"><strong>Training Complete</strong>By completing all sections of this guide, both you and your supervisor confirm that all stages of the RideSource Driver Training Guide have been completed. You have received, reviewed, and understood all policies, procedures, and operational requirements.</div>
<div class="callout" style="border-left-color:#aaa;background:#f7f7f7;font-size:12px;margin-top:8px;"><strong>All Stages Completed:</strong><br>
&#9744; &nbsp;Online Training (Days 1â€“2) â€” PASS, Defensive Driving, Online CPR/AED/First Aid<br>
&#9744; &nbsp;Day 3 â€” Vehicle Basics &amp; Ride-Along (Observe)<br>
&#9744; &nbsp;Day 4 â€” Android Dispatch Device Training (Ride-Along)<br>
&#9744; &nbsp;Day 5 â€” Solo Drive with Observer + Equipment Issued<br>
&#9744; &nbsp;Day 6 â€” Office Orientation: Policies, Handbook, Signature Tracker, Admin Setup<br>
&#9744; &nbsp;In-Person CPR/AED Certification â€” Scheduled (required within 60 days of hire)
</div>` }
];

const HANDBOOK_SECTIONS = [
  { title: 'Sec 1: Welcome', content: `<h1>Section 1: Welcome & Company Overview</h1>
<h2>1.1 Welcome Message</h2>
<p>Welcome to RideSource Inc. We are proud to have you join our team. RideSource is a Non-Emergency Medical Transportation (NEMT) company based in Norway, Maine, committed to providing reliable, safe, and compassionate transportation services to the communities we serve. Our drivers and staff are the foundation of that commitment.</p>
<p>This handbook has been carefully prepared to give you the information you need to be successful at RideSource. Please read it thoroughly, ask questions when something is unclear, and refer to it whenever you need guidance.</p>
<h2>1.2 Our Mission, Vision & Values</h2>
<p><strong>Mission:</strong> To provide safe, reliable, and dignified transportation services that connect passengers to the care and resources they need â€” every trip, every time.</p>
<h3>Core Values</h3>
<ul>
<li><strong>Safety First</strong> â€” Every decision prioritizes the safety of passengers and staff</li>
<li><strong>Reliability</strong> â€” We show up on time, every time, as promised</li>
<li><strong>Dignity & Respect</strong> â€” Every passenger is treated with professionalism and compassion</li>
<li><strong>Accountability</strong> â€” We take responsibility for our actions and our service</li>
<li><strong>Community</strong> â€” We are proud to serve the communities of Maine</li>
</ul>` },
  { title: 'Sec 2: Employment', content: `<h1>Section 2: Employment Requirements & Expectations</h1>
<h2>2.1 Summary of Employment Requirements</h2>
<ul>
<li>Must be at least 25 years of age and have held a valid driver's license for at least five years</li>
<li>Drivers shall have no more than one chargeable accident or moving violation in the last ten years</li>
<li>Must not have been convicted of any felony-level crime as defined in Maine State Law</li>
<li>All drivers must be professional, courteous, patient, neat and clean in appearance</li>
<li>No driver shall use prescription medications that impair the ability to perform duties while on duty</li>
<li>All drivers must wear a visible, easily readable name tag at all times while on duty</li>
</ul>
<h2>2.3 At-Will Employment</h2>
<p>Employment at RideSource Inc. is at-will. Either you or RideSource may end the employment relationship at any time, with or without cause.</p>
<h2>2.4 Equal Opportunity & Non-Discrimination</h2>
<p>RideSource Inc. is an equal opportunity employer committed to providing employment opportunities without regard to race, color, religion, sex, national origin, age, disability, or any other characteristic protected by law. RideSource has a zero-tolerance policy for harassment of any kind, including sexual harassment.</p>
<h2>2.6 Introductory Period</h2>
<p>All new employees serve a 90-day introductory period. During this time, RideSource evaluates your performance, attendance, and fit within our team.</p>` },
  { title: 'Sec 3: Conduct', content: `<h1>Section 3: Workplace Conduct & Professional Standards</h1>
<h2>3.1 Code of Conduct & Ethics</h2>
<ul>
<li>Treat all passengers, colleagues, and the public with dignity and respect</li>
<li>Be honest and transparent in all work-related communications</li>
<li>Do not accept gifts, gratuities, or personal benefits from passengers or vendors</li>
<li>Do not contact any member except as appropriate and necessary for their transport</li>
</ul>
<h2>3.2 Confidentiality & Information Security</h2>
<p>All passenger information is strictly confidential â€” including names, addresses, health information, and immigration status. All HIPAA-protected information must be used with utmost care. You must not share passenger information with any third party. This obligation continues after your employment ends.</p>
<h2>3.3 Personal Appearance</h2>
<p>All employees must project a professional image while on duty. Clothing must be consistent with a professional transportation environment. All employees should be covered from shoulders to knees at all times.</p>
<h2>3.5 Social Media</h2>
<p>Do not post passenger information, photos taken in company vehicles, or any content that could harm RideSource or its passengers. Policy violations may result in disciplinary action up to and including termination.</p>` },
  { title: 'Sec 4: Attendance', content: `<h1>Section 4: Attendance, Time & Scheduling</h1>
<h2>4.1 Attendance & Punctuality</h2>
<p>If you are unable to report to work, you must notify your supervisor no later than <strong>one hour before</strong> your scheduled start time. Early notification reduces canceled rides and allows us to arrange coverage.</p>
<h3>No-Call/No-Show Policy</h3>
<ul>
<li>First offense â€” Verbal warning; written record placed in your personnel file</li>
<li>Second offense â€” Written warning</li>
<li>Third offense â€” Final warning; continued attendance issues may result in termination</li>
</ul>
<p>All planned time off requests must be submitted <strong>at least two weeks in advance</strong> through the <a href="https://ridesourcecalendar-hub.github.io/ridesource-onboarding/timeoff.html" target="_blank">RideSource Staff Portal</a>.</p>
<h2>4.3 Parascope & Trip Documentation</h2>
<ul>
<li>Select "On the Way" when departing for pickup â€” not when arriving</li>
<li>Complete each trip in Parascope promptly after drop-off</li>
<li>Obtain required passenger or guardian signature for every trip</li>
</ul>` },
  { title: 'Sec 5: Compensation', content: `<h1>Section 5: Compensation & Performance</h1>
<h2>5.1 Pay Periods & Paydays</h2>
<p>RideSource pays employees on a biweekly basis. Wages are paid for the period ending the previous Friday, with paydays generally falling on <strong>Wednesdays</strong>. Direct deposit is required for all employees.</p>
<h2>5.2 Performance Reviews & Compensation</h2>
<p>RideSource conducts performance reviews annually. Compensation adjustments are reviewed after the introductory period and are based on performance, attendance, reliability, and business needs. A performance review does not result in an automatic pay increase â€” all compensation decisions are made at the discretion of the management team.</p>
<h2>5.4 Timekeeping & TWE System</h2>
<p>All employees are required to accurately record all hours worked using the TWE system. Falsification of time records may result in disciplinary action up to and including termination.</p>` },
  { title: 'Sec 6: Benefits', content: `<h1>Section 6: Benefits & Insurance</h1>
<h2>6.1 Benefits Overview</h2>
<p>RideSource offers a benefits package to eligible employees. Eligibility, waiting periods, and specific plan details are provided during onboarding and enrollment. Contact management for current benefit offerings.</p>
<h2>6.2 Health & Wellness Benefits</h2>
<p>Eligible employees may have access to medical, dental, and vision insurance coverage. Benefits begin after the applicable waiting period.</p>
<h2>6.4 Workers' Compensation</h2>
<p>All RideSource employees are covered by Maine workers' compensation insurance. If you are injured on the job, report the injury to your supervisor immediately and seek appropriate medical attention. Failure to report a work injury promptly may affect your claim.</p>
<h2>6.5 Leave Policies Overview</h2>
<p>RideSource complies with all applicable federal and state leave laws, including FMLA, Maine state leave laws, military leave (USERRA), jury duty, and bereavement leave. Time off requests must be submitted through the RideSource Staff Portal.</p>` },
  { title: 'Sec 7: Safety', content: `<h1>Section 7: Workplace Safety & Health</h1>
<h2>7.1 Safety Is Everyone's Responsibility</h2>
<p>Every employee is responsible for following safety procedures, reporting hazards, and cooperating with safety initiatives. If you observe an unsafe condition, report it to your supervisor immediately.</p>
<h2>7.2 Drug-Free Workplace</h2>
<p>The use, possession, sale, or distribution of alcohol or controlled substances on duty, on company property, or in company vehicles is strictly prohibited. RideSource requires pre-employment, reasonable suspicion, and post-accident testing.</p>
<h2>7.4 Accident & Incident Reporting</h2>
<p>All workplace accidents, injuries, near-misses, passenger incidents, and vehicle accidents must be reported to your supervisor <strong>immediately</strong>. The four basic emergency handling steps: (1) Keep calm; (2) Contact your dispatcher; (3) Protect your passengers, yourself, and your vehicle; (4) Complete all required reports thoroughly.</p>
<h2>7.7 Smoking & Tobacco</h2>
<p>Smoking, vaping, and using any tobacco products are prohibited in all company vehicles, on all company property, and at all company-sponsored events.</p>` },
  { title: 'Sec 8: Operations', content: `<h1>Section 8: Transportation Operations & Service Standards</h1>
<h2>8.1 Passenger Identity Verification</h2>
<p>Before beginning any transport, verify that the passenger matches the individual listed on the trip manifest. Do not transport any individual not listed on the manifest.</p>
<h2>8.2 Trip Assignment & Refusal of Trips</h2>
<p>Refusing trips or clients is not acceptable and is inconsistent with your job responsibilities. Drivers may not pick and choose trips or clients. Failure to comply may result in corrective action up to and including termination.</p>
<h2>8.6 Hands-Free Mobile Device Policy</h2>
<p>Maine State Law prohibits drivers from holding any electronic device while operating a vehicle. RideSource provides a company Bluetooth device and phone mount to every driver â€” these must be used for all calls while driving.</p>
<h2>8.7 Dash Camera System</h2>
<p>All RideSource vehicles are equipped with dash cameras. Footage is stored for approximately 30 days and reviewed only in the event of a complaint, incident, or accident. Each vehicle is equipped with a panic button that bookmarks 10 seconds before and 20 seconds after an event.</p>` },
  { title: 'Sec 9â€“10: Dev & Separation', content: `<h1>Sections 9 & 10: Development & Separation</h1>
<h2>9.1 Training & Development</h2>
<p>RideSource encourages ongoing learning and professional growth. Required training is a condition of employment, and failure to complete it may result in disciplinary action.</p>
<h2>10.2 Disciplinary Process</h2>
<p>RideSource uses a progressive discipline process:</p>
<ul>
<li><strong>Verbal Warning</strong> â€” Documented in your personnel file</li>
<li><strong>Written Warning</strong> â€” Used for serious violations or when verbal warning was ineffective</li>
<li><strong>Final Warning / PIP</strong> â€” Up to 90 days; failure to meet PIP goals may result in termination</li>
</ul>
<p>Some violations may result in immediate termination, including workplace violence, theft, intoxication on duty, camera tampering, and HIPAA violations.</p>
<h2>10.3 Resignation & Termination</h2>
<p>Employees who choose to resign are asked to provide at least two weeks' written notice. Employees separated due to job abandonment are ineligible for rehire. Upon separation, all company property must be returned on or before your last day.</p>
<h2>10.4 Non-Compete Agreement</h2>
<p>For a period of 24 months following employment, former employees may not engage in the same or similar activities as those performed for RideSource in any business within 50 miles of a RideSource office.</p>` },
  { title: 'Sec 11: Acknowledgments', content: `<h1>Section 11: Acknowledgment</h1>
<p>You have reached the final section of the Employee Handbook. Please scroll down to the acknowledgment block below and complete your signature to finalize this step.</p>
<div class="callout"><strong>Final Certification Language</strong>By signing, I certify that I have received and reviewed the RideSource Inc. Employee Handbook, that I understand my responsibilities as an employee, and that I agree to comply with all policies contained herein. I acknowledge that this handbook does not constitute a contract of employment, that my employment is at-will, and that my post-employment confidentiality obligations remain in effect after separation.</div>
<p>Please scroll down to the acknowledgment form below.</p>` }
];



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOCUMENT READER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildReader(type, sections) {
  const tabs = document.getElementById(type + '-tabs');
  tabs.innerHTML = sections.map((s, i) => `<div class="doc-tab ${i === 0 ? 'active' : ''}" id="${type}-tab-${i}" onclick="goToSection('${type}', ${i})">${s.title}</div>`).join('');
  renderSection(type, 0, sections);
}

function buildTraining() { buildReader('training', TRAINING_SECTIONS); }
function buildHandbook() { buildReader('handbook', HANDBOOK_SECTIONS); }

function renderSection(type, idx, sections) {
  const s = sections || (type === 'training' ? TRAINING_SECTIONS : HANDBOOK_SECTIONS);
  const sec = s[idx];
  document.getElementById(type + '-body').innerHTML = sec.content;
  document.getElementById(type + '-body').scrollTop = 0;
  document.getElementById(type + '-progress-label').textContent = `Section ${idx + 1} of ${s.length}`;
  document.querySelectorAll(`#${type}-tabs .doc-tab`).forEach((t, i) => {
    t.classList.toggle('active', i === idx);
    if ((type === 'training' ? trainingSectionRead : handbookSectionRead)[i]) t.classList.add('completed');
  });
  const nextBtn = document.getElementById(type + '-next');
  const prevBtn = document.getElementById(type + '-prev');
  prevBtn.disabled = idx === 0;
  nextBtn.disabled = true; // re-enabled on scroll
  // Mark as read if already read
  const readMap = type === 'training' ? trainingSectionRead : handbookSectionRead;
  if (readMap[idx]) { nextBtn.disabled = false; document.getElementById(type + '-scroll-note').textContent = 'âœ… Section read.'; }
  else { document.getElementById(type + '-scroll-note').textContent = 'ğŸ“– Scroll to the bottom of this section to continue.'; }

  const isLast = idx === s.length - 1;
  if (isLast) {
    nextBtn.textContent = type === 'handbook' ? 'Complete & Sign â†’' : 'Finish Training Guide â†’';
  } else {
    nextBtn.textContent = 'Next Section â†’';
  }
}

function goToSection(type, idx) {
  if (type === 'training') { trainingSection = idx; renderSection('training', idx); }
  else { handbookSection = idx; renderSection('handbook', idx); }
}

function changeSection(type, dir) {
  const sections = type === 'training' ? TRAINING_SECTIONS : HANDBOOK_SECTIONS;
  const current = type === 'training' ? trainingSection : handbookSection;
  const next = current + dir;
  if (next < 0 || next > sections.length) return;
  if (next === sections.length) {
    if (type === 'training') { trainingComplete = true; showTrainingComplete(); saveState(); updateDashboard(); }
    else { showHandbookSig(); }
    return;
  }
  if (type === 'training') { trainingSection = next; renderSection('training', next); }
  else { handbookSection = next; renderSection('handbook', next); }
}

function checkScroll(type) {
  const body = document.getElementById(type + '-body');
  const atBottom = body.scrollHeight - body.scrollTop - body.clientHeight < 40;
  if (!atBottom) return;
  const idx = type === 'training' ? trainingSection : handbookSection;
  const readMap = type === 'training' ? trainingSectionRead : handbookSectionRead;
  if (!readMap[idx]) {
    readMap[idx] = true;
    document.getElementById(type + '-next').disabled = false;
    document.getElementById(type + '-scroll-note').textContent = 'âœ… Section read.';
    const tab = document.getElementById(`${type}-tab-${idx}`);
    if (tab) tab.classList.add('completed');
    saveState(); updateDashboard();
  }
}

function showTrainingComplete() {
  document.getElementById('training-complete-banner').style.display = 'block';
  document.querySelector('.doc-reader').style.display = 'none';
}

function showHandbookSig() {
  document.getElementById('handbook-sig').style.display = 'block';
  handbookSection = HANDBOOK_SECTIONS.length - 1;
  handbookSectionRead[HANDBOOK_SECTIONS.length - 1] = true;
  saveState();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HANDBOOK SIGNATURE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectHandbookOpt(val) {
  handbookSigChoice = val;
  document.getElementById('opt-print').classList.toggle('selected', val === 'print');
  document.getElementById('opt-digital').classList.toggle('selected', val === 'digital');
  document.getElementById('rb-' + val).checked = true;
  checkHbSig();
}

document.addEventListener('DOMContentLoaded', () => {
  const inp = document.getElementById('hb-sig-input');
  if (inp) inp.addEventListener('input', checkHbSig);
});

function checkHbSig() {
  const sig = document.getElementById('hb-sig-input')?.value.trim();
  const btn = document.getElementById('hb-submit-btn');
  if (btn) btn.disabled = !(sig && handbookSigChoice);
}

async function submitHandbookSig() {
  const sig = document.getElementById('hb-sig-input').value.trim();
  const btn = document.getElementById('hb-submit-btn');
  btn.disabled = true; btn.textContent = 'Saving...';
  const payload = {
    employee_name: user.name,
    employee_email: user.email,
    county: user.county,
    handbook_version: '3.0',
    signature: sig,
    print_requested: handbookSigChoice === 'print',
    signed_at: new Date().toISOString()
  };
  try {
    await db.from('handbook_signatures').insert([payload]);
  } catch(e) { console.log('Handbook sig save:', e); }
  handbookComplete = true;
  saveState();
  document.getElementById('handbook-sig').innerHTML = `<div class="success-banner"><div class="big-check">âœ…</div><h2>Handbook Acknowledged!</h2><p>${handbookSigChoice === 'print' ? 'A printed copy has been requested. HR will arrange delivery.' : 'Thank you â€” your digital acknowledgment has been recorded.'}</p><button class="btn-primary" style="margin-top:16px;background:rgba(255,255,255,0.2);border:2px solid rgba(255,255,255,0.5);" onclick="showSection('policies')">Continue to Policy Sign-Offs â†’</button></div>`;
  updateDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POLICY SIGN-OFFS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildPolicies() {
  const list = document.getElementById('policy-list');
  list.innerHTML = POLICIES.map((p, i) => `
    <div class="policy-item" id="pol-${p.id}" data-signed="0">
      <div class="policy-check" id="check-${p.id}">â€“</div>
      <div class="policy-info">
        <div class="policy-name">${p.name}</div>
        <div class="policy-desc">${p.desc}</div>
        <div class="policy-time" id="time-${p.id}"></div>
      </div>
      <button class="policy-btn policy-btn-read" id="pbtn-${p.id}" onclick="openPolicyModal(${i})">Read & Sign</button>
    </div>`).join('');
  updateBadge();
}

function openPolicyModal(idx) {
  currentPolicyIndex = idx;
  modalScrolled = false;
  const p = POLICIES[idx];
  document.getElementById('modal-title').textContent = p.name;
  document.getElementById('modal-desc').textContent = 'Read the full policy below, then type your name to sign.';
  document.getElementById('modal-body').innerHTML = p.content;
  document.getElementById('modal-body').scrollTop = 0;
  document.getElementById('modal-sig').value = '';
  document.getElementById('modal-sign-btn').disabled = true;
  document.getElementById('policy-modal').classList.add('open');
}

function closePolicyModal() {
  document.getElementById('policy-modal').classList.remove('open');
}

function checkModalScroll() {
  const body = document.getElementById('modal-body');
  const atBottom = body.scrollHeight - body.scrollTop - body.clientHeight < 40;
  if (atBottom && !modalScrolled) { modalScrolled = true; checkModalSig(); }
}

function checkModalSig() {
  const sig = document.getElementById('modal-sig').value.trim();
  document.getElementById('modal-sign-btn').disabled = !(sig && modalScrolled);
}

async function signPolicy() {
  const p = POLICIES[currentPolicyIndex];
  const sig = document.getElementById('modal-sig').value.trim();
  const btn = document.getElementById('modal-sign-btn');
  btn.disabled = true; btn.textContent = 'Saving...';
  const now = new Date();
  const ts = now.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
  try {
    await db.from('policy_signatures').upsert([{
      employee_name: user.name,
      employee_email: user.email,
      county: user.county,
      policy_id: p.id,
      policy_name: p.name,
      signature: sig,
      signed_at: now.toISOString()
    }], { onConflict: 'employee_email,policy_id' });
  } catch(e) { console.log('Policy sig:', e); }
  const item = document.getElementById('pol-' + p.id);
  item.classList.add('signed'); item.dataset.signed = '1';
  document.getElementById('check-' + p.id).textContent = 'âœ“';
  document.getElementById('time-' + p.id).textContent = 'Signed ' + ts;
  document.getElementById('pbtn-' + p.id).textContent = 'âœ“ Signed';
  document.getElementById('pbtn-' + p.id).className = 'policy-btn policy-btn-done';
  closePolicyModal();
  updateBadge();
  updateDashboard();
  checkAllSigned();
}

function updateBadge() {
  const total = POLICIES.length;
  const done = POLICIES.filter(p => { const el = document.getElementById('pol-' + p.id); return el && el.dataset.signed === '1'; }).length;
  document.getElementById('badge-policies').textContent = `${done}/${total}`;
}

function checkAllSigned() {
  const done = POLICIES.filter(p => { const el = document.getElementById('pol-' + p.id); return el && el.dataset.signed === '1'; }).length;
  if (done === POLICIES.length) {
    document.getElementById('all-signed-banner').style.display = 'block';
    notifyCompletion();
  }
}

async function notifyCompletion() {
  if (typeof emailjs === 'undefined') return;
  try {
    await emailjs.send(EMAILJS_SERVICE_ID, 'timeoff_submission', {
      employee_name: user.name,
      employee_email: user.email,
      county: user.county,
      request_type: 'ONBOARDING COMPLETE',
      start_date: new Date().toLocaleDateString(),
      end_date: '',
      time_detail: 'All policies signed, handbook acknowledged.',
      reason: `${user.name} has completed all onboarding acknowledgments in the Employee Portal.`,
      portal_url: PORTAL_URL,
      to_email: SUPERVISOR_EMAIL
    });
  } catch(e) { console.log('Notification:', e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateDashboard() {
  const trainingRead = Object.keys(trainingSectionRead).length;
  const handbookRead = Object.keys(handbookSectionRead).length;
  const docsComplete = (trainingComplete ? 1 : 0) + (handbookComplete ? 1 : 0);
  const polSigned = POLICIES.filter(p => { const el = document.getElementById('pol-' + p.id); return el && el.dataset.signed === '1'; }).length;
  const total = 2 + POLICIES.length; // 2 docs + policies
  const done = docsComplete + polSigned;
  const pct = Math.round((done / total) * 100);
  document.getElementById('progress-fill').style.width = pct + '%';
  document.getElementById('progress-pct').textContent = pct + '%';
  document.getElementById('stat-docs').textContent = docsComplete + '/2';
  document.getElementById('stat-sigs').textContent = polSigned + '/' + POLICIES.length;
  document.getElementById('stat-remaining').textContent = total - done;

  const checks = [
    { label: 'Complete online training courses (PASS, Defensive Driving, CPR)', done: true },
    { label: 'Read Driver Training Guide', done: trainingComplete },
    { label: 'Read Employee Handbook', done: handbookComplete },
    { label: `Sign policy acknowledgments (${polSigned}/${POLICIES.length} complete)`, done: polSigned === POLICIES.length },
  ];
  document.getElementById('dash-checklist').innerHTML = checks.map(c => `
    <li>
      <div class="check-dot ${c.done ? 'done' : 'pending'}">${c.done ? 'âœ“' : 'â—‹'}</div>
      <span style="color:${c.done ? '#27AE60' : '#444'};${c.done ? 'text-decoration:line-through;opacity:0.7;' : ''}">${c.label}</span>
    </li>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIME OFF REQUEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectReqType(type) {
  currentReqType = type;
  document.querySelectorAll('.req-type-btn').forEach(b => { b.style.background = 'transparent'; b.style.color = 'var(--navy)'; });
  event.target.style.background = 'var(--navy)'; event.target.style.color = '#fff';
  const fields = document.getElementById('req-fields');
  let html = '';
  if (type === 'Full Day Off') {
    html = `<div class="sig-field"><label>Date</label><input type="date" id="req-date1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div>`;
  } else if (type === 'Multiple Days') {
    html = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="sig-field"><label>Start Date</label><input type="date" id="req-date1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div>
      <div class="sig-field"><label>End Date</label><input type="date" id="req-date2" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div>
    </div>`;
  } else if (type === 'Start Late') {
    html = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="sig-field"><label>Date</label><input type="date" id="req-date1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div>
      <div class="sig-field"><label>Arriving At</label><input type="time" id="req-time1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div>
    </div>`;
  } else if (type === 'End Early') {
    html = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="sig-field"><label>Date</label><input type="date" id="req-date1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div>
      <div class="sig-field"><label>Leaving At</label><input type="time" id="req-time1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div>
    </div>`;
  } else if (type === 'Mid-Day Appointment') {
    html = `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
      <div class="sig-field"><label>Date</label><input type="date" id="req-date1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div>
      <div class="sig-field"><label>Approx. Time Leaving</label><input type="time" id="req-time1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div>
      <div class="sig-field"><label>Approx. Time Returning</label><input type="time" id="req-time2" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div>
    </div>`;
  }
  fields.innerHTML = html;
  document.getElementById('req-form').style.display = 'block';
  document.getElementById('req-success').style.display = 'none';
}

async function submitTimeOff() {
  const date1 = document.getElementById('req-date1')?.value;
  const date2 = document.getElementById('req-date2')?.value || date1;
  const time1 = document.getElementById('req-time1')?.value || '';
  const time2 = document.getElementById('req-time2')?.value || '';
  const reason = document.getElementById('req-reason').value;
  const timeDetail = time2 ? `${time1} â€“ ${time2}` : time1;
  if (!date1) { alert('Please select a date.'); return; }
  try {
    await db.from('time_off_requests').insert([{
      employee_name: user.name, employee_email: user.email, county: user.county,
      request_type: currentReqType, start_date: date1, end_date: date2,
      time_detail: timeDetail, reason, status: 'PENDING', submitted_at: new Date().toISOString()
    }]);
    if (typeof emailjs !== 'undefined') {
      await emailjs.send(EMAILJS_SERVICE_ID, 'template_26w7bfc', {
        employee_name: user.name, employee_email: user.email, county: user.county,
        request_type: currentReqType, start_date: date1, end_date: date2,
        time_detail: timeDetail, reason, portal_url: PORTAL_URL, to_email: SUPERVISOR_EMAIL
      });
    }
  } catch(e) { console.log('Time off submit:', e); }
  document.getElementById('req-form').style.display = 'none';
  document.getElementById('req-success').style.display = 'block';
}

function resetTimeOff() {
  currentReqType = null;
  document.getElementById('req-form').style.display = 'none';
  document.getElementById('req-success').style.display = 'none';
  document.getElementById('req-reason').value = '';
  document.querySelectorAll('.req-type-btn').forEach(b => { b.style.background = 'transparent'; b.style.color = 'var(--navy)'; });
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ MANAGER GUIDE SECTIONS â”€â”€
const MGR_SECTIONS=[
  {title:'Sec 1: Onboarding Role',content:`<h1>Section 1: Your Role in Onboarding</h1>
<p>As a supervisor or manager at RideSource, you are the most important part of the onboarding experience. A new employee's success in their first 30 days depends largely on how consistently and thoroughly you guide them through this process.</p>
<h2>1.1 Your Responsibilities at a Glance</h2>
<ul>
<li>Ensure all pre-employment clearances are complete before sending a Welcome Aboard letter</li>
<li>Coordinate online training course enrollment (ordered by HR)</li>
<li>Conduct all four phases of hands-on training (Days 3â€“6)</li>
<li>Guide the employee through all policy acknowledgments via the Digital Onboarding Portal</li>
<li>Check in daily during the first solo week on the road</li>
</ul>
<h2>1.2 The Four Core Tools</h2>
<ul>
<li><strong>Employee Portal</strong> â€” Where employees read guides, handbook, and sign policies</li>
<li><strong>Admin Portal</strong> â€” Where you (manager) track progress, generate warnings, and access HR tools</li>
<li><strong>Time Off Portal</strong> â€” Handles all time off requests and call-out logging</li>
<li><strong>Onboarding Checklist</strong> â€” Physical/digital checklist retained in the employee's personnel file</li>
</ul>`},
  {title:'Sec 2: Pre-Employment',content:`<h1>Section 2: Pre-Employment Process</h1>
<p>The hiring process at RideSource follows a specific sequence before any training begins. Every step below must be completed and cleared before a Welcome Aboard Letter is sent.</p>
<h2>2.1 Interview & Same-Day Screening</h2>
<ul>
<li>Conduct interview using the standardized Interview Questions form (available in HR Templates)</li>
<li>Collect driver info form and emergency contact form</li>
<li>Obtain consent for background check, MVR, and fingerprinting</li>
<li>Collect consent for certification release</li>
</ul>
<h2>2.2 Waiting Period (~1 Week)</h2>
<p>After the interview, allow approximately one week for all four clearances:</p>
<ul>
<li>Background check results</li>
<li>Motor vehicle record (MVR) review</li>
<li>Fingerprint clearance</li>
<li>Reference checks (if applicable)</li>
</ul>
<h2>2.3 Welcome Aboard Letter or Letter of Rejection</h2>
<p>Once all clearances are confirmed, send the Welcome Aboard Letter via the HR Templates section of this portal. If the applicant does not pass screenings, send the Letter of Rejection within one week of receiving results.</p>
<div class="callout"><strong>Important</strong>HR orders the three online training courses immediately after the Welcome Aboard Letter is sent. Employees are NOT paid for online training completed at home.</div>`},
  {title:'Sec 3: Preparing for Day 3',content:`<h1>Section 3: Preparing for a New Hire</h1>
<p>A successful Day 3 (first in-office hands-on day) requires preparation ahead of time. Use this checklist before every new hire.</p>
<h2>Pre-Day 3 Checklist</h2>
<ul>
<li>â˜ Confirm online training courses are completed and certificates received</li>
<li>â˜ Assign vehicle â€” inspect and ensure it is clean and fueled</li>
<li>â˜ Set up Android dispatch device with employee credentials</li>
<li>â˜ Prepare employee ID badge</li>
<li>â˜ Set up TWE timekeeping access</li>
<li>â˜ Prepare the secure Day 1 info document (Driver ID, door code, vehicle, phone number, payroll login)</li>
<li>â˜ Notify dispatch of new employee training schedule</li>
<li>â˜ Block time on your calendar for Days 3â€“6 training</li>
</ul>
<div class="warn-box"><strong>âš ï¸ Do Not Begin Training Until:</strong>All clearances confirmed AND all online courses completed. No exceptions.</div>`},
  {title:'Sec 4: Time Off System',content:`<h1>Section 4: Time Off Request System</h1>
<p>RideSource uses the digital Staff Portal for all time off requests and call-out tracking. As a supervisor, you are responsible for approving requests and logging call-outs on behalf of your team.</p>
<h2>4.1 How Employee Time Off Requests Work</h2>
<ul>
<li>Employee submits a request via the <strong>Employee Portal â†’ Request Time Off</strong></li>
<li>You receive an automatic email notification with request details</li>
<li>Log in to this Admin Portal â†’ Pending Requests â†’ approve or deny</li>
<li>Employee receives an automatic email with your decision</li>
<li>Approved requests appear on the Team Calendar automatically</li>
</ul>
<h2>4.2 Logging a Call-Out (Manager Responsibility)</h2>
<p>When an employee calls out unexpectedly, you log the call-out on their behalf. Employees never submit their own call-outs.</p>
<ul>
<li>Go to <strong>Call-Out Log</strong> in this portal</li>
<li>Enter employee name, county, date, reason, and optional notes</li>
<li>Submit â€” the record is saved to Supabase and the attendance system updates automatically</li>
</ul>
<h2>4.3 Attendance Monitoring</h2>
<p>The system automatically flags any employee with 3+ call-outs in a rolling 30-day window. Flagged employees appear in the <strong>Attendance Warnings</strong> section with their specific call-out dates pre-loaded. You review, edit if needed, and generate the appropriate warning letter.</p>`},
  {title:'Sec 5: Policy Tracker',content:`<h1>Section 5: Digital Onboarding & Policy Tracker</h1>
<p>All new employees must complete the Employee Portal, which collects acknowledgments for all required RideSource policies. This is a compliance requirement and must be completed before the end of Week 2.</p>
<h2>Required Acknowledgments (Employee Portal)</h2>
<ul>
<li>At-Will Employment Policy</li>
<li>HIPAA & Confidentiality Policy</li>
<li>Employee Code of Conduct</li>
<li>Safety & Vehicle Policy</li>
<li>Attendance & Punctuality Policy</li>
<li>Drug-Free Workplace Policy</li>
<li>Non-Compete & Separation Policy</li>
<li>Employee Handbook (with print copy option)</li>
</ul>
<h2>Your Role</h2>
<ul>
<li>Direct the employee to the Employee Portal and ensure they can access it</li>
<li>Best practice: have the employee complete it in the office so questions can be addressed</li>
<li>Monitor progress in the <strong>Onboarding Tracker</strong> section of this Admin Portal</li>
<li>Confirm all items are signed before the end of Week 2</li>
</ul>`},
  {title:'Sec 6: Supporting New Hires',content:`<h1>Section 6: Supporting New Employees</h1>
<h2>6.1 The First Week Solo</h2>
<p>The first week a driver is on the road solo is critical. Check in daily. They've completed the training â€” now they need to build confidence and develop good habits in real conditions. Things to check:</p>
<ul>
<li>Are they using Parascope correctly and in real time?</li>
<li>Are trips being completed and documented on time?</li>
<li>Is the vehicle being kept clean and inspected daily?</li>
<li>Are they communicating proactively if issues arise?</li>
</ul>
<h2>6.2 When to Contact HR</h2>
<div class="warn-box"><strong>Contact HR Immediately If:</strong></div>
<ul>
<li>An employee reports harassment, discrimination, or hostile work environment</li>
<li>You need to issue a written warning or take disciplinary action</li>
<li>An employee discloses a medical condition, disability, or pregnancy</li>
<li>An employee requests FMLA or a leave of absence</li>
<li>You observe potential safety, confidentiality, or conduct violations</li>
<li>An attendance concern escalates beyond a supportive conversation</li>
</ul>
<div class="callout"><strong>When in Doubt</strong>Always ask your management team before acting. It is always better to ask than to proceed without guidance on sensitive situations.</div>`}
];

const HB_REF_SECTIONS=[
  {title:'Sec 1-2',content:`<h1>Sections 1â€“2: Welcome & Employment</h1><h2>1.1 Welcome Message</h2><p>RideSource Inc. is a Non-Emergency Medical Transportation (NEMT) company based in Norway, Maine, committed to providing reliable, safe, and compassionate transportation services to the communities we serve.</p><h2>1.2 Mission & Values</h2><ul><li><strong>Safety First</strong> â€” Every decision prioritizes safety</li><li><strong>Reliability</strong> â€” We show up on time, every time</li><li><strong>Dignity & Respect</strong> â€” Every passenger treated with compassion</li><li><strong>Accountability</strong> â€” We take responsibility for our service</li><li><strong>Community</strong> â€” Proud to serve the communities of Maine</li></ul><h2>2.3 At-Will Employment</h2><p>Employment at RideSource Inc. is at-will. Either party may end the relationship at any time without cause.</p><h2>2.6 Introductory Period</h2><p>All new employees serve a 90-day introductory period.</p>`},
  {title:'Sec 3: Conduct',content:`<h1>Section 3: Workplace Conduct & Professional Standards</h1><h2>3.2 Confidentiality</h2><p>All passenger information is strictly confidential. HIPAA violations may result in immediate termination.</p><h2>3.3 Appearance</h2><p>Professional, covered from shoulders to knees at all times. No offensive clothing or imagery.</p><h2>3.5 Social Media</h2><p>Do not post passenger information, vehicle photos, or anything that could harm RideSource or its clients.</p>`},
  {title:'Sec 4: Attendance',content:`<h1>Section 4: Attendance, Time & Scheduling</h1><h2>4.1 Attendance Policy</h2><p>Notify supervisor no later than 1 hour before scheduled start time. All planned time off submitted minimum 2 weeks in advance through the Staff Portal.</p><h3>Progressive Consequences</h3><ul><li>1st offense â€” Verbal warning</li><li>2nd offense â€” Written warning</li><li>3rd offense â€” Final warning; termination possible</li></ul><h2>4.3 Parascope</h2><p>Select "On the Way" when departing for pickup. Complete trip documentation promptly after drop-off. Obtain signature for every trip.</p>`},
  {title:'Sec 5-6',content:`<h1>Sections 5â€“6: Compensation & Benefits</h1><h2>5.1 Pay Periods</h2><p>Biweekly pay. Wages paid for period ending previous Friday; paydays generally fall on Wednesdays. Direct deposit required.</p><h2>5.2 Performance Reviews</h2><p>Annual reviews. Compensation adjustments reviewed after introductory period based on performance, attendance, reliability, and business needs. Not automatic.</p><h2>6.4 Workers' Compensation</h2><p>All employees covered by Maine workers' compensation. Report any injury to supervisor immediately.</p>`},
  {title:'Sec 7-8',content:`<h1>Sections 7â€“8: Safety & Operations</h1><h2>7.2 Drug-Free Workplace</h2><p>No alcohol or controlled substances on duty, on company property, or in company vehicles. Pre-employment, reasonable suspicion, and post-accident testing may be required.</p><h2>7.4 Incident Reporting</h2><p>All accidents, near-misses, and incidents must be reported immediately. Keep calm â†’ Contact dispatcher â†’ Protect passengers â†’ Complete all reports.</p><h2>8.1 Passenger Identity Verification</h2><p>Confirm name and destination before every trip. Do not transport anyone not on the manifest.</p><h2>8.6 Hands-Free Policy</h2><p>Maine law prohibits holding devices while driving. Company-issued Bluetooth device and mount must be used at all times.</p>`},
  {title:'Sec 9-10',content:`<h1>Sections 9â€“10: Development & Separation</h1><h2>10.2 Disciplinary Process</h2><ul><li>Verbal Warning â†’ Written Warning â†’ Final Warning/PIP â†’ Termination</li><li>Immediate termination for: HIPAA violations, falsification, impaired driving, harassment, safety violations, camera tampering</li></ul><h2>10.3 Separation</h2><p>Two weeks' written notice requested. Job abandonment = 3 consecutive missed days without contact â†’ ineligible for rehire.</p><h2>10.4 Non-Compete</h2><p>24-month non-compete within 50 miles of any RideSource office following separation.</p>`}
];

function buildMgrGuide(){
  const tabs=document.getElementById('mgr-tabs');
  tabs.innerHTML=MGR_SECTIONS.map((s,i)=>`<div class="doc-tab ${i===0?'active':''}" onclick="goMgrSection(${i})">${s.title}</div>`).join('');
  renderMgrSection(0);
}
function buildHbRef(){
  const tabs=document.getElementById('hb-ref-tabs');
  tabs.innerHTML=HB_REF_SECTIONS.map((s,i)=>`<div class="doc-tab ${i===0?'active':''}" onclick="goHbRefSection(${i})">${s.title}</div>`).join('');
  renderHbRefSection(0);
}
function renderMgrSection(i){
  mgrSection=i;
  document.getElementById('mgr-body').innerHTML=MGR_SECTIONS[i].content;
  document.querySelectorAll('#mgr-tabs .doc-tab').forEach((t,j)=>t.classList.toggle('active',i===j));
}
function renderHbRefSection(i){
  hbRefSection=i;
  document.getElementById('hb-ref-body').innerHTML=HB_REF_SECTIONS[i].content;
  document.querySelectorAll('#hb-ref-tabs .doc-tab').forEach((t,j)=>t.classList.toggle('active',i===j));
}
function goMgrSection(i){renderMgrSection(i);}
function goHbRefSection(i){renderHbRefSection(i);}
function changeMgrSection(dir){const n=mgrSection+dir;if(n>=0&&n<MGR_SECTIONS.length)renderMgrSection(n);}
function changeHbRefSection(dir){const n=hbRefSection+dir;if(n>=0&&n<HB_REF_SECTIONS.length)renderHbRefSection(n);}

// â”€â”€ DASHBOARD â”€â”€
async function loadDashboard(){
  const {data:reqs}=await db.from('time_off_requests').select('*').eq('status','PENDING').order('submitted_at',{ascending:false});
  const {data:callouts}=await db.from('call_out_log').select('*').order('callout_date',{ascending:false}).limit(100);
  const {data:sigs}=await db.from('policy_signatures').select('employee_email').order('signed_at',{ascending:false});
  const unique=sigs?[...new Set(sigs.map(s=>s.employee_email))].length:0;
  document.getElementById('dash-stats').innerHTML=`
    <div class="stat-card"><div class="stat-icon" style="background:#fff3cd;">â³</div><div><div class="stat-val">${reqs?reqs.length:0}</div><div class="stat-label">Pending Requests</div></div></div>
    <div class="stat-card"><div class="stat-icon" style="background:#fdecea;">ğŸ“</div><div><div class="stat-val">${callouts?callouts.length:0}</div><div class="stat-label">Total Call-Outs (All Time)</div></div></div>
    <div class="stat-card"><div class="stat-icon" style="background:#d4edda;">âœ…</div><div><div class="stat-val">${unique}</div><div class="stat-label">Employees w/ Signed Policies</div></div></div>`;
  const pendList=document.getElementById('dash-pending-list');
  if(!reqs||reqs.length===0){pendList.textContent='No pending requests. âœ“';}
  else{pendList.innerHTML=reqs.slice(0,5).map(r=>`<div style="padding:6px 0;border-bottom:1px solid #f0f0f0;font-size:12px;"><strong>${r.employee_name}</strong> â€” ${r.request_type} â€” ${r.start_date} <span style="color:#888;">(${r.county})</span></div>`).join('');}
  loadFlagsInto('dash-flags-list', callouts||[]);
}

function loadFlagsInto(elId, callouts){
  const el=document.getElementById(elId);
  const flagged=detectFlags(callouts);
  if(flagged.length===0){el.textContent='No attendance flags. âœ“';}
  else{el.innerHTML=flagged.slice(0,5).map(f=>`<div style="padding:6px 0;border-bottom:1px solid #f0f0f0;font-size:12px;"><strong>${f.name}</strong> â€” <span style="color:var(--red);">${f.count} call-outs in 30 days</span> <span style="color:#888;">(${f.county})</span></div>`).join('');}
  document.getElementById('badge-flags').textContent=flagged.length||'0';
}

function detectFlags(callouts){
  const groups={};
  callouts.forEach(c=>{
    const k=c.employee_name+'|'+c.county;
    if(!groups[k])groups[k]={name:c.employee_name,county:c.county,dates:[]};
    groups[k].dates.push(new Date(c.callout_date));
  });
  const flagged=[];
  Object.values(groups).forEach(g=>{
    const now=new Date();
    const thirtyDaysAgo=new Date(now-30*24*60*60*1000);
    const recent=g.dates.filter(d=>d>=thirtyDaysAgo).sort((a,b)=>a-b);
    if(recent.length>=3){flagged.push({name:g.name,county:g.county,count:recent.length,dates:recent,allDates:g.dates.sort((a,b)=>a-b)});}
  });
  return flagged;
}

// â”€â”€ ATTENDANCE FLAGS â”€â”€
async function loadFlags(){
  const {data:callouts}=await db.from('call_out_log').select('*').order('callout_date',{ascending:false});
  const flagged=detectFlags(callouts||[]);
  document.getElementById('badge-flags').textContent=flagged.length||'0';
  const el=document.getElementById('flagged-employees');
  if(flagged.length===0){el.innerHTML=`<div class="card" style="text-align:center;padding:32px;color:var(--success);"><div style="font-size:32px;margin-bottom:8px;">âœ…</div><div style="font-weight:700;">No attendance flags at this time.</div><div style="font-size:13px;color:#888;margin-top:4px;">The system will automatically detect employees with 3+ call-outs in 30 days.</div></div>`;return;}
  el.innerHTML=flagged.map(f=>{
    const dates=f.dates.map(d=>d.toLocaleDateString('en-US',{month:'short',day:'numeric'})).join(', ');
    const allCount=f.allDates.length;
    const level=allCount>=9?'Final Written Warning':allCount>=6?'Standard Warning':allCount>=3?'Standard Warning':'Informational';
    return `<div class="warning-employee">
      <div class="warning-flag">
        <div style="font-size:24px;">âš ï¸</div>
        <div>
          <div class="warning-info">${f.name} <span style="font-weight:400;color:#888;">Â· ${f.county}</span></div>
          <div class="warning-detail">${f.count} call-outs in last 30 days Â· Dates: ${dates}</div>
          <div class="warning-detail" style="margin-top:2px;">Total call-outs on record: ${allCount}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span class="badge badge-flag">${level}</span>
        <button class="btn btn-red btn-sm" onclick='openWarningModal(${JSON.stringify(f).replace(/'/g,"&#39;")})'>Generate Warning</button>
      </div>
    </div>`;
  }).join('');
}

function openWarningModal(f){
  warningData=f;
  const allCount=f.allDates?f.allDates.length:f.count;
  const level=allCount>=6?'final':'standard';
  const dates=f.dates.map(d=>new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})).join(', ');
  document.getElementById('warn-modal-title').textContent=`Attendance Warning â€” ${f.name}`;
  document.getElementById('warn-modal-desc').textContent='Review and edit the details below. The call-out dates are pulled automatically from Supabase.';
  document.getElementById('warn-preview').style.display='none';
  document.getElementById('warn-form').innerHTML=`
    <div class="form-row">
      <div class="form-field"><label>Employee Name</label><input type="text" id="wf-name" value="${f.name}"></div>
      <div class="form-field"><label>County</label><input type="text" id="wf-county" value="${f.county}"></div>
    </div>
    <div class="form-row">
      <div class="form-field"><label>Number of Call-Outs</label><input type="number" id="wf-count" value="${f.count}"></div>
      <div class="form-field"><label>Warning Level</label>
        <select id="wf-level">
          <option value="standard" ${level==='standard'?'selected':''}>Standard Warning</option>
          <option value="final" ${level==='final'?'selected':''}>Final Written Warning</option>
          <option value="manifest">Call-Out After Manifest Received</option>
        </select>
      </div>
    </div>
    <div class="form-field"><label>Timeframe</label><input type="text" id="wf-timeframe" value="the past 30 days"></div>
    <div class="form-field"><label>Call-Out Dates (auto-filled from Supabase)</label><input type="text" id="wf-dates" value="${dates}"></div>
    <div class="form-field"><label>Additional Notes (optional)</label><textarea id="wf-notes" placeholder="Any additional context for this warning..."></textarea></div>`;
  document.getElementById('warning-modal').classList.add('open');
}

function generateWarning(){
  const name=document.getElementById('wf-name').value;
  const count=document.getElementById('wf-count').value;
  const timeframe=document.getElementById('wf-timeframe').value;
  const level=document.getElementById('wf-level').value;
  const dates=document.getElementById('wf-dates').value;
  const notes=document.getElementById('wf-notes').value;
  const today=new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  let body='';
  if(level==='final'){
    body=`SUBJECT: Attendance Warning â€” Final Written Warning\n\nDear ${name},\n\nThis correspondence serves as a Final Written Warning regarding your continued attendance violations.\n\nDespite previous discussions and/or written warnings concerning your attendance, you have continued to accumulate call-outs. To date, you have recorded ${count} call-out(s) within ${timeframe} (${dates}), which does not meet the attendance standards required for your position.\n\nAs previously communicated, reliable attendance is an essential job function. Repeated call-outs disrupt operations, impact service commitments, place strain on team members, and affect the company's ability to meet organizational goals.\n\nThis Final Written Warning places you on notice that any further attendance violations may result in additional disciplinary action, up to and including termination of employment.\n\nImmediate and sustained improvement is required. We expect full compliance with company attendance policies moving forward.\n\nIf there are circumstances you believe should be considered, you must notify your supervisor immediately.\n${notes?'\nAdditional Notes: '+notes+'\n':''}\nSincerely,\nManagement Team\nRideSource\n\nDate: ${today}`;
  }else if(level==='manifest'){
    body=`SUBJECT: Attendance Warning â€” Call-Out After Receiving Trip Assignment\n\nDear ${name},\n\nThis notice serves as formal documentation of your call-out after receiving an assigned manifest.\n\nAs discussed during your interview and throughout training, RideSource maintains strict attendance and punctuality standards due to the nature of our operations. Once a manifest has been issued, we are contractually committed to providing the scheduled services assigned.\n\nYour call-out(s) occurred on: ${dates}\n\nCall-outs after manifest assignment create significant operational challenges, including financial liability due to missed services, disruption to clients, additional strain on team members, and underutilization of scheduled company resources.\n\nPlease be reminded that absences during the introductory training period may result in corrective action, up to and including termination of employment.\n${notes?'\nAdditional Notes: '+notes+'\n':''}\nSincerely,\nManagement Team\nRideSource\n\nDate: ${today}`;
  }else{
    body=`SUBJECT: Attendance Warning â€” Standard\n\nDear ${name},\n\nThis notice serves as formal documentation of your recent call-outs and attendance concerns.\n\nAs discussed during your interview and throughout your employment, RideSource maintains strict attendance and punctuality standards due to the operational nature of our services. Reliable attendance is an essential function of your position and is critical to maintaining service commitments, supporting team operations, and meeting client expectations.\n\nAt this time, you have accumulated ${count} call-out(s) within ${timeframe}. Your call-out dates are: ${dates}.\n\nContinued attendance issues may result in further corrective action. We expect immediate and sustained improvement moving forward.\n\nIf there are circumstances that you believe should be considered, please notify your supervisor promptly.\n${notes?'\nAdditional Notes: '+notes+'\n':''}\nSincerely,\nManagement Team\nRideSource\n\nDate: ${today}`;
  }
  document.getElementById('warn-form').style.display='none';
  document.querySelector('#warning-modal .btn-red').style.display='none';
  const preview=document.getElementById('warn-preview');
  preview.style.display='block';
  preview.textContent=body;
  document.querySelector('#warning-modal .btn-red').insertAdjacentHTML('afterend',`<button class="btn btn-primary" onclick="printWarning()" style="margin-left:8px;">ğŸ–¨ï¸ Print / Save as PDF</button>`);
  document.querySelector('#warning-modal .btn-red').style.display='none';
}

function printWarning(){
  const content=document.getElementById('warn-preview').textContent;
  const win=window.open('','_blank');
  win.document.write(`<html><head><title>Attendance Warning</title><style>body{font-family:Arial,sans-serif;max-width:700px;margin:60px auto;font-size:14px;line-height:1.8;white-space:pre-wrap;}</style></head><body>${content.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</body></html>`);
  win.document.close();win.print();
}

// â”€â”€ TIME OFF REQUESTS â”€â”€
async function loadRequests(){
  const {data}=await db.from('time_off_requests').select('*').order('submitted_at',{ascending:false});
  document.getElementById('badge-requests').textContent=(data||[]).filter(r=>r.status==='PENDING').length||'0';
  const el=document.getElementById('requests-table');
  if(!data||data.length===0){el.innerHTML='<p style="color:#888;font-size:13px;">No requests found.</p>';return;}
  el.innerHTML=`<table class="data-table"><thead><tr><th>Employee</th><th>County</th><th>Type</th><th>Date(s)</th><th>Time Detail</th><th>Reason</th><th>Status</th><th>Actions</th></tr></thead><tbody>`+
    data.map(r=>`<tr><td><strong>${r.employee_name}</strong><br><span style="font-size:11px;color:#888;">${r.employee_email}</span></td><td>${r.county}</td><td>${r.request_type}</td><td>${r.start_date}${r.end_date&&r.end_date!==r.start_date?' â†’ '+r.end_date:''}</td><td>${r.time_detail||'â€”'}</td><td>${r.reason||'â€”'}</td><td><span class="badge badge-${r.status.toLowerCase()}">${r.status}</span></td><td style="white-space:nowrap;">${r.status==='PENDING'?`<button class="btn btn-green btn-sm" onclick="decideRequest(${r.id},'APPROVED')">âœ“ Approve</button> <button class="btn btn-sm" style="background:#f8d7da;color:#721c24;margin-left:4px;" onclick="decideRequest(${r.id},'DENIED')">âœ— Deny</button>`:'â€”'}</td></tr>`).join('')+
    '</tbody></table>';
}

async function decideRequest(id,status){
  await db.from('time_off_requests').update({status,decided_at:new Date().toISOString(),decided_by:adminName}).eq('id',id);
  loadRequests();loadDashboard();
}

// â”€â”€ CALL-OUT LOG â”€â”€
async function loadCallOuts(){
  const {data}=await db.from('call_out_log').select('*').order('callout_date',{ascending:false}).limit(50);
  const el=document.getElementById('callout-table');
  if(!data||data.length===0){el.innerHTML='<p style="color:#888;font-size:13px;">No call-outs logged yet.</p>';return;}
  el.innerHTML=`<table class="data-table"><thead><tr><th>Employee</th><th>County</th><th>Date</th><th>Reason</th><th>Notes</th><th>Logged By</th></tr></thead><tbody>`+
    data.map(c=>`<tr><td><strong>${c.employee_name}</strong></td><td>${c.county}</td><td>${c.callout_date}</td><td>${c.reason}</td><td>${c.notes||'â€”'}</td><td>${c.logged_by}</td></tr>`).join('')+
    '</tbody></table>';
}

async function logCallOut(){
  const name=document.getElementById('co-name').value.trim();
  const county=document.getElementById('co-county').value;
  const date=document.getElementById('co-date').value;
  const reason=document.getElementById('co-reason').value;
  const notes=document.getElementById('co-notes').value;
  if(!name||!county||!date){alert('Please fill in employee name, county, and date.');return;}
  await db.from('call_out_log').insert([{employee_name:name,county,callout_date:date,reason,notes,logged_by:adminName,logged_at:new Date().toISOString()}]);
  document.getElementById('co-name').value='';document.getElementById('co-date').value='';document.getElementById('co-notes').value='';
  const msg=document.getElementById('co-msg');msg.style.display='inline';setTimeout(()=>msg.style.display='none',3000);
  loadCallOuts();loadFlags();loadDashboard();
}

// â”€â”€ MANUAL LOOKUP â”€â”€
async function manualLookup(){
  const name=document.getElementById('manual-name').value.trim();
  const county=document.getElementById('manual-county').value;
  if(!name){alert('Please enter an employee name.');return;}
  let query=db.from('call_out_log').select('*').ilike('employee_name','%'+name+'%').order('callout_date',{ascending:true});
  if(county)query=query.eq('county',county);
  const {data}=await query;
  const el=document.getElementById('manual-results');
  if(!data||data.length===0){el.innerHTML=`<p style="color:#888;font-size:13px;">No call-outs found for "${name}".</p>`;return;}
  const dates=data.map(c=>new Date(c.callout_date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}));
  const datesStr=dates.join(', ');
  el.innerHTML=`<div class="warning-employee"><div><div class="warning-info">${data[0].employee_name} â€” ${data[0].county}</div><div class="warning-detail">${data.length} total call-out(s) Â· Dates: ${datesStr}</div></div><button class="btn btn-red btn-sm" onclick='openWarningModal(${JSON.stringify({name:data[0].employee_name,county:data[0].county,count:data.length,dates:data.map(c=>new Date(c.callout_date)),allDates:data.map(c=>new Date(c.callout_date))})})'>Generate Warning</button></div>`;
}

// â”€â”€ ONBOARDING TRACKER â”€â”€
async function loadOnboarding(){
  const {data:sigs}=await db.from('policy_signatures').select('*').order('signed_at',{ascending:false});
  const {data:hbSigs}=await db.from('handbook_signatures').select('*').order('signed_at',{ascending:false}).catch(()=>({data:[]}));
  const el=document.getElementById('onboarding-data');
  if(!sigs||sigs.length===0){el.innerHTML='<p style="color:#888;font-size:13px;">No onboarding signatures recorded yet.</p>';return;}
  const byEmployee={};
  sigs.forEach(s=>{if(!byEmployee[s.employee_email])byEmployee[s.employee_email]={name:s.employee_name,email:s.employee_email,county:s.county,policies:[],handbookSigned:false,printRequested:false};byEmployee[s.employee_email].policies.push(s.policy_name);});
  if(hbSigs){hbSigs.forEach(h=>{if(byEmployee[h.employee_email]){byEmployee[h.employee_email].handbookSigned=true;byEmployee[h.employee_email].printRequested=h.print_requested;}});}
  el.innerHTML=`<table class="data-table"><thead><tr><th>Employee</th><th>County</th><th>Policies Signed</th><th>Handbook</th><th>Print Requested</th></tr></thead><tbody>`+
    Object.values(byEmployee).map(e=>`<tr><td><strong>${e.name}</strong><br><span style="font-size:11px;color:#888;">${e.email}</span></td><td>${e.county}</td><td><span class="badge ${e.policies.length>=7?'badge-approved':'badge-warning'}">${e.policies.length}/7</span></td><td>${e.handbookSigned?'<span class="badge badge-approved">âœ“ Signed</span>':'<span class="badge badge-warning">Pending</span>'}</td><td>${e.printRequested?'<span class="badge badge-flag">ğŸ“¦ Yes â€” arrange delivery</span>':'No'}</td></tr>`).join('')+
    '</tbody></table>';
  // Also populate print requests in handbook reference section
  const printList=document.getElementById('print-requests-list');
  const printReqs=Object.values(byEmployee).filter(e=>e.printRequested);
  if(printReqs.length===0){printList.textContent='No printed copy requests at this time.';}
  else{printList.innerHTML=printReqs.map(e=>`<div style="padding:6px 0;border-bottom:1px solid #e0e0e0;font-size:12px;"><strong>${e.name}</strong> (${e.email}) â€” ${e.county}</div>`).join('');}
}

// â”€â”€ MANAGERS ROSTER â”€â”€
const MANAGERS = {
  tiffany: { name:'Tiffany Gallagher', title:'Regional Operations Manager', office:'207-743-7433', direct:'207-812-5357', mobile:'207-515-3808', email:'tiffanyb@ridesourcemaine.com' },
  // Add managers here as RideSource grows:
  // jane: { name:'Jane Smith', title:'HR Manager', office:'207-000-0000', direct:'207-000-0001', mobile:'207-000-0002', email:'jane@ridesourcemaine.com' },
};

// â”€â”€ HR TEMPLATE DEFINITIONS â”€â”€
const TEMPLATES = {
  welcome: {
    title: 'Welcome Aboard Letter',
    filename: 'Welcome_Aboard_Letter',
    hasManager: true,
    fields: [
      {id:'date',      label:'Date',              type:'date',   required:true},
      {id:'firstName', label:'Employee First Name',type:'text',   required:true},
      {id:'jobTitle',  label:'Job Title',          type:'text',   required:true},
      {id:'startDate', label:'Start Date',         type:'date',   required:true},
      {id:'reportTime',label:'Report Time',        type:'time',   required:true},
    ]
  },
  rejection: {
    title: 'Letter of Rejection',
    filename: 'Letter_of_Rejection',
    hasManager: true,
    fields: [
      {id:'date',      label:'Date',               type:'date',   required:true},
      {id:'appName',   label:'Applicant Full Name', type:'text',   required:true},
      {id:'address',   label:'Address',             type:'text',   required:false},
      {id:'cityState', label:'City, State, ZIP',    type:'text',   required:false},
    ]
  },
  interview: {
    title: 'Interview Questions Form',
    filename: 'Interview_Questions',
    hasManager: false,
    fields: [
      {id:'date',      label:'Interview Date',     type:'date',   required:true},
      {id:'applicant', label:'Applicant Name',     type:'text',   required:true},
      {id:'location',  label:'Interview Location', type:'text',   required:false, placeholder:'Ellsworth Office'},
      {id:'posType',   label:'Position Type',      type:'select', required:true, options:['Full-Time Agency Driver','Part-Time Agency Driver','Volunteer']},
      {id:'pay',       label:'Rate of Pay Discussed',type:'text', required:false},
    ]
  },
  driverinfo: {
    title: 'Driver Info Form',
    filename: 'Driver_Info_Form',
    hasManager: false,
    fields: [
      {id:'firstName', label:'First Name',                   type:'text', required:false},
      {id:'mi',        label:'Middle Initial',               type:'text', required:false},
      {id:'lastName',  label:'Last Name',                    type:'text', required:false},
      {id:'maiden',    label:'Maiden Name (if applicable)',  type:'text', required:false},
      {id:'homePhone', label:'Home Phone',                   type:'text', required:false},
      {id:'cellPhone', label:'Cell Phone',                   type:'text', required:false},
      {id:'ecName',    label:'Emergency Contact Name',       type:'text', required:false},
      {id:'ecNumber',  label:'Emergency Contact Number',     type:'text', required:false},
      {id:'email',     label:'Active Email Address',         type:'text', required:false},
      {id:'cityBirth', label:'City and State of Birth',      type:'text', required:false},
      {id:'dlState',   label:'License State of Issue',       type:'text', required:false},
      {id:'dlIssued',  label:'Date Issued',                  type:'date', required:false},
      {id:'dlExpiry',  label:'Expiration Date',              type:'date', required:false},
      {id:'dlClass',   label:'Class / Endorsement(s)',       type:'text', required:false},
    ]
  },
  emergency: {
    title: 'Emergency Contact Form',
    filename: 'Emergency_Contact_Form',
    hasManager: false,
    fields: [
      {id:'empName',   label:'Employee Name',             type:'text', required:false},
      {id:'division',  label:'Division / County',         type:'text', required:false},
      {id:'ec1Name',   label:'Emergency Contact #1 â€” Name',           type:'text', required:false},
      {id:'ec1Rel',    label:'Relationship',              type:'text', required:false},
      {id:'ec1Address',label:'Address',                   type:'text', required:false},
      {id:'ec1Cell',   label:'Cell Phone',                type:'text', required:false},
      {id:'ec1Biz',    label:'Business Phone',            type:'text', required:false},
      {id:'ec1Home',   label:'Home Phone',                type:'text', required:false},
      {id:'ec1Email',  label:'Email',                     type:'text', required:false},
      {id:'ec2Name',   label:'Emergency Contact #2 â€” Name',           type:'text', required:false},
      {id:'ec2Rel',    label:'Relationship',              type:'text', required:false},
      {id:'ec2Address',label:'Address',                   type:'text', required:false},
      {id:'ec2Cell',   label:'Cell Phone',                type:'text', required:false},
      {id:'ec2Biz',    label:'Business Phone',            type:'text', required:false},
      {id:'ec2Home',   label:'Home Phone',                type:'text', required:false},
      {id:'ec2Email',  label:'Email',                     type:'text', required:false},
    ]
  },
  consent: {
    title: 'Consent for Certification Release',
    filename: 'Consent_Certification_Release',
    hasManager: false,
    fields: [
      {id:'employee',  label:'Employee Full Name', type:'text', required:true},
      {id:'date',      label:'Date',               type:'date', required:true},
    ]
  },
  resignation: {
    title: 'Voluntary Resignation Acknowledgment',
    filename: 'Resignation_Acknowledgment',
    hasManager: false,
    fields: [
      {id:'date',          label:'Date',                        type:'date', required:true},
      {id:'employee',      label:'Employee Full Name',          type:'text', required:true},
      {id:'position',      label:'Position / Title',            type:'text', required:false},
      {id:'county',        label:'Location / County',           type:'text', required:false},
      {id:'supervisor',    label:'Supervisor',                  type:'text', required:false},
      {id:'receivedDate',  label:'Date Resignation Received',   type:'date', required:false},
      {id:'lastDay',       label:'Employee\'s Last Day of Work',type:'date', required:false},
      {id:'method',        label:'Method of Resignation',       type:'select', required:false, options:['Verbal','Written â€” Email','Written â€” Letter','Text Message']},
      {id:'reason',        label:'Reason for Leaving (if provided)', type:'textarea', required:false},
    ]
  },
  'warn-standard': {
    title: 'Attendance Warning â€” Standard',
    filename: 'Attendance_Warning_Standard',
    hasManager: false,
    warnLevel: 'standard',
    fields: [
      {id:'empName',   label:'Employee Name',              type:'text', required:true},
      {id:'warnDate',  label:'Date of Warning',            type:'date', required:true},
      {id:'position',  label:'Position / Title',           type:'text', required:false},
      {id:'county',    label:'Department / County',        type:'text', required:false},
      {id:'supervisor',label:'Supervisor',                 type:'text', required:false},
      {id:'incDate',   label:'Date of Incident',           type:'date', required:false},
      {id:'callCount', label:'Total Call-Outs (Last 90 Days)', type:'number', required:false},
      {id:'prevWarn',  label:'Previous Warnings on File',  type:'text', required:false},
      {id:'description', label:'Description of Attendance Issue', type:'textarea', required:false},
      {id:'actionPlan',  label:'Additional Comments / Action Plan', type:'textarea', required:false},
    ]
  },
  'warn-callout': {
    title: 'Attendance Warning â€” Call-Out After Trip',
    filename: 'Attendance_Warning_CallOut',
    hasManager: false,
    warnLevel: 'callout',
    fields: [
      {id:'empName',   label:'Employee Name',              type:'text', required:true},
      {id:'warnDate',  label:'Date of Warning',            type:'date', required:true},
      {id:'position',  label:'Position / Title',           type:'text', required:false},
      {id:'county',    label:'Department / County',        type:'text', required:false},
      {id:'supervisor',label:'Supervisor',                 type:'text', required:false},
      {id:'incDate',   label:'Date of Incident',           type:'date', required:false},
      {id:'callCount', label:'Total Call-Outs (Last 90 Days)', type:'number', required:false},
      {id:'prevWarn',  label:'Previous Warnings on File',  type:'text', required:false},
      {id:'description', label:'Description of Attendance Issue', type:'textarea', required:false},
      {id:'actionPlan',  label:'Additional Comments / Action Plan', type:'textarea', required:false},
    ]
  },
  'warn-final': {
    title: 'Final Written Warning',
    filename: 'Attendance_Warning_Final',
    hasManager: false,
    warnLevel: 'final',
    fields: [
      {id:'empName',   label:'Employee Name',              type:'text', required:true},
      {id:'warnDate',  label:'Date of Warning',            type:'date', required:true},
      {id:'position',  label:'Position / Title',           type:'text', required:false},
      {id:'county',    label:'Department / County',        type:'text', required:false},
      {id:'supervisor',label:'Supervisor',                 type:'text', required:false},
      {id:'incDate',   label:'Date of Incident',           type:'date', required:false},
      {id:'callCount', label:'Total Call-Outs (Last 90 Days)', type:'number', required:false},
      {id:'prevWarn',  label:'Previous Warnings on File',  type:'text', required:false},
      {id:'description', label:'Description of Attendance Issue', type:'textarea', required:false},
      {id:'actionPlan',  label:'Additional Comments / Action Plan', type:'textarea', required:false},
    ]
  },
};

let currentTemplate = null;

function openTemplate(id) {
  currentTemplate = id;
  const t = TEMPLATES[id];
  document.getElementById('tmpl-title').textContent = t.title;
  document.getElementById('tmpl-desc').textContent = 'Fill in the fields below, then click Download to get your Word document.';

  let formHtml = '';

  // Manager selector â€” only for templates that need it
  if (t.hasManager) {
    formHtml += `<div class="form-field">
      <label>Hiring Manager *</label>
      <select id="tmpl-manager">
        ${Object.entries(MANAGERS).map(([key,m]) =>
          `<option value="${key}">${m.name} â€” ${m.title}</option>`
        ).join('')}
      </select>
    </div>`;
  }

  // Field rows â€” group pairs side by side
  const fields = t.fields;
  let i = 0;
  while (i < fields.length) {
    const f = fields[i];
    const next = fields[i+1];
    // Pair short fields in two columns, keep textareas full width
    const canPair = next && f.type !== 'textarea' && next.type !== 'textarea' && f.type !== 'select' && next.type !== 'select';
    if (canPair) {
      formHtml += `<div class="form-row">
        ${fieldHtml(f)}
        ${fieldHtml(next)}
      </div>`;
      i += 2;
    } else {
      formHtml += `<div class="form-field">${fieldInner(f)}</div>`;
      i++;
    }
  }

  document.getElementById('tmpl-form').innerHTML = formHtml;
  document.getElementById('template-modal').classList.add('open');
}

function fieldHtml(f) {
  return `<div class="form-field">${fieldInner(f)}</div>`;
}
function fieldInner(f) {
  const label = `<label>${f.label}${f.required ? ' *' : ''}</label>`;
  if (f.type === 'textarea') return label + `<textarea id="tmpl-${f.id}" placeholder="${f.placeholder||f.label}..."></textarea>`;
  if (f.type === 'select')   return label + `<select id="tmpl-${f.id}">${f.options.map(o=>`<option>${o}</option>`).join('')}</select>`;
  return label + `<input type="${f.type}" id="tmpl-${f.id}" placeholder="${f.placeholder||''}">`;
}

function getVal(id) {
  const el = document.getElementById('tmpl-' + id);
  return el ? el.value.trim() : '';
}
function fmtDate(d) {
  if (!d) return '';
  const dt = new Date(d + 'T00:00:00');
  return dt.toLocaleDateString('en-US', {month:'long', day:'numeric', year:'numeric'});
}
function fmtTime(t) {
  if (!t) return '';
  return new Date('2000-01-01T' + t).toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit'});
}

async function downloadTemplate() {
  const t = TEMPLATES[currentTemplate];
  const btn = document.getElementById('tmpl-download-btn');

  // Validate required fields
  let valid = true;
  t.fields.forEach(f => {
    if (f.required) {
      const el = document.getElementById('tmpl-' + f.id);
      if (!el || !el.value.trim()) { el && (el.style.borderColor = 'var(--red)'); valid = false; }
      else el.style.borderColor = '';
    }
  });
  if (!valid) { alert('Please fill in all required fields (marked with *).'); return; }

  btn.textContent = 'â³ Generating...';
  btn.disabled = true;

  try {
    const mgr = t.hasManager ? MANAGERS[document.getElementById('tmpl-manager').value] || MANAGERS.tiffany : null;
    const blob = await buildDocx(currentTemplate, mgr);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = t.filename + '.docx';
    a.click();
    URL.revokeObjectURL(url);
    closeModal('template-modal');
  } catch(e) {
    console.error(e);
    alert('Error generating document. Please try again.');
  }

  btn.textContent = 'â¬‡ï¸ Download Word Doc';
  btn.disabled = false;
}

// â”€â”€ DOCX BUILDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function buildDocx(templateId, mgr) {
  const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell,
          AlignmentType, BorderStyle, WidthType, ShadingType, VerticalAlign, LevelFormat } = docx;

  const NAVY='1B2A4A', RED='C0392B', LIGHT='EAF0FB', WHITE='FFFFFF', GRAY='F7F9FC', BORDER_C='D0D9EC';
  const CW=9360, LETTER_W=12240, LETTER_H=15840, MARGIN=1440;

  const nb = s => ({style:s||BorderStyle.NONE,size:0,color:'FFFFFF'});
  const noborders = {top:nb(),bottom:nb(),left:nb(),right:nb()};
  const solidBorder = (c=BORDER_C) => {const b={style:BorderStyle.SINGLE,size:4,color:c}; return{top:b,bottom:b,left:b,right:b};};
  const underline = (c=NAVY) => ({top:nb(),left:nb(),right:nb(),bottom:{style:BorderStyle.SINGLE,size:4,color:c}});

  const pageProps = () => ({page:{size:{width:LETTER_W,height:LETTER_H},margin:{top:MARGIN,right:MARGIN,bottom:MARGIN,left:MARGIN}}});
  const sp = (pts=120) => new Paragraph({spacing:{before:pts},children:[]});
  const txt = (text, opts={}) => new TextRun({text,font:'Arial',...opts});
  const body = (text, opts={}) => new Paragraph({spacing:{after:100},children:[txt(text,{size:20,...opts})]});
  const divider = (c=NAVY) => new Paragraph({border:{bottom:{style:BorderStyle.SINGLE,size:8,color:c}},children:[],spacing:{after:100}});

  const companyLogo = () => new Table({
    width:{size:CW,type:WidthType.DXA},columnWidths:[CW],
    rows:[new TableRow({children:[new TableCell({borders:noborders,margins:{top:0,bottom:100,left:0,right:0},width:{size:CW,type:WidthType.DXA},children:[
      new Paragraph({alignment:AlignmentType.CENTER,children:[
        txt('Ride',{bold:true,size:48,color:NAVY}),txt('Source',{bold:true,size:48,color:RED}),txt(' Inc.',{bold:true,size:48,color:NAVY})
      ]}),
      new Paragraph({alignment:AlignmentType.CENTER,children:[txt('Reliable Safe Transportation',{size:20,color:'666666',italics:true})]})
    ]})]})],
  });

  const headerBar = (title, sub='') => new Table({
    width:{size:CW,type:WidthType.DXA},columnWidths:[CW],
    rows:[new TableRow({children:[new TableCell({borders:solidBorder(NAVY),shading:{fill:NAVY,type:ShadingType.CLEAR},margins:{top:160,bottom:160,left:200,right:200},width:{size:CW,type:WidthType.DXA},children:[
      new Paragraph({alignment:AlignmentType.CENTER,children:[txt(title,{bold:true,size:30,color:WHITE})]}),
      ...(sub?[new Paragraph({alignment:AlignmentType.CENTER,children:[txt(sub,{size:18,color:'AABBDD'})]})]:[])
    ]})]})],
  });

  const sectionLabel = text => new Paragraph({spacing:{before:220,after:60},children:[txt(text,{bold:true,size:21,color:NAVY,allCaps:true})]});

  const fieldRow = (label, value='', w=CW) => {
    const lw=Math.round(w*0.38), vw=w-lw;
    return new Table({width:{size:w,type:WidthType.DXA},columnWidths:[lw,vw],rows:[new TableRow({children:[
      new TableCell({borders:underline(BORDER_C),margins:{top:60,bottom:40,left:0,right:80},width:{size:lw,type:WidthType.DXA},children:[new Paragraph({children:[txt(label,{bold:true,size:19,color:'333333'})]})]  }),
      new TableCell({borders:underline(NAVY),margins:{top:60,bottom:40,left:60,right:0},width:{size:vw,type:WidthType.DXA},children:[new Paragraph({children:[txt(value,{size:19,color:value?'111111':'999999',italics:!value})]})]}),
    ]})]}); };

  const fieldPair = (l1,v1,l2,v2) => {
    const half=Math.round(CW/2)-40, gutter=80;
    return new Table({width:{size:CW,type:WidthType.DXA},columnWidths:[half,gutter,half],rows:[new TableRow({children:[
      new TableCell({borders:noborders,width:{size:half,type:WidthType.DXA},children:[fieldRow(l1,v1,half)]}),
      new TableCell({borders:noborders,width:{size:gutter,type:WidthType.DXA},children:[new Paragraph({children:[]})]}),
      new TableCell({borders:noborders,width:{size:half,type:WidthType.DXA},children:[fieldRow(l2,v2,half)]}),
    ]})]});};

  const emptyLines = (n=3, indent=0) => Array(n).fill(null).map(()=>new Table({
    width:{size:CW-indent,type:WidthType.DXA},columnWidths:[CW-indent],
    rows:[new TableRow({children:[new TableCell({borders:{...noborders,bottom:{style:BorderStyle.SINGLE,size:4,color:BORDER_C}},margins:{top:100,bottom:0,left:indent,right:0},width:{size:CW-indent,type:WidthType.DXA},children:[new Paragraph({children:[]})]})]})]
  }));

  const sigBlock = (l1,l2) => {
    const c1=Math.round(CW*.6),c2=CW-c1;
    return new Table({width:{size:CW,type:WidthType.DXA},columnWidths:[c1,c2],rows:[new TableRow({children:[
      new TableCell({borders:underline(NAVY),margins:{top:200,bottom:60,left:0,right:80},width:{size:c1,type:WidthType.DXA},children:[new Paragraph({children:[txt(l1,{size:18,color:'555555'})]})]  }),
      new TableCell({borders:underline(NAVY),margins:{top:200,bottom:60,left:80,right:0},width:{size:c2,type:WidthType.DXA},children:[new Paragraph({children:[txt(l2,{size:18,color:'555555'})]})]  }),
    ]})]});};

  const noticeBox = (label, text, fill=LIGHT, lc=NAVY) => new Table({
    width:{size:CW,type:WidthType.DXA},columnWidths:[1100,CW-1100],
    rows:[new TableRow({children:[
      new TableCell({borders:solidBorder(lc),shading:{fill:lc,type:ShadingType.CLEAR},margins:{top:80,bottom:80,left:100,right:100},width:{size:1100,type:WidthType.DXA},verticalAlign:VerticalAlign.CENTER,children:[new Paragraph({alignment:AlignmentType.CENTER,children:[txt(label,{bold:true,size:18,color:WHITE})]})]}),
      new TableCell({borders:solidBorder(lc),shading:{fill,type:ShadingType.CLEAR},margins:{top:80,bottom:80,left:120,right:120},width:{size:CW-1100,type:WidthType.DXA},children:[new Paragraph({children:[txt(text,{size:18,color:'333333'})]})]  }),
    ]})]});

  const checkboxRow = items => {
    const colW = Math.floor(CW/items.length);
    return new Table({width:{size:CW,type:WidthType.DXA},columnWidths:items.map(()=>colW),rows:[new TableRow({children:items.map(item=>new TableCell({borders:noborders,margins:{top:60,bottom:60,left:0,right:40},width:{size:colW,type:WidthType.DXA},children:[new Paragraph({children:[txt(`â˜  ${item}`,{size:20})]})]}))})]}); };

  const yesNo = () => new Table({width:{size:CW,type:WidthType.DXA},columnWidths:[900,900,CW-1800],rows:[new TableRow({children:[
    new TableCell({borders:noborders,margins:{top:60,bottom:60,left:0,right:60},width:{size:900,type:WidthType.DXA},children:[new Paragraph({children:[txt('â˜  Yes',{size:20})]})]}),
    new TableCell({borders:noborders,margins:{top:60,bottom:60,left:0,right:0},width:{size:900,type:WidthType.DXA},children:[new Paragraph({children:[txt('â˜  No',{size:20})]})]}),
    new TableCell({borders:noborders,width:{size:CW-1800,type:WidthType.DXA},children:[new Paragraph({children:[]})]}),
  ]})]}); };

  // â”€â”€ CONTENT BUILDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let children = [], numbering = undefined;

  if (templateId === 'welcome') {
    const fn  = getVal('firstName') || '[Employee First Name]';
    const jt  = getVal('jobTitle')  || '[Job Title]';
    const sd  = fmtDate(getVal('startDate'))  || '[Start Date]';
    const dt  = fmtDate(getVal('date'))       || '[Date]';
    const rt  = fmtTime(getVal('reportTime')) || '[Time]';
    numbering = {config:[{reference:'bullets',levels:[{level:0,format:LevelFormat.BULLET,text:'\u2022',alignment:AlignmentType.LEFT,style:{paragraph:{indent:{left:440,hanging:220},spacing:{after:60}}}}]}]};
    children = [
      companyLogo(), sp(80), divider(), sp(160),
      new Paragraph({children:[txt(dt,{size:20,color:'555555'})]}), sp(80),
      new Paragraph({children:[txt(`Dear ${fn},`,{bold:true,size:22,color:NAVY})]}), sp(80),
      body("On behalf of the entire RideSource team, it is my sincere pleasure to welcome you as our newest team member. We are genuinely excited to have you with us, and we want you to know that this decision was made with real confidence in what you bring to our organization."),
      body("RideSource exists to connect people to the care and resources they need â€” every trip, every time. The work we do matters deeply to the individuals and communities we serve, and the people behind the wheel are at the heart of that mission. That's you."),
      sp(80), sectionLabel('Your Position & Start Details'),
      fieldRow('Position:',jt), sp(40), fieldRow('Start Date:',sd), sp(40),
      fieldRow('Report Time:',rt), sp(40),
      fieldRow('Report Location:','102 Main Street, Suite C, Ellsworth, ME 04605'), sp(40),
      fieldRow('Your Contact:',`${mgr.name}, ${mgr.title}`), sp(40),
      fieldRow('Phone:',mgr.direct),
      sp(160), sectionLabel('Before Your First Day'),
      body("To ensure your first day of hands-on training goes smoothly, please complete the following online training courses prior to your arrival. These can be completed from any device, at your own pace. RideSource covers the full cost â€” you simply need to complete them."),
      sp(60), noticeBox('REQUIRED','PASS Certification   â€¢   Defensive Driving   â€¢   First Aid, CPR & AED'),
      sp(80), body(`Upon completing each course, you will receive a certificate by email. Please forward your completed certificates to ${mgr.email} as soon as they are received. Hands-on CPR training will be scheduled within your first 60 days.`),
      sp(120), sectionLabel('What to Expect on Day One'),
      body('Your first day will be spent getting oriented, meeting the team, and laying the groundwork for your training:'),
      ...['Overview of RideSource\'s mission, values, and culture','Review of your role, responsibilities, and daily expectations','Team introductions and facility orientation','Vehicle and phone assignment','Required documentation (if not already completed)','Badge photo and ID setup','Time off requests, timekeeping, and payroll systems']
        .map(item=>new Paragraph({numbering:{reference:'bullets',level:0},children:[txt(item,{size:20})]})),
      sp(120), sectionLabel('Important Information'),
      body('A secure document containing your Driver ID, door code, vehicle assignment, and phone information will be presented to you on your first day of employment.'),
      sp(120), noticeBox('QUESTIONS?',`${mgr.name} â€” ${mgr.title}\nOffice: ${mgr.office}  |  Direct: ${mgr.direct}  |  Mobile: ${mgr.mobile}\n${mgr.email}`,LIGHT,NAVY),
      sp(160), body(`We are looking forward to seeing you on ${sd}. Welcome to the RideSource family â€” we are glad you're here.`),
      sp(80), body('Warmly,'), sp(160),
      new Paragraph({children:[txt(mgr.name,{bold:true,size:22,color:NAVY})]}),
      body(mgr.title), body('RideSource Inc.'),
    ];
  }

  else if (templateId === 'rejection') {
    const dt  = fmtDate(getVal('date')) || '[Date]';
    const app = getVal('appName') || '[Applicant Name]';
    const addr = getVal('address');
    const cs   = getVal('cityState');
    children = [
      companyLogo(), sp(80), divider(), sp(160),
      new Paragraph({children:[txt(dt,{size:20,color:'555555'})]}), sp(80),
      ...(addr?[new Paragraph({children:[txt(app,{size:20})]}), new Paragraph({children:[txt(addr,{size:20})]}), new Paragraph({children:[txt(cs,{size:20})]}), sp(80)]:[]),
      body(`Dear ${app},`), sp(80),
      body('Thank you for your interest in joining the RideSource team and for taking the time to interview for our driving position. We genuinely appreciate the time and effort you invested in our process.'),
      sp(60), body('After careful consideration, we have decided to move forward with another candidate whose qualifications more closely match our current needs. This was a difficult decision, as we had many strong applicants.'),
      sp(60), body('We encourage you to apply for future openings at RideSource that align with your skills and experience. We will retain your application on file for 30 days.'),
      sp(60), body('We wish you the very best in your job search and future endeavors.'),
      sp(160), body('Sincerely,'), sp(160),
      new Paragraph({children:[txt(mgr.name,{bold:true,size:22,color:NAVY})]}),
      body(mgr.title), body('RideSource Inc.'), body(mgr.email),
      sp(160), divider(BORDER_C), sp(60),
      noticeBox('NOTE','This letter is sent on behalf of RideSource Inc. Retain a copy in the applicant file.',LIGHT,NAVY),
    ];
  }

  else if (templateId === 'interview') {
    const dt  = fmtDate(getVal('date')) || '[Date]';
    const app = getVal('applicant') || '[Applicant Name]';
    const loc = getVal('location')  || 'Ellsworth Office';
    const pos = getVal('posType')   || '';
    const pay = getVal('pay')       || 'â€”';
    const q   = (text, lines=2) => [
      new Paragraph({spacing:{before:100,after:40},children:[txt(text,{size:19,color:'333333'})]}),
      ...emptyLines(lines)
    ];
    children = [
      companyLogo(), sp(80), divider(), sp(80),
      headerBar('DRIVER INTERVIEW GUIDE','For Internal Use Only â€” HR & Management'), sp(80),
      noticeBox('NOTICE','For internal use only. Do not ask about age, national origin, religion, marital status, disability, pregnancy, or any other protected characteristic.',LIGHT,RED),
      sp(120),
      fieldPair('Applicant Name:',app,'Interview Date:',dt), sp(60),
      fieldPair('Location:',loc,'Position Type:',pos), sp(60),
      fieldPair('Rate of Pay Discussed:',pay,'Interviewer:',''), sp(120),
      sectionLabel('General'),
      ...q('How did you hear about this position?',1), sp(60),
      ...q('Are you familiar with what we do at RideSource?',1), sp(60),
      new Paragraph({spacing:{before:100,after:40},children:[txt('Do you have any relevant experience or certifications for this position?',{size:19,color:'333333'})]}),
      yesNo(), ...emptyLines(1), sp(60),
      new Paragraph({spacing:{before:80,after:40},children:[txt('For Volunteer applicants only â€” please confirm:',{size:18,color:'555555',italics:true})]}),
      checkboxRow(['License','Insurance Declaration 100â€“300','Registration']),
      sp(120), sectionLabel('Background & Eligibility'),
      new Paragraph({spacing:{before:80,after:40},children:[txt('Are you okay with a background check, motor vehicle check, and fingerprinting?',{size:19,color:'333333'})]}),
      yesNo(), sp(60),
      new Paragraph({spacing:{before:80,after:40},children:[txt('This position requires a valid driver\'s license, clean driving record meeting our insurance carrier\'s standards, and the ability to pass all required state and federal background checks. Do you meet these requirements?',{size:19,color:'333333'})]}),
      yesNo(), ...emptyLines(1), sp(60),
      new Paragraph({spacing:{before:80,after:40},children:[txt('Have you ever been convicted of a felony/crime or driving-related offense that would prevent you from legally operating a motor vehicle for employment?',{size:19,color:'333333'})]}),
      yesNo(), ...emptyLines(1), sp(120),
      sectionLabel('Driving & Situational'),
      ...q('How would you rate your driving record?',1), sp(60),
      new Paragraph({spacing:{before:100,after:40},children:[txt('How do you handle the following stressful situations? (Give examples)',{size:19,color:'333333'})]}),
      ...q('Disgruntled clients:',1), sp(40),
      ...q('Last-minute changes:',1), sp(40),
      ...q('Inclement weather:',1), sp(120),
      sectionLabel('Technology & Reliability'),
      ...q('What is your experience level with Android devices?',1), sp(60),
      ...q('If we spoke to a prior supervisor about your attendance and punctuality, what would they say?',1),
      new Paragraph({spacing:{before:60,after:80},children:[txt('~ Explain why punctuality and attendance are essential in this role',{size:17,color:'666666',italics:true})]}),
      sp(120), sectionLabel('Availability'),
      new Paragraph({spacing:{before:80,after:60},children:[txt('What is your availability?',{size:19,color:'333333'})]}),
      checkboxRow(['Monday','Tuesday','Wednesday','Thursday','Friday']),
      sp(40), checkboxRow(['Saturday','Sunday','Nights']),
      sp(60), fieldPair('Available From:','','Available To:',''), sp(60),
      new Paragraph({spacing:{before:80,after:40},children:[txt('Do you have any upcoming time-off requests?',{size:19,color:'333333'})]}),
      yesNo(), ...emptyLines(1), sp(60),
      new Paragraph({spacing:{before:80,after:40},children:[txt('Are you willing to transport children or students?',{size:19,color:'333333'})]}),
      yesNo(), sp(120),
      sectionLabel('Additional'),
      ...q('Do you have any questions for us?',2), sp(120),
      sectionLabel('Interviewer Decision'),
      ...emptyLines(3), sp(80),
      new Table({width:{size:CW,type:WidthType.DXA},columnWidths:[Math.round(CW*.35),Math.round(CW*.65)],rows:[new TableRow({children:[
        new TableCell({borders:noborders,margins:{top:80,bottom:80,left:0,right:80},width:{size:Math.round(CW*.35),type:WidthType.DXA},children:[
          new Paragraph({children:[txt('â˜  Hire',{size:22,bold:true,color:'27AE60'})]}),
          new Paragraph({spacing:{before:60},children:[txt('â˜  Do Not Hire',{size:22,bold:true,color:RED})]})
        ]}),
        new TableCell({borders:{...noborders,bottom:{style:BorderStyle.SINGLE,size:4,color:BORDER_C}},margins:{top:80,bottom:40,left:80,right:0},width:{size:Math.round(CW*.65),type:WidthType.DXA},children:[new Paragraph({children:[txt('Reason (if not hired):',{size:19,color:'333333'})]})]})
      ]})])),
      sp(120), sigBlock('Interviewer Signature','Date'),
      sp(120), divider(BORDER_C), sp(60),
      new Paragraph({alignment:AlignmentType.CENTER,children:[txt('RideSource, Inc.  |  For Internal Use Only',{size:17,color:'888888'})]})
    ];
  }

  else if (templateId === 'driverinfo') {
    const v = id => getVal(id);
    children = [
      companyLogo(), sp(80), divider(), sp(80),
      headerBar('NEW DRIVER CANDIDATE INFORMATION'), sp(160),
      sectionLabel('Full Legal Name'),
      fieldPair('First:',v('firstName'),'M.I.:',v('mi')), sp(60),
      fieldRow('Last:',v('lastName')), sp(40),
      fieldRow('Maiden Name (if applicable):',v('maiden')),
      sp(160), sectionLabel('Contact Information'),
      fieldPair('Home Phone:',v('homePhone'),'Cell Phone:',v('cellPhone')), sp(60),
      fieldPair('Emergency Contact Name:',v('ecName'),'Emergency Contact Number:',v('ecNumber')), sp(60),
      fieldRow('Active Email Address:',v('email')),
      sp(160), sectionLabel('Required Background Information'),
      fieldRow('City and State of Birth:',v('cityBirth')),
      sp(160), sectionLabel("Driver's License Information"),
      fieldPair('State of Issue:',v('dlState'),'Date Issued:',v('dlIssued')?fmtDate(v('dlIssued')):''), sp(60),
      fieldPair('Expiration Date:',v('dlExpiry')?fmtDate(v('dlExpiry')):'',' Class / Endorsement(s):',v('dlClass')),
      sp(160), noticeBox('IMPORTANT','Please attach a clear copy of your driver\'s license to this form before returning it to HR.'),
      sp(60), new Paragraph({alignment:AlignmentType.CENTER,children:[txt('***** ATTACH COPY OF LICENSE TO THIS FORM AND RETURN TO HR *****',{bold:true,size:20,color:NAVY})]}),
      sp(200), divider(BORDER_C), sp(80),
      new Paragraph({alignment:AlignmentType.CENTER,children:[txt('RideSource, Inc.  |  Reliable Safe Transportation',{size:18,color:'888888'})]})
    ];
  }

  else if (templateId === 'emergency') {
    const v = id => getVal(id);
    const contactBlock = (num, prefix) => [
      new Table({width:{size:CW,type:WidthType.DXA},columnWidths:[CW],rows:[new TableRow({children:[new TableCell({borders:solidBorder(NAVY),shading:{fill:NAVY,type:ShadingType.CLEAR},margins:{top:80,bottom:80,left:120,right:120},width:{size:CW,type:WidthType.DXA},children:[new Paragraph({alignment:AlignmentType.CENTER,children:[txt(`Emergency Contact #${num}`,{bold:true,size:22,color:WHITE})]})]})]})]}),
      sp(80),
      fieldRow('Name:',v(`${prefix}Name`)), sp(40),
      fieldRow('Relationship to You:',v(`${prefix}Rel`)), sp(40),
      fieldRow('Address:',v(`${prefix}Address`)), sp(40),
      fieldPair('Cell Phone:',v(`${prefix}Cell`),'Business Phone:',v(`${prefix}Biz`)), sp(40),
      fieldPair('Home Phone:',v(`${prefix}Home`),'Email:',v(`${prefix}Email`)),
    ];
    children = [
      companyLogo(), sp(80), divider(), sp(80),
      headerBar('EMERGENCY CONTACT FORM'), sp(80),
      body('In case of any emergency, please list anyone you would like us to contact and with whom you will allow us to share information about your location, situation, and needs.'),
      sp(80), fieldPair('Employee Name:',v('empName'),'Division / County:',v('division')),
      sp(120), ...contactBlock(1,'ec1'),
      sp(120), ...contactBlock(2,'ec2'),
      sp(120), noticeBox('NOTE','This form is confidential. RideSource will use emergency contact information solely to contact designated individuals in the event of an emergency involving you.'),
      sp(160), sigBlock('Employee Signature','Date'),
      sp(120),
      new Paragraph({spacing:{after:80},children:[txt('PRIVACY ACT NOTICE: ',{bold:true,size:18,color:NAVY}),txt('We are authorized to request this information pursuant to applicable federal and state employment law. We will use this information to contact individuals about you in the event of an emergency. You are not required to provide this information.',{size:17,color:'555555'})]}),
      sp(80), divider(BORDER_C), sp(60),
      new Paragraph({alignment:AlignmentType.CENTER,children:[txt('RideSource, Inc.  |  Reliable Safe Transportation',{size:18,color:'888888'})]})
    ];
  }

  else if (templateId === 'consent') {
    const emp  = getVal('employee') || '[Employee Name]';
    const dt   = fmtDate(getVal('date')) || '[Date]';
    children = [
      companyLogo(), sp(80), divider(), sp(80),
      headerBar('CONSENT FOR CERTIFICATION RELEASE'), sp(80),
      fieldPair('Date:',dt,'Employee Name:',emp), sp(120),
      body(`I, ${emp}, hereby consent and authorize the release, use, and reproduction of all training certifications obtained during my employment by RideSource, Inc. and ModivCare and its agents.`),
      sp(60), body('This authorization covers all certifications including but not limited to: PASS Certification, Defensive Driving, First Aid / CPR / AED, and any other required training certifications.'),
      sp(160), sigBlock('Employee Signature','Date'),
      sp(80), new Paragraph({children:[txt('Printed Name: ',{bold:true,size:20}),txt(emp,{size:20})]}),
      sp(160), divider(BORDER_C), sp(80),
      sectionLabel('For HR Use Only'),
      fieldPair('Received By:','','Date:',''), sp(60),
      new Paragraph({children:[txt('Filed in personnel file: ',{bold:true,size:19}),txt('â˜ Yes',{size:19})]}),
      sp(120), divider(BORDER_C), sp(60),
      new Paragraph({alignment:AlignmentType.CENTER,children:[txt('RideSource, Inc.  |  Reliable Safe Transportation',{size:18,color:'888888'})]})
    ];
  }

  else if (templateId === 'resignation') {
    const dt    = fmtDate(getVal('date'))         || '[Date]';
    const emp   = getVal('employee')              || '[Employee Name]';
    const pos   = getVal('position')              || '';
    const county= getVal('county')                || '';
    const sup   = getVal('supervisor')            || '';
    const recv  = fmtDate(getVal('receivedDate')) || '';
    const last  = fmtDate(getVal('lastDay'))      || '';
    const meth  = getVal('method')                || '';
    const reason= getVal('reason')                || '';
    const checkItem = label => new Table({width:{size:CW,type:WidthType.DXA},columnWidths:[700,CW-700],rows:[new TableRow({children:[
      new TableCell({borders:solidBorder(BORDER_C),shading:{fill:GRAY,type:ShadingType.CLEAR},margins:{top:70,bottom:70,left:120,right:120},width:{size:700,type:WidthType.DXA},verticalAlign:VerticalAlign.CENTER,children:[new Paragraph({alignment:AlignmentType.CENTER,children:[txt('â˜',{size:22})]})]}),
      new TableCell({borders:solidBorder(BORDER_C),margins:{top:70,bottom:70,left:120,right:120},width:{size:CW-700,type:WidthType.DXA},children:[new Paragraph({children:[txt(label,{size:20})]})]}),
    ]})]}));
    children = [
      companyLogo(), sp(80), divider(), sp(80),
      headerBar('VOLUNTARY RESIGNATION ACKNOWLEDGMENT','RideSource Inc. â€” HR Department'), sp(120),
      sectionLabel('Employee Information'),
      fieldPair('Employee Name:',emp,'Date:',dt), sp(60),
      fieldPair('Position / Title:',pos,'Location / County:',county), sp(60),
      fieldRow('Supervisor:',sup), sp(120),
      sectionLabel('Resignation Details'),
      fieldRow('Date Resignation Was Received:',recv), sp(60),
      fieldRow("Employee's Last Day of Work:",last), sp(60),
      fieldRow('Method of Resignation:',meth), sp(60),
      ...(reason ? [new Paragraph({spacing:{before:80,after:40},children:[txt('Reason for Leaving:',{bold:true,size:19,color:'333333'})]}), body(reason)] : [fieldRow('Reason for Leaving (if provided):')]),
      sp(120), sectionLabel('Off-boarding Checklist'),
      ...['Company vehicle returned','Company phone returned','Keys / access cards / badge returned','Final timesheet submitted & verified','Direct deposit / payroll finalized','Final paycheck date confirmed'].map(checkItem),
      sp(120), sectionLabel('Notes'), ...emptyLines(3),
      sp(120), sectionLabel('Acknowledgment'),
      body('Signatures below confirm that this resignation was voluntary and that off-boarding steps have been completed as checked above.'),
      sp(80), sigBlock('Employee Signature','Date'),
      sp(80), sigBlock('Supervisor / Manager Signature','Date'),
      sp(80), sigBlock('HR Representative','Date'),
      sp(120), divider(BORDER_C), sp(60),
      new Paragraph({alignment:AlignmentType.CENTER,children:[txt('RideSource, Inc.  |  Reliable Safe Transportation  |  Confidential HR Document',{size:17,color:'888888'})]})
    ];
  }

  else if (['warn-standard','warn-callout','warn-final'].includes(templateId)) {
    const warnCfg = {
      'warn-standard': {badge:'WRITTEN WARNING',        color:'E67E22', text:'This written warning is being issued due to attendance concerns that violate RideSource\'s Attendance & Punctuality Policy. Reliable attendance is essential to our ability to provide dependable service to our passengers and community.'},
      'warn-callout':  {badge:'CALL-OUT AFTER TRIP RECEIVED', color:'D35400', text:'This warning is issued because this employee called out after a trip manifest had already been finalized. Once a manifest is distributed, RideSource cannot make last-minute adjustments. Call-outs at this stage create significant operational disruptions and may result in liquidated damage fees from the brokerage.'},
      'warn-final':    {badge:'FINAL WARNING â€” TERMINATION RISK', color:RED,     text:'This Final Written Warning is the last step in the progressive disciplinary process before termination. The employee has been previously warned regarding attendance and has not demonstrated the required improvement. Any further violations may result in immediate termination.'},
    };
    const cfg = warnCfg[templateId];
    const warnTitle = templateId === 'warn-final' ? 'FINAL WRITTEN WARNING' : 'ATTENDANCE WARNING';
    const v = id => getVal(id);
    children = [
      companyLogo(), sp(80), divider(), sp(80),
      headerBar(warnTitle,'RideSource Inc. â€” HR Department'), sp(120),
      new Table({width:{size:CW,type:WidthType.DXA},columnWidths:[CW],rows:[new TableRow({children:[new TableCell({borders:solidBorder(cfg.color),shading:{fill:cfg.color,type:ShadingType.CLEAR},margins:{top:100,bottom:100,left:120,right:120},width:{size:CW,type:WidthType.DXA},children:[new Paragraph({alignment:AlignmentType.CENTER,children:[txt(cfg.badge,{bold:true,size:24,color:WHITE,allCaps:true})]})]})]})]}),
      sp(120), sectionLabel('Employee Information'),
      fieldPair('Employee Name:',v('empName'),'Date of Warning:',v('warnDate')?fmtDate(v('warnDate')):''), sp(60),
      fieldPair('Position / Title:',v('position'),'Department / County:',v('county')), sp(60),
      fieldPair('Supervisor:',v('supervisor'),'Incident Date:',v('incDate')?fmtDate(v('incDate')):''),
      sp(120), sectionLabel('Incident Details'),
      fieldRow('Description of Attendance Issue:'), sp(40), ...emptyLines(4),
      sp(120), sectionLabel('Attendance Record'),
      fieldRow('Total Call-Outs (Last 90 Days):',v('callCount')||''), sp(40),
      fieldRow('Previous Warnings on File:',v('prevWarn')||''),
      sp(120), sectionLabel('Policy Reminder'),
      noticeBox('POLICY', cfg.text, LIGHT, cfg.color),
      sp(120), sectionLabel('Corrective Action Required'),
      body('The employee is expected to demonstrate immediate and sustained improvement in attendance. Any further violations may result in additional disciplinary action, up to and including termination of employment.'),
      sp(40), fieldRow('Additional Comments / Action Plan:'), sp(40), ...emptyLines(3),
      sp(120), sectionLabel('Acknowledgment'),
      body('Employee signature acknowledges receipt of this warning. It does not necessarily indicate agreement with its contents.'),
      sp(80), sigBlock('Employee Signature','Date'),
      sp(80), sigBlock('Supervisor / Manager Signature','Date'),
      sp(80), sigBlock('HR Representative (if applicable)','Date'),
      sp(120), noticeBox('FILE','A copy of this document must be retained in the employee\'s personnel file.',LIGHT,NAVY),
      sp(80), divider(BORDER_C), sp(60),
      new Paragraph({alignment:AlignmentType.CENTER,children:[txt('RideSource, Inc.  |  Reliable Safe Transportation  |  Confidential HR Document',{size:17,color:'888888'})]})
    ];
  }

  const docDef = { sections:[{ properties:pageProps(), children }] };
  if (numbering) docDef.numbering = numbering;
  const doc = new Document(docDef);
  const buffer = await Packer.toBlob(doc);
  return buffer;
}

// â”€â”€ CALENDAR â”€â”€
const COUNTY_COLORS={Hancock:'#2980B9',Washington:'#C0392B',Somerset:'#E67E22',Waldo:'#F39C12',Knox:'#16A085',Androscoggin:'#E74C3C',Cumberland:'#1ABC9C',Franklin:'#95A5A6',Kennebec:'#8E44AD',Lincoln:'#EC407A',Oxford:'#7E57C2',Penobscot:'#C0392B',Piscataquis:'#1565C0',Sagadahoc:'#D84315',York:'#F57F17',Aroostook:'#27AE60'};

async function renderCalendar(){
  const title=new Date(calYear,calMonth).toLocaleDateString('en-US',{month:'long',year:'numeric'});
  document.getElementById('cal-title').textContent=title;
  const {data:timeoff}=await db.from('time_off_requests').select('*').eq('status','APPROVED');
  const {data:callouts}=await db.from('call_out_log').select('*');
  const events={};
  (timeoff||[]).forEach(r=>{
    const start=new Date(r.start_date+'T00:00:00');
    const end=new Date((r.end_date||r.start_date)+'T00:00:00');
    for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)){
      if(d.getMonth()===calMonth&&d.getFullYear()===calYear){
        const k=d.getDate();if(!events[k])events[k]=[];
        events[k].push({label:r.employee_name.split(' ')[0]+' (TO)',color:COUNTY_COLORS[r.county]||'#555'});
      }
    }
  });
  (callouts||[]).forEach(c=>{
    const d=new Date(c.callout_date+'T00:00:00');
    if(d.getMonth()===calMonth&&d.getFullYear()===calYear){
      const k=d.getDate();if(!events[k])events[k]=[];
      events[k].push({label:c.employee_name.split(' ')[0]+' (CO)',color:'#27AE60'});
    }
  });
  const firstDay=new Date(calYear,calMonth,1).getDay();
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let html=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;">`;
  days.forEach(d=>html+=`<div style="text-align:center;font-size:11px;font-weight:700;color:#888;padding:6px 0;">${d}</div>`);
  for(let i=0;i<firstDay;i++)html+=`<div style="min-height:80px;"></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const isToday=new Date().getDate()===d&&new Date().getMonth()===calMonth&&new Date().getFullYear()===calYear;
    const evs=events[d]||[];
    html+=`<div style="min-height:80px;border:1px solid #e8e8e8;border-radius:4px;padding:4px;background:${isToday?'#EAF0FB':'#fff'};">
      <div style="font-size:12px;font-weight:${isToday?'800':'600'};color:${isToday?'var(--navy)':'#333'};margin-bottom:3px;">${d}</div>
      ${evs.map(e=>`<div style="background:${e.color};color:#fff;font-size:10px;padding:2px 5px;border-radius:3px;margin-bottom:2px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">${e.label}</div>`).join('')}
    </div>`;
  }
  html+=`</div>`;
  document.getElementById('cal-grid').innerHTML=html;
  const legend=Object.entries(COUNTY_COLORS).map(([county,color])=>`<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;"><span style="width:12px;height:12px;border-radius:2px;background:${color};display:inline-block;"></span>${county}</span>`).join('');
  document.getElementById('cal-legend').innerHTML=`<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;"><span style="width:12px;height:12px;border-radius:2px;background:#27AE60;display:inline-block;"></span>Call-Out</span> `+legend;
}
function changeMonth(dir){calMonth+=dir;if(calMonth>11){calMonth=0;calYear++;}else if(calMonth<0){calMonth=11;calYear--;}renderCalendar();}

function generateCertificate() {
  const now = new Date();
  const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
  const rows = POLICIES.map(p => {
    const el = document.getElementById('pol-' + p.id);
    const timeEl = document.getElementById('time-' + p.id);
    const signedTime = timeEl ? timeEl.textContent.replace('Signed ', '') : dateStr;
    return `<tr><td style="padding:10px 14px;border-bottom:1px solid #e5e7eb;font-weight:600;color:#1a2e4a;">${p.name}</td><td style="padding:10px 14px;border-bottom:1px solid #e5e7eb;color:#16a34a;text-align:center;">âœ“ Acknowledged</td><td style="padding:10px 14px;border-bottom:1px solid #e5e7eb;color:#555;font-size:13px;">${signedTime}</td></tr>`;
  }).join('');
  const certHTML = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Policy Acknowledgment Certificate</title><style>body{font-family:Georgia,serif;margin:0;padding:40px;background:#f8f9fa;color:#1a2e4a;}.cert-wrapper{max-width:780px;margin:0 auto;background:#fff;border:3px solid #1a2e4a;border-radius:12px;padding:50px 60px;box-shadow:0 4px 24px rgba(0,0,0,.10);}.cert-header{text-align:center;border-bottom:2px solid #c0392b;padding-bottom:24px;margin-bottom:32px;}.cert-logo{font-size:28px;font-weight:900;letter-spacing:2px;color:#1a2e4a;text-transform:uppercase;}.cert-logo span{color:#c0392b;}.cert-title{font-size:30px;font-weight:700;color:#1a2e4a;margin:24px 0 6px;text-align:center;}.cert-body{text-align:center;font-size:16px;color:#444;line-height:1.7;margin-bottom:32px;}.cert-name{font-size:26px;font-weight:700;color:#c0392b;border-bottom:2px solid #c0392b;display:inline-block;padding:0 20px 4px;margin:8px 0;}.cert-meta{display:flex;justify-content:center;gap:40px;margin-bottom:32px;font-size:14px;color:#555;}.cert-meta div{text-align:center;}.cert-meta strong{display:block;color:#1a2e4a;font-size:15px;}table{width:100%;border-collapse:collapse;margin-bottom:32px;font-family:Arial,sans-serif;}thead tr{background:#1a2e4a;color:#fff;}thead th{padding:12px 14px;text-align:left;font-size:13px;font-weight:600;}.cert-footer{border-top:2px solid #1a2e4a;padding-top:24px;display:flex;justify-content:space-between;align-items:flex-end;gap:40px;}.sig-block{flex:1;}.sig-line{border-bottom:1.5px solid #1a2e4a;margin-bottom:6px;height:32px;}.sig-label{font-size:12px;color:#888;text-transform:uppercase;letter-spacing:.5px;}.seal-circle{width:90px;height:90px;border-radius:50%;border:3px double #1a2e4a;display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 auto;}.seal-circle div{font-size:10px;font-weight:700;color:#1a2e4a;text-align:center;line-height:1.3;}.legal{font-size:11px;color:#aaa;text-align:center;margin-top:24px;line-height:1.6;}@media print{body{padding:0;background:#fff;}}</style></head>
  <body><div class="cert-wrapper"><div class="cert-header"><div class="cert-logo">Ride<span>Source</span> Inc.</div><div style="font-size:13px;color:#888;letter-spacing:1px;text-transform:uppercase;margin-top:4px;">Non-Emergency Medical Transportation Â· Maine</div></div>
  <div class="cert-title">Certificate of Policy Acknowledgment</div>
  <div class="cert-body">This certifies that<br><span class="cert-name">${user.name}</span><br>has read, reviewed, and electronically acknowledged all required RideSource Inc. employment policies as part of the new employee onboarding process.</div>
  <div class="cert-meta"><div><strong>${user.county}</strong>County / Location</div><div><strong>${user.email}</strong>Employee Email</div><div><strong>${dateStr}</strong>Date Completed</div></div>
  <table><thead><tr><th>Policy</th><th style="text-align:center;">Status</th><th>Date &amp; Time</th></tr></thead><tbody>${rows}</tbody></table>
  <div class="cert-footer"><div class="sig-block"><div class="sig-line"></div><div class="sig-label">Employee Signature (Electronic)</div><div style="font-size:13px;color:#1a2e4a;margin-top:4px;">${user.name}</div></div>
  <div style="text-align:center;"><div class="seal-circle"><div>RIDE<br>SOURCE<br>âœ“<br>VERIFIED</div></div><div style="font-size:11px;color:#888;margin-top:6px;">Electronically Sealed</div></div>
  <div class="sig-block" style="text-align:right;"><div class="sig-line"></div><div class="sig-label">Date Completed</div><div style="font-size:13px;color:#1a2e4a;margin-top:4px;">${dateStr} at ${timeStr}</div></div></div>
  <div class="legal">Electronic signatures on this certificate are legally binding under the E-SIGN Act and applicable Maine state law. This document serves as official record of policy acknowledgment for RideSource Inc.</div></div>
  <div style="text-align:center;margin-top:24px;"><button onclick="window.print()" style="background:#1a2e4a;color:#fff;border:none;padding:12px 32px;font-size:15px;border-radius:8px;cursor:pointer;font-weight:600;">ğŸ–¨ï¸ Print / Save as PDF</button></div></body></html>`;
  const blob = new Blob([certHTML], { type: 'text/html' });
  window.open(URL.createObjectURL(blob), '_blank');
}

</script>
</body>
</html>
