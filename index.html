<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RideSource Staff Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.min.js"></script>
<style>
:root{--navy:#1B2A4A;--red:#C0392B;--light:#EAF0FB;--border:#D0D9EC;--success:#27AE60;--warn:#E67E22;--gray:#F7F9FC;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:Arial,sans-serif;background:#F0F4FA;color:#222;min-height:100vh;}

/* ‚îÄ‚îÄ LANDING ‚îÄ‚îÄ */
.landing-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0f1f3d 0%,#1B2A4A 60%,#2c3e6b 100%);}
.landing-card{background:#fff;border-radius:16px;padding:52px 48px;width:100%;max-width:500px;box-shadow:0 20px 60px rgba(0,0,0,0.4);text-align:center;}
.landing-brand{font-size:32px;font-weight:900;color:var(--navy);letter-spacing:-1px;margin-bottom:4px;}
.landing-brand span{color:var(--red);}
.landing-sub{font-size:13px;color:#888;margin-bottom:28px;letter-spacing:.5px;text-transform:uppercase;}

/* Tab switcher on landing */
.portal-tabs{display:flex;border-radius:10px;overflow:hidden;border:2px solid var(--border);margin-bottom:28px;}
.portal-tab{flex:1;padding:12px;font-size:14px;font-weight:700;cursor:pointer;border:none;background:#f8f9fa;color:#888;transition:all .2s;}
.portal-tab.active{background:var(--navy);color:#fff;}

.landing-title{font-size:18px;font-weight:700;color:var(--navy);margin-bottom:6px;}
.landing-desc{font-size:13px;color:#666;margin-bottom:24px;line-height:1.6;}
.landing-field{width:100%;padding:13px 16px;border:2px solid var(--border);border-radius:8px;font-size:15px;margin-bottom:12px;outline:none;transition:border-color .2s;font-family:Arial,sans-serif;}
.landing-field:focus{border-color:var(--navy);}
.landing-btn{width:100%;padding:14px;background:var(--navy);color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer;transition:background .2s;}
.landing-btn:hover{background:#0f1f3d;}
.error-msg{background:#fdecea;border:1px solid #f5c6c2;border-radius:6px;padding:10px 14px;color:var(--red);font-size:13px;margin-top:8px;display:none;}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen{display:none;}.screen.active{display:block;}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header{background:var(--navy);padding:0 32px;display:flex;align-items:center;justify-content:space-between;height:64px;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.3);}
.brand{font-size:22px;font-weight:800;color:#fff;letter-spacing:-.5px;}
.brand span{color:var(--red);}
.tagline{font-size:11px;color:rgba(255,255,255,.5);letter-spacing:.5px;}
.header-badge{background:var(--red);color:#fff;font-size:11px;font-weight:700;padding:3px 10px;border-radius:12px;letter-spacing:.5px;}
.header-right{display:flex;align-items:center;gap:12px;}
.header-user{font-size:13px;color:rgba(255,255,255,.75);}
.header-user strong{color:#fff;}
.btn-logout{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;}
.btn-logout:hover{background:rgba(255,255,255,.2);}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.portal-layout{display:flex;min-height:calc(100vh - 64px);}
.sidebar{width:240px;background:#fff;border-right:1px solid var(--border);padding:24px 0;flex-shrink:0;position:sticky;top:64px;height:calc(100vh - 64px);overflow-y:auto;}
.sidebar-label{font-size:10px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;padding:8px 16px 4px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 16px;cursor:pointer;font-size:13px;color:#555;font-weight:500;transition:all .15s;margin:1px 8px;border-radius:8px;}
.nav-item:hover{background:var(--light);color:var(--navy);}
.nav-item.active{background:var(--navy);color:#fff;}
.nav-icon{font-size:16px;width:20px;text-align:center;}
.nav-badge{margin-left:auto;background:var(--red);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;}
.nav-item.active .nav-badge{background:rgba(255,255,255,.25);}
.main-content{flex:1;padding:32px;overflow-y:auto;}

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.progress-bar-wrap{background:#fff;border:1px solid var(--border);border-radius:10px;padding:16px 20px;margin-bottom:24px;}
.progress-label{font-size:12px;font-weight:600;color:#888;margin-bottom:8px;display:flex;justify-content:space-between;}
.progress-track{height:8px;background:#eee;border-radius:4px;overflow:hidden;}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--navy),#4a7fd4);border-radius:4px;transition:width .5s ease;}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:28px;margin-bottom:24px;}
.card-title{font-size:18px;font-weight:700;color:var(--navy);margin-bottom:6px;display:flex;align-items:center;gap:10px;}
.card-sub{font-size:13px;color:#888;margin-bottom:20px;}

/* ‚îÄ‚îÄ DOC READER ‚îÄ‚îÄ */
.doc-reader{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden;}
.doc-nav{background:var(--navy);padding:16px 24px;display:flex;align-items:center;justify-content:space-between;}
.doc-nav-title{color:#fff;font-size:15px;font-weight:700;}
.doc-nav-progress{color:rgba(255,255,255,.65);font-size:12px;}
.doc-tabs{display:flex;background:var(--gray);border-bottom:1px solid var(--border);overflow-x:auto;}
.doc-tab{padding:12px 20px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;color:#777;border-bottom:3px solid transparent;transition:all .15s;}
.doc-tab:hover{color:var(--navy);}
.doc-tab.active{color:var(--navy);border-bottom-color:var(--navy);background:#fff;}
.doc-tab.completed{color:var(--success);}
.doc-tab.completed::before{content:'‚úì ';}
.doc-body{padding:36px 48px;min-height:500px;max-height:70vh;overflow-y:auto;font-size:14px;line-height:1.75;}
.doc-body h1{font-size:22px;color:var(--navy);margin:28px 0 10px;padding-bottom:8px;border-bottom:2px solid var(--red);}
.doc-body h2{font-size:17px;color:var(--navy);margin:20px 0 8px;font-weight:700;}
.doc-body h3{font-size:15px;color:#444;margin:16px 0 6px;font-weight:700;}
.doc-body p{margin-bottom:12px;color:#333;}
.doc-body ul{margin:8px 0 12px 24px;}
.doc-body li{margin-bottom:4px;color:#333;}
.doc-body table{width:100%;border-collapse:collapse;margin:12px 0;}
.doc-body th{background:var(--navy);color:#fff;padding:8px 12px;font-size:13px;text-align:left;}
.doc-body td{padding:8px 12px;border-bottom:1px solid #eee;font-size:13px;}
.doc-body .callout{background:var(--light);border-left:4px solid var(--navy);border-radius:0 8px 8px 0;padding:14px 18px;margin:16px 0;}
.doc-body .callout strong{color:var(--navy);display:block;margin-bottom:4px;}
.doc-body .warn-box{background:#fff3cd;border-left:4px solid var(--warn);border-radius:0 8px 8px 0;padding:12px 16px;margin:12px 0;}
.doc-footer{padding:16px 24px;background:var(--gray);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.doc-footer-note{font-size:12px;color:#888;}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn-primary{background:var(--navy);color:#fff;border:none;padding:10px 22px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:background .2s;}
.btn-primary:hover{background:#0f1f3d;}
.btn-primary:disabled{background:#aaa;cursor:not-allowed;}
.btn-secondary{background:transparent;color:var(--navy);border:2px solid var(--navy);padding:9px 20px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-secondary:hover{background:var(--light);}
.btn{padding:9px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s;}
.btn-red{background:var(--red);color:#fff;}
.btn-red:hover{background:#a93226;}
.btn-green{background:var(--success);color:#fff;}
.btn-sm{padding:6px 12px;font-size:12px;}

/* ‚îÄ‚îÄ SIG ‚îÄ‚îÄ */
.sig-block{background:#fff;border:2px solid var(--navy);border-radius:12px;padding:32px;margin-top:24px;}
.sig-block h3{font-size:17px;color:var(--navy);margin-bottom:6px;}
.sig-block p{font-size:13px;color:#666;margin-bottom:20px;line-height:1.6;}
.sig-options{display:flex;flex-direction:column;gap:14px;margin-bottom:24px;}
.sig-option{display:flex;align-items:flex-start;gap:12px;padding:16px;border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all .2s;}
.sig-option:hover{border-color:var(--navy);background:var(--light);}
.sig-option.selected{border-color:var(--navy);background:var(--light);}
.sig-option input[type="radio"]{margin-top:2px;accent-color:var(--navy);transform:scale(1.2);}
.sig-option label{cursor:pointer;font-size:14px;line-height:1.5;}
.sig-option label strong{display:block;color:var(--navy);margin-bottom:3px;}
.sig-field{margin-bottom:16px;}
.sig-field label{display:block;font-size:12px;font-weight:700;color:#555;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;}
.sig-field input{width:100%;padding:11px 14px;border:2px solid var(--border);border-radius:8px;font-size:15px;font-style:italic;outline:none;transition:border-color .2s;}
.sig-field input:focus{border-color:var(--navy);}
.sig-legal{font-size:11px;color:#999;line-height:1.5;margin-bottom:20px;padding:12px;background:var(--gray);border-radius:6px;border:1px solid var(--border);}

/* ‚îÄ‚îÄ POLICY ‚îÄ‚îÄ */
.policy-list{display:flex;flex-direction:column;gap:12px;}
.policy-item{display:flex;align-items:center;gap:14px;padding:16px 18px;border:1px solid var(--border);border-radius:10px;background:#fff;}
.policy-item.signed{background:#f0faf4;border-color:#a8d5b5;}
.policy-check{width:28px;height:28px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px;}
.policy-item.signed .policy-check{background:var(--success);border-color:var(--success);color:#fff;}
.policy-info{flex:1;}
.policy-name{font-size:14px;font-weight:700;color:var(--navy);margin-bottom:2px;}
.policy-desc{font-size:12px;color:#888;}
.policy-time{font-size:11px;color:#aaa;}
.policy-btn{padding:8px 16px;font-size:13px;font-weight:600;border-radius:6px;cursor:pointer;border:none;}
.policy-btn-read{background:var(--navy);color:#fff;}
.policy-btn-done{background:var(--success);color:#fff;cursor:default;}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:200;display:none;align-items:center;justify-content:center;padding:24px;}
.modal-overlay.open{display:flex;}
.modal{background:#fff;border-radius:16px;padding:32px;width:100%;max-width:700px;max-height:90vh;overflow-y:auto;position:relative;}
.modal-close{position:absolute;top:16px;right:20px;background:none;border:none;font-size:22px;cursor:pointer;color:#aaa;}
.modal-close:hover{color:#333;}
.modal h3{font-size:20px;color:var(--navy);margin-bottom:8px;}
.modal p{font-size:14px;color:#666;margin-bottom:16px;line-height:1.6;}
.modal-body{max-height:50vh;overflow-y:auto;border:1px solid var(--border);border-radius:8px;padding:20px 24px;margin-bottom:20px;font-size:13px;line-height:1.7;color:#444;background:var(--gray);}

/* ‚îÄ‚îÄ WELCOME DASH ‚îÄ‚îÄ */
.welcome-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:24px;}
.stat-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:20px;display:flex;align-items:center;gap:16px;}
.stat-icon{width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;}
.stat-val{font-size:24px;font-weight:800;color:var(--navy);}
.stat-label{font-size:12px;color:#888;font-weight:500;}
.checklist{list-style:none;}
.checklist li{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #f0f0f0;font-size:14px;}
.checklist li:last-child{border-bottom:none;}
.checklist-item{display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid #f0f0f0;font-size:13px;line-height:1.6;}
.checklist-item:last-of-type{border-bottom:none;}
.check-box{font-size:18px;color:var(--navy);flex-shrink:0;margin-top:1px;}
.check-dot{width:20px;height:20px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;}
.check-dot.done{background:var(--success);color:#fff;}
.check-dot.pending{background:#eee;color:#aaa;}

/* ‚îÄ‚îÄ SUCCESS ‚îÄ‚îÄ */
.success-banner{background:linear-gradient(135deg,#1a6b3a,#27AE60);color:#fff;border-radius:12px;padding:32px;text-align:center;margin-bottom:24px;}
.success-banner .big-check{font-size:48px;margin-bottom:12px;}
.success-banner h2{font-size:24px;margin-bottom:8px;}
.success-banner p{font-size:14px;opacity:.85;}

/* ‚îÄ‚îÄ PORTAL SECTION ‚îÄ‚îÄ */
.portal-section{display:none;}

/* ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ */
.admin-section{display:none;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:20px;}
.admin-stat-card{background:#fff;border:1px solid var(--border);border-radius:10px;padding:18px;display:flex;align-items:center;gap:14px;}
.admin-stat-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.admin-stat-val{font-size:26px;font-weight:800;color:var(--navy);}
.admin-stat-label{font-size:11px;color:#888;font-weight:500;}
.data-table{width:100%;border-collapse:collapse;}
.data-table th{background:var(--navy);color:#fff;padding:10px 14px;text-align:left;font-size:12px;font-weight:700;letter-spacing:.3px;}
.data-table td{padding:10px 14px;font-size:13px;border-bottom:1px solid #f0f0f0;}
.data-table tr:hover td{background:var(--gray);}
.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;}
.badge-pending{background:#fff3cd;color:#856404;}
.badge-approved{background:#d4edda;color:#155724;}
.badge-denied{background:#f8d7da;color:#721c24;}
.badge-flag{background:#fdecea;color:var(--red);}
.badge-warning{background:#fef3e8;color:var(--warn);}
.template-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-bottom:20px;}
.template-card{background:#fff;border:1px solid var(--border);border-radius:10px;padding:18px;cursor:pointer;transition:all .2s;}
.template-card:hover{border-color:var(--navy);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.08);}
.template-icon{font-size:28px;margin-bottom:10px;}
.template-name{font-size:14px;font-weight:700;color:var(--navy);margin-bottom:4px;}
.template-desc{font-size:12px;color:#888;line-height:1.5;}
.form-field{margin-bottom:14px;}
.form-field label{display:block;font-size:11px;font-weight:700;color:#555;text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px;}
.form-field input,.form-field select,.form-field textarea{width:100%;padding:10px 13px;border:2px solid var(--border);border-radius:8px;font-size:13px;outline:none;transition:border-color .2s;font-family:Arial,sans-serif;}
.form-field input:focus,.form-field select:focus,.form-field textarea:focus{border-color:var(--navy);}
.form-field textarea{min-height:100px;resize:vertical;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.warning-employee{background:#fff;border:1px solid var(--border);border-radius:10px;padding:16px 18px;display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.preview-box{background:var(--gray);border:1px solid var(--border);border-radius:8px;padding:20px 24px;margin:14px 0;font-size:13px;line-height:1.8;white-space:pre-wrap;font-family:Arial,sans-serif;max-height:350px;overflow-y:auto;}

@media(max-width:768px){.sidebar{display:none;}.main-content{padding:16px;}.doc-body{padding:20px;}}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LANDING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-landing" class="screen active">
  <div class="landing-wrap">
    <div class="landing-card">
      <div class="landing-brand">Ride<span>Source</span> Inc.</div>
      <div class="landing-sub">Reliable Safe Transportation</div>

      <div class="portal-tabs">
        <button class="portal-tab active" id="tab-emp" onclick="switchLanding('employee')">üë§ Employee Portal</button>
        <button class="portal-tab" id="tab-adm" onclick="switchLanding('admin')">üîí Admin Portal</button>
      </div>

      <!-- Employee login -->
      <div id="landing-employee">
        <div class="landing-title">Welcome!</div>
        <div class="landing-desc">Complete your onboarding, review company policies, and sign your acknowledgments ‚Äî all in one place.</div>
        <input class="landing-field" id="login-name" type="text" placeholder="Your Full Name" autocomplete="name">
        <input class="landing-field" id="login-email" type="email" placeholder="Your Email Address" autocomplete="email">
        <select class="landing-field" id="login-county">
          <option value="">Select Your County</option>
          <option>Androscoggin</option><option>Aroostook</option><option>Cumberland</option>
          <option>Franklin</option><option>Hancock</option><option>Kennebec</option>
          <option>Knox</option><option>Lincoln</option><option>Oxford</option>
          <option>Penobscot</option><option>Piscataquis</option><option>Sagadahoc</option>
          <option>Somerset</option><option>Waldo</option><option>Washington</option><option>York</option>
        </select>
        <button class="landing-btn" onclick="startPortal()">Enter Employee Portal ‚Üí</button>
        <div class="error-msg" id="login-error">Please fill in all fields to continue.</div>
      </div>

      <!-- Admin login -->
      <div id="landing-admin" style="display:none;">
        <div class="landing-title">Admin &amp; Manager Access</div>
        <div class="landing-desc">Supervisors and HR staff only. Enter your name and admin password to continue.</div>
        <input class="landing-field" id="admin-name" type="text" placeholder="Your Full Name">
        <input class="landing-field" id="admin-pass" type="password" placeholder="Admin Password" onkeydown="if(event.key==='Enter')adminLogin()">
        <button class="landing-btn" onclick="adminLogin()">Enter Admin Portal ‚Üí</button>
        <div class="error-msg" id="admin-error">Incorrect password or missing name. Please try again.</div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EMPLOYEE PORTAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-portal" class="screen">
  <div class="header">
    <div>
      <div class="brand">Ride<span>Source</span> Inc.</div>
      <div class="tagline">Employee Portal</div>
    </div>
    <div class="header-right">
      <div class="header-user">Welcome, <strong id="display-name"></strong></div>
      <button class="btn-logout" onclick="logout()">Sign Out</button>
    </div>
  </div>
  <div class="portal-layout">
    <div class="sidebar">
      <div style="padding:0 8px;">
        <div class="sidebar-label">Overview</div>
        <div class="nav-item active" onclick="showSection('dashboard')" id="nav-dashboard"><span class="nav-icon">üè†</span>Dashboard</div>
        <div class="sidebar-label">Documents</div>
        <div class="nav-item" onclick="showSection('training')" id="nav-training"><span class="nav-icon">üìã</span>Driver Training Guide</div>
        <div class="nav-item" onclick="showSection('handbook')" id="nav-handbook"><span class="nav-icon">üìñ</span>Employee Handbook</div>
        <div class="sidebar-label">Actions</div>
        <div class="nav-item" onclick="showSection('policies')" id="nav-policies"><span class="nav-icon">‚úçÔ∏è</span>Policy Sign-Offs<span class="nav-badge" id="badge-policies">0/7</span></div>
        <div class="nav-item" onclick="showSection('timeoff')" id="nav-timeoff"><span class="nav-icon">üìÖ</span>Request Time Off</div>
      </div>
    </div>
    <div class="main-content">

      <!-- DASHBOARD -->
      <div id="section-dashboard" class="portal-section" style="display:block;">
        <div class="progress-bar-wrap">
          <div class="progress-label"><span>Onboarding Progress</span><span id="progress-pct">0%</span></div>
          <div class="progress-track"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
        </div>
        <div class="welcome-grid">
          <div class="stat-card"><div class="stat-icon" style="background:var(--light);">üìÑ</div><div><div class="stat-val" id="stat-docs">0/2</div><div class="stat-label">Documents Read</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:#e8f8ee;">‚úçÔ∏è</div><div><div class="stat-val" id="stat-sigs">0/7</div><div class="stat-label">Policies Signed</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:#fef3e8;">‚è≥</div><div><div class="stat-val" id="stat-remaining">9</div><div class="stat-label">Items Remaining</div></div></div>
        </div>
        <div class="card">
          <div class="card-title">üìù Your Onboarding Checklist</div>
          <ul class="checklist" id="dash-checklist"></ul>
        </div>
      </div>

      <!-- TRAINING -->
      <div id="section-training" class="portal-section">
        <div class="card-title" style="font-size:22px;color:var(--navy);margin-bottom:4px;">üìã Driver Training Guide</div>
        <p style="color:#888;font-size:14px;margin-bottom:20px;">Version 2.1 ¬∑ February 2026</p>
        <div class="doc-reader">
          <div class="doc-nav">
            <div class="doc-nav-title">RideSource Driver Training Guide</div>
            <div class="doc-nav-progress" id="training-progress-label">Section 1 of 6</div>
          </div>
          <div class="doc-tabs" id="training-tabs"></div>
          <div class="doc-body" id="training-body" onscroll="checkScroll('training')"></div>
          <div class="doc-footer">
            <div class="doc-footer-note" id="training-scroll-note">üìñ Scroll to the bottom of this section to continue.</div>
            <div style="display:flex;gap:8px;">
              <button class="btn-secondary" id="training-prev" onclick="changeSection('training',-1)" style="padding:8px 16px;font-size:13px;" disabled>‚Üê Previous</button>
              <button class="btn-primary" id="training-next" onclick="changeSection('training',1)" style="padding:8px 16px;font-size:13px;" disabled>Next Section ‚Üí</button>
            </div>
          </div>
        </div>
        <div id="training-complete-banner" style="display:none;margin-top:20px;" class="success-banner">
          <div class="big-check">‚úÖ</div>
          <h2>Training Guide Complete!</h2>
          <p>Great work. Continue to the Employee Handbook next.</p>
          <button class="btn-primary" style="margin-top:12px;background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.5);" onclick="showSection('handbook')">Go to Employee Handbook ‚Üí</button>
        </div>
      </div>

      <!-- HANDBOOK -->
      <div id="section-handbook" class="portal-section">
        <div class="card-title" style="font-size:22px;color:var(--navy);margin-bottom:4px;">üìñ Employee Handbook</div>
        <p style="color:#888;font-size:14px;margin-bottom:20px;">Version 3.0 ¬∑ February 2026</p>
        <div class="doc-reader">
          <div class="doc-nav">
            <div class="doc-nav-title">RideSource Employee Handbook</div>
            <div class="doc-nav-progress" id="handbook-progress-label">Section 1 of 10</div>
          </div>
          <div class="doc-tabs" id="handbook-tabs"></div>
          <div class="doc-body" id="handbook-body" onscroll="checkScroll('handbook')"></div>
          <div class="doc-footer">
            <div class="doc-footer-note" id="handbook-scroll-note">üìñ Scroll to the bottom of this section to continue.</div>
            <div style="display:flex;gap:8px;">
              <button class="btn-secondary" id="handbook-prev" onclick="changeSection('handbook',-1)" style="padding:8px 16px;font-size:13px;" disabled>‚Üê Previous</button>
              <button class="btn-primary" id="handbook-next" onclick="changeSection('handbook',1)" style="padding:8px 16px;font-size:13px;" disabled>Next Section ‚Üí</button>
            </div>
          </div>
        </div>
        <div id="handbook-sig" style="display:none;" class="sig-block">
          <h3>üìù Handbook Acknowledgment</h3>
          <p>You've completed the Employee Handbook. Please provide your electronic signature to complete this step.</p>
          <div class="sig-options">
            <div class="sig-option" id="opt-print" onclick="selectHandbookOpt('print')">
              <input type="radio" name="hb-opt" value="print" id="rb-print">
              <label for="rb-print"><strong>I would like to receive a printed copy of this handbook.</strong>By signing, I acknowledge I have read and understand the handbook and request a printed copy.</label>
            </div>
            <div class="sig-option" id="opt-digital" onclick="selectHandbookOpt('digital')">
              <input type="radio" name="hb-opt" value="digital" id="rb-digital">
              <label for="rb-digital"><strong>I acknowledge receipt and understanding ‚Äî no printed copy requested.</strong>By signing, I acknowledge I have received, read, and understand the handbook.</label>
            </div>
          </div>
          <div class="sig-field"><label>Electronic Signature (type your full legal name)</label><input type="text" id="hb-sig-input" placeholder="Type your full name to sign..." oninput="checkHbSig()"></div>
          <div class="sig-legal">By typing your name above, you are providing an electronic signature legally binding under the E-SIGN Act and Maine law.</div>
          <button class="btn-primary" onclick="submitHandbookSig()" id="hb-submit-btn" disabled>Submit Acknowledgment</button>
        </div>
      </div>

      <!-- POLICIES -->
      <div id="section-policies" class="portal-section">
        <div class="card-title" style="font-size:22px;color:var(--navy);margin-bottom:4px;">‚úçÔ∏è Policy Acknowledgments</div>
        <p style="color:#888;font-size:14px;margin-bottom:20px;">Read and sign each policy below. All must be completed before your onboarding is finalized.</p>
        <div class="policy-list" id="policy-list"></div>
        <div id="all-signed-banner" style="display:none;margin-top:24px;" class="success-banner">
          <div class="big-check">üéâ</div>
          <h2>All Policies Signed!</h2>
          <p>Your onboarding acknowledgments are complete. Your supervisor has been notified. Welcome to the RideSource team!</p>
          <button class="btn-primary" style="margin-top:16px;font-size:15px;padding:12px 28px;" onclick="generateCertificate()">üìÑ Get Your Certificate of Completion</button>
        </div>
      </div>

      <!-- TIME OFF -->
      <div id="section-timeoff" class="portal-section">
        <div class="card-title" style="font-size:22px;color:var(--navy);margin-bottom:4px;">üìÖ Request Time Off</div>
        <p style="color:#888;font-size:14px;margin-bottom:24px;">Submit a time off request below. Your supervisor will be notified and will approve or deny within a reasonable timeframe.</p>
        <div class="card">
          <div class="card-sub">Select a request type to get started.</div>
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:24px;">
            <button class="req-type-btn btn-secondary" onclick="selectReqType('Full Day Off')">‚òÄÔ∏è Full Day Off</button>
            <button class="req-type-btn btn-secondary" onclick="selectReqType('Multiple Days')">üìÜ Multiple Days</button>
            <button class="req-type-btn btn-secondary" onclick="selectReqType('Start Late')">‚è∞ Start Late</button>
            <button class="req-type-btn btn-secondary" onclick="selectReqType('End Early')">üö™ End Early</button>
            <button class="req-type-btn btn-secondary" onclick="selectReqType('Mid-Day Appointment')">üè• Mid-Day Appointment</button>
          </div>
          <div id="req-form" style="display:none;">
            <div id="req-fields"></div>
            <div class="sig-field"><label>Reason (optional)</label><input type="text" id="req-reason" placeholder="Brief reason..." style="width:100%;padding:11px 14px;border:2px solid var(--border);border-radius:8px;font-size:14px;outline:none;"></div>
            <button class="btn-primary" onclick="submitTimeOff()" style="margin-top:8px;">Submit Request</button>
          </div>
          <div id="req-success" style="display:none;" class="success-banner">
            <div>‚úÖ</div><h2 style="font-size:18px;margin-top:8px;">Request Submitted!</h2>
            <p>Your supervisor has been notified. You'll receive an email when a decision is made.</p>
            <button class="btn-primary" style="margin-top:12px;background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.5);" onclick="resetTimeOff()">Submit Another Request</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADMIN PORTAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-admin" class="screen">
  <div class="header">
    <div><div class="brand">Ride<span>Source</span> Inc.</div><div class="tagline">Admin &amp; Manager Portal</div></div>
    <div class="header-right">
      <div class="header-badge">ADMIN</div>
      <span style="color:rgba(255,255,255,.7);font-size:13px;" id="admin-display"></span>
      <button class="btn-logout" onclick="adminLogout()">Sign Out</button>
    </div>
  </div>
  <div class="portal-layout">
    <div class="sidebar">
      <div style="padding:0 8px;">
        <div class="sidebar-label">Overview</div>
        <div class="nav-item active" onclick="showAdmin('dashboard')" id="nav-adm-dashboard"><span class="nav-icon">üìä</span>Dashboard</div>
        <div class="sidebar-label">Reference</div>
        <div class="nav-item" onclick="showAdmin('manager-guide')" id="nav-adm-manager-guide"><span class="nav-icon">üìò</span>Manager Guide</div>
        <div class="nav-item" onclick="showAdmin('handbook-ref')" id="nav-adm-handbook-ref"><span class="nav-icon">üìñ</span>Employee Handbook</div>
        <div class="sidebar-label">HR Tools</div>
        <div class="nav-item" onclick="showAdmin('templates')" id="nav-adm-templates"><span class="nav-icon">üìÑ</span>HR Templates</div>
        <div class="nav-item" onclick="showAdmin('warnings')" id="nav-adm-warnings"><span class="nav-icon">‚ö†Ô∏è</span>Attendance Warnings<span class="nav-badge" id="badge-flags">0</span></div>
        <div class="nav-item" onclick="showAdmin('onboarding-tracker')" id="nav-adm-onboarding-tracker"><span class="nav-icon">‚úÖ</span>Onboarding Tracker</div>
        <div class="sidebar-label">Time Off</div>
        <div class="nav-item" onclick="showAdmin('requests')" id="nav-adm-requests"><span class="nav-icon">üìÖ</span>Pending Requests<span class="nav-badge" id="badge-requests">0</span></div>
        <div class="nav-item" onclick="showAdmin('callouts')" id="nav-adm-callouts"><span class="nav-icon">üìû</span>Call-Out Log</div>
        <div class="nav-item" onclick="showAdmin('calendar')" id="nav-adm-calendar"><span class="nav-icon">üóìÔ∏è</span>Team Calendar</div>
      </div>
    </div>
    <div class="main-content">

      <div id="section-adm-dashboard" class="admin-section" style="display:block;">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">Admin Dashboard</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Welcome back, <strong id="dash-admin-name"></strong>. Here's your team at a glance.</p>
        <div class="stats-grid" id="dash-stats"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="card"><div class="card-title">‚è≥ Pending Time Off Requests</div><div id="dash-pending-list" style="font-size:13px;color:#888;">Loading...</div></div>
          <div class="card"><div class="card-title">üö© Attendance Flags</div><div id="dash-flags-list" style="font-size:13px;color:#888;">Loading...</div></div>
        </div>
      </div>

      <div id="section-adm-manager-guide" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">üìò Supervisor &amp; Manager Guide</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Version 1.0 ¬∑ February 2026 ¬∑ Confidential</p>
        <div class="doc-reader">
          <div class="doc-nav"><div class="doc-nav-title">RideSource Supervisor &amp; Manager Guide</div></div>
          <div class="doc-tabs" id="mgr-tabs"></div>
          <div class="doc-body" id="mgr-body"></div>
          <div class="doc-footer">
            <div style="font-size:12px;color:#888;">Confidential ‚Äî Management Use Only</div>
            <div style="display:flex;gap:8px;"><button class="btn btn-secondary btn-sm" onclick="changeMgrSection(-1)">‚Üê Previous</button><button class="btn btn-primary btn-sm" onclick="changeMgrSection(1)">Next ‚Üí</button></div>
          </div>
        </div>
      </div>

      <div id="section-adm-handbook-ref" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">üìñ Employee Handbook Reference</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Read-only reference copy.</p>
        <div class="card" style="padding:16px 20px;background:var(--light);border-color:#b8ccf0;">
          <p style="font-size:13px;color:var(--navy);font-weight:600;">üìå Printed Copy Requests</p>
          <div id="print-requests-list" style="margin-top:12px;font-size:13px;color:#888;">Loading...</div>
        </div>
        <div class="doc-reader" style="margin-top:16px;">
          <div class="doc-nav"><div class="doc-nav-title">Employee Handbook v3.0 ‚Äî Reference Copy</div></div>
          <div class="doc-tabs" id="hb-ref-tabs"></div>
          <div class="doc-body" id="hb-ref-body"></div>
          <div class="doc-footer">
            <div style="font-size:12px;color:#888;">Read-only reference</div>
            <div style="display:flex;gap:8px;"><button class="btn btn-secondary btn-sm" onclick="changeHbRefSection(-1)">‚Üê Previous</button><button class="btn btn-primary btn-sm" onclick="changeHbRefSection(1)">Next ‚Üí</button></div>
          </div>
        </div>
      </div>

      <div id="section-adm-templates" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">üìÑ HR Templates</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Fill out any template below and download it as a Word document (.docx).</p>
        <div style="font-size:12px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Hiring</div>
        <div class="template-grid" style="margin-bottom:24px;">
          <div class="template-card" onclick="openTemplate('welcome')"><div class="template-icon">üéâ</div><div class="template-name">Welcome Aboard Letter</div><div class="template-desc">New hire welcome letter with training instructions.</div></div>
          <div class="template-card" onclick="openTemplate('rejection')"><div class="template-icon">üì®</div><div class="template-name">Letter of Rejection</div><div class="template-desc">Professional rejection letter for applicants not selected.</div></div>
          <div class="template-card" onclick="openTemplate('interview')"><div class="template-icon">üó£Ô∏è</div><div class="template-name">Interview Questions Form</div><div class="template-desc">Standardized driver interview form with hire decision.</div></div>
        </div>
        <div style="font-size:12px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">New Employee Forms</div>
        <div class="template-grid" style="margin-bottom:24px;">
          <div class="template-card" onclick="openTemplate('driverinfo')"><div class="template-icon">ü™™</div><div class="template-name">Driver Info Form</div><div class="template-desc">New driver candidate information.</div></div>
          <div class="template-card" onclick="openTemplate('emergency')"><div class="template-icon">üö®</div><div class="template-name">Emergency Contact Form</div><div class="template-desc">Employee emergency contacts with signature block.</div></div>
          <div class="template-card" onclick="openTemplate('consent')"><div class="template-icon">üìã</div><div class="template-name">Consent for Certification Release</div><div class="template-desc">Authorization for release of training certifications.</div></div>
        </div>
        <div style="font-size:12px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Separation &amp; HR</div>
        <div class="template-grid">
          <div class="template-card" onclick="openTemplate('resignation')"><div class="template-icon">üìù</div><div class="template-name">Voluntary Resignation Acknowledgment</div><div class="template-desc">Formal acknowledgment with off-boarding checklist.</div></div>
          <div class="template-card" onclick="openTemplate('warn-standard')"><div class="template-icon">‚ö†Ô∏è</div><div class="template-name">Attendance Warning ‚Äî Standard</div><div class="template-desc">Written attendance warning.</div></div>
          <div class="template-card" onclick="openTemplate('warn-callout')"><div class="template-icon">üìµ</div><div class="template-name">Attendance Warning ‚Äî Call-Out After Trip</div><div class="template-desc">Warning for call-outs after manifest finalized.</div></div>
          <div class="template-card" onclick="openTemplate('warn-final')"><div class="template-icon">üö®</div><div class="template-name">Final Written Warning</div><div class="template-desc">Last step before termination.</div></div>
        </div>
      </div>

      <div id="section-adm-warnings" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">‚ö†Ô∏è Attendance Warning Generator</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">System automatically detects employees with 3+ call-outs in 30 days.</p>
        <div id="flagged-employees" style="margin-bottom:20px;"><p style="font-size:13px;color:#888;">Loading attendance data...</p></div>
        <div class="card">
          <div class="card-title">üîç Manual Warning Lookup</div>
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-field"><label>Employee Name</label><input type="text" id="manual-name" placeholder="Enter employee name..."></div>
            <div class="form-field"><label>County</label><select id="manual-county"><option value="">All Counties</option><option>Androscoggin</option><option>Aroostook</option><option>Cumberland</option><option>Franklin</option><option>Hancock</option><option>Kennebec</option><option>Knox</option><option>Lincoln</option><option>Oxford</option><option>Penobscot</option><option>Piscataquis</option><option>Sagadahoc</option><option>Somerset</option><option>Waldo</option><option>Washington</option><option>York</option></select></div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="manualLookup()">Search Call-Out History</button>
          <div id="manual-results" style="margin-top:14px;"></div>
        </div>
      </div>

      <div id="section-adm-onboarding-tracker" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">‚úÖ Onboarding Tracker</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Track which employees have completed policy acknowledgments.</p>
        <div id="onboarding-data" style="font-size:13px;color:#888;">Loading...</div>
      </div>

      <div id="section-adm-requests" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">üìÖ Time Off Requests</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Review and approve or deny employee time off requests.</p>
        <div id="requests-table">Loading...</div>
      </div>

      <div id="section-adm-callouts" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">üìû Call-Out Log</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Log employee call-outs. This data powers the attendance warning system automatically.</p>
        <div class="card" style="margin-bottom:16px;">
          <div class="card-title">Log a New Call-Out</div>
          <div class="form-row">
            <div class="form-field"><label>Employee Name</label><input type="text" id="co-name" placeholder="Full name..."></div>
            <div class="form-field"><label>County</label><select id="co-county"><option value="">Select county</option><option>Androscoggin</option><option>Aroostook</option><option>Cumberland</option><option>Franklin</option><option>Hancock</option><option>Kennebec</option><option>Knox</option><option>Lincoln</option><option>Oxford</option><option>Penobscot</option><option>Piscataquis</option><option>Sagadahoc</option><option>Somerset</option><option>Waldo</option><option>Washington</option><option>York</option></select></div>
          </div>
          <div class="form-row">
            <div class="form-field"><label>Call-Out Date</label><input type="date" id="co-date"></div>
            <div class="form-field"><label>Reason</label><select id="co-reason"><option>Sick</option><option>Family Emergency</option><option>Weather</option><option>No reason provided</option><option>Other</option></select></div>
          </div>
          <div class="form-field"><label>Notes</label><input type="text" id="co-notes" placeholder="Optional notes..."></div>
          <button class="btn btn-primary" onclick="logCallOut()">Log Call-Out</button>
          <span id="co-msg" style="font-size:13px;color:var(--success);margin-left:12px;display:none;">‚úì Logged!</span>
        </div>
        <div class="card"><div class="card-title">Recent Call-Outs</div><div id="callout-table">Loading...</div></div>
      </div>

      <div id="section-adm-calendar" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">üóìÔ∏è Team Calendar</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Approved time off and call-outs, color-coded by county.</p>
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <button class="btn btn-secondary btn-sm" onclick="changeMonth(-1)">‚Üê Previous</button>
            <div style="font-size:16px;font-weight:700;color:var(--navy);" id="cal-title"></div>
            <button class="btn btn-secondary btn-sm" onclick="changeMonth(1)">Next ‚Üí</button>
          </div>
          <div id="cal-grid"></div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:16px;" id="cal-legend"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Policy Modal -->
<div class="modal-overlay" id="policy-modal">
  <div class="modal">
    <button class="modal-close" onclick="closePolicyModal()">‚úï</button>
    <h3 id="modal-title">Policy Title</h3>
    <p id="modal-desc">Please read the policy below, then provide your signature.</p>
    <div class="modal-body" id="modal-body" onscroll="checkModalScroll()"></div>
    <div class="sig-field"><label>Electronic Signature (type your full legal name)</label><input type="text" id="modal-sig" placeholder="Type your full name to sign..." oninput="checkModalSig()"></div>
    <div class="sig-legal">By typing your name, you are providing a legally binding electronic signature (E-SIGN Act).</div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
      <button class="btn-secondary" onclick="closePolicyModal()">Cancel</button>
      <button class="btn-primary" id="modal-sign-btn" onclick="signPolicy()" disabled>Sign &amp; Acknowledge</button>
    </div>
  </div>
</div>

<!-- HR Template Modal -->
<div class="modal-overlay" id="template-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('template-modal')">‚úï</button>
    <h3 id="tmpl-title">Template</h3>
    <p id="tmpl-desc">Fill in the fields below, then download your Word document.</p>
    <div id="tmpl-form"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
      <button class="btn btn-secondary" onclick="closeModal('template-modal')">Cancel</button>
      <button class="btn btn-primary" id="tmpl-download-btn" onclick="downloadTemplate()">‚¨áÔ∏è Download Word Doc</button>
    </div>
  </div>
</div>

<!-- Warning Modal -->
<div class="modal-overlay" id="warning-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('warning-modal')">‚úï</button>
    <h3 id="warn-modal-title">Attendance Warning</h3>
    <p id="warn-modal-desc">Review and edit the warning below before generating.</p>
    <div id="warn-form"></div>
    <div class="preview-box" id="warn-preview" style="display:none;"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;">
      <button class="btn btn-secondary" onclick="closeModal('warning-modal')">Cancel</button>
      <button class="btn btn-red" id="warn-gen-btn" onclick="generateWarning()">Generate Warning Letter</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
const SUPABASE_URL='https://iasphxpahlmjwkapyxrs.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlhc3BoeHBhaGxtandrYXB5eHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNDIyNDYsImV4cCI6MjA4NjkxODI0Nn0.ntQxEiEJqZOvXjfX58I-PPQ2ZOoAT_RgLyf3aWMeXds';
const EMAILJS_SERVICE_ID='ridesource_calendar';
const EMAILJS_PUBLIC_KEY='AoArkSo12DpQtsvZZ';
const SUPERVISOR_EMAIL='tiffanyb@ridesourcemaine.com';
const PORTAL_URL='https://ridesourcecalendar-hub.github.io/ridesource-onboarding/index.html';
const ADMIN_PASSWORD='RideSource2026!';

const {createClient}=supabase;
const db=createClient(SUPABASE_URL,SUPABASE_KEY);
if(typeof emailjs!=='undefined'){emailjs.init({publicKey:EMAILJS_PUBLIC_KEY});}

// ‚îÄ‚îÄ LANDING ‚îÄ‚îÄ
function switchLanding(mode){
  document.getElementById('landing-employee').style.display=mode==='employee'?'block':'none';
  document.getElementById('landing-admin').style.display=mode==='admin'?'block':'none';
  document.getElementById('tab-emp').classList.toggle('active',mode==='employee');
  document.getElementById('tab-adm').classList.toggle('active',mode==='admin');
}

// ‚îÄ‚îÄ EMPLOYEE AUTH ‚îÄ‚îÄ
let user=null,trainingSection=0,handbookSection=0;
let trainingSectionRead={},handbookSectionRead={};
let trainingComplete=false,handbookComplete=false,handbookSigChoice=null;
let currentPolicyIndex=null,modalScrolled=false,currentReqType=null;

function startPortal(){
  const name=document.getElementById('login-name').value.trim();
  const email=document.getElementById('login-email').value.trim();
  const county=document.getElementById('login-county').value;
  if(!name||!email||!county){document.getElementById('login-error').style.display='block';return;}
  document.getElementById('login-error').style.display='none';
  user={name,email,county};
  document.getElementById('display-name').textContent=name;
  document.getElementById('screen-landing').classList.remove('active');
  document.getElementById('screen-portal').classList.add('active');
  loadSavedState();buildTraining();buildHandbook();buildPolicies();updateDashboard();
}

function logout(){
  saveState();user=null;trainingSection=0;handbookSection=0;
  trainingSectionRead={};handbookSectionRead={};trainingComplete=false;handbookComplete=false;
  document.getElementById('screen-portal').classList.remove('active');
  document.getElementById('screen-landing').classList.add('active');
}

// ‚îÄ‚îÄ ADMIN AUTH ‚îÄ‚îÄ
let adminName='',mgrSection=0,hbRefSection=0;
let calYear=new Date().getFullYear(),calMonth=new Date().getMonth(),warningData=null;

function adminLogin(){
  const name=document.getElementById('admin-name').value.trim();
  const pass=document.getElementById('admin-pass').value;
  if(pass!==ADMIN_PASSWORD||!name){document.getElementById('admin-error').style.display='block';return;}
  document.getElementById('admin-error').style.display='none';
  adminName=name;
  document.getElementById('admin-display').textContent=name;
  document.getElementById('dash-admin-name').textContent=name.split(' ')[0];
  document.getElementById('screen-landing').classList.remove('active');
  document.getElementById('screen-admin').classList.add('active');
  buildMgrGuide();buildHbRef();
  loadDashboard();loadRequests();loadCallOuts();loadFlags();loadOnboarding();renderCalendar();
}

function adminLogout(){
  document.getElementById('screen-admin').classList.remove('active');
  document.getElementById('screen-landing').classList.add('active');
  document.getElementById('admin-pass').value='';
  switchLanding('admin');
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function showSection(id){
  document.querySelectorAll('.portal-section').forEach(el=>el.style.display='none');
  document.querySelectorAll('#screen-portal .nav-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('section-'+id).style.display='block';
  document.getElementById('nav-'+id).classList.add('active');
}
function showAdmin(id){
  document.querySelectorAll('.admin-section').forEach(el=>el.style.display='none');
  document.querySelectorAll('#screen-admin .nav-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('section-adm-'+id).style.display='block';
  document.getElementById('nav-adm-'+id).classList.add('active');
}
function closeModal(id){document.getElementById(id).classList.remove('open');}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
function saveState(){
  if(!user)return;
  localStorage.setItem('rs_'+user.email,JSON.stringify({trainingSectionRead,handbookSectionRead,trainingComplete,handbookComplete,handbookSigChoice}));
}
function loadSavedState(){
  const d=JSON.parse(localStorage.getItem('rs_'+user.email)||'{}');
  trainingSectionRead=d.trainingSectionRead||{};handbookSectionRead=d.handbookSectionRead||{};
  trainingComplete=d.trainingComplete||false;handbookComplete=d.handbookComplete||false;handbookSigChoice=d.handbookSigChoice||null;
}

// ‚îÄ‚îÄ POLICIES ‚îÄ‚îÄ
const POLICIES=[
  {id:'at_will',name:'At-Will Employment Policy',desc:'Confirms your employment relationship with RideSource',content:`<h2>At-Will Employment</h2><p>Employment at RideSource Inc. is at-will. Either you or RideSource may end the employment relationship at any time, with or without cause, provided there is no violation of applicable federal or state law.</p><p>No manager, supervisor, or representative of RideSource has authority to enter into any employment agreement other than at-will.</p><p>This handbook does not create and is not intended to create a promise or representation of continued employment.</p>`},
  {id:'hipaa',name:'HIPAA & Confidentiality Policy',desc:'Protects client health information ‚Äî critical for NEMT operations',content:`<h2>HIPAA & Confidentiality</h2><p>All passenger information is strictly confidential. This includes names, addresses, phone numbers, destinations, family information, and any personal circumstances including health information and immigration status.</p><h3>Your Obligations</h3><ul><li>Protect all Protected Health Information (PHI) at all times</li><li>Never discuss client information in public settings</li><li>Secure all paperwork and electronic devices</li><li>Never discuss one client's information with another client</li><li>Report suspected privacy breaches to your supervisor immediately</li></ul><div class="callout"><strong>‚ö†Ô∏è Important</strong>Confidentiality violations may result in immediate termination. This obligation continues after your employment ends.</div>`},
  {id:'conduct',name:'Employee Code of Conduct',desc:'Professional standards, HIPAA compliance, safety, and ethics',content:`<h2>Employee Code of Conduct</h2><h3>Professional Expectations</h3><p>Employees must maintain a respectful, calm, and professional demeanor; use appropriate and courteous language; maintain client dignity at all times; protect confidentiality; and maintain appropriate professional boundaries.</p><h3>Prohibited Conduct</h3><ul><li>Complain about RideSource, coworkers, supervisors, pay, or policies to clients</li><li>Discuss politics, religion, or controversial topics with passengers</li><li>Share personal contact information with clients</li><li>Connect with clients on social media</li><li>Form personal relationships with clients</li></ul><h3>Disciplinary Action</h3><p>RideSource utilizes progressive discipline: Verbal Warning ‚Üí Written Warning ‚Üí Final Warning/Suspension ‚Üí Termination. Immediate termination may occur for HIPAA violations, falsification of records, impaired driving, or serious safety violations.</p><div class="callout"><strong>Non-Retaliation</strong>RideSource prohibits retaliation against clients or staff who file complaints in good faith.</div>`},
  {id:'safety',name:'Safety & Vehicle Policy',desc:'Driving safety, vehicle inspection, and emergency procedures',content:`<h2>Safety & Vehicle Policy</h2><p>RideSource prioritizes the safety of every client and every employee. Safety is not optional ‚Äî it is the foundation of everything we do.</p><h3>Driving Safety</h3><ul><li>Avoid all forms of distracted driving</li><li>Never use a handheld cell phone while driving ‚Äî hands-free only</li><li>Never drive over the speed limit</li><li>Ensure all passengers are properly secured before moving the vehicle</li><li>Never transport a child without an appropriate car seat</li></ul><h3>Vehicle Inspection</h3><ul><li>Complete a pre-trip and post-trip inspection every shift</li><li>Report all mechanical issues or damage immediately</li><li>Do not operate a vehicle you believe is unsafe</li><li>Vehicles must be left with at least one-half tank of fuel</li></ul><h3>Incident Reporting</h3><p>All accidents, near-misses, and passenger incidents must be reported to your supervisor immediately.</p>`},
  {id:'attendance',name:'Attendance & Punctuality Policy',desc:'Call-out procedures, time off requests, and no-call/no-show policy',content:`<h2>Attendance & Punctuality</h2><p>Reliable attendance is essential to RideSource's ability to provide dependable service.</p><h3>Call-Out Procedure</h3><p>Notify your supervisor no later than <strong>one hour before</strong> your scheduled start time.</p><h3>No-Call / No-Show Policy</h3><ul><li>First offense ‚Äî Verbal warning</li><li>Second offense ‚Äî Written warning</li><li>Third offense ‚Äî Final warning; continued issues may result in termination</li></ul><h3>Time Off Requests</h3><p>All planned time off must be submitted a minimum of <strong>two weeks in advance</strong> through the Staff Portal.</p><div class="callout"><strong>Job Abandonment</strong>Employees who fail to report or contact their supervisor for three consecutive workdays are considered to have voluntarily abandoned their position.</div>`},
  {id:'drug_free',name:'Drug-Free Workplace Policy',desc:'Substance use, testing requirements, and employee assistance',content:`<h2>Drug-Free Workplace</h2><p>The use, possession, sale, or distribution of alcohol or controlled substances on duty, on company property, or in company vehicles is strictly prohibited.</p><h3>Required Testing</h3><ul><li><strong>Pre-employment</strong> ‚Äî May be required before beginning work</li><li><strong>Reasonable suspicion</strong> ‚Äî Based on supervisor observations of apparent impairment</li><li><strong>Post-accident</strong> ‚Äî Required when an employee causes or contributes to an accident</li></ul><p>Employees who refuse to cooperate with required testing will be terminated.</p>`},
  {id:'non_compete',name:'Non-Compete & Separation Policy',desc:'Post-employment obligations and return of company property',content:`<h2>Non-Compete & Separation Policy</h2><h3>Non-Compete Agreement</h3><p>For a period of <strong>24 months</strong> following the end of employment, former employees may not engage in the same or similar activities as those performed for RideSource in any business operating within <strong>50 miles</strong> of a RideSource office.</p><h3>Resignation</h3><p>Employees are asked to provide at least <strong>two weeks' written notice</strong>.</p><h3>Return of Property</h3><p>Upon separation, employees must return all company property on or before their last day.</p><div class="callout"><strong>Post-Employment Confidentiality</strong>Your confidentiality obligations remain in full effect after your employment ends.</div>`}
];

// ‚îÄ‚îÄ TRAINING SECTIONS ‚îÄ‚îÄ
const TRAINING_SECTIONS=[
  {title:'Welcome',content:`<h1>Welcome to RideSource!</h1><p>We are excited to have you on board. This guide walks you through everything from your first day of online training to your first day driving solo.</p><div class="callout"><strong>Your Training Journey at a Glance</strong><table style="width:100%;font-size:13px;margin-top:8px;border-collapse:collapse;"><tr style="background:#dde8f7;"><th style="padding:6px 10px;text-align:left;">Stage</th><th style="padding:6px 10px;text-align:left;">Timing</th><th style="padding:6px 10px;text-align:left;">What Happens</th></tr><tr><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Online Training</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Days 1‚Äì2 (at home)</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">PASS, Defensive Driving, Online CPR/AED/First Aid ‚Äî unpaid</td></tr><tr><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Day 3</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">At office/in vehicle</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Ride with seasoned driver ‚Äî observe, learn vehicle basics</td></tr><tr><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Day 4</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">In vehicle</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Continue ride-along, begin Android dispatch device training</td></tr><tr><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Day 5</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">In vehicle</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">You drive ‚Äî trainer observes. Company phone issued.</td></tr><tr><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Day 6</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">At office</td><td style="padding:6px 10px;border-bottom:1px solid #ccc;">Policies, handbook, badge photo, timesheet, fuel card</td></tr><tr><td style="padding:6px 10px;">Day 7+</td><td style="padding:6px 10px;">Solo</td><td style="padding:6px 10px;">You are on the road independently!</td></tr></table></div><p><strong>RideSource covers the cost of all required online courses.</strong></p>`},
  {title:'Days 1‚Äì2: Online',content:`<h1>Days 1‚Äì2 ‚Äî Online Training (At Home)</h1><p>Complete all three courses on Days 1 and 2 before your first hands-on day.</p><h2>Required Courses</h2><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>PASS Training</strong><br>Complete the full PASS course online. Certificate required.</div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Defensive Driving</strong><br>Complete the full Defensive Driving course online. Certificate required.</div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Online CPR / AED / First Aid</strong><br>Complete the online course. Certificate required.</div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Submit all three certificates to your supervisor</strong><br>Email or bring printed copies on Day 3.</div></div><div class="callout" style="border-left-color:var(--warn);background:#fff8ee;"><strong>&#9888; In-Person CPR/AED ‚Äî Required Within 60 Days of Hire</strong><br>Separate from the online course. HR will schedule this session.</div>`},
  {title:'Day 3: Vehicle',content:`<h1>Day 3 ‚Äî Vehicle Basics &amp; Ride-Along</h1><p>Today you ride as a passenger with your trainer. Observe, ask questions, and get comfortable with the vehicle and daily routine.</p><h2>Vehicle Familiarization</h2><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Pre-trip inspection procedure</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Interior layout &amp; controls</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Wheelchair lift / ramp operation</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Safety equipment locations</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Fuel card &amp; fueling procedure</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Car seats ‚Äî locations and securement</strong></div></div><h2>Daily Operations</h2><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Manifest review</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Dispatch communication</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Passenger pick-up &amp; drop-off procedures</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>End-of-day procedures</strong></div></div>`},
  {title:'Day 4: Android',content:`<h1>Day 4 ‚Äî Android Dispatch Device Training</h1><p>Today you begin hands-on training with the Android dispatch device while riding along.</p><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Device overview and login</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Viewing your manifest on the device</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Starting your route</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Passenger status updates ‚Äî pick-ups, drop-offs, no-shows</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Communicating with Dispatch through the app</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>GPS &amp; navigation features</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>End-of-route closeout</strong></div></div><div class="callout"><strong>Technical Issues</strong>If you experience a technical issue with the dispatch app, contact your supervisor immediately.</div>`},
  {title:'Day 5: Solo Eval',content:`<h1>Day 5 ‚Äî Solo Drive with Observer</h1><p>Today you are in the driver's seat. Your trainer rides along to observe ‚Äî but <strong>you</strong> are running the route.</p><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Pre-trip inspection completed independently</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Manifest reviewed and route understood before departure</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Android device operated throughout the route</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Passenger boarding &amp; safety protocols followed</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Safe and professional driving demonstrated</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>End-of-route closeout completed</strong></div></div><h2>Equipment Issued Today</h2><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Company phone issued &amp; set up</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Full-Time: Vehicle keys issued</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Part-Time: Key storage orientation</strong></div></div>`},
  {title:'Day 6: Office',content:`<h1>Day 6 ‚Äî Office Orientation Session</h1><p>This session covers the administrative side of your role.</p><h2>Policies &amp; Handbook</h2><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Employee Handbook review</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Policy acknowledgments via Digital Signature Tracker</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Attendance &amp; Punctuality Standards</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Drug &amp; Alcohol-Free Workplace</strong></div></div><h2>Administrative Setup</h2><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Badge ID photo taken</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Timesheet process reviewed</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Time Off Request Portal walkthrough</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Fuel card issued &amp; protocols reviewed</strong></div></div><div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Pay schedule &amp; direct deposit confirmed</strong></div></div><div class="callout"><strong>Training Complete!</strong>You have received, reviewed, and understood all policies, procedures, and operational requirements. Welcome to the team!</div>`}
];

// ‚îÄ‚îÄ HANDBOOK SECTIONS ‚îÄ‚îÄ
const HANDBOOK_SECTIONS=[
  {title:'Sec 1: Welcome',content:`<h1>Section 1: Welcome & Company Overview</h1><h2>1.1 Welcome Message</h2><p>Welcome to RideSource Inc. We are proud to have you join our team. RideSource is a Non-Emergency Medical Transportation (NEMT) company based in Norway, Maine, committed to providing reliable, safe, and compassionate transportation services.</p><h2>1.2 Mission & Values</h2><p><strong>Mission:</strong> To provide safe, reliable, and dignified transportation services that connect passengers to the care and resources they need ‚Äî every trip, every time.</p><ul><li><strong>Safety First</strong> ‚Äî Every decision prioritizes safety</li><li><strong>Reliability</strong> ‚Äî We show up on time, every time</li><li><strong>Dignity & Respect</strong> ‚Äî Every passenger treated with compassion</li><li><strong>Accountability</strong> ‚Äî We take responsibility for our service</li><li><strong>Community</strong> ‚Äî Proud to serve the communities of Maine</li></ul>`},
  {title:'Sec 2: Employment',content:`<h1>Section 2: Employment Requirements</h1><h2>2.1 Requirements</h2><ul><li>Must be at least 25 years of age with a valid license for at least five years</li><li>No more than one chargeable accident or moving violation in the last ten years</li><li>Must not have been convicted of any felony-level crime</li><li>Must be professional, courteous, patient, and neat in appearance</li><li>Must wear a visible name tag at all times while on duty</li></ul><h2>2.3 At-Will Employment</h2><p>Employment at RideSource Inc. is at-will. Either you or RideSource may end the employment relationship at any time, with or without cause.</p><h2>2.6 Introductory Period</h2><p>All new employees serve a 90-day introductory period.</p>`},
  {title:'Sec 3: Conduct',content:`<h1>Section 3: Workplace Conduct</h1><h2>3.2 Confidentiality</h2><p>All passenger information is strictly confidential. HIPAA violations may result in immediate termination. This obligation continues after employment ends.</p><h2>3.3 Personal Appearance</h2><p>All employees must project a professional image. Clothing must be consistent with a professional transportation environment.</p><h2>3.5 Social Media</h2><p>Do not post passenger information, vehicle photos, or any content that could harm RideSource or its passengers.</p>`},
  {title:'Sec 4: Attendance',content:`<h1>Section 4: Attendance, Time & Scheduling</h1><h2>4.1 Attendance Policy</h2><p>Notify supervisor no later than <strong>one hour before</strong> scheduled start time.</p><h3>No-Call/No-Show Policy</h3><ul><li>1st offense ‚Äî Verbal warning</li><li>2nd offense ‚Äî Written warning</li><li>3rd offense ‚Äî Final warning; termination possible</li></ul><p>All planned time off submitted minimum <strong>two weeks in advance</strong> through the Staff Portal.</p><h2>4.3 Parascope & Trip Documentation</h2><ul><li>Select "On the Way" when departing for pickup ‚Äî not when arriving</li><li>Complete each trip in Parascope promptly after drop-off</li><li>Obtain required passenger or guardian signature for every trip</li></ul>`},
  {title:'Sec 5: Compensation',content:`<h1>Section 5: Compensation & Performance</h1><h2>5.1 Pay Periods</h2><p>Biweekly pay. Wages paid for period ending previous Friday; paydays generally fall on <strong>Wednesdays</strong>. Direct deposit required.</p><h2>5.2 Performance Reviews</h2><p>Annual reviews. Compensation adjustments based on performance, attendance, and business needs. Not automatic.</p><h2>5.4 Timekeeping</h2><p>All employees must accurately record hours using the TWE system. Falsification may result in termination.</p>`},
  {title:'Sec 6: Benefits',content:`<h1>Section 6: Benefits & Insurance</h1><p>RideSource offers a benefits package to eligible employees. Contact management for current benefit offerings.</p><h2>6.4 Workers' Compensation</h2><p>All employees covered by Maine workers' compensation. Report any injury to supervisor immediately.</p><h2>6.5 Leave Policies</h2><p>RideSource complies with all applicable federal and state leave laws including FMLA, military leave, jury duty, and bereavement leave.</p>`},
  {title:'Sec 7: Safety',content:`<h1>Section 7: Workplace Safety & Health</h1><h2>7.2 Drug-Free Workplace</h2><p>No alcohol or controlled substances on duty, on company property, or in company vehicles. Pre-employment, reasonable suspicion, and post-accident testing required.</p><h2>7.4 Incident Reporting</h2><p>All accidents, near-misses, and incidents must be reported immediately. Keep calm ‚Üí Contact dispatcher ‚Üí Protect passengers ‚Üí Complete all reports.</p><h2>7.7 Smoking & Tobacco</h2><p>Prohibited in all company vehicles, on all company property, and at all company-sponsored events.</p>`},
  {title:'Sec 8: Operations',content:`<h1>Section 8: Transportation Operations</h1><h2>8.1 Passenger Identity Verification</h2><p>Verify the passenger matches the manifest before every trip. Do not transport anyone not listed.</p><h2>8.2 Trip Assignment</h2><p>Drivers may not pick and choose trips or clients. Refusal may result in termination.</p><h2>8.6 Hands-Free Policy</h2><p>Maine law prohibits holding devices while driving. Company-issued Bluetooth device and mount must be used.</p><h2>8.7 Dash Camera System</h2><p>All RideSource vehicles are equipped with dash cameras. Footage reviewed only in the event of a complaint or incident.</p>`},
  {title:'Sec 9-10: Dev',content:`<h1>Sections 9 & 10: Development & Separation</h1><h2>10.2 Disciplinary Process</h2><ul><li>Verbal Warning ‚Üí Written Warning ‚Üí Final Warning/PIP ‚Üí Termination</li><li>Immediate termination for: HIPAA violations, falsification, impaired driving, harassment, camera tampering</li></ul><h2>10.3 Separation</h2><p>Two weeks' written notice requested. Job abandonment (3 missed days without contact) = ineligible for rehire. All company property returned on last day.</p><h2>10.4 Non-Compete</h2><p>24-month non-compete within 50 miles of any RideSource office following separation.</p>`},
  {title:'Sec 11: Sign',content:`<h1>Section 11: Acknowledgment</h1><p>You have reached the final section of the Employee Handbook. Please scroll down to the acknowledgment block and complete your signature.</p><div class="callout"><strong>Final Certification</strong>By signing, I certify that I have received and reviewed the RideSource Inc. Employee Handbook, that I understand my responsibilities as an employee, and that I agree to comply with all policies contained herein. I acknowledge that this handbook does not constitute a contract of employment, that my employment is at-will, and that my post-employment confidentiality obligations remain in effect after separation.</div><p>Please scroll down to complete your signature below.</p>`}
];

// ‚îÄ‚îÄ DOCUMENT READER ‚îÄ‚îÄ
function buildReader(type,sections){
  const tabs=document.getElementById(type+'-tabs');
  tabs.innerHTML=sections.map((s,i)=>`<div class="doc-tab ${i===0?'active':''}" id="${type}-tab-${i}" onclick="goToSection('${type}',${i})">${s.title}</div>`).join('');
  renderSection(type,0,sections);
}
function buildTraining(){buildReader('training',TRAINING_SECTIONS);}
function buildHandbook(){buildReader('handbook',HANDBOOK_SECTIONS);}

function renderSection(type,idx,sections){
  const s=sections||(type==='training'?TRAINING_SECTIONS:HANDBOOK_SECTIONS);
  document.getElementById(type+'-body').innerHTML=s[idx].content;
  document.getElementById(type+'-body').scrollTop=0;
  document.getElementById(type+'-progress-label').textContent=`Section ${idx+1} of ${s.length}`;
  document.querySelectorAll(`#${type}-tabs .doc-tab`).forEach((t,i)=>{
    t.classList.toggle('active',i===idx);
    if((type==='training'?trainingSectionRead:handbookSectionRead)[i])t.classList.add('completed');
  });
  const nextBtn=document.getElementById(type+'-next');
  const prevBtn=document.getElementById(type+'-prev');
  prevBtn.disabled=idx===0;
  const readMap=type==='training'?trainingSectionRead:handbookSectionRead;
  if(readMap[idx]){nextBtn.disabled=false;document.getElementById(type+'-scroll-note').textContent='‚úÖ Section read.';}
  else{nextBtn.disabled=true;document.getElementById(type+'-scroll-note').textContent='üìñ Scroll to the bottom to continue.';}
  const isLast=idx===s.length-1;
  nextBtn.textContent=isLast?(type==='handbook'?'Complete & Sign ‚Üí':'Finish Training Guide ‚Üí'):'Next Section ‚Üí';
}

function goToSection(type,idx){
  if(type==='training'){trainingSection=idx;renderSection('training',idx);}
  else{handbookSection=idx;renderSection('handbook',idx);}
}

function changeSection(type,dir){
  const sections=type==='training'?TRAINING_SECTIONS:HANDBOOK_SECTIONS;
  const current=type==='training'?trainingSection:handbookSection;
  const next=current+dir;
  if(next<0||next>sections.length)return;
  if(next===sections.length){
    if(type==='training'){trainingComplete=true;showTrainingComplete();saveState();updateDashboard();}
    else{showHandbookSig();}
    return;
  }
  if(type==='training'){trainingSection=next;renderSection('training',next);}
  else{handbookSection=next;renderSection('handbook',next);}
}

function checkScroll(type){
  const body=document.getElementById(type+'-body');
  const atBottom=body.scrollHeight-body.scrollTop-body.clientHeight<40;
  if(!atBottom)return;
  const idx=type==='training'?trainingSection:handbookSection;
  const readMap=type==='training'?trainingSectionRead:handbookSectionRead;
  if(!readMap[idx]){
    readMap[idx]=true;
    document.getElementById(type+'-next').disabled=false;
    document.getElementById(type+'-scroll-note').textContent='‚úÖ Section read.';
    const tab=document.getElementById(`${type}-tab-${idx}`);
    if(tab)tab.classList.add('completed');
    saveState();updateDashboard();
  }
}

function showTrainingComplete(){
  document.getElementById('training-complete-banner').style.display='block';
  document.getElementById('section-training').querySelector('.doc-reader').style.display='none';
}
function showHandbookSig(){
  document.getElementById('handbook-sig').style.display='block';
  handbookSection=HANDBOOK_SECTIONS.length-1;
  handbookSectionRead[HANDBOOK_SECTIONS.length-1]=true;
  saveState();
}

// ‚îÄ‚îÄ HANDBOOK SIG ‚îÄ‚îÄ
function selectHandbookOpt(val){
  handbookSigChoice=val;
  document.getElementById('opt-print').classList.toggle('selected',val==='print');
  document.getElementById('opt-digital').classList.toggle('selected',val==='digital');
  document.getElementById('rb-'+val).checked=true;
  checkHbSig();
}
function checkHbSig(){
  const sig=document.getElementById('hb-sig-input')?.value.trim();
  const btn=document.getElementById('hb-submit-btn');
  if(btn)btn.disabled=!(sig&&handbookSigChoice);
}
async function submitHandbookSig(){
  const sig=document.getElementById('hb-sig-input').value.trim();
  const btn=document.getElementById('hb-submit-btn');
  btn.disabled=true;btn.textContent='Saving...';
  try{await db.from('handbook_signatures').insert([{employee_name:user.name,employee_email:user.email,county:user.county,handbook_version:'3.0',signature:sig,print_requested:handbookSigChoice==='print',signed_at:new Date().toISOString()}]);}catch(e){console.log(e);}
  handbookComplete=true;saveState();
  document.getElementById('handbook-sig').innerHTML=`<div class="success-banner"><div class="big-check">‚úÖ</div><h2>Handbook Acknowledged!</h2><p>${handbookSigChoice==='print'?'A printed copy has been requested.':'Your digital acknowledgment has been recorded.'}</p><button class="btn-primary" style="margin-top:16px;background:rgba(255,255,255,0.2);border:2px solid rgba(255,255,255,0.5);" onclick="showSection('policies')">Continue to Policy Sign-Offs ‚Üí</button></div>`;
  updateDashboard();
}

// ‚îÄ‚îÄ POLICIES ‚îÄ‚îÄ
function buildPolicies(){
  document.getElementById('policy-list').innerHTML=POLICIES.map((p,i)=>`<div class="policy-item" id="pol-${p.id}" data-signed="0"><div class="policy-check" id="check-${p.id}">‚Äì</div><div class="policy-info"><div class="policy-name">${p.name}</div><div class="policy-desc">${p.desc}</div><div class="policy-time" id="time-${p.id}"></div></div><button class="policy-btn policy-btn-read" id="pbtn-${p.id}" onclick="openPolicyModal(${i})">Read & Sign</button></div>`).join('');
  updateBadge();
}
function openPolicyModal(idx){
  currentPolicyIndex=idx;modalScrolled=false;
  const p=POLICIES[idx];
  document.getElementById('modal-title').textContent=p.name;
  document.getElementById('modal-desc').textContent='Read the full policy below, then type your name to sign.';
  document.getElementById('modal-body').innerHTML=p.content;
  document.getElementById('modal-body').scrollTop=0;
  document.getElementById('modal-sig').value='';
  document.getElementById('modal-sign-btn').disabled=true;
  document.getElementById('policy-modal').classList.add('open');
}
function closePolicyModal(){document.getElementById('policy-modal').classList.remove('open');}
function checkModalScroll(){
  const body=document.getElementById('modal-body');
  if(body.scrollHeight-body.scrollTop-body.clientHeight<40&&!modalScrolled){modalScrolled=true;checkModalSig();}
}
function checkModalSig(){
  document.getElementById('modal-sign-btn').disabled=!(document.getElementById('modal-sig').value.trim()&&modalScrolled);
}
async function signPolicy(){
  const p=POLICIES[currentPolicyIndex];
  const sig=document.getElementById('modal-sig').value.trim();
  const btn=document.getElementById('modal-sign-btn');
  btn.disabled=true;btn.textContent='Saving...';
  const now=new Date();
  const ts=now.toLocaleString('en-US',{dateStyle:'medium',timeStyle:'short'});
  try{await db.from('policy_signatures').upsert([{employee_name:user.name,employee_email:user.email,county:user.county,policy_id:p.id,policy_name:p.name,signature:sig,signed_at:now.toISOString()}],{onConflict:'employee_email,policy_id'});}catch(e){console.log(e);}
  const item=document.getElementById('pol-'+p.id);
  item.classList.add('signed');item.dataset.signed='1';
  document.getElementById('check-'+p.id).textContent='‚úì';
  document.getElementById('time-'+p.id).textContent='Signed '+ts;
  document.getElementById('pbtn-'+p.id).textContent='‚úì Signed';
  document.getElementById('pbtn-'+p.id).className='policy-btn policy-btn-done';
  closePolicyModal();updateBadge();updateDashboard();checkAllSigned();
}
function updateBadge(){
  const done=POLICIES.filter(p=>{const el=document.getElementById('pol-'+p.id);return el&&el.dataset.signed==='1';}).length;
  document.getElementById('badge-policies').textContent=`${done}/${POLICIES.length}`;
}
function checkAllSigned(){
  const done=POLICIES.filter(p=>{const el=document.getElementById('pol-'+p.id);return el&&el.dataset.signed==='1';}).length;
  if(done===POLICIES.length){document.getElementById('all-signed-banner').style.display='block';notifyCompletion();}
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
function updateDashboard(){
  const docsComplete=(trainingComplete?1:0)+(handbookComplete?1:0);
  const polSigned=POLICIES.filter(p=>{const el=document.getElementById('pol-'+p.id);return el&&el.dataset.signed==='1';}).length;
  const total=2+POLICIES.length;
  const done=docsComplete+polSigned;
  const pct=Math.round((done/total)*100);
  document.getElementById('progress-fill').style.width=pct+'%';
  document.getElementById('progress-pct').textContent=pct+'%';
  document.getElementById('stat-docs').textContent=docsComplete+'/2';
  document.getElementById('stat-sigs').textContent=polSigned+'/'+POLICIES.length;
  document.getElementById('stat-remaining').textContent=total-done;
  const checks=[
    {label:'Complete online training courses (PASS, Defensive Driving, CPR)',done:true},
    {label:'Read Driver Training Guide',done:trainingComplete},
    {label:'Read Employee Handbook',done:handbookComplete},
    {label:`Sign policy acknowledgments (${polSigned}/${POLICIES.length} complete)`,done:polSigned===POLICIES.length},
  ];
  document.getElementById('dash-checklist').innerHTML=checks.map(c=>`<li><div class="check-dot ${c.done?'done':'pending'}">${c.done?'‚úì':'‚óã'}</div><span style="color:${c.done?'#27AE60':'#444'};${c.done?'text-decoration:line-through;opacity:0.7;':''}">${c.label}</span></li>`).join('');
}

// ‚îÄ‚îÄ TIME OFF ‚îÄ‚îÄ
function selectReqType(type){
  currentReqType=type;
  document.querySelectorAll('.req-type-btn').forEach(b=>{b.style.background='transparent';b.style.color='var(--navy)';});
  event.target.style.background='var(--navy)';event.target.style.color='#fff';
  let html='';
  if(type==='Full Day Off'){html=`<div class="sig-field"><label>Date</label><input type="date" id="req-date1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div>`;}
  else if(type==='Multiple Days'){html=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;"><div class="sig-field"><label>Start Date</label><input type="date" id="req-date1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div><div class="sig-field"><label>End Date</label><input type="date" id="req-date2" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div></div>`;}
  else if(type==='Start Late'){html=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;"><div class="sig-field"><label>Date</label><input type="date" id="req-date1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div><div class="sig-field"><label>Arriving At</label><input type="time" id="req-time1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div></div>`;}
  else if(type==='End Early'){html=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;"><div class="sig-field"><label>Date</label><input type="date" id="req-date1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div><div class="sig-field"><label>Leaving At</label><input type="time" id="req-time1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div></div>`;}
  else if(type==='Mid-Day Appointment'){html=`<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;"><div class="sig-field"><label>Date</label><input type="date" id="req-date1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div><div class="sig-field"><label>Time Leaving</label><input type="time" id="req-time1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div><div class="sig-field"><label>Time Returning</label><input type="time" id="req-time2" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div></div>`;}
  document.getElementById('req-fields').innerHTML=html;
  document.getElementById('req-form').style.display='block';
  document.getElementById('req-success').style.display='none';
}
async function submitTimeOff(){
  const date1=document.getElementById('req-date1')?.value;
  const date2=document.getElementById('req-date2')?.value||date1;
  const time1=document.getElementById('req-time1')?.value||'';
  const time2=document.getElementById('req-time2')?.value||'';
  const reason=document.getElementById('req-reason').value;
  const timeDetail=time2?`${time1} ‚Äì ${time2}`:time1;
  if(!date1){alert('Please select a date.');return;}
  try{
    await db.from('time_off_requests').insert([{employee_name:user.name,employee_email:user.email,county:user.county,request_type:currentReqType,start_date:date1,end_date:date2,time_detail:timeDetail,reason,status:'PENDING',submitted_at:new Date().toISOString()}]);
    if(typeof emailjs!=='undefined'){await emailjs.send(EMAILJS_SERVICE_ID,'template_26w7bfc',{employee_name:user.name,employee_email:user.email,county:user.county,request_type:currentReqType,start_date:date1,end_date:date2,time_detail:timeDetail,reason,portal_url:PORTAL_URL,to_email:SUPERVISOR_EMAIL});}
  }catch(e){console.log(e);}
  document.getElementById('req-form').style.display='none';
  document.getElementById('req-success').style.display='block';
}
function resetTimeOff(){
  currentReqType=null;
  document.getElementById('req-form').style.display='none';
  document.getElementById('req-success').style.display='none';
  document.getElementById('req-reason').value='';
  document.querySelectorAll('.req-type-btn').forEach(b=>{b.style.background='transparent';b.style.color='var(--navy)';});
}

// ‚îÄ‚îÄ CERTIFICATE ‚îÄ‚îÄ
function generateCertificate(){
  const now=new Date();
  const dateStr=now.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
  const timeStr=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  const rows=POLICIES.map(p=>{
    const timeEl=document.getElementById('time-'+p.id);
    const signedTime=timeEl?timeEl.textContent.replace('Signed ',''):dateStr;
    return `<tr><td style="padding:10px 14px;border-bottom:1px solid #e5e7eb;font-weight:600;color:#1a2e4a;">${p.name}</td><td style="padding:10px 14px;border-bottom:1px solid #e5e7eb;color:#16a34a;text-align:center;">‚úì Acknowledged</td><td style="padding:10px 14px;border-bottom:1px solid #e5e7eb;color:#555;font-size:13px;">${signedTime}</td></tr>`;
  }).join('');
  const certHTML=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Certificate ‚Äî ${user.name}</title><style>body{font-family:Georgia,serif;margin:0;padding:40px;background:#f8f9fa;}.cert-wrapper{max-width:780px;margin:0 auto;background:#fff;border:3px solid #1a2e4a;border-radius:12px;padding:50px 60px;box-shadow:0 4px 24px rgba(0,0,0,.10);}.cert-header{text-align:center;border-bottom:2px solid #c0392b;padding-bottom:24px;margin-bottom:32px;}.logo{font-size:28px;font-weight:900;color:#1a2e4a;}.logo span{color:#c0392b;}.cert-title{font-size:30px;font-weight:700;color:#1a2e4a;margin:24px 0 6px;text-align:center;}.cert-body{text-align:center;font-size:16px;color:#444;line-height:1.7;margin-bottom:32px;}.cert-name{font-size:26px;font-weight:700;color:#c0392b;border-bottom:2px solid #c0392b;display:inline-block;padding:0 20px 4px;}.cert-meta{display:flex;justify-content:center;gap:40px;margin-bottom:32px;font-size:14px;color:#555;}.cert-meta div{text-align:center;}.cert-meta strong{display:block;color:#1a2e4a;}table{width:100%;border-collapse:collapse;margin-bottom:32px;font-family:Arial,sans-serif;}thead tr{background:#1a2e4a;color:#fff;}thead th{padding:12px 14px;text-align:left;font-size:13px;}.cert-footer{border-top:2px solid #1a2e4a;padding-top:24px;display:flex;justify-content:space-between;align-items:flex-end;gap:40px;}.sig-block{flex:1;}.sig-line{border-bottom:1.5px solid #1a2e4a;margin-bottom:6px;height:32px;}.sig-label{font-size:12px;color:#888;text-transform:uppercase;}.seal{width:90px;height:90px;border-radius:50%;border:3px double #1a2e4a;display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 auto;font-size:10px;font-weight:700;color:#1a2e4a;text-align:center;line-height:1.3;}.legal{font-size:11px;color:#aaa;text-align:center;margin-top:24px;line-height:1.6;}@media print{body{padding:0;background:#fff;}}</style></head><body><div class="cert-wrapper"><div class="cert-header"><div class="logo">Ride<span>Source</span> Inc.</div><div style="font-size:13px;color:#888;margin-top:4px;">Non-Emergency Medical Transportation ¬∑ Maine</div></div><div class="cert-title">Certificate of Policy Acknowledgment</div><div class="cert-body">This certifies that<br><span class="cert-name">${user.name}</span><br>has read, reviewed, and electronically acknowledged all required RideSource Inc. employment policies as part of the new employee onboarding process.</div><div class="cert-meta"><div><strong>${user.county}</strong>County</div><div><strong>${user.email}</strong>Email</div><div><strong>${dateStr}</strong>Completed</div></div><table><thead><tr><th>Policy</th><th style="text-align:center;">Status</th><th>Date & Time</th></tr></thead><tbody>${rows}</tbody></table><div class="cert-footer"><div class="sig-block"><div class="sig-line"></div><div class="sig-label">Employee Signature (Electronic)</div><div style="font-size:13px;color:#1a2e4a;margin-top:4px;">${user.name}</div></div><div style="text-align:center;"><div class="seal">RIDE<br>SOURCE<br>‚úì<br>VERIFIED</div><div style="font-size:11px;color:#888;margin-top:6px;">Electronically Sealed</div></div><div class="sig-block" style="text-align:right;"><div class="sig-line"></div><div class="sig-label">Date Completed</div><div style="font-size:13px;color:#1a2e4a;margin-top:4px;">${dateStr} at ${timeStr}</div></div></div><div class="legal">Electronic signatures are legally binding under the E-SIGN Act and applicable Maine state law.</div></div><div style="text-align:center;margin-top:24px;"><button onclick="window.print()" style="background:#1a2e4a;color:#fff;border:none;padding:12px 32px;font-size:15px;border-radius:8px;cursor:pointer;font-weight:600;">üñ®Ô∏è Print / Save as PDF</button></div></body></html>`;
  window.open(URL.createObjectURL(new Blob([certHTML],{type:'text/html'})),'_blank');
}

async function notifyCompletion(){
  if(typeof emailjs==='undefined')return;
  try{await emailjs.send(EMAILJS_SERVICE_ID,'timeoff_submission',{employee_name:user.name,employee_email:user.email,county:user.county,request_type:'ONBOARDING COMPLETE',start_date:new Date().toLocaleDateString(),end_date:'',time_detail:'All policies signed.',reason:`${user.name} has completed all onboarding acknowledgments.`,portal_url:PORTAL_URL,to_email:SUPERVISOR_EMAIL});}catch(e){console.log(e);}
}

// ‚îÄ‚îÄ ADMIN: MANAGER GUIDE ‚îÄ‚îÄ
const MGR_SECTIONS=[
  {title:'Sec 1: Onboarding',content:`<h1>Section 1: Your Role in Onboarding</h1><p>As a supervisor or manager at RideSource, you are the most important part of the onboarding experience.</p><h2>Your Responsibilities</h2><ul><li>Ensure all pre-employment clearances are complete before sending a Welcome Aboard letter</li><li>Coordinate online training course enrollment</li><li>Conduct all four phases of hands-on training (Days 3‚Äì6)</li><li>Guide the employee through all policy acknowledgments via the Digital Onboarding Portal</li><li>Check in daily during the first solo week on the road</li></ul>`},
  {title:'Sec 2: Pre-Employment',content:`<h1>Section 2: Pre-Employment Process</h1><h2>Interview & Same-Day Screening</h2><ul><li>Conduct interview using standardized Interview Questions form</li><li>Collect driver info form and emergency contact form</li><li>Obtain consent for background check, MVR, and fingerprinting</li></ul><h2>Waiting Period (~1 Week)</h2><ul><li>Background check results</li><li>Motor vehicle record (MVR) review</li><li>Fingerprint clearance</li></ul><h2>Welcome Aboard or Rejection</h2><p>Once all clearances are confirmed, send the Welcome Aboard Letter via HR Templates. If not selected, send the Letter of Rejection within one week.</p><div class="callout"><strong>Important</strong>HR orders online training courses immediately after the Welcome Aboard Letter. Employees are NOT paid for home training.</div>`},
  {title:'Sec 3: Preparation',content:`<h1>Section 3: Preparing for Day 3</h1><h2>Pre-Day 3 Checklist</h2><ul><li>‚òê Confirm online training completed and certificates received</li><li>‚òê Assign vehicle ‚Äî clean and fueled</li><li>‚òê Set up Android dispatch device with employee credentials</li><li>‚òê Prepare employee ID badge</li><li>‚òê Set up TWE timekeeping access</li><li>‚òê Notify dispatch of new employee training schedule</li></ul><div class="warn-box"><strong>‚ö†Ô∏è Do Not Begin Training Until:</strong>All clearances confirmed AND all online courses completed.</div>`},
  {title:'Sec 4: Time Off',content:`<h1>Section 4: Time Off Request System</h1><h2>How Requests Work</h2><ul><li>Employee submits via Employee Portal ‚Üí Request Time Off</li><li>You receive automatic email notification</li><li>Log in to Admin Portal ‚Üí Pending Requests ‚Üí approve or deny</li><li>Employee receives email with your decision</li></ul><h2>Logging Call-Outs</h2><p>When an employee calls out, you log it on their behalf via Call-Out Log. The system automatically flags employees with 3+ call-outs in 30 days.</p>`},
  {title:'Sec 5: Tracker',content:`<h1>Section 5: Digital Onboarding & Policy Tracker</h1><p>All new employees must complete the Employee Portal acknowledgments before the end of Week 2.</p><h2>Required Acknowledgments</h2><ul><li>At-Will Employment Policy</li><li>HIPAA & Confidentiality Policy</li><li>Employee Code of Conduct</li><li>Safety & Vehicle Policy</li><li>Attendance & Punctuality Policy</li><li>Drug-Free Workplace Policy</li><li>Non-Compete & Separation Policy</li><li>Employee Handbook</li></ul><p>Monitor progress in the <strong>Onboarding Tracker</strong> section of this Admin Portal.</p>`},
  {title:'Sec 6: Support',content:`<h1>Section 6: Supporting New Employees</h1><h2>First Week Solo</h2><p>Check in daily during the first solo week. Verify Parascope usage, trip documentation, vehicle cleanliness, and proactive communication.</p><h2>When to Contact HR Immediately</h2><ul><li>Employee reports harassment or hostile work environment</li><li>You need to issue a written warning</li><li>Employee discloses medical condition, disability, or pregnancy</li><li>Employee requests FMLA or leave of absence</li><li>Attendance concern escalates beyond a supportive conversation</li></ul><div class="callout"><strong>When in Doubt</strong>Always ask your management team before acting on sensitive situations.</div>`}
];

const HB_REF_SECTIONS=[
  {title:'Sec 1-2',content:`<h1>Sections 1‚Äì2: Welcome & Employment</h1><p>RideSource Inc. is a Non-Emergency Medical Transportation (NEMT) company based in Norway, Maine.</p><p><strong>At-Will Employment:</strong> Either party may end the relationship at any time without cause. 90-day introductory period for all new employees.</p>`},
  {title:'Sec 3-4',content:`<h1>Sections 3‚Äì4: Conduct & Attendance</h1><p><strong>Confidentiality:</strong> All passenger information strictly confidential. HIPAA violations may result in immediate termination.</p><p><strong>Attendance:</strong> Notify supervisor 1 hour before start. Planned time off 2 weeks in advance. Progressive discipline for no-call/no-shows.</p>`},
  {title:'Sec 5-6',content:`<h1>Sections 5‚Äì6: Compensation & Benefits</h1><p><strong>Pay:</strong> Biweekly. Paydays generally Wednesdays. Direct deposit required. Performance reviews annual ‚Äî not automatic increases.</p><p><strong>Workers' Comp:</strong> All employees covered. Report any injury immediately.</p>`},
  {title:'Sec 7-8',content:`<h1>Sections 7‚Äì8: Safety & Operations</h1><p><strong>Drug-Free:</strong> No substances on duty. Pre-employment, reasonable suspicion, and post-accident testing.</p><p><strong>Incidents:</strong> Report all accidents immediately. Keep calm ‚Üí Contact dispatcher ‚Üí Protect passengers ‚Üí Complete reports.</p><p><strong>Hands-Free:</strong> Maine law prohibits holding devices while driving. Company Bluetooth required.</p>`},
  {title:'Sec 9-10',content:`<h1>Sections 9‚Äì10: Development & Separation</h1><p><strong>Discipline:</strong> Verbal ‚Üí Written ‚Üí Final/PIP ‚Üí Termination. Immediate termination for HIPAA violations, falsification, impaired driving, harassment.</p><p><strong>Separation:</strong> 2 weeks notice requested. Job abandonment (3 missed days) = ineligible for rehire.</p><p><strong>Non-Compete:</strong> 24 months within 50 miles of any RideSource office.</p>`}
];

function buildMgrGuide(){
  document.getElementById('mgr-tabs').innerHTML=MGR_SECTIONS.map((s,i)=>`<div class="doc-tab ${i===0?'active':''}" onclick="goMgrSection(${i})">${s.title}</div>`).join('');
  renderMgrSection(0);
}
function buildHbRef(){
  document.getElementById('hb-ref-tabs').innerHTML=HB_REF_SECTIONS.map((s,i)=>`<div class="doc-tab ${i===0?'active':''}" onclick="goHbRefSection(${i})">${s.title}</div>`).join('');
  renderHbRefSection(0);
}
function renderMgrSection(i){mgrSection=i;document.getElementById('mgr-body').innerHTML=MGR_SECTIONS[i].content;document.querySelectorAll('#mgr-tabs .doc-tab').forEach((t,j)=>t.classList.toggle('active',i===j));}
function renderHbRefSection(i){hbRefSection=i;document.getElementById('hb-ref-body').innerHTML=HB_REF_SECTIONS[i].content;document.querySelectorAll('#hb-ref-tabs .doc-tab').forEach((t,j)=>t.classList.toggle('active',i===j));}
function goMgrSection(i){renderMgrSection(i);}
function goHbRefSection(i){renderHbRefSection(i);}
function changeMgrSection(dir){const n=mgrSection+dir;if(n>=0&&n<MGR_SECTIONS.length)renderMgrSection(n);}
function changeHbRefSection(dir){const n=hbRefSection+dir;if(n>=0&&n<HB_REF_SECTIONS.length)renderHbRefSection(n);}

// ‚îÄ‚îÄ ADMIN DASHBOARD ‚îÄ‚îÄ
async function loadDashboard(){
  const {data:reqs}=await db.from('time_off_requests').select('*').eq('status','PENDING').order('submitted_at',{ascending:false});
  const {data:callouts}=await db.from('call_out_log').select('*').order('callout_date',{ascending:false}).limit(100);
  const {data:sigs}=await db.from('policy_signatures').select('employee_email').order('signed_at',{ascending:false});
  const unique=sigs?[...new Set(sigs.map(s=>s.employee_email))].length:0;
  document.getElementById('dash-stats').innerHTML=`<div class="stat-card"><div class="stat-icon" style="background:#fff3cd;">‚è≥</div><div><div class="stat-val">${reqs?reqs.length:0}</div><div class="stat-label">Pending Requests</div></div></div><div class="stat-card"><div class="stat-icon" style="background:#fdecea;">üìû</div><div><div class="stat-val">${callouts?callouts.length:0}</div><div class="stat-label">Total Call-Outs</div></div></div><div class="stat-card"><div class="stat-icon" style="background:#d4edda;">‚úÖ</div><div><div class="stat-val">${unique}</div><div class="stat-label">Employees w/ Signed Policies</div></div></div>`;
  const pendList=document.getElementById('dash-pending-list');
  if(!reqs||reqs.length===0){pendList.textContent='No pending requests. ‚úì';}
  else{pendList.innerHTML=reqs.slice(0,5).map(r=>`<div style="padding:6px 0;border-bottom:1px solid #f0f0f0;font-size:12px;"><strong>${r.employee_name}</strong> ‚Äî ${r.request_type} ‚Äî ${r.start_date}</div>`).join('');}
  loadFlagsInto('dash-flags-list',callouts||[]);
}

function detectFlags(callouts){
  const groups={};
  callouts.forEach(c=>{const k=c.employee_name+'|'+c.county;if(!groups[k])groups[k]={name:c.employee_name,county:c.county,dates:[]};groups[k].dates.push(new Date(c.callout_date));});
  const flagged=[];
  Object.values(groups).forEach(g=>{
    const now=new Date();const thirtyAgo=new Date(now-30*24*60*60*1000);
    const recent=g.dates.filter(d=>d>=thirtyAgo).sort((a,b)=>a-b);
    if(recent.length>=3)flagged.push({name:g.name,county:g.county,count:recent.length,dates:recent,allDates:g.dates.sort((a,b)=>a-b)});
  });
  return flagged;
}

function loadFlagsInto(elId,callouts){
  const el=document.getElementById(elId);
  const flagged=detectFlags(callouts);
  if(flagged.length===0){el.textContent='No attendance flags. ‚úì';}
  else{el.innerHTML=flagged.slice(0,5).map(f=>`<div style="padding:6px 0;border-bottom:1px solid #f0f0f0;font-size:12px;"><strong>${f.name}</strong> ‚Äî <span style="color:var(--red);">${f.count} call-outs in 30 days</span></div>`).join('');}
  document.getElementById('badge-flags').textContent=flagged.length||'0';
}

async function loadFlags(){
  const {data:callouts}=await db.from('call_out_log').select('*').order('callout_date',{ascending:false});
  const flagged=detectFlags(callouts||[]);
  document.getElementById('badge-flags').textContent=flagged.length||'0';
  const el=document.getElementById('flagged-employees');
  if(flagged.length===0){el.innerHTML=`<div class="card" style="text-align:center;padding:32px;color:var(--success);"><div style="font-size:32px;">‚úÖ</div><div style="font-weight:700;margin-top:8px;">No attendance flags at this time.</div></div>`;return;}
  el.innerHTML=flagged.map(f=>{
    const dates=f.dates.map(d=>d.toLocaleDateString('en-US',{month:'short',day:'numeric'})).join(', ');
    const level=f.allDates.length>=9?'Final Written Warning':'Standard Warning';
    return `<div class="warning-employee"><div style="display:flex;gap:14px;align-items:center;"><div style="font-size:24px;">‚ö†Ô∏è</div><div><div style="font-weight:700;">${f.name} <span style="font-weight:400;color:#888;">¬∑ ${f.county}</span></div><div style="font-size:12px;color:#666;margin-top:2px;">${f.count} call-outs in last 30 days ¬∑ ${dates}</div></div></div><div style="display:flex;align-items:center;gap:10px;"><span class="badge badge-flag">${level}</span><button class="btn btn-red btn-sm" onclick='openWarningModal(${JSON.stringify(f).replace(/'/g,"&#39;")})'>Generate Warning</button></div></div>`;
  }).join('');
}

function openWarningModal(f){
  warningData=f;
  const dates=f.dates.map(d=>new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})).join(', ');
  const allCount=f.allDates?f.allDates.length:f.count;
  const level=allCount>=6?'final':'standard';
  document.getElementById('warn-modal-title').textContent=`Attendance Warning ‚Äî ${f.name}`;
  document.getElementById('warn-preview').style.display='none';
  document.getElementById('warn-gen-btn').style.display='';
  document.getElementById('warn-form').innerHTML=`<div class="form-row"><div class="form-field"><label>Employee Name</label><input type="text" id="wf-name" value="${f.name}"></div><div class="form-field"><label>County</label><input type="text" id="wf-county" value="${f.county}"></div></div><div class="form-row"><div class="form-field"><label>Number of Call-Outs</label><input type="number" id="wf-count" value="${f.count}"></div><div class="form-field"><label>Warning Level</label><select id="wf-level"><option value="standard" ${level==='standard'?'selected':''}>Standard Warning</option><option value="final" ${level==='final'?'selected':''}>Final Written Warning</option><option value="manifest">Call-Out After Manifest</option></select></div></div><div class="form-field"><label>Timeframe</label><input type="text" id="wf-timeframe" value="the past 30 days"></div><div class="form-field"><label>Call-Out Dates</label><input type="text" id="wf-dates" value="${dates}"></div><div class="form-field"><label>Additional Notes (optional)</label><textarea id="wf-notes" placeholder="Any additional context..."></textarea></div>`;
  document.getElementById('warning-modal').classList.add('open');
}

function generateWarning(){
  const name=document.getElementById('wf-name').value;
  const count=document.getElementById('wf-count').value;
  const timeframe=document.getElementById('wf-timeframe').value;
  const level=document.getElementById('wf-level').value;
  const dates=document.getElementById('wf-dates').value;
  const notes=document.getElementById('wf-notes').value;
  const today=new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  let body='';
  if(level==='final'){body=`SUBJECT: Attendance Warning ‚Äî Final Written Warning\n\nDear ${name},\n\nThis correspondence serves as a Final Written Warning regarding your continued attendance violations.\n\nYou have recorded ${count} call-out(s) within ${timeframe} (${dates}), which does not meet the attendance standards required for your position.\n\nAny further attendance violations may result in additional disciplinary action, up to and including termination of employment.\n${notes?'\nAdditional Notes: '+notes+'\n':''}\nSincerely,\nManagement Team\nRideSource Inc.\nDate: ${today}`;}
  else if(level==='manifest'){body=`SUBJECT: Attendance Warning ‚Äî Call-Out After Trip Assignment\n\nDear ${name},\n\nThis notice serves as formal documentation of your call-out after receiving an assigned manifest.\n\nYour call-out(s) occurred on: ${dates}\n\nCall-outs after manifest assignment create significant operational challenges.\n${notes?'\nAdditional Notes: '+notes+'\n':''}\nSincerely,\nManagement Team\nRideSource Inc.\nDate: ${today}`;}
  else{body=`SUBJECT: Attendance Warning ‚Äî Standard\n\nDear ${name},\n\nThis notice serves as formal documentation of your recent call-outs and attendance concerns.\n\nYou have accumulated ${count} call-out(s) within ${timeframe}. Your call-out dates are: ${dates}.\n\nContinued attendance issues may result in further corrective action.\n${notes?'\nAdditional Notes: '+notes+'\n':''}\nSincerely,\nManagement Team\nRideSource Inc.\nDate: ${today}`;}
  document.getElementById('warn-form').style.display='none';
  document.getElementById('warn-gen-btn').style.display='none';
  const preview=document.getElementById('warn-preview');
  preview.style.display='block';preview.textContent=body;
  document.getElementById('warn-modal-desc').textContent='Warning generated. Print or save as PDF.';
  const existingPrint=document.getElementById('warn-print-btn');
  if(!existingPrint){
    const printBtn=document.createElement('button');
    printBtn.id='warn-print-btn';printBtn.className='btn btn-primary';printBtn.style.marginLeft='8px';
    printBtn.textContent='üñ®Ô∏è Print / Save as PDF';
    printBtn.onclick=printWarning;
    document.querySelector('#warning-modal .btn-secondary').insertAdjacentElement('afterend',printBtn);
  }
}
function printWarning(){
  const content=document.getElementById('warn-preview').textContent;
  const win=window.open('','_blank');
  win.document.write(`<html><head><title>Attendance Warning</title><style>body{font-family:Arial,sans-serif;max-width:700px;margin:60px auto;font-size:14px;line-height:1.8;white-space:pre-wrap;}</style></head><body>${content.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</body></html>`);
  win.document.close();win.print();
}

// ‚îÄ‚îÄ TIME OFF REQUESTS ‚îÄ‚îÄ
async function loadRequests(){
  const {data}=await db.from('time_off_requests').select('*').order('submitted_at',{ascending:false});
  document.getElementById('badge-requests').textContent=(data||[]).filter(r=>r.status==='PENDING').length||'0';
  const el=document.getElementById('requests-table');
  if(!data||data.length===0){el.innerHTML='<p style="color:#888;font-size:13px;">No requests found.</p>';return;}
  el.innerHTML=`<table class="data-table"><thead><tr><th>Employee</th><th>County</th><th>Type</th><th>Date(s)</th><th>Reason</th><th>Status</th><th>Actions</th></tr></thead><tbody>`+
    data.map(r=>`<tr><td><strong>${r.employee_name}</strong></td><td>${r.county}</td><td>${r.request_type}</td><td>${r.start_date}${r.end_date&&r.end_date!==r.start_date?' ‚Üí '+r.end_date:''}</td><td>${r.reason||'‚Äî'}</td><td><span class="badge badge-${r.status.toLowerCase()}">${r.status}</span></td><td style="white-space:nowrap;">${r.status==='PENDING'?`<button class="btn btn-green btn-sm" onclick="decideRequest(${r.id},'APPROVED')">‚úì Approve</button> <button class="btn btn-sm" style="background:#f8d7da;color:#721c24;margin-left:4px;" onclick="decideRequest(${r.id},'DENIED')">‚úó Deny</button>`:'‚Äî'}</td></tr>`).join('')+
    '</tbody></table>';
}
async function decideRequest(id,status){
  await db.from('time_off_requests').update({status,decided_at:new Date().toISOString(),decided_by:adminName}).eq('id',id);
  loadRequests();loadDashboard();
}

// ‚îÄ‚îÄ CALL-OUT LOG ‚îÄ‚îÄ
async function loadCallOuts(){
  const {data}=await db.from('call_out_log').select('*').order('callout_date',{ascending:false}).limit(50);
  const el=document.getElementById('callout-table');
  if(!data||data.length===0){el.innerHTML='<p style="color:#888;font-size:13px;">No call-outs logged yet.</p>';return;}
  el.innerHTML=`<table class="data-table"><thead><tr><th>Employee</th><th>County</th><th>Date</th><th>Reason</th><th>Notes</th><th>Logged By</th></tr></thead><tbody>`+
    data.map(c=>`<tr><td><strong>${c.employee_name}</strong></td><td>${c.county}</td><td>${c.callout_date}</td><td>${c.reason}</td><td>${c.notes||'‚Äî'}</td><td>${c.logged_by}</td></tr>`).join('')+
    '</tbody></table>';
}
async function logCallOut(){
  const name=document.getElementById('co-name').value.trim();
  const county=document.getElementById('co-county').value;
  const date=document.getElementById('co-date').value;
  const reason=document.getElementById('co-reason').value;
  const notes=document.getElementById('co-notes').value;
  if(!name||!county||!date){alert('Please fill in employee name, county, and date.');return;}
  await db.from('call_out_log').insert([{employee_name:name,county,callout_date:date,reason,notes,logged_by:adminName,logged_at:new Date().toISOString()}]);
  document.getElementById('co-name').value='';document.getElementById('co-date').value='';document.getElementById('co-notes').value='';
  const msg=document.getElementById('co-msg');msg.style.display='inline';setTimeout(()=>msg.style.display='none',3000);
  loadCallOuts();loadFlags();loadDashboard();
}

async function manualLookup(){
  const name=document.getElementById('manual-name').value.trim();
  const county=document.getElementById('manual-county').value;
  if(!name){alert('Please enter an employee name.');return;}
  let query=db.from('call_out_log').select('*').ilike('employee_name','%'+name+'%').order('callout_date',{ascending:true});
  if(county)query=query.eq('county',county);
  const {data}=await query;
  const el=document.getElementById('manual-results');
  if(!data||data.length===0){el.innerHTML=`<p style="color:#888;font-size:13px;">No call-outs found for "${name}".</p>`;return;}
  const dates=data.map(c=>new Date(c.callout_date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}));
  el.innerHTML=`<div class="warning-employee"><div><div style="font-weight:700;">${data[0].employee_name} ‚Äî ${data[0].county}</div><div style="font-size:12px;color:#666;margin-top:4px;">${data.length} total call-out(s) ¬∑ ${dates.join(', ')}</div></div><button class="btn btn-red btn-sm" onclick='openWarningModal(${JSON.stringify({name:data[0].employee_name,county:data[0].county,count:data.length,dates:data.map(c=>new Date(c.callout_date)),allDates:data.map(c=>new Date(c.callout_date))})})'>Generate Warning</button></div>`;
}

// ‚îÄ‚îÄ ONBOARDING TRACKER ‚îÄ‚îÄ
async function loadOnboarding(){
  const {data:sigs}=await db.from('policy_signatures').select('*').order('signed_at',{ascending:false});
  const {data:hbSigs}=await db.from('handbook_signatures').select('*').order('signed_at',{ascending:false}).catch(()=>({data:[]}));
  const el=document.getElementById('onboarding-data');
  if(!sigs||sigs.length===0){el.innerHTML='<p style="color:#888;font-size:13px;">No onboarding signatures recorded yet.</p>';return;}
  const byEmployee={};
  sigs.forEach(s=>{if(!byEmployee[s.employee_email])byEmployee[s.employee_email]={name:s.employee_name,email:s.employee_email,county:s.county,policies:[],handbookSigned:false,printRequested:false};byEmployee[s.employee_email].policies.push(s.policy_name);});
  if(hbSigs){hbSigs.forEach(h=>{if(byEmployee[h.employee_email]){byEmployee[h.employee_email].handbookSigned=true;byEmployee[h.employee_email].printRequested=h.print_requested;}});}
  el.innerHTML=`<table class="data-table"><thead><tr><th>Employee</th><th>County</th><th>Policies Signed</th><th>Handbook</th><th>Print Requested</th></tr></thead><tbody>`+
    Object.values(byEmployee).map(e=>`<tr><td><strong>${e.name}</strong><br><span style="font-size:11px;color:#888;">${e.email}</span></td><td>${e.county}</td><td><span class="badge ${e.policies.length>=7?'badge-approved':'badge-warning'}">${e.policies.length}/7</span></td><td>${e.handbookSigned?'<span class="badge badge-approved">‚úì Signed</span>':'<span class="badge badge-warning">Pending</span>'}</td><td>${e.printRequested?'<span class="badge badge-flag">üì¶ Yes</span>':'No'}</td></tr>`).join('')+
    '</tbody></table>';
  const printList=document.getElementById('print-requests-list');
  const printReqs=Object.values(byEmployee).filter(e=>e.printRequested);
  printList.innerHTML=printReqs.length===0?'No printed copy requests.':`<div>${printReqs.map(e=>`<div style="padding:6px 0;border-bottom:1px solid #e0e0e0;font-size:12px;"><strong>${e.name}</strong> (${e.email}) ‚Äî ${e.county}</div>`).join('')}</div>`;
}

// ‚îÄ‚îÄ HR TEMPLATES ‚îÄ‚îÄ
const MANAGERS={
  tiffany:{name:'Tiffany Gallagher',title:'Regional Operations Manager',office:'207-743-7433',direct:'207-812-5357',mobile:'207-515-3808',email:'tiffanyb@ridesourcemaine.com'}
};

const TEMPLATES={
  welcome:{title:'Welcome Aboard Letter',filename:'Welcome_Aboard_Letter',hasManager:true,fields:[{id:'date',label:'Date',type:'date',required:true},{id:'firstName',label:'Employee First Name',type:'text',required:true},{id:'jobTitle',label:'Job Title',type:'text',required:true},{id:'startDate',label:'Start Date',type:'date',required:true},{id:'reportTime',label:'Report Time',type:'time',required:true}]},
  rejection:{title:'Letter of Rejection',filename:'Letter_of_Rejection',hasManager:true,fields:[{id:'date',label:'Date',type:'date',required:true},{id:'appName',label:'Applicant Full Name',type:'text',required:true},{id:'address',label:'Address',type:'text',required:false},{id:'cityState',label:'City, State, ZIP',type:'text',required:false}]},
  interview:{title:'Interview Questions Form',filename:'Interview_Questions',hasManager:false,fields:[{id:'date',label:'Interview Date',type:'date',required:true},{id:'applicant',label:'Applicant Name',type:'text',required:true},{id:'location',label:'Interview Location',type:'text',required:false,placeholder:'Ellsworth Office'},{id:'posType',label:'Position Type',type:'select',required:true,options:['Full-Time Agency Driver','Part-Time Agency Driver','Volunteer']},{id:'pay',label:'Rate of Pay Discussed',type:'text',required:false}]},
  driverinfo:{title:'Driver Info Form',filename:'Driver_Info_Form',hasManager:false,fields:[{id:'firstName',label:'First Name',type:'text',required:false},{id:'lastName',label:'Last Name',type:'text',required:false},{id:'cellPhone',label:'Cell Phone',type:'text',required:false},{id:'homePhone',label:'Home Phone',type:'text',required:false},{id:'email',label:'Email Address',type:'text',required:false},{id:'ecName',label:'Emergency Contact Name',type:'text',required:false},{id:'ecNumber',label:'Emergency Contact Number',type:'text',required:false},{id:'dlState',label:'License State',type:'text',required:false},{id:'dlIssued',label:'Date Issued',type:'date',required:false},{id:'dlExpiry',label:'Expiration Date',type:'date',required:false}]},
  emergency:{title:'Emergency Contact Form',filename:'Emergency_Contact_Form',hasManager:false,fields:[{id:'empName',label:'Employee Name',type:'text',required:false},{id:'division',label:'Division / County',type:'text',required:false},{id:'ec1Name',label:'Contact #1 ‚Äî Name',type:'text',required:false},{id:'ec1Rel',label:'Relationship',type:'text',required:false},{id:'ec1Cell',label:'Cell Phone',type:'text',required:false},{id:'ec1Home',label:'Home Phone',type:'text',required:false},{id:'ec2Name',label:'Contact #2 ‚Äî Name',type:'text',required:false},{id:'ec2Rel',label:'Relationship',type:'text',required:false},{id:'ec2Cell',label:'Cell Phone',type:'text',required:false},{id:'ec2Home',label:'Home Phone',type:'text',required:false}]},
  consent:{title:'Consent for Certification Release',filename:'Consent_Certification_Release',hasManager:false,fields:[{id:'employee',label:'Employee Full Name',type:'text',required:true},{id:'date',label:'Date',type:'date',required:true}]},
  resignation:{title:'Voluntary Resignation Acknowledgment',filename:'Resignation_Acknowledgment',hasManager:false,fields:[{id:'date',label:'Date',type:'date',required:true},{id:'employee',label:'Employee Full Name',type:'text',required:true},{id:'position',label:'Position / Title',type:'text',required:false},{id:'county',label:'Location / County',type:'text',required:false},{id:'supervisor',label:'Supervisor',type:'text',required:false},{id:'lastDay',label:'Last Day of Work',type:'date',required:false},{id:'reason',label:'Reason for Leaving (if provided)',type:'textarea',required:false}]},
  'warn-standard':{title:'Attendance Warning ‚Äî Standard',filename:'Attendance_Warning_Standard',hasManager:false,fields:[{id:'empName',label:'Employee Name',type:'text',required:true},{id:'warnDate',label:'Date of Warning',type:'date',required:true},{id:'position',label:'Position / Title',type:'text',required:false},{id:'county',label:'Department / County',type:'text',required:false},{id:'callCount',label:'Total Call-Outs (Last 90 Days)',type:'number',required:false},{id:'description',label:'Description of Issue',type:'textarea',required:false}]},
  'warn-callout':{title:'Attendance Warning ‚Äî Call-Out After Trip',filename:'Attendance_Warning_CallOut',hasManager:false,fields:[{id:'empName',label:'Employee Name',type:'text',required:true},{id:'warnDate',label:'Date of Warning',type:'date',required:true},{id:'incDate',label:'Date of Incident',type:'date',required:false},{id:'description',label:'Description',type:'textarea',required:false}]},
  'warn-final':{title:'Final Written Warning',filename:'Attendance_Warning_Final',hasManager:false,fields:[{id:'empName',label:'Employee Name',type:'text',required:true},{id:'warnDate',label:'Date of Warning',type:'date',required:true},{id:'callCount',label:'Total Call-Outs (Last 90 Days)',type:'number',required:false},{id:'description',label:'Description',type:'textarea',required:false}]}
};

let currentTemplate=null;

function openTemplate(id){
  currentTemplate=id;
  const t=TEMPLATES[id];
  document.getElementById('tmpl-title').textContent=t.title;
  document.getElementById('tmpl-desc').textContent='Fill in the fields below, then click Download to get your Word document.';
  let html='';
  if(t.hasManager){html+=`<div class="form-field"><label>Hiring Manager *</label><select id="tmpl-manager">${Object.entries(MANAGERS).map(([key,m])=>`<option value="${key}">${m.name} ‚Äî ${m.title}</option>`).join('')}</select></div>`;}
  const fields=t.fields;let i=0;
  while(i<fields.length){
    const f=fields[i],next=fields[i+1];
    const canPair=next&&f.type!=='textarea'&&next.type!=='textarea';
    if(canPair){html+=`<div class="form-row"><div class="form-field">${fieldInner(f)}</div><div class="form-field">${fieldInner(next)}</div></div>`;i+=2;}
    else{html+=`<div class="form-field">${fieldInner(f)}</div>`;i++;}
  }
  document.getElementById('tmpl-form').innerHTML=html;
  document.getElementById('template-modal').classList.add('open');
}

function fieldInner(f){
  const label=`<label>${f.label}${f.required?' *':''}</label>`;
  if(f.type==='textarea')return label+`<textarea id="tmpl-${f.id}" placeholder="${f.placeholder||f.label}..."></textarea>`;
  if(f.type==='select')return label+`<select id="tmpl-${f.id}">${f.options.map(o=>`<option>${o}</option>`).join('')}</select>`;
  return label+`<input type="${f.type}" id="tmpl-${f.id}" placeholder="${f.placeholder||''}">`;
}

function getVal(id){const el=document.getElementById('tmpl-'+id);return el?el.value.trim():'';}
function fmtDate(d){if(!d)return '';return new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});}
function fmtTime(t){if(!t)return '';return new Date('2000-01-01T'+t).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});}

async function downloadTemplate(){
  const t=TEMPLATES[currentTemplate];
  const btn=document.getElementById('tmpl-download-btn');
  let valid=true;
  t.fields.forEach(f=>{if(f.required){const el=document.getElementById('tmpl-'+f.id);if(!el||!el.value.trim()){if(el)el.style.borderColor='var(--red)';valid=false;}else if(el)el.style.borderColor='';}});
  if(!valid){alert('Please fill in all required fields (marked with *).');return;}
  btn.textContent='‚è≥ Generating...';btn.disabled=true;
  try{
    const mgr=t.hasManager?MANAGERS[document.getElementById('tmpl-manager').value]||MANAGERS.tiffany:null;
    const blob=await buildDocx(currentTemplate,mgr);
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=t.filename+'.docx';a.click();
    URL.revokeObjectURL(url);closeModal('template-modal');
  }catch(e){console.error(e);alert('Error generating document. Please try again.');}
  btn.textContent='‚¨áÔ∏è Download Word Doc';btn.disabled=false;
}

// ‚îÄ‚îÄ DOCX BUILDER (simplified but functional) ‚îÄ‚îÄ
async function buildDocx(templateId,mgr){
  const {Document,Packer,Paragraph,TextRun,AlignmentType,BorderStyle}=docx;
  const txt=(text,opts={})=>new TextRun({text,font:'Arial',...opts});
  const body=(text,opts={})=>new Paragraph({spacing:{after:120},children:[txt(text,{size:20,...opts})]});
  const heading=(text)=>new Paragraph({spacing:{before:240,after:120},children:[txt(text,{bold:true,size:24,color:'1B2A4A'})]});
  const sp=()=>new Paragraph({spacing:{after:80},children:[]});

  let children=[];
  const today=new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});

  // Header for all docs
  children.push(new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:60},children:[txt('RideSource',{bold:true,size:40,color:'1B2A4A'}),txt(' Inc.',{bold:true,size:40,color:'C0392B'})]}));
  children.push(new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:200},children:[txt('Reliable Safe Transportation',{size:18,color:'888888',italics:true})]}));
  children.push(new Paragraph({border:{bottom:{style:BorderStyle.SINGLE,size:8,color:'1B2A4A'}},spacing:{after:200},children:[]}));

  if(templateId==='welcome'){
    const fn=getVal('firstName')||'[Employee]';const jt=getVal('jobTitle')||'[Job Title]';
    const sd=fmtDate(getVal('startDate'));const dt=fmtDate(getVal('date'));const rt=fmtTime(getVal('reportTime'));
    children.push(heading('WELCOME ABOARD LETTER'));
    children.push(body(dt));children.push(sp());
    children.push(body(`Dear ${fn},`));children.push(sp());
    children.push(body('On behalf of the entire RideSource team, it is our sincere pleasure to welcome you as our newest team member. We are genuinely excited to have you with us.'));
    children.push(sp());children.push(heading('Your Position & Start Details'));
    children.push(body(`Position: ${jt}`));children.push(body(`Start Date: ${sd}`));
    children.push(body(`Report Time: ${rt}`));children.push(body('Report Location: 102 Main Street, Suite C, Ellsworth, ME 04605'));
    if(mgr){children.push(body(`Your Contact: ${mgr.name}, ${mgr.title}`));children.push(body(`Phone: ${mgr.direct} | Email: ${mgr.email}`));}
    children.push(sp());children.push(heading('Before Your First Day'));
    children.push(body('Please complete the following online training courses prior to your arrival: PASS Certification, Defensive Driving, and First Aid/CPR/AED. Forward certificates to your supervisor when complete.'));
    children.push(sp());children.push(body('We look forward to seeing you on your first day. Welcome to the RideSource family!'));
    children.push(sp());children.push(body('Warmly,'));children.push(sp());children.push(sp());
    if(mgr){children.push(body(mgr.name,{bold:true}));children.push(body(mgr.title));children.push(body('RideSource Inc.'));}
  }
  else if(templateId==='rejection'){
    const dt=fmtDate(getVal('date'));const app=getVal('appName')||'[Applicant]';
    children.push(heading('LETTER OF REJECTION'));children.push(body(dt));children.push(sp());
    children.push(body(`Dear ${app},`));children.push(sp());
    children.push(body('Thank you for your interest in joining the RideSource team and for taking the time to interview for our driving position. We genuinely appreciate the time and effort you invested in our process.'));
    children.push(sp());children.push(body('After careful consideration, we have decided to move forward with another candidate whose qualifications more closely match our current needs.'));
    children.push(sp());children.push(body('We wish you the very best in your job search and future endeavors.'));
    children.push(sp());children.push(body('Sincerely,'));children.push(sp());children.push(sp());
    if(mgr){children.push(body(mgr.name,{bold:true}));children.push(body(mgr.title));children.push(body('RideSource Inc.'));}
  }
  else{
    // Generic template for all others
    const tpl=TEMPLATES[templateId];
    children.push(heading(tpl.title.toUpperCase()));children.push(body(`Date: ${today}`));children.push(sp());
    tpl.fields.forEach(f=>{
      const val=getVal(f.id);
      if(f.type==='date'&&val){children.push(body(`${f.label}: ${fmtDate(val)}`));}
      else if(val){children.push(body(`${f.label}: ${val}`));}
      else{children.push(new Paragraph({spacing:{after:80},children:[txt(`${f.label}: `,{bold:true,size:20}),txt('_______________________________',{size:20,color:'999999'})]}));}
    });
    children.push(sp());children.push(sp());
    children.push(new Paragraph({border:{bottom:{style:BorderStyle.SINGLE,size:4,color:'D0D9EC'}},spacing:{after:80},children:[]}));
    children.push(body('Employee Signature: _________________________________ Date: _____________'));
    children.push(body('Supervisor Signature: _________________________________ Date: _____________'));
  }

  const doc=new Document({sections:[{properties:{page:{size:{width:12240,height:15840},margin:{top:1440,right:1440,bottom:1440,left:1440}}},children}]});
  return await Packer.toBlob(doc);
}

// ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ
const COUNTY_COLORS={Hancock:'#2980B9',Washington:'#C0392B',Somerset:'#E67E22',Waldo:'#F39C12',Knox:'#16A085',Androscoggin:'#E74C3C',Cumberland:'#1ABC9C',Franklin:'#95A5A6',Kennebec:'#8E44AD',Lincoln:'#EC407A',Oxford:'#7E57C2',Penobscot:'#2471A3',Piscataquis:'#1565C0',Sagadahoc:'#D84315',York:'#F57F17',Aroostook:'#27AE60'};

async function renderCalendar(){
  document.getElementById('cal-title').textContent=new Date(calYear,calMonth).toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const {data:timeoff}=await db.from('time_off_requests').select('*').eq('status','APPROVED');
  const {data:callouts}=await db.from('call_out_log').select('*');
  const events={};
  (timeoff||[]).forEach(r=>{
    const start=new Date(r.start_date+'T00:00:00'),end=new Date((r.end_date||r.start_date)+'T00:00:00');
    for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)){
      if(d.getMonth()===calMonth&&d.getFullYear()===calYear){const k=d.getDate();if(!events[k])events[k]=[];events[k].push({label:r.employee_name.split(' ')[0]+' (TO)',color:COUNTY_COLORS[r.county]||'#555'});}
    }
  });
  (callouts||[]).forEach(c=>{
    const d=new Date(c.callout_date+'T00:00:00');
    if(d.getMonth()===calMonth&&d.getFullYear()===calYear){const k=d.getDate();if(!events[k])events[k]=[];events[k].push({label:c.employee_name.split(' ')[0]+' (CO)',color:'#E74C3C'});}
  });
  const firstDay=new Date(calYear,calMonth,1).getDay();
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  let html=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;">`;
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>html+=`<div style="text-align:center;font-size:11px;font-weight:700;color:#888;padding:6px 0;">${d}</div>`);
  for(let i=0;i<firstDay;i++)html+=`<div style="min-height:80px;"></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const isToday=new Date().getDate()===d&&new Date().getMonth()===calMonth&&new Date().getFullYear()===calYear;
    const evs=events[d]||[];
    html+=`<div style="min-height:80px;border:1px solid #e8e8e8;border-radius:4px;padding:4px;background:${isToday?'#EAF0FB':'#fff'};"><div style="font-size:12px;font-weight:${isToday?'800':'600'};color:${isToday?'var(--navy)':'#333'};margin-bottom:3px;">${d}</div>${evs.map(e=>`<div style="background:${e.color};color:#fff;font-size:10px;padding:2px 5px;border-radius:3px;margin-bottom:2px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">${e.label}</div>`).join('')}</div>`;
  }
  html+=`</div>`;
  document.getElementById('cal-grid').innerHTML=html;
  document.getElementById('cal-legend').innerHTML=`<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;"><span style="width:12px;height:12px;background:#E74C3C;border-radius:2px;display:inline-block;"></span>Call-Out</span> `+Object.entries(COUNTY_COLORS).map(([c,col])=>`<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;"><span style="width:12px;height:12px;background:${col};border-radius:2px;display:inline-block;"></span>${c}</span>`).join(' ');
}
function changeMonth(dir){calMonth+=dir;if(calMonth>11){calMonth=0;calYear++;}else if(calMonth<0){calMonth=11;calYear--;}renderCalendar();}
</script>
</body>
</html>
