<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RideSource Staff Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://unpkg.com/docx@8.5.0/build/index.min.js"></script>
<style>
:root{--navy:#1B2A4A;--red:#C0392B;--light:#EAF0FB;--border:#D0D9EC;--success:#27AE60;--warn:#E67E22;--gray:#F7F9FC;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:Arial,sans-serif;background:#F0F4FA;color:#222;min-height:100vh;}

/* â”€â”€ LANDING â”€â”€ */
.landing-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0f1f3d 0%,#1B2A4A 60%,#2c3e6b 100%);}
.landing-card{background:#fff;border-radius:16px;padding:52px 48px;width:100%;max-width:500px;box-shadow:0 20px 60px rgba(0,0,0,0.4);text-align:center;}
.landing-brand{font-size:32px;font-weight:900;color:var(--navy);letter-spacing:-1px;margin-bottom:4px;}
.landing-brand span{color:var(--red);}
.landing-sub{font-size:13px;color:#888;margin-bottom:28px;letter-spacing:.5px;text-transform:uppercase;}

/* Tab switcher on landing */
.portal-tabs{display:flex;border-radius:10px;overflow:hidden;border:2px solid var(--border);margin-bottom:28px;}
.portal-tab{flex:1;padding:12px;font-size:14px;font-weight:700;cursor:pointer;border:none;background:#f8f9fa;color:#888;transition:all .2s;}
.portal-tab.active{background:var(--navy);color:#fff;}

.landing-title{font-size:18px;font-weight:700;color:var(--navy);margin-bottom:6px;}
.landing-desc{font-size:13px;color:#666;margin-bottom:24px;line-height:1.6;}
.landing-field{width:100%;padding:13px 16px;border:2px solid var(--border);border-radius:8px;font-size:15px;margin-bottom:12px;outline:none;transition:border-color .2s;font-family:Arial,sans-serif;}
.landing-field:focus{border-color:var(--navy);}
.landing-btn{width:100%;padding:14px;background:var(--navy);color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer;transition:background .2s;}
.landing-btn:hover{background:#0f1f3d;}
.error-msg{background:#fdecea;border:1px solid #f5c6c2;border-radius:6px;padding:10px 14px;color:var(--red);font-size:13px;margin-top:8px;display:none;}

/* â”€â”€ SCREENS â”€â”€ */
.screen{display:none;}.screen.active{display:block;}

/* â”€â”€ HEADER â”€â”€ */
.header{background:var(--navy);padding:0 32px;display:flex;align-items:center;justify-content:space-between;height:64px;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.3);}
.brand{font-size:22px;font-weight:800;color:#fff;letter-spacing:-.5px;}
.brand span{color:var(--red);}
.tagline{font-size:11px;color:rgba(255,255,255,.5);letter-spacing:.5px;}
.header-badge{background:var(--red);color:#fff;font-size:11px;font-weight:700;padding:3px 10px;border-radius:12px;letter-spacing:.5px;}
.header-right{display:flex;align-items:center;gap:12px;}
.header-user{font-size:13px;color:rgba(255,255,255,.75);}
.header-user strong{color:#fff;}
.btn-logout{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;}
.btn-logout:hover{background:rgba(255,255,255,.2);}

/* â”€â”€ LAYOUT â”€â”€ */
.portal-layout{display:flex;min-height:calc(100vh - 64px);}
.sidebar{width:240px;background:#fff;border-right:1px solid var(--border);padding:24px 0;flex-shrink:0;position:sticky;top:64px;height:calc(100vh - 64px);overflow-y:auto;}
.sidebar-label{font-size:10px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;padding:8px 16px 4px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 16px;cursor:pointer;font-size:13px;color:#555;font-weight:500;transition:all .15s;margin:1px 8px;border-radius:8px;}
.nav-item:hover{background:var(--light);color:var(--navy);}
.nav-item.active{background:var(--navy);color:#fff;border-color:var(--navy);}
.nav-icon{font-size:16px;width:20px;text-align:center;}
.nav-badge{margin-left:auto;background:var(--red);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;}
.nav-item.active .nav-badge{background:rgba(255,255,255,.25);}
.main-content{flex:1;padding:32px;overflow-y:auto;}
.brand{font-size:26px;font-weight:900;color:#fff;letter-spacing:-.5px;line-height:1;}
.brand span{color:#ff9999;}
.tagline{font-size:11px;color:rgba(255,255,255,0.55);letter-spacing:.5px;margin-top:2px;}

/* â”€â”€ PROGRESS â”€â”€ */
.progress-bar-wrap{background:#fff;border:1px solid var(--border);border-radius:10px;padding:16px 20px;margin-bottom:24px;}
.progress-label{font-size:12px;font-weight:600;color:#888;margin-bottom:8px;display:flex;justify-content:space-between;}
.progress-track{height:8px;background:#eee;border-radius:4px;overflow:hidden;}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--navy),#4a7fd4);border-radius:4px;transition:width .5s ease;}

/* â”€â”€ CARDS â”€â”€ */
.card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:28px;margin-bottom:24px;}
.card-title{font-size:18px;font-weight:700;color:var(--navy);margin-bottom:6px;display:flex;align-items:center;gap:10px;}
.card-sub{font-size:13px;color:#888;margin-bottom:20px;}

/* â”€â”€ DOC READER â”€â”€ */
.doc-reader{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden;}
.doc-nav{background:var(--navy);padding:16px 24px;display:flex;align-items:center;justify-content:space-between;}
.doc-nav-title{color:#fff;font-size:15px;font-weight:700;}
.doc-nav-progress{color:rgba(255,255,255,.65);font-size:12px;}
.doc-tabs{display:flex;background:var(--gray);border-bottom:1px solid var(--border);overflow-x:auto;}
.doc-tab{padding:12px 20px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;color:#777;border-bottom:3px solid transparent;border:1px solid transparent;border-radius:6px 6px 0 0;transition:all .15s;}
.doc-tab:hover{color:var(--navy);}
.doc-tab.active{color:var(--navy);border-bottom-color:var(--navy);background:#fff;}
.doc-tab.completed{color:var(--success);}
.doc-tab.completed::before{content:'âœ“ ';}
.doc-body{padding:36px 48px;min-height:500px;overflow-y:auto;font-size:14px;line-height:1.75;max-height:none;}
.doc-body h1{font-size:22px;color:var(--navy);margin:28px 0 10px;padding-bottom:8px;border-bottom:2px solid var(--red);}
.doc-body h2{font-size:17px;color:var(--navy);margin:20px 0 8px;font-weight:700;}
.doc-body h3{font-size:15px;color:#444;margin:16px 0 6px;font-weight:700;}
.doc-body p{margin-bottom:12px;color:#333;}
.doc-body ul{margin:8px 0 12px 24px;}
.doc-body li{margin-bottom:4px;color:#333;}
.doc-body table{width:100%;border-collapse:collapse;margin:12px 0;}
.doc-body th{background:var(--navy);color:#fff;padding:8px 12px;font-size:13px;text-align:left;}
.doc-body td{padding:8px 12px;border-bottom:1px solid #eee;font-size:13px;}
.doc-body .callout{background:var(--light);border-left:4px solid var(--navy);border-radius:0 8px 8px 0;padding:14px 18px;margin:16px 0;}
.doc-body .callout strong{color:var(--navy);display:block;margin-bottom:4px;}
.doc-body .warn-box{background:#fff3cd;border-left:4px solid var(--warn);border-radius:0 8px 8px 0;padding:12px 16px;margin:12px 0;}
.doc-footer{padding:16px 24px;background:var(--gray);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.doc-footer-note{font-size:12px;color:#888;}

/* â”€â”€ BUTTONS â”€â”€ */
.btn-primary{background:var(--navy);color:#fff;border:none;padding:10px 22px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:background .2s;}
.btn-primary:hover{background:#0f1f3d;}
.btn-primary:disabled{background:#aaa;cursor:not-allowed;}
.btn-secondary{background:transparent;color:var(--navy);border:2px solid var(--navy);padding:9px 20px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-secondary:hover{background:var(--light);}
.btn{padding:9px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s;}
.btn-red{background:var(--red);color:#fff;}
.btn-red:hover{background:#a93226;}
.btn-green{background:var(--success);color:#fff;}
.btn-sm{padding:6px 12px;font-size:12px;}

/* â”€â”€ SIG â”€â”€ */
.sig-block{background:#fff;border:2px solid var(--navy);border-radius:12px;padding:32px;margin-top:24px;}
.sig-block h3{font-size:17px;color:var(--navy);margin-bottom:6px;}
.sig-block p{font-size:13px;color:#666;margin-bottom:20px;line-height:1.6;}
.sig-options{display:flex;flex-direction:column;gap:14px;margin-bottom:24px;}
.sig-option{display:flex;align-items:flex-start;gap:12px;padding:16px;border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all .2s;}
.sig-option:hover{border-color:var(--navy);background:var(--light);}
.sig-option.selected{border-color:var(--navy);background:var(--light);}
.sig-option input[type="radio"]{margin-top:2px;accent-color:var(--navy);transform:scale(1.2);}
.sig-option label{cursor:pointer;font-size:14px;line-height:1.5;}
.sig-option label strong{display:block;color:var(--navy);margin-bottom:3px;}
.sig-field{margin-bottom:16px;}
.sig-field label{display:block;font-size:12px;font-weight:700;color:#555;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;}
.sig-field input{width:100%;padding:11px 14px;border:2px solid var(--border);border-radius:8px;font-size:15px;font-style:italic;outline:none;transition:border-color .2s;}
.sig-field input:focus{border-color:var(--navy);}
.sig-legal{font-size:11px;color:#999;line-height:1.5;margin-bottom:20px;padding:12px;background:var(--gray);border-radius:6px;border:1px solid var(--border);}

/* â”€â”€ POLICY â”€â”€ */
.policy-list{display:flex;flex-direction:column;gap:12px;}
.policy-item{display:flex;align-items:center;gap:14px;padding:16px 18px;border:1px solid var(--border);border-radius:10px;background:#fff;}
.policy-item.signed{background:#f0faf4;border-color:#a8d5b5;}
.policy-check{width:28px;height:28px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px;}
.policy-item.signed .policy-check{background:var(--success);border-color:var(--success);color:#fff;}
.policy-info{flex:1;}
.policy-name{font-size:14px;font-weight:700;color:var(--navy);margin-bottom:2px;}
.policy-desc{font-size:12px;color:#888;}
.policy-time{font-size:11px;color:#aaa;}
.policy-btn{padding:8px 16px;font-size:13px;font-weight:600;border-radius:6px;cursor:pointer;border:none;}
.policy-btn-read{background:var(--navy);color:#fff;}
.policy-btn-done{background:var(--success);color:#fff;cursor:default;}

/* â”€â”€ MODALS â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:200;display:none;align-items:center;justify-content:center;padding:24px;}
.modal-overlay.open{display:flex;}
.modal{background:#fff;border-radius:16px;padding:32px;width:100%;max-width:700px;max-height:90vh;overflow-y:auto;position:relative;}
.modal-close{position:absolute;top:16px;right:20px;background:none;border:none;font-size:22px;cursor:pointer;color:#aaa;}
.modal-close:hover{color:#333;}
.modal h3{font-size:20px;color:var(--navy);margin-bottom:8px;}
.modal p{font-size:14px;color:#666;margin-bottom:16px;line-height:1.6;}
.modal-body{max-height:50vh;overflow-y:auto;border:1px solid var(--border);border-radius:8px;padding:20px 24px;margin-bottom:20px;font-size:13px;line-height:1.7;color:#444;background:var(--gray);}

/* â”€â”€ WELCOME DASH â”€â”€ */
.welcome-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:24px;}
.stat-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:20px;display:flex;align-items:center;gap:16px;}
.stat-icon{width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;}
.stat-val{font-size:24px;font-weight:800;color:var(--navy);}
.stat-label{font-size:12px;color:#888;font-weight:500;}
.checklist{list-style:none;}
.checklist li{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #f0f0f0;font-size:14px;}
.checklist li:last-child{border-bottom:none;}
.checklist-item{display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid #f0f0f0;font-size:13px;line-height:1.6;}
.checklist-item:last-of-type{border-bottom:none;}
.check-box{font-size:18px;color:var(--navy);flex-shrink:0;margin-top:1px;}
.check-dot{width:20px;height:20px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;}
.check-dot.done{background:var(--success);color:#fff;}
.check-dot.pending{background:#eee;color:#aaa;}

/* â”€â”€ SUCCESS â”€â”€ */
.success-banner{background:linear-gradient(135deg,#1a6b3a,#27AE60);color:#fff;border-radius:12px;padding:32px;text-align:center;margin-bottom:24px;}
.success-banner .big-check{font-size:48px;margin-bottom:12px;}
.success-banner h2{font-size:24px;margin-bottom:8px;}
.success-banner p{font-size:14px;opacity:.85;}

/* â”€â”€ PORTAL SECTION â”€â”€ */
.portal-section{display:none;}

/* â”€â”€ ADMIN â”€â”€ */
.admin-section{display:none;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:20px;}
.admin-stat-card{background:#fff;border:1px solid var(--border);border-radius:10px;padding:18px;display:flex;align-items:center;gap:14px;}
.admin-stat-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.admin-stat-val{font-size:26px;font-weight:800;color:var(--navy);}
.admin-stat-label{font-size:11px;color:#888;font-weight:500;}
.data-table{width:100%;border-collapse:collapse;}
.data-table th{background:var(--navy);color:#fff;padding:10px 14px;text-align:left;font-size:12px;font-weight:700;letter-spacing:.3px;}
.data-table td{padding:10px 14px;font-size:13px;border-bottom:1px solid #f0f0f0;}
.data-table tr:hover td{background:var(--gray);}
.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;}
.badge-pending{background:#fff3cd;color:#856404;}
.badge-approved{background:#d4edda;color:#155724;}
.badge-denied{background:#f8d7da;color:#721c24;}
.badge-flag{background:#fdecea;color:var(--red);}
.badge-warning{background:#fef3e8;color:var(--warn);}
.template-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-bottom:20px;}
.template-card{background:#fff;border:1px solid var(--border);border-radius:10px;padding:18px;cursor:pointer;transition:all .2s;}
.template-card:hover{border-color:var(--navy);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.08);}
.template-icon{font-size:28px;margin-bottom:10px;}
.template-name{font-size:14px;font-weight:700;color:var(--navy);margin-bottom:4px;}
.template-desc{font-size:12px;color:#888;line-height:1.5;}
.form-field{margin-bottom:14px;}
.form-field label{display:block;font-size:11px;font-weight:700;color:#555;text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px;}
.form-field input,.form-field select,.form-field textarea{width:100%;padding:10px 13px;border:2px solid var(--border);border-radius:8px;font-size:13px;outline:none;transition:border-color .2s;font-family:Arial,sans-serif;}
.form-field input:focus,.form-field select:focus,.form-field textarea:focus{border-color:var(--navy);}
.form-field textarea{min-height:100px;resize:vertical;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.warning-employee{background:#fff;border:1px solid var(--border);border-radius:10px;padding:16px 18px;display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.preview-box{background:var(--gray);border:1px solid var(--border);border-radius:8px;padding:20px 24px;margin:14px 0;font-size:13px;line-height:1.8;white-space:pre-wrap;font-family:Arial,sans-serif;max-height:350px;overflow-y:auto;}

@media(max-width:768px){.sidebar{display:none;}.main-content{padding:16px;}.doc-body{padding:20px;}}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â• LANDING â•â•â•â•â•â•â•â• -->
<div id="screen-landing" class="screen active">
  <div class="landing-wrap">
    <div class="landing-card">
      <div style="margin-bottom:4px;text-align:center;"><div style="font-size:36px;font-weight:900;color:#1B2A4A;letter-spacing:-1px;line-height:1;">Ride<span style="color:#C0392B;">Source</span><span style="font-size:14px;font-weight:700;color:#1B2A4A;"> Inc.</span></div><div style="font-size:11px;font-weight:700;color:#888;letter-spacing:1px;text-transform:uppercase;margin-top:2px;">Reliable Safe Transportation</div></div>
      <div class="landing-sub">Reliable Safe Transportation</div>

      <div class="portal-tabs">
        <button class="portal-tab active" id="tab-emp" onclick="switchLanding('employee')">ğŸ‘¤ Employee Portal</button>
        <button class="portal-tab" id="tab-adm" onclick="switchLanding('admin')">ğŸ”’ Admin Portal</button>
      </div>

      <!-- Employee login -->
      <div id="landing-employee">
        <div class="landing-title">Welcome!</div>
        <div class="landing-desc">Complete your onboarding, review company policies, and sign your acknowledgments â€” all in one place.</div>
        <input class="landing-field" id="login-name" type="text" placeholder="Your Full Name" autocomplete="name">
        <input class="landing-field" id="login-email" type="email" placeholder="Your Email Address" autocomplete="email">
        <select class="landing-field" id="login-county">
          <option value="">Select Your County</option>
          <option>Androscoggin</option><option>Aroostook</option><option>Cumberland</option>
          <option>Franklin</option><option>Hancock</option><option>Kennebec</option>
          <option>Knox</option><option>Lincoln</option><option>Oxford</option>
          <option>Penobscot</option><option>Piscataquis</option><option>Sagadahoc</option>
          <option>Somerset</option><option>Waldo</option><option>Washington</option><option>York</option>
        </select>
        <button class="landing-btn" onclick="startPortal()">Enter Employee Portal â†’</button>
        <div class="error-msg" id="login-error">Please fill in all fields to continue.</div>
      </div>

      <!-- Admin login -->
      <div id="landing-admin" style="display:none;">
        <div class="landing-title">Admin &amp; Manager Access</div>
        <div class="landing-desc">Supervisors and HR staff only. Enter your name and admin password to continue.</div>
        <input class="landing-field" id="admin-name" type="text" placeholder="Your Full Name">
        <input class="landing-field" id="admin-pass" type="password" placeholder="Admin Password" onkeydown="if(event.key==='Enter')adminLogin()">
        <button class="landing-btn" onclick="adminLogin()">Enter Admin Portal â†’</button>
        <div class="error-msg" id="admin-error">Incorrect password or missing name. Please try again.</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• EMPLOYEE PORTAL â•â•â•â•â•â•â•â• -->
<div id="screen-portal" class="screen">
  <div class="header">
    <div>
      <div style="line-height:1.2;"><div style="font-size:22px;font-weight:900;color:#fff;letter-spacing:-.5px;">Ride<span style="color:#ff6b6b;">Source</span></div><div style="font-size:10px;color:rgba(255,255,255,0.55);letter-spacing:.5px;">RELIABLE SAFE TRANSPORTATION</div></div>
    </div>
    <div class="header-right">
      <div class="header-user">Welcome, <strong id="display-name"></strong></div>
      <button class="btn-logout" onclick="logout()">Sign Out</button>
    </div>
  </div>
  <div class="portal-layout">
    <div class="sidebar">
      <div style="padding:0 8px;">
        <div class="sidebar-label">Overview</div>
        <div class="nav-item active" onclick="showSection('dashboard')" id="nav-dashboard"><span class="nav-icon">ğŸ </span>Dashboard</div>
        <div class="sidebar-label">Documents</div>
        <div class="nav-item" onclick="showSection('training')" id="nav-training"><span class="nav-icon">ğŸ“‹</span>Driver Training Guide</div>
        <div class="nav-item" onclick="showSection('handbook')" id="nav-handbook"><span class="nav-icon">ğŸ“–</span>Employee Handbook</div>
        <div class="sidebar-label">Actions</div>
        <div class="nav-item" onclick="showSection('policies')" id="nav-policies"><span class="nav-icon">âœï¸</span>Policy Sign-Offs<span class="nav-badge" id="badge-policies">0/7</span></div>
        <div class="nav-item" onclick="showSection('timeoff')" id="nav-timeoff"><span class="nav-icon">ğŸ“…</span>Request Time Off</div>
      </div>
    </div>
    <div class="main-content">

      <!-- DASHBOARD -->
      <div id="section-dashboard" class="portal-section" style="display:block;">
        <div class="progress-bar-wrap">
          <div class="progress-label"><span>Onboarding Progress</span><span id="progress-pct">0%</span></div>
          <div class="progress-track"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
        </div>
        <div class="welcome-grid">
          <div class="stat-card"><div class="stat-icon" style="background:var(--light);">ğŸ“„</div><div><div class="stat-val" id="stat-docs">0/2</div><div class="stat-label">Documents Read</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:#e8f8ee;">âœï¸</div><div><div class="stat-val" id="stat-sigs">0/7</div><div class="stat-label">Policies Signed</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:#fef3e8;">â³</div><div><div class="stat-val" id="stat-remaining">9</div><div class="stat-label">Items Remaining</div></div></div>
        </div>
        <div class="card">
          <div class="card-title">ğŸ“ Your Onboarding Checklist</div>
          <ul class="checklist" id="dash-checklist"></ul>
        </div>
      </div>

      <!-- TRAINING -->
      <div id="section-training" class="portal-section">
        <div class="card-title" style="font-size:22px;color:var(--navy);margin-bottom:4px;">ğŸ“‹ Driver Training Guide</div>
        <p style="color:#888;font-size:14px;margin-bottom:20px;">Version 2.1 Â· February 2026</p>
        <div class="doc-reader">
          <div class="doc-nav">
            <div class="doc-nav-title">RideSource Driver Training Guide</div>
            <div class="doc-nav-progress" id="training-progress-label">Section 1 of 6</div>
          </div>
          <div class="doc-tabs" id="training-tabs"></div>
          <div class="doc-body" id="training-body" onscroll="checkScroll('training')"></div>
          <div class="doc-footer">
            <div class="doc-footer-note" id="training-scroll-note">ğŸ“– Scroll to the bottom of this section to continue.</div>
            <div style="display:flex;gap:8px;">
              <button class="btn-secondary" id="training-prev" onclick="changeSection('training',-1)" style="padding:8px 16px;font-size:13px;" disabled>â† Previous</button>
              <button class="btn-primary" id="training-next" onclick="changeSection('training',1)" style="padding:8px 16px;font-size:13px;" disabled>Next Section â†’</button>
            </div>
          </div>
        </div>
        <div id="training-complete-banner" style="display:none;margin-top:20px;" class="success-banner">
          <div class="big-check">âœ…</div>
          <h2>Training Guide Complete!</h2>
          <p>Great work. Continue to the Employee Handbook next.</p>
          <button class="btn-primary" style="margin-top:12px;background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.5);" onclick="showSection('handbook')">Go to Employee Handbook â†’</button>
        </div>
      </div>

      <!-- HANDBOOK -->
      <div id="section-handbook" class="portal-section">
        <div class="card-title" style="font-size:22px;color:var(--navy);margin-bottom:4px;">ğŸ“– Employee Handbook</div>
        <p style="color:#888;font-size:14px;margin-bottom:20px;">Version 3.0 Â· February 2026</p>
        <div class="doc-reader">
          <div class="doc-nav">
            <div class="doc-nav-title">RideSource Employee Handbook</div>
            <div class="doc-nav-progress" id="handbook-progress-label">Section 1 of 10</div>
          </div>
          <div class="doc-tabs" id="handbook-tabs"></div>
          <div class="doc-body" id="handbook-body" onscroll="checkScroll('handbook')"></div>
          <div class="doc-footer">
            <div class="doc-footer-note" id="handbook-scroll-note">ğŸ“– Scroll to the bottom of this section to continue.</div>
            <div style="display:flex;gap:8px;">
              <button class="btn-secondary" id="handbook-prev" onclick="changeSection('handbook',-1)" style="padding:8px 16px;font-size:13px;" disabled>â† Previous</button>
              <button class="btn-primary" id="handbook-next" onclick="changeSection('handbook',1)" style="padding:8px 16px;font-size:13px;" disabled>Next Section â†’</button>
            </div>
          </div>
        </div>
        <div id="handbook-sig" style="display:none;" class="sig-block">
          <h3>ğŸ“ Handbook Acknowledgment</h3>
          <p>You've completed the Employee Handbook. Please provide your electronic signature to complete this step.</p>
          <div class="sig-options">
            <div class="sig-option" id="opt-print" onclick="selectHandbookOpt('print')">
              <input type="radio" name="hb-opt" value="print" id="rb-print">
              <label for="rb-print"><strong>I would like to receive a printed copy of this handbook.</strong>By signing, I acknowledge I have read and understand the handbook and request a printed copy.</label>
            </div>
            <div class="sig-option" id="opt-digital" onclick="selectHandbookOpt('digital')">
              <input type="radio" name="hb-opt" value="digital" id="rb-digital">
              <label for="rb-digital"><strong>I acknowledge receipt and understanding â€” no printed copy requested.</strong>By signing, I acknowledge I have received, read, and understand the handbook.</label>
            </div>
          </div>
          <div class="sig-field"><label>Electronic Signature (type your full legal name)</label><input type="text" id="hb-sig-input" placeholder="Type your full name to sign..." oninput="checkHbSig()"></div>
          <div class="sig-legal">By typing your name above, you are providing an electronic signature legally binding under the E-SIGN Act and Maine law.</div>
          <button class="btn-primary" onclick="submitHandbookSig()" id="hb-submit-btn" disabled>Submit Acknowledgment</button>
        </div>
      </div>

      <!-- POLICIES -->
      <div id="section-policies" class="portal-section">
        <div class="card-title" style="font-size:22px;color:var(--navy);margin-bottom:4px;">âœï¸ Policy Acknowledgments</div>
        <p style="color:#888;font-size:14px;margin-bottom:20px;">Read and sign each policy below. All must be completed before your onboarding is finalized.</p>
        <div class="policy-list" id="policy-list"></div>
        <div id="all-signed-banner" style="display:none;margin-top:24px;" class="success-banner">
          <div class="big-check">ğŸ‰</div>
          <h2>All Policies Signed!</h2>
          <p>Your onboarding acknowledgments are complete. Your supervisor has been notified. Welcome to the RideSource team!</p>
          <button class="btn-primary" style="margin-top:16px;font-size:15px;padding:12px 28px;" onclick="generateCertificate()">ğŸ“„ Get Your Certificate of Completion</button>
        </div>
      </div>

      <!-- TIME OFF -->
      <div id="section-timeoff" class="portal-section">
        <div class="card-title" style="font-size:22px;color:var(--navy);margin-bottom:4px;">ğŸ“… Request Time Off</div>
        <p style="color:#888;font-size:14px;margin-bottom:24px;">Submit a time off request below. Your supervisor will be notified and will approve or deny within a reasonable timeframe.</p>
        <div class="card">
          <div class="card-sub">Select a request type to get started.</div>
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:24px;">
            <button class="req-type-btn btn-secondary" onclick="selectReqType('Full Day Off')">â˜€ï¸ Full Day Off</button>
            <button class="req-type-btn btn-secondary" onclick="selectReqType('Multiple Days')">ğŸ“† Multiple Days</button>
            <button class="req-type-btn btn-secondary" onclick="selectReqType('Start Late')">â° Start Late</button>
            <button class="req-type-btn btn-secondary" onclick="selectReqType('End Early')">ğŸšª End Early</button>
            <button class="req-type-btn btn-secondary" onclick="selectReqType('Mid-Day Appointment')">ğŸ¥ Mid-Day Appointment</button>
          </div>
          <div id="req-form" style="display:none;">
            <div id="req-fields"></div>
            <div class="sig-field"><label>Reason (optional)</label><input type="text" id="req-reason" placeholder="Brief reason..." style="width:100%;padding:11px 14px;border:2px solid var(--border);border-radius:8px;font-size:14px;outline:none;"></div>
            <button class="btn-primary" onclick="submitTimeOff()" style="margin-top:8px;">Submit Request</button>
          </div>
          <div id="req-success" style="display:none;" class="success-banner">
            <div>âœ…</div><h2 style="font-size:18px;margin-top:8px;">Request Submitted!</h2>
            <p>Your supervisor has been notified. You'll receive an email when a decision is made.</p>
            <button class="btn-primary" style="margin-top:12px;background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.5);" onclick="resetTimeOff()">Submit Another Request</button>
          </div>
          <div class="card" style="margin-top:16px;">
            <div style="font-size:15px;font-weight:700;color:var(--navy);margin-bottom:12px;">ğŸ“‹ My Submitted Requests</div>
            <div id="my-requests-list"><p style="color:#888;font-size:13px;">Loading...</p></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• ADMIN PORTAL â•â•â•â•â•â•â•â• -->
<div id="screen-admin" class="screen">
  <div class="header">
    <div><div style="line-height:1.2;"><div style="font-size:22px;font-weight:900;color:#fff;letter-spacing:-.5px;">Ride<span style="color:#ff6b6b;">Source</span></div><div style="font-size:10px;color:rgba(255,255,255,0.55);letter-spacing:.5px;">RELIABLE SAFE TRANSPORTATION</div></div></div>
    <div class="header-right">
      <div class="header-badge">ADMIN</div>
      <span style="color:rgba(255,255,255,.7);font-size:13px;" id="admin-display"></span>
      <button class="btn-logout" onclick="adminLogout()">Sign Out</button>
    </div>
  </div>
  <div class="portal-layout">
    <div class="sidebar">
      <div style="padding:0 8px;">
        <div class="sidebar-label">Overview</div>
        <div class="nav-item active" onclick="showAdmin('dashboard')" id="nav-adm-dashboard"><span class="nav-icon">ğŸ“Š</span>Dashboard</div>
        <div class="sidebar-label">Reference</div>
        <div class="nav-item" onclick="showAdmin('manager-guide')" id="nav-adm-manager-guide"><span class="nav-icon">ğŸ“˜</span>Manager Guide</div>
        <div class="nav-item" onclick="showAdmin('handbook-ref')" id="nav-adm-handbook-ref"><span class="nav-icon">ğŸ“–</span>Employee Handbook</div>
        <div class="sidebar-label">HR Tools</div>
        <div class="nav-item" onclick="showAdmin('templates')" id="nav-adm-templates"><span class="nav-icon">ğŸ“„</span>HR Templates</div>
        <div class="nav-item" onclick="showAdmin('warnings')" id="nav-adm-warnings"><span class="nav-icon">âš ï¸</span>Attendance Warnings<span class="nav-badge" id="badge-flags">0</span></div>
        <div class="nav-item" onclick="showAdmin('onboarding-tracker')" id="nav-adm-onboarding-tracker"><span class="nav-icon">âœ…</span>Onboarding Tracker</div>
        <div class="sidebar-label">Time Off</div>
        <div class="nav-item" onclick="showAdmin('requests')" id="nav-adm-requests"><span class="nav-icon">ğŸ“…</span>Pending Requests<span class="nav-badge" id="badge-requests">0</span></div>
        <div class="nav-item" onclick="showAdmin('callouts')" id="nav-adm-callouts"><span class="nav-icon">ğŸ“</span>Call-Out Log</div>
        <div class="nav-item" onclick="showAdmin('calendar')" id="nav-adm-calendar"><span class="nav-icon">ğŸ—“ï¸</span>Team Calendar</div>
        <div class="sidebar-label">Resources</div>
        <div class="nav-item" onclick="showAdmin('documents')" id="nav-adm-documents"><span class="nav-icon">ğŸ“¥</span>Document Library</div>
      </div>
    </div>
    <div class="main-content">

      <div id="section-adm-dashboard" class="admin-section" style="display:block;">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">Admin Dashboard</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Welcome back, <strong id="dash-admin-name"></strong>. Here's your team at a glance.</p>
        <div class="stats-grid" id="dash-stats"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="card"><div class="card-title">â³ Pending Time Off Requests</div><div id="dash-pending-list" style="font-size:13px;color:#888;">Loading...</div></div>
          <div class="card"><div class="card-title">ğŸš© Attendance Flags</div><div id="dash-flags-list" style="font-size:13px;color:#888;">Loading...</div></div>
        </div>
      </div>

      <div id="section-adm-manager-guide" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">ğŸ“˜ Supervisor &amp; Manager Guide</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Version 1.0 Â· February 2026 Â· Confidential</p>
        <div class="doc-reader">
          <div class="doc-nav"><div class="doc-nav-title">RideSource Supervisor &amp; Manager Guide</div></div>
          <div class="doc-tabs" id="mgr-tabs"></div>
          <div class="doc-body" id="mgr-body"></div>
          <div class="doc-footer">
            <div style="font-size:12px;color:#888;">Confidential â€” Management Use Only</div>
            <div style="display:flex;gap:8px;"><button class="btn btn-secondary btn-sm" onclick="changeMgrSection(-1)">â† Previous</button><button class="btn btn-primary btn-sm" onclick="changeMgrSection(1)">Next â†’</button></div>
          </div>
        </div>
      </div>

      <div id="section-adm-handbook-ref" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">ğŸ“– Employee Handbook Reference</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Read-only reference copy.</p>
        <div class="card" style="padding:16px 20px;background:var(--light);border-color:#b8ccf0;">
          <p style="font-size:13px;color:var(--navy);font-weight:600;">ğŸ“Œ Printed Copy Requests</p>
          <div id="print-requests-list" style="margin-top:12px;font-size:13px;color:#888;">Loading...</div>
        </div>
        <div class="doc-reader" style="margin-top:16px;">
          <div class="doc-nav"><div class="doc-nav-title">Employee Handbook v3.0 â€” Reference Copy</div></div>
          <div class="doc-tabs" id="hb-ref-tabs"></div>
          <div class="doc-body" id="hb-ref-body"></div>
          <div class="doc-footer">
            <div style="font-size:12px;color:#888;">Read-only reference</div>
            <div style="display:flex;gap:8px;"><button class="btn btn-secondary btn-sm" onclick="changeHbRefSection(-1)">â† Previous</button><button class="btn btn-primary btn-sm" onclick="changeHbRefSection(1)">Next â†’</button></div>
          </div>
        </div>
      </div>

      <div id="section-adm-templates" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">ğŸ“„ HR Templates</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Fill out any template below and download it as a Word document (.docx).</p>
        <div style="font-size:12px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Hiring</div>
        <div class="template-grid" style="margin-bottom:24px;">
          <div class="template-card" onclick="openTemplate('welcome')"><div class="template-icon">ğŸ‰</div><div class="template-name">Welcome Aboard Letter</div><div class="template-desc">New hire welcome letter with training instructions.</div></div>
          <div class="template-card" onclick="openTemplate('rejection')"><div class="template-icon">ğŸ“¨</div><div class="template-name">Letter of Rejection</div><div class="template-desc">Professional rejection letter for applicants not selected.</div></div>
          <div class="template-card" onclick="openTemplate('interview')"><div class="template-icon">ğŸ—£ï¸</div><div class="template-name">Interview Questions Form</div><div class="template-desc">Standardized driver interview form with hire decision.</div></div>
        </div>
        <div style="font-size:12px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">New Employee Forms</div>
        <div class="template-grid" style="margin-bottom:24px;">
          <div class="template-card" onclick="openTemplate('driverinfo')"><div class="template-icon">ğŸªª</div><div class="template-name">Driver Info Form</div><div class="template-desc">New driver candidate information.</div></div>
          <div class="template-card" onclick="openTemplate('emergency')"><div class="template-icon">ğŸš¨</div><div class="template-name">Emergency Contact Form</div><div class="template-desc">Employee emergency contacts with signature block.</div></div>
          <div class="template-card" onclick="openTemplate('consent')"><div class="template-icon">ğŸ“‹</div><div class="template-name">Consent for Certification Release</div><div class="template-desc">Authorization for release of training certifications.</div></div>
        </div>
        <div style="font-size:12px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Separation &amp; HR</div>
        <div class="template-grid">
          <div class="template-card" onclick="openTemplate('resignation')"><div class="template-icon">ğŸ“</div><div class="template-name">Voluntary Resignation Acknowledgment</div><div class="template-desc">Formal acknowledgment with off-boarding checklist.</div></div>
          <div class="template-card" onclick="openTemplate('warn-standard')"><div class="template-icon">âš ï¸</div><div class="template-name">Attendance Warning â€” Standard</div><div class="template-desc">Written attendance warning.</div></div>
          <div class="template-card" onclick="openTemplate('warn-callout')"><div class="template-icon">ğŸ“µ</div><div class="template-name">Attendance Warning â€” Call-Out After Trip</div><div class="template-desc">Warning for call-outs after manifest finalized.</div></div>
          <div class="template-card" onclick="openTemplate('warn-final')"><div class="template-icon">ğŸš¨</div><div class="template-name">Final Written Warning</div><div class="template-desc">Last step before termination.</div></div>
        </div>
        <div style="font-size:12px;font-weight:700;color:#888;text-transform:uppercase;letter-spacing:.5px;margin:20px 0 10px;">Performance Management</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;">
          <div class="template-card" onclick="openTemplate('eval30')"><div class="template-icon">ğŸ“Š</div><div class="template-name">30-Day Evaluation</div><div class="template-desc">Introductory performance review at 30 days.</div></div>
          <div class="template-card" onclick="openTemplate('eval60')"><div class="template-icon">ğŸ“Š</div><div class="template-name">60-Day Evaluation</div><div class="template-desc">Mid-probation performance review at 60 days.</div></div>
          <div class="template-card" onclick="openTemplate('eval90')"><div class="template-icon">ğŸ†</div><div class="template-name">90-Day Evaluation</div><div class="template-desc">Final introductory period performance review.</div></div>
          <div class="template-card" onclick="openTemplate('pip')"><div class="template-icon">âš ï¸</div><div class="template-name">Performance Improvement Plan</div><div class="template-desc">Formal PIP when goals are not being met.</div></div>
        </div>
      </div>

      <div id="section-adm-warnings" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">âš ï¸ Attendance Warning Generator</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">System automatically detects employees with 3+ call-outs in 30 days.</p>
        <div id="flagged-employees" style="margin-bottom:20px;"><p style="font-size:13px;color:#888;">Loading attendance data...</p></div>
        <div class="card">
          <div class="card-title">ğŸ” Manual Warning Lookup</div>
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-field"><label>Employee Name</label><input type="text" id="manual-name" placeholder="Enter employee name..."></div>
            <div class="form-field"><label>County</label><select id="manual-county"><option value="">All Counties</option><option>Androscoggin</option><option>Aroostook</option><option>Cumberland</option><option>Franklin</option><option>Hancock</option><option>Kennebec</option><option>Knox</option><option>Lincoln</option><option>Oxford</option><option>Penobscot</option><option>Piscataquis</option><option>Sagadahoc</option><option>Somerset</option><option>Waldo</option><option>Washington</option><option>York</option></select></div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="manualLookup()">Search Call-Out History</button>
          <div id="manual-results" style="margin-top:14px;"></div>
        </div>
      </div>

      <div id="section-adm-onboarding-tracker" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">âœ… Onboarding Tracker</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Track which employees have completed policy acknowledgments.</p>
        <div id="onboarding-data" style="font-size:13px;color:#888;">Loading...</div>
      </div>

      <div id="section-adm-requests" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">ğŸ“… Time Off Requests</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Review and approve or deny employee time off requests.</p>
        <div id="requests-table">Loading...</div>
      </div>

      <div id="section-adm-callouts" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">ğŸ“ Call-Out Log</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Log employee call-outs. This data powers the attendance warning system automatically.</p>
        <div class="card" style="margin-bottom:16px;">
          <div class="card-title">Log a New Call-Out</div>
          <div class="form-row">
            <div class="form-field"><label>Employee Name</label><input type="text" id="co-name" placeholder="Full name..."></div>
            <div class="form-field"><label>County</label><select id="co-county"><option value="">Select county</option><option>Androscoggin</option><option>Aroostook</option><option>Cumberland</option><option>Franklin</option><option>Hancock</option><option>Kennebec</option><option>Knox</option><option>Lincoln</option><option>Oxford</option><option>Penobscot</option><option>Piscataquis</option><option>Sagadahoc</option><option>Somerset</option><option>Waldo</option><option>Washington</option><option>York</option></select></div>
          </div>
          <div class="form-row">
            <div class="form-field"><label>Call-Out Date</label><input type="date" id="co-date"></div>
            <div class="form-field"><label>Reason</label><select id="co-reason"><option>Sick</option><option>Family Emergency</option><option>Weather</option><option>No reason provided</option><option>Other</option></select></div>
          </div>
          <div class="form-field"><label>Notes</label><input type="text" id="co-notes" placeholder="Optional notes..."></div>
          <button class="btn btn-primary" onclick="logCallOut()">Log Call-Out</button>
          <span id="co-msg" style="font-size:13px;color:var(--success);margin-left:12px;display:none;">âœ“ Logged!</span>
        </div>
        <div class="card"><div class="card-title">Recent Call-Outs</div><div id="callout-table">Loading...</div></div>
      </div>

      <div id="section-adm-calendar" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">ğŸ—“ï¸ Team Calendar</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Approved time off and call-outs, color-coded by county.</p>
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <button class="btn btn-secondary btn-sm" onclick="changeMonth(-1)">â† Previous</button>
            <div style="font-size:16px;font-weight:700;color:var(--navy);" id="cal-title">
    <select id="cal-county-filter" onchange="renderCalendar()" style="padding:6px 12px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-weight:600;">
      <option value="ALL">All Counties</option>
      <option value="Hancock">Hancock</option>
<option value="Washington">Washington</option>
<option value="Somerset">Somerset</option>
<option value="Waldo">Waldo</option>
<option value="Knox">Knox</option>
<option value="Androscoggin">Androscoggin</option>
<option value="Cumberland">Cumberland</option>
<option value="Franklin">Franklin</option>
<option value="Kennebec">Kennebec</option>
<option value="Lincoln">Lincoln</option>
<option value="Oxford">Oxford</option>
<option value="Penobscot">Penobscot</option>
<option value="Piscataquis">Piscataquis</option>
<option value="Sagadahoc">Sagadahoc</option>
<option value="York">York</option>
<option value="Aroostook">Aroostook</option>
    </select>
  </div>
            <button class="btn btn-secondary btn-sm" onclick="changeMonth(1)">Next â†’</button>
          </div>
          <div id="cal-grid"></div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:16px;" id="cal-legend"></div>
        </div>
      </div>

      <div id="section-adm-documents" class="admin-section">
        <div style="font-size:22px;font-weight:800;color:var(--navy);margin-bottom:4px;">ğŸ“¥ Document Library</div>
        <p style="color:#888;font-size:13px;margin-bottom:20px;">Download any of the official RideSource documents below for printing or offline reference.</p>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;">
          <div style="background:#fff;border:1px solid var(--border);border-radius:12px;padding:24px;">
            <div style="font-size:32px;margin-bottom:10px;">ğŸ“–</div>
            <div style="font-size:15px;font-weight:700;color:var(--navy);margin-bottom:4px;">Employee Handbook</div>
            <div style="font-size:12px;color:#888;margin-bottom:16px;line-height:1.5;">Version 6 Â· February 2026 Â· Comprehensive edition covering all policies, conduct, safety, and separation.</div>
            <button onclick="tryDownload('RideSource_Employee_Handbook_v6.docx',this)" style="display:inline-flex;align-items:center;gap:8px;background:var(--navy);color:#fff;padding:10px 18px;border-radius:8px;font-size:13px;font-weight:700;border:none;cursor:pointer;">â¬‡ï¸ Download .docx</button>
          </div>
          <div style="background:#fff;border:1px solid var(--border);border-radius:12px;padding:24px;">
            <div style="font-size:32px;margin-bottom:10px;">ğŸ“‹</div>
            <div style="font-size:15px;font-weight:700;color:var(--navy);margin-bottom:4px;">Driver Training Guide</div>
            <div style="font-size:12px;color:#888;margin-bottom:16px;line-height:1.5;">Version 2.1 Â· February 2026 Â· Complete training guide from Day 1 online courses through Day 6 office orientation.</div>
            <button onclick="tryDownload('RideSource_Driver_Training_Guide_v2_1.docx',this)" style="display:inline-flex;align-items:center;gap:8px;background:var(--navy);color:#fff;padding:10px 18px;border-radius:8px;font-size:13px;font-weight:700;border:none;cursor:pointer;">â¬‡ï¸ Download .docx</button>
          </div>
          <div style="background:#fff;border:1px solid var(--border);border-radius:12px;padding:24px;">
            <div style="font-size:32px;margin-bottom:10px;">âœ…</div>
            <div style="font-size:15px;font-weight:700;color:var(--navy);margin-bottom:4px;">New Employee Onboarding Checklist</div>
            <div style="font-size:12px;color:#888;margin-bottom:16px;line-height:1.5;">Updated 2026 Â· Comprehensive phase-by-phase onboarding checklist for supervisors to complete with new hires.</div>
            <button onclick="tryDownload('RideSource_Onboarding_Checklist.docx',this)" style="display:inline-flex;align-items:center;gap:8px;background:var(--navy);color:#fff;padding:10px 18px;border-radius:8px;font-size:13px;font-weight:700;border:none;cursor:pointer;">â¬‡ï¸ Download .docx</button>
          </div>
          <div style="background:#fff;border:1px solid var(--border);border-radius:12px;padding:24px;">
            <div style="font-size:32px;margin-bottom:10px;">ğŸ“˜</div>
            <div style="font-size:15px;font-weight:700;color:var(--navy);margin-bottom:4px;">Supervisor &amp; Manager Guide</div>
            <div style="font-size:12px;color:#888;margin-bottom:16px;line-height:1.5;">Version F1 Â· February 2026 Â· Confidential guide covering onboarding responsibilities, time off system, and HR procedures.</div>
            <button onclick="tryDownload('RideSource_Manager_Guide_vF1.docx',this)" style="display:inline-flex;align-items:center;gap:8px;background:var(--navy);color:#fff;padding:10px 18px;border-radius:8px;font-size:13px;font-weight:700;border:none;cursor:pointer;">â¬‡ï¸ Download .docx</button>
          </div>
        </div>
        <div class="card" style="margin-top:20px;background:#e8f5e9;border-color:#81c784;">
          <div style="font-size:13px;color:#2e7d32;font-weight:600;margin-bottom:6px;">ğŸ“Œ How to enable document downloads</div>
          <p style="font-size:12px;color:#1b5e20;line-height:1.7;margin:0;">Upload your .docx files directly to your GitHub repository (same folder as <code>index.html</code>). Use these exact filenames:<br>
          <code>RideSource_Employee_Handbook_v6.docx</code> &nbsp;Â·&nbsp; <code>RideSource_Driver_Training_Guide_v2_1.docx</code> &nbsp;Â·&nbsp; <code>RideSource_Onboarding_Checklist.docx</code> &nbsp;Â·&nbsp; <code>RideSource_Manager_Guide_vF1.docx</code><br><br>
          Once uploaded, the Download buttons above will work automatically. The buttons currently show a message if the file hasn't been uploaded yet.</p>
        </div>
      </div>

    </div>
  </div>
</div>
<div class="modal-overlay" id="policy-modal">
  <div class="modal" style="max-width:640px;">
    <button class="modal-close" onclick="closePolicyModal()">âœ•</button>
    <h3 id="modal-title">Policy Title</h3>
    <p id="modal-desc" style="color:#666;font-size:13px;margin-bottom:12px;">Please read the full policy below, then check the box and provide your electronic signature.</p>
    <div class="modal-body" id="modal-body" onscroll="checkModalScroll()" style="max-height:340px;"></div>
    <div style="background:#f8f9fa;border:1px solid var(--border);border-radius:8px;padding:14px;margin-top:12px;">
      <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;font-size:13px;">
        <input type="checkbox" id="modal-understand-check" onchange="checkModalSig()" style="margin-top:2px;width:16px;height:16px;accent-color:var(--navy);">
        <span>I have read and understand this policy in its entirety, and I agree to comply with all terms and conditions described above.</span>
      </label>
    </div>
    <div class="sig-field" style="margin-top:12px;">
      <label>Electronic Signature â€” Type your full legal name *</label>
      <input type="text" id="modal-sig" placeholder="Type your full name to sign..." oninput="checkModalSig()">
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
      <label style="font-size:12px;color:#666;min-width:90px;">Date Signed:</label>
      <input type="date" id="modal-date" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
    </div>
    <div class="sig-legal" style="margin-top:8px;">By typing your name above, you are providing a legally binding electronic signature under the E-SIGN Act.</div>
    <div style="color:#888;font-size:11px;margin-top:4px;" id="modal-scroll-note">ğŸ“– Please scroll to the bottom of the policy before signing.</div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
      <button class="btn-secondary" onclick="closePolicyModal()">Cancel</button>
      <button class="btn-primary" id="modal-sign-btn" onclick="signPolicy()" disabled>âœ Sign &amp; Acknowledge</button>
    </div>
  </div>
</div>

<!-- HR Template Modal -->
<div class="modal-overlay" id="template-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('template-modal')">âœ•</button>
    <h3 id="tmpl-title">Template</h3>
    <p id="tmpl-desc">Fill in the fields below, then download your Word document.</p>
    <div id="tmpl-form"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
      <button class="btn btn-secondary" onclick="closeModal('template-modal')">Cancel</button>
      <button class="btn btn-primary" id="tmpl-download-btn" onclick="downloadTemplate()">â¬‡ï¸ Download Word Doc</button>
    </div>
  </div>
</div>

<!-- Warning Modal -->
<div class="modal-overlay" id="warning-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('warning-modal')">âœ•</button>
    <h3 id="warn-modal-title">Attendance Warning</h3>
    <p id="warn-modal-desc">Review and edit the warning below before generating.</p>
    <div id="warn-form"></div>
    <div class="preview-box" id="warn-preview" style="display:none;"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;">
      <button class="btn btn-secondary" onclick="closeModal('warning-modal')">Cancel</button>
      <button class="btn btn-red" id="warn-gen-btn" onclick="generateWarning()">Generate Warning Letter</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ CONFIG â”€â”€
function getDocx(){
  if(typeof docx!=='undefined')return docx;
  if(window.docx)return window.docx;
  if(typeof Document!=='undefined'&&typeof Packer!=='undefined')return window;
  return null;
}
const SUPABASE_URL='https://iasphxpahlmjwkapyxrs.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlhc3BoeHBhaGxtandrYXB5eHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNDIyNDYsImV4cCI6MjA4NjkxODI0Nn0.ntQxEiEJqZOvXjfX58I-PPQ2ZOoAT_RgLyf3aWMeXds';
const EMAILJS_SERVICE_ID='ridesource_calendar';
const EMAILJS_PUBLIC_KEY='AoArkSo12DpQtsvZZ';
const SUPERVISOR_EMAIL='tiffanyb@ridesourcemaine.com';
const PORTAL_URL='https://ridesourcecalendar-hub.github.io/ridesource-onboarding/index.html';
const ADMIN_PASSWORD='RideSource2026!';

const {createClient}=supabase;
const db=createClient(SUPABASE_URL,SUPABASE_KEY);
if(typeof emailjs!=='undefined'){emailjs.init({publicKey:EMAILJS_PUBLIC_KEY});}

// â”€â”€ LANDING â”€â”€
function switchLanding(mode){
  document.getElementById('landing-employee').style.display=mode==='employee'?'block':'none';
  document.getElementById('landing-admin').style.display=mode==='admin'?'block':'none';
  document.getElementById('tab-emp').classList.toggle('active',mode==='employee');
  document.getElementById('tab-adm').classList.toggle('active',mode==='admin');
}

// â”€â”€ EMPLOYEE AUTH â”€â”€
let user=null,trainingSection=0,handbookSection=0;
let trainingSectionRead={},handbookSectionRead={};
let trainingComplete=false,handbookComplete=false,handbookSigChoice=null;
let currentPolicyIndex=null,modalScrolled=false,currentReqType=null;

function startPortal(){
  const name=document.getElementById('login-name').value.trim();
  const email=document.getElementById('login-email').value.trim();
  const county=document.getElementById('login-county').value;
  if(!name||!email||!county){document.getElementById('login-error').style.display='block';return;}
  document.getElementById('login-error').style.display='none';
  user={name,email,county};
  document.getElementById('display-name').textContent=name;
  document.getElementById('screen-landing').classList.remove('active');
  document.getElementById('screen-portal').classList.add('active');
  loadSavedState();buildTraining();buildHandbook();buildPolicies();updateDashboard();
}

function logout(){
  saveState();user=null;trainingSection=0;handbookSection=0;
  trainingSectionRead={};handbookSectionRead={};trainingComplete=false;handbookComplete=false;
  document.getElementById('screen-portal').classList.remove('active');
  document.getElementById('screen-landing').classList.add('active');
}

// â”€â”€ ADMIN AUTH â”€â”€
let adminName='',mgrSection=0,hbRefSection=0;
let calYear=new Date().getFullYear(),calMonth=new Date().getMonth(),warningData=null;

function adminLogin(){
  const name=document.getElementById('admin-name').value.trim();
  const pass=document.getElementById('admin-pass').value;
  if(pass!==ADMIN_PASSWORD||!name){document.getElementById('admin-error').style.display='block';return;}
  document.getElementById('admin-error').style.display='none';
  adminName=name;
  document.getElementById('admin-display').textContent=name;
  document.getElementById('dash-admin-name').textContent=name.split(' ')[0];
  document.getElementById('screen-landing').classList.remove('active');
  document.getElementById('screen-admin').classList.add('active');
  buildMgrGuide();buildHbRef();
  loadDashboard();loadRequests();loadCallOuts();loadFlags();loadOnboarding();renderCalendar();
}

function adminLogout(){
  document.getElementById('screen-admin').classList.remove('active');
  document.getElementById('screen-landing').classList.add('active');
  document.getElementById('admin-pass').value='';
  switchLanding('admin');
}

// â”€â”€ NAV â”€â”€
// FIX 1: loadMyRequests() call moved INSIDE showSection where 'id' is in scope
function showSection(id){
  document.querySelectorAll('.portal-section').forEach(el=>el.style.display='none');
  document.querySelectorAll('#screen-portal .nav-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('section-'+id).style.display='block';
  document.getElementById('nav-'+id).classList.add('active');
  if(id==='timeoff'){loadMyRequests();}
}
function showAdmin(id){
  document.querySelectorAll('.admin-section').forEach(el=>el.style.display='none');
  document.querySelectorAll('#screen-admin .nav-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('section-adm-'+id).style.display='block';
  document.getElementById('nav-adm-'+id).classList.add('active');
}
function closeModal(id){document.getElementById(id).classList.remove('open');}

// â”€â”€ STATE â”€â”€
function saveState(){
  if(!user)return;
  localStorage.setItem('rs_'+user.email,JSON.stringify({trainingSectionRead,handbookSectionRead,trainingComplete,handbookComplete,handbookSigChoice}));
}
function loadSavedState(){
  const d=JSON.parse(localStorage.getItem('rs_'+user.email)||'{}');
  trainingSectionRead=d.trainingSectionRead||{};handbookSectionRead=d.handbookSectionRead||{};
  trainingComplete=d.trainingComplete||false;handbookComplete=d.handbookComplete||false;handbookSigChoice=d.handbookSigChoice||null;
}

// â”€â”€ POLICIES â”€â”€
const POLICIES=[
  {id:'at_will',name:'At-Will Employment Policy',desc:'Confirms your employment relationship with RideSource',content:`<h2>At-Will Employment</h2><p>Employment at RideSource Inc. is at-will. Either you or RideSource may end the employment relationship at any time, with or without cause, provided there is no violation of applicable federal or state law.</p><p>No manager, supervisor, or representative of RideSource has authority to enter into any employment agreement other than at-will.</p><p>This handbook does not create and is not intended to create a promise or representation of continued employment.</p>`},
  {id:'hipaa',name:'HIPAA & Confidentiality Policy',desc:'Protects client health information â€” critical for NEMT operations',content:`<h2>HIPAA & Confidentiality</h2><p>All passenger information is strictly confidential. This includes names, addresses, phone numbers, destinations, family information, and any personal circumstances including health information and immigration status.</p><h3>Your Obligations</h3><ul><li>Protect all Protected Health Information (PHI) at all times</li><li>Never discuss client information in public settings</li><li>Secure all paperwork and electronic devices</li><li>Never discuss one client's information with another client</li><li>Report suspected privacy breaches to your supervisor immediately</li></ul><div class="callout"><strong>âš ï¸ Important</strong>Confidentiality violations may result in immediate termination. This obligation continues after your employment ends.</div>`},
  {id:'conduct',name:'Employee Code of Conduct',desc:'Professional standards, HIPAA compliance, safety, and ethics',content:`<h2>Employee Code of Conduct</h2><h3>Professional Expectations</h3><p>Employees must maintain a respectful, calm, and professional demeanor; use appropriate and courteous language; maintain client dignity at all times; protect confidentiality; and maintain appropriate professional boundaries.</p><h3>Prohibited Conduct</h3><ul><li>Complain about RideSource, coworkers, supervisors, pay, or policies to clients</li><li>Discuss politics, religion, or controversial topics with passengers</li><li>Share personal contact information with clients</li><li>Connect with clients on social media</li><li>Form personal relationships with clients</li></ul><h3>Disciplinary Action</h3><p>RideSource utilizes progressive discipline: Verbal Warning â†’ Written Warning â†’ Final Warning/Suspension â†’ Termination. Immediate termination may occur for HIPAA violations, falsification of records, impaired driving, or serious safety violations.</p><div class="callout"><strong>Non-Retaliation</strong>RideSource prohibits retaliation against clients or staff who file complaints in good faith.</div>`},
  {id:'safety',name:'Safety & Vehicle Policy',desc:'Driving safety, vehicle inspection, and emergency procedures',content:`<h2>Safety & Vehicle Policy</h2><p>RideSource prioritizes the safety of every client and every employee. Safety is not optional â€” it is the foundation of everything we do.</p><h3>Driving Safety</h3><ul><li>Avoid all forms of distracted driving</li><li>Never use a handheld cell phone while driving â€” hands-free only</li><li>Never drive over the speed limit</li><li>Ensure all passengers are properly secured before moving the vehicle</li><li>Never transport a child without an appropriate car seat</li></ul><h3>Vehicle Inspection</h3><ul><li>Complete a pre-trip and post-trip inspection every shift</li><li>Report all mechanical issues or damage immediately</li><li>Do not operate a vehicle you believe is unsafe</li><li>Vehicles must be left with at least one-half tank of fuel</li></ul><h3>Incident Reporting</h3><p>All accidents, near-misses, and passenger incidents must be reported to your supervisor immediately.</p>`},
  {id:'attendance',name:'Attendance & Punctuality Policy',desc:'Call-out procedures, time off requests, and no-call/no-show policy',content:`<h2>Attendance & Punctuality</h2><p>Reliable attendance is essential to RideSource's ability to provide dependable service.</p><h3>Call-Out Procedure</h3><p>Notify your supervisor no later than <strong>one hour before</strong> your scheduled start time.</p><h3>No-Call / No-Show Policy</h3><ul><li>First offense â€” Verbal warning</li><li>Second offense â€” Written warning</li><li>Third offense â€” Final warning; continued issues may result in termination</li></ul><h3>Time Off Requests</h3><p>All planned time off must be submitted a minimum of <strong>two weeks in advance</strong> through the Staff Portal.</p><div class="callout"><strong>Job Abandonment</strong>Employees who fail to report or contact their supervisor for three consecutive workdays are considered to have voluntarily abandoned their position.</div>`},
  {id:'drug_free',name:'Drug-Free Workplace Policy',desc:'Substance use, testing requirements, and employee assistance',content:`<h2>Drug-Free Workplace</h2><p>The use, possession, sale, or distribution of alcohol or controlled substances on duty, on company property, or in company vehicles is strictly prohibited.</p><h3>Required Testing</h3><ul><li><strong>Pre-employment</strong> â€” May be required before beginning work</li><li><strong>Reasonable suspicion</strong> â€” Based on supervisor observations of apparent impairment</li><li><strong>Post-accident</strong> â€” Required when an employee causes or contributes to an accident</li></ul><p>Employees who refuse to cooperate with required testing will be terminated.</p>`},
  {id:'non_compete',name:'Non-Compete & Separation Policy',desc:'Post-employment obligations and return of company property',content:`<h2>Non-Compete & Separation Policy</h2><h3>Non-Compete Agreement</h3><p>For a period of <strong>24 months</strong> following the end of employment, former employees may not engage in the same or similar activities as those performed for RideSource in any business operating within <strong>50 miles</strong> of a RideSource office.</p><h3>Resignation</h3><p>Employees are asked to provide at least <strong>two weeks' written notice</strong>.</p><h3>Return of Property</h3><p>Upon separation, employees must return all company property on or before their last day.</p><div class="callout"><strong>Post-Employment Confidentiality</strong>Your confidentiality obligations remain in full effect after your employment ends.</div>`}
];

// â”€â”€ TRAINING SECTIONS â”€â”€
const TRAINING_SECTIONS=[
  {title:'Welcome',content:`<h1>Welcome to RideSource!</h1><p>We are excited to have you on board. This guide walks you through everything from your first day of online training to your first day driving solo. Your trainer will work through the hands-on sections with you step by step.</p>
<div class="callout"><strong>Your Training Journey at a Glance</strong>
<table style="width:100%;font-size:13px;margin-top:8px;border-collapse:collapse;">
<tr style="background:#dde8f7;"><th style="padding:6px 10px;text-align:left;">Stage</th><th style="padding:6px 10px;text-align:left;">Timing</th><th style="padding:6px 10px;text-align:left;">What Happens</th></tr>
<tr><td style="padding:6px 10px;border-bottom:1px solid #ddd;"><strong>Online Training</strong></td><td style="padding:6px 10px;border-bottom:1px solid #ddd;">Days 1â€“2 (at home)</td><td style="padding:6px 10px;border-bottom:1px solid #ddd;">PASS, Defensive Driving, and Online CPR/AED/First Aid â€” completed at your own pace, unpaid</td></tr>
<tr><td style="padding:6px 10px;border-bottom:1px solid #ddd;"><strong>Day 3</strong></td><td style="padding:6px 10px;border-bottom:1px solid #ddd;">At office/in vehicle</td><td style="padding:6px 10px;border-bottom:1px solid #ddd;">Ride with seasoned driver â€” observe, learn vehicle basics and daily routine</td></tr>
<tr><td style="padding:6px 10px;border-bottom:1px solid #ddd;"><strong>Day 4</strong></td><td style="padding:6px 10px;border-bottom:1px solid #ddd;">In vehicle</td><td style="padding:6px 10px;border-bottom:1px solid #ddd;">Ride with seasoned driver â€” continue observing, begin operating the Android dispatch device</td></tr>
<tr><td style="padding:6px 10px;border-bottom:1px solid #ddd;"><strong>Day 5</strong></td><td style="padding:6px 10px;border-bottom:1px solid #ddd;">In vehicle</td><td style="padding:6px 10px;border-bottom:1px solid #ddd;">You drive â€” trainer observes. Company phone issued. Keys (FT) or vehicle key orientation (PT)</td></tr>
<tr><td style="padding:6px 10px;border-bottom:1px solid #ddd;"><strong>Day 6 (Monday)</strong></td><td style="padding:6px 10px;border-bottom:1px solid #ddd;">At office</td><td style="padding:6px 10px;border-bottom:1px solid #ddd;">Policies, handbook, badge photo, timesheet, time off, fuel card &amp; protocols</td></tr>
<tr><td style="padding:6px 10px;"><strong>Day 7+</strong></td><td style="padding:6px 10px;">Solo</td><td style="padding:6px 10px;">You are on the road independently!</td></tr>
</table></div>
<p style="margin-top:12px;"><strong>RideSource covers the cost of all required online courses.</strong> Employees are not paid for online training, which is completed at home.</p>`},
  {title:'Days 1â€“2: Online',content:`<h1>Days 1â€“2 â€” Online Training (At Home)</h1>
<p>Your online training courses will be ordered by HR and sent to you before your start date. Complete all three courses on Days 1 and 2. Days 3, 4, and 5 will be your hands-on vehicle training.</p>
<h2>Required Courses</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>PASS Training</strong><br>Complete the full PASS course online. Certificate of completion required.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Defensive Driving</strong><br>Complete the full Defensive Driving course online. Certificate of completion required.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Online CPR / AED / First Aid</strong><br>Complete the online First Aid, CPR, and AED course. Certificate of completion required.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Submit all three completion certificates to your supervisor</strong><br>Email or bring printed copies on Day 3.</div></div>
<div class="callout" style="border-left-color:var(--warn);background:#fff8ee;"><strong>âš  In-Person CPR/AED Certification â€” Required Within 60 Days of Hire</strong><br>This is separate from the online course above and must be completed in person. HR will schedule your hands-on CPR session. Watch for that communication.</div>`},
  {title:'Day 3: Vehicle',content:`<h1>Day 3 â€” Vehicle Basics &amp; Ride-Along</h1>
<p>Today you ride as a passenger with your trainer. Your job is to observe, ask questions, and get comfortable with the vehicle and the daily routine. <strong>You will not operate any equipment today.</strong></p>
<h2>Vehicle Familiarization</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Pre-trip inspection procedure and vehicle walk-around</strong><br>Step-by-step walkthrough of the daily pre-trip inspection checklist; exterior inspection points: lights, tires, body condition, fuel level.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Interior layout &amp; controls</strong><br>Driver seat adjustment, mirrors, dashboard, safety equipment locations.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Wheelchair lift / ramp operation</strong><br>How to safely deploy and stow the lift or ramp.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Safety equipment locations</strong><br>First aid kit, fire extinguisher, emergency exits.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Fuel card &amp; fueling procedure</strong><br>Where to fuel, how to use the fuel card, what to record.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Car seats â€” front-facing and booster seat locations and securement</strong><br>Where to store these, how to determine safe installation, when to use.</div></div>
<h2>Daily Routine &amp; Operations</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Manifest review</strong><br>How to read your daily manifest â€” passenger info, pickup times, vehicle assignment.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Key storage procedure (Part-Time)</strong><br>How to locate your assigned vehicle on the manifest and retrieve the correct key.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Vehicle keys (Full-Time)</strong><br>Full-time drivers are assigned a dedicated vehicle and take keys home.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Dispatch communication</strong><br>How to communicate with dispatch while on route â€” including no-shows, cancellations, etc.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Passenger pick-up &amp; drop-off procedures</strong><br>Proper greeting, boarding assistance, safety protocols, and documentation.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Incident &amp; accident awareness</strong><br>What to watch for; who to call and what to document if something happens.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>End-of-day procedures</strong><br>Return route, vehicle check-in, paperwork, and key return (PT).</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>After-hours assistance â€” On-Call procedure and numbers</strong><br>When to call, who to call, what you should call for.</div></div>`},
  {title:'Day 4: Android',content:`<h1>Day 4 â€” Android Dispatch Device Training</h1>
<p>Today you ride as a passenger again with your trainer. In addition to continuing to observe daily operations, you will begin hands-on training with the Android dispatch device.</p>
<h2>Android Device â€” Dispatch Software Training</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Device overview</strong><br>Hardware basics: powering on/off, charging, care and handling of the company device.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Logging in to the dispatch app</strong><br>Username, password, and what to do if you have login issues.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Viewing your manifest on the device</strong><br>How your daily route and passenger list appear in the app.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Starting your route</strong><br>How to start or preview your route.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Passenger status updates</strong><br>Marking pick-ups, drop-offs, no-shows, and exceptions in real time.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Communicating with Dispatch</strong><br>Relaying information regarding trips, member information, cancellations, no-shows, etc.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>GPS &amp; navigation features</strong><br>How the app integrates with navigation; what to do if routing is incorrect.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Completing end-of-route closeout</strong><br>How to properly close out your route at the end of the day.</div></div>
<div class="callout"><strong>Technical Issues</strong>If you experience any technical issue with the dispatch app, contact your supervisor immediately so IT and billing can be notified and the issue documented.</div>`},
  {title:'Day 5: Solo Eval',content:`<h1>Day 5 â€” Solo Drive with Observer</h1>
<p>Today you are in the driver's seat. Your trainer rides along to observe and support â€” but <strong>you</strong> are running the route and operating the Android device. This is your final hands-on evaluation before going solo.</p>
<h2>Driving Evaluation Checklist</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Pre-trip inspection completed independently</strong><br>Driver performs full pre-trip without prompting.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Manifest reviewed and route understood before departure</strong><br>Driver confirms all stops, times, and passenger notes.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Android device operated throughout the route</strong><br>All pick-ups, drop-offs, and status updates logged correctly in real time.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Passenger boarding &amp; safety protocols followed</strong><br>Proper greeting, assistance, securement, and documentation observed.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Dispatch communication handled appropriately</strong><br>Driver contacts dispatch correctly when needed.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Safe and professional driving demonstrated</strong><br>Defensive driving techniques, speed, following distance, and demeanor.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>End-of-route closeout completed</strong><br>Route closed out correctly in the app; vehicle returned and secured.</div></div>
<h2>Equipment Issued Today</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Company phone issued &amp; set up</strong><br>Driver's name, login credentials, and dispatch app installed and tested.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Full-Time Drivers: Vehicle keys issued</strong><br>Assigned vehicle confirmed; driver authorized to take vehicle home.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Part-Time Drivers: Vehicle key storage and orientation</strong><br>Location of key board confirmed; how to identify assigned vehicle on manifest reviewed.</div></div>`},
  {title:'Day 6: Office',content:`<h1>Day 6 â€” Office Orientation Session</h1>
<p>Report to the office at your scheduled arrival time. This session covers the administrative side of your role â€” policies, systems, and everything you need to know to manage your employment at RideSource.</p>
<h2>Policies &amp; Handbook Review</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Employee Handbook review</strong><br>Walk through key sections with HR; opportunity to ask questions.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>At-Will Employment</strong><br>Understanding what this means for both you and RideSource.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Attendance &amp; Punctuality Standards</strong><br>Expectations, call-in procedures, and how attendance patterns are monitored.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Code of Business Conduct &amp; Ethics</strong><br>Professional standards, conflict of interest, and gifts policy.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Confidentiality &amp; Information Security</strong><br>Protecting client and company information; social media guidelines.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Anti-Harassment Policy</strong><br>Zero tolerance; definitions, reporting steps, and your protections.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Drug &amp; Alcohol-Free Workplace</strong><br>Policy, testing, and consequences.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Workplace Safety &amp; Emergency Procedures</strong><br>Your responsibilities; who to call; incident reporting.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Equal Opportunity &amp; Non-Discrimination</strong><br>EEO commitment and how to request accommodations.</div></div>
<h2>Digital Signature Tracker â€” Policy Acknowledgments</h2>
<p>Your Supervisor will walk you through the Digital Signature Tracker. You will read and acknowledge each of the following policies:</p>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>1. Handbook Receipt &amp; Acknowledgment</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>2. Fingerprinting, Background and Motor Vehicle Check Consent</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>3. Client Confidentiality Agreement</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>4. Sexual Harassment</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>5. Drug Free Workplace</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>6. Company Vehicle Use</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>7. Personal Appearance</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>8. Attendance and Punctuality</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>9. Passenger Interaction and Service Standards</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>10. Cell Phone and Distracted Driving Policy</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>11. Accident and Incident Reporting Policy</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div>12. Social Media and Public Communications Policy</div></div>
<h2>Administrative Setup</h2>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Badge ID photo taken</strong><br>HR will photograph you for your RideSource employee ID badge.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Timesheet process reviewed</strong><br>How to log your hours, timesheet deadlines, and approval process.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Time Off Request Portal walkthrough</strong><br>How to submit planned time off through the Staff Portal.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Call-out procedure</strong><br>For unplanned absences â€” call your supervisor directly; manager logs the call-out on your behalf.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Fuel card issued &amp; protocols reviewed</strong><br>How to use your fuel card, what to record, and what is not permitted.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Pay schedule &amp; direct deposit confirmed</strong><br>Pay periods, paydays, and how to view your pay stub.</div></div>
<div class="checklist-item"><span class="check-box">&#9744;</span><div><strong>Benefits overview</strong><br>Health, dental, vision, 401(k) â€” enrollment windows and next steps.</div></div>
<div class="callout"><strong>âœ… Training Complete!</strong><br>By completing all stages, you confirm that you have received, reviewed, and understood all policies, procedures, and operational requirements covered in this guide. Welcome to the RideSource team!</div>`}
];

const HANDBOOK_SECTIONS=[
  {title:'Sec 1: Welcome',content:`<h1>Section 1: Welcome &amp; Company Overview</h1><h2>1.1 Welcome Message</h2><p>Welcome to RideSource Inc. We are proud to have you join our team. RideSource is a Non-Emergency Medical Transportation (NEMT) company based in Norway, Maine, committed to providing reliable, safe, and compassionate transportation services to the communities we serve. Our drivers and staff are the foundation of that commitment.</p><p>This handbook has been carefully prepared to give you the information you need to be successful at RideSource. Please read it thoroughly, ask questions when something is unclear, and refer to it whenever you need guidance. Your supervisor and the management team are always available to help.</p><p>This handbook contains general information and guidelines and is not intended to be a comprehensive document. Specific questions not addressed here should be directed to your supervisor or the operations manager. RideSource reserves the right to modify or discontinue any policy, practice, or benefit described in this handbook at any time, and you will be notified of material changes.</p><h2>1.2 Our Mission, Vision &amp; Values</h2><p><strong>Mission:</strong> To provide safe, reliable, and dignified transportation services that connect passengers to the care and resources they need â€” every trip, every time.</p><h3>Core Values</h3><ul><li><strong>Safety First</strong> â€” Every decision prioritizes the safety of passengers and staff</li><li><strong>Reliability</strong> â€” We show up on time, every time, as promised</li><li><strong>Dignity &amp; Respect</strong> â€” Every passenger is treated with professionalism and compassion</li><li><strong>Accountability</strong> â€” We take responsibility for our actions and our service</li><li><strong>Community</strong> â€” We are proud to serve the communities of Maine</li></ul><h2>1.3 How to Use This Handbook</h2><p>This handbook is organized into sections covering all major areas of your employment. Use the tabs above to navigate. This is a living document â€” RideSource reserves the right to update policies at any time, and you will be notified of material changes.</p>`},
  {title:'Sec 2: Employment',content:`<h1>Section 2: Employment Requirements &amp; Expectations</h1><h2>2.1 Summary of Employment Requirements</h2><ul><li>Must be at least 25 years of age and have held a valid driver's license for at least five years</li><li>Must maintain a current valid driver's license appropriate to the assigned company vehicle</li><li>Drivers shall have no more than one chargeable accident or moving violation in the last ten years, as defined by Modivcare</li><li>Drivers shall not have had their driver's license suspended or revoked for traffic violations in the previous fifteen years</li><li>Must not have been convicted of any felony-level or greater crime as defined in Maine State Law, or any conviction that would directly conflict with the job expectations at RideSource</li><li>All drivers should be professional, courteous, patient, neat and clean in appearance, and helpful to all riders</li><li>No driver or attendant shall use prescription medications or drugs that impair the ability to perform duties while on duty</li><li>All drivers and attendants shall wear a visible, easily readable name tag always while on duty</li><li>Vehicles shall always be smoke-free; drivers and attendants shall not smoke while in the vehicle or in the presence of any member</li><li>Drivers should not use mobile phones (including texting) or headphones while the vehicle is in motion</li><li>Drivers must provide appropriate assistance to members as required, including curb-to-curb, door-to-door, and hand-to-hand assistance as noted on the manifest</li><li>Prior to moving the vehicle, drivers must assist members in being seated and confirm all seat belts are properly fastened</li><li>Prior to starting the vehicle, drivers must properly secure all wheelchairs and wheelchair passengers</li><li>Drivers and attendants must comply with HIPAA by keeping all member health care identifying information strictly confidential</li><li>All company-issued equipment, including cell phones, tablets, and vehicles, is for company use only</li></ul><h2>2.2 Background &amp; Driving Record Checks</h2><p>To ensure a safe and productive work environment, RideSource conducts pre-employment background and driving record checks on all applicants who accept an offer of employment. All offers of employment are conditioned on receipt of a background check report acceptable to RideSource. Reports are kept confidential and reviewed only by individuals involved in the hiring process.</p><h2>2.3 At-Will Employment</h2><p>Employment at RideSource Inc. is at-will. This means that either you or RideSource may end the employment relationship at any time, with or without cause, provided there is no violation of applicable federal or state law. No manager, supervisor, or representative of RideSource has authority to enter into any employment agreement other than at-will. Only the owner(s) of RideSource Inc. may authorize any written exception to this policy. This handbook does not create and is not intended to create a promise or representation of continued employment.</p><h2>2.4 Equal Opportunity &amp; Non-Discrimination</h2><p>RideSource Inc. is an equal opportunity employer committed to providing employment opportunities to all qualified individuals without regard to race, color, religion, sex, national origin, age, disability, veteran status, or any other characteristic protected by applicable law. RideSource will not tolerate any form of unlawful discrimination or harassment in the workplace.</p><p><strong>Anti-Harassment &amp; Sexual Harassment:</strong> RideSource has a zero-tolerance policy for harassment of any kind, including sexual harassment. Employees who experience or witness harassment should report it immediately to their supervisor or management. Retaliation against anyone who reports harassment in good faith is strictly prohibited.</p><h2>2.5 Employee Classifications</h2><p><strong>Full-Time</strong> employees regularly work 30 or more hours per week and are generally eligible for benefits after the applicable waiting period. <strong>Part-Time</strong> employees regularly work fewer than 30 hours per week; benefit eligibility may vary. Non-exempt employees are entitled to overtime pay for hours worked beyond 40 in a work week.</p><h2>2.6 Introductory Period</h2><p>All new employees serve a 90-day introductory period. During this time, RideSource evaluates your performance, attendance, and fit within our team. Completion of the introductory period does not guarantee continued employment or alter the at-will nature of your employment.</p><h2>2.7 Outside Employment</h2><p>Employees are permitted to hold other jobs subject to the following restrictions. Outside activities must not compete with or compromise RideSource's interests, or adversely affect your job performance. Outside employment will not be considered an excuse for poor performance, absenteeism, or tardiness. Company tools, vehicles, or equipment may not be used for outside employment purposes.</p><h2>2.8 Employee Personnel Files</h2><p>Employee files are maintained by RideSource and are considered confidential. Managers and supervisors may access personnel file information only on a need-to-know basis. Current and former employees may request access to their file within three business days unless otherwise required by state law.</p>`},
  {title:'Sec 3: Conduct',content:`<h1>Section 3: Workplace Conduct &amp; Professional Standards</h1><h2>3.1 Code of Conduct &amp; Ethics</h2><p>RideSource employees are expected to conduct themselves professionally, ethically, and with respect for colleagues, passengers, and the public at all times. You represent RideSource in every interaction.</p><ul><li>Treat all passengers, colleagues, and the public with dignity and respect</li><li>Be honest and transparent in all work-related communications and documentation</li><li>Avoid any conflict of interest between your personal interests and your duties to RideSource</li><li>Report any suspected violations of company policy or law to your supervisor or management</li><li>Do not accept gifts, gratuities, or personal benefits from passengers or vendors</li><li>Do not solicit or accept money, goods, or additional business from members</li><li>Do not contact any member except as appropriate and necessary to assist them into or out of the vehicle, secure a seat belt, or render first aid</li><li>Maintain professional relationships only with clients; do not call riders by nicknames, lend or accept money, make unscheduled stops, or follow clients on social media</li></ul><h2>3.2 Confidentiality &amp; Information Security</h2><h3>Passenger &amp; HIPAA Confidentiality</h3><p>All passenger information is strictly confidential. This includes names, addresses, phone numbers, destinations, family information, and any personal circumstances including health information and immigration status. All communications that include any rider, provider, address, trip, or company information are considered protected under HIPAA. You must not share passenger information with any third party without the passenger's consent and RideSource's approval. <strong>This obligation continues after your employment ends.</strong></p><h3>Company Information</h3><p>Business strategies, financial information, operational data, and other proprietary company information are confidential. Do not share company information outside of RideSource without authorization.</p><div class="callout"><strong>âš ï¸ Zero Tolerance</strong>Confidentiality and HIPAA violations may result in immediate termination, regardless of progressive discipline steps.</div><h2>3.3 Personal Appearance &amp; Professional Standards</h2><p>All employees must project a professional image while on duty. Clothing must be consistent with the standards of a professional transportation environment. All employees should be covered from shoulders to knees at all times â€” no see-through or sleeveless clothing is permitted. Natural and artificial scents may be considered objectionable by passengers and are subject to this policy. No employee should wear clothing bearing profanities, vulgar content, or inappropriate imagery.</p><h2>3.4 Electronic Communication &amp; Internet Use</h2><p>Company-provided equipment is for company use only. Equipment may not be used to transmit communications of a defamatory, discriminatory, harassing, or pornographic nature. Internal and external emails and texts are considered business records and may be subject to discovery in litigation. Personal, inappropriate, or illegal use may result in disciplinary action up to and including termination.</p><h2>3.5 Social Media</h2><p>Employees may not post financial, confidential, sensitive, or proprietary information about RideSource, clients, or employees on any social platform. Do not post passenger information, photos taken in company vehicles, or any content that could embarrass or harm RideSource or its passengers. Policy violations may result in disciplinary action up to and including termination.</p><h2>3.6 Solicitations, Distributions &amp; Posting of Materials</h2><p>RideSource prohibits the solicitation, distribution, and posting of materials on or at company property except as permitted by this policy. Non-employees may not solicit employees or distribute materials on company premises at any time. Employees may not distribute literature during work hours or in any work area except in connection with company-sponsored events.</p><h2>3.7 Conflicts of Interest</h2><p>Employees must avoid any relationship or activity that might impair their ability to make objective decisions when performing their jobs. Company property, information, or business opportunities may not be used for personal gain. Employees with a conflict-of-interest question should seek guidance from management before engaging in any such activity.</p>`},
  {title:'Sec 4: Attendance',content:`<h1>Section 4: Attendance, Time &amp; Scheduling</h1><h2>4.1 Attendance &amp; Punctuality</h2><p>Reliable attendance and punctuality are essential to RideSource's ability to provide dependable service. Passengers depend on us to be on time â€” and that starts with every employee. If you are unable to report to work or will be late, you must notify your supervisor as early as possible and <strong>no later than one hour before your scheduled start time.</strong> Early notification reduces canceled rides and allows us to arrange coverage for our clients.</p><h3>Absence &amp; No-Call/No-Show Policy</h3><p>Failing to report to work without notifying your supervisor is a serious matter. The following progressive consequences apply:</p><ul><li><strong>First offense</strong> â€” Verbal warning; a written record of the discussion is placed in your personnel file</li><li><strong>Second offense</strong> â€” Written warning, placed in your personnel file</li><li><strong>Third offense</strong> â€” Final warning; continued attendance issues will result in termination</li></ul><p>Employees must notify the office a minimum of two weeks in advance for any anticipated time off. All planned time off requests must be submitted through the RideSource Staff Portal. Unexcused absences may result in disciplinary action. Employees who fail to report to work or contact their supervisor for <strong>three consecutive workdays</strong> will be considered to have voluntarily abandoned their position and will be ineligible for rehire.</p><h3>Mid-Day or Unscheduled Time Off</h3><p>Once a manifest or route list is finalized, RideSource does not have the flexibility to make adjustments for unscheduled and non-emergency personal time off. When drivers are scheduled and on the clock, they are expected to be available to fulfill company and client obligations. Calling out creates significant operational disruptions and financial liability â€” liquidated damage fees are incurred from the brokerage as a direct result of missed service when RideSource is unable to secure coverage.</p><h2>4.3 Parascope &amp; Trip Documentation</h2><p>All drivers are required to use the Parascope system accurately and in real time. Proper use of Parascope is critical â€” when trips are not documented correctly, RideSource does not get paid for the service provided.</p><ul><li>Select <strong>"On the Way"</strong> when departing for pickup â€” not when arriving at the location</li><li>Complete the trip in Parascope promptly after drop-off â€” do not allow significant time to pass before closing out the trip</li><li>Obtain the required passenger or guardian signature for every trip</li><li>If a client is unable to sign, a caregiver or parent must sign (UTS); if the rider signs for themselves, select ATS</li></ul><p>If you experience technical issues with Parascope, contact your supervisor immediately so that IT and billing can be notified and the issue documented.</p><h2>4.4 Meal &amp; Rest Periods</h2><p>RideSource complies with all Maine State Law requirements regarding meal and rest periods. Your supervisor will provide specific break schedules based on your role and shift. Meal periods are generally unpaid; rest breaks are paid. You may not skip breaks in exchange for early departure without supervisor approval. Drivers are encouraged to use downtime between trips to take meal breaks, which must be properly documented in your timesheet.</p>`},
  {title:'Sec 5: Compensation',content:`<h1>Section 5: Compensation &amp; Performance</h1><h2>5.1 Pay Periods &amp; Paydays</h2><p>RideSource pays employees on a biweekly basis. Wages are paid for the period ending the previous Friday, with paydays generally falling on <strong>Wednesdays</strong>. Direct deposit is the standard payment method and is required for all employees. If a normal payday falls on a company-recognized holiday, paychecks will be distributed one workday before or after at the payroll company's discretion. Employees should verify their pay each period and report discrepancies to their supervisor promptly.</p><h2>5.2 Performance Reviews &amp; Compensation</h2><p>RideSource conducts performance reviews to provide employees with feedback, recognize achievements, and identify opportunities for growth. Reviews are conducted on an established annual cycle. Both the employee and manager will review and sign the evaluation form, which will be retained in the employee's personnel file.</p><h3>Compensation Adjustments &amp; Raises</h3><p>Compensation adjustments are reviewed after an employee has completed their introductory (probationary) period and demonstrated consistent performance and reliability. Pay adjustments are based on performance, attendance, reliability, and the business needs of the organization at the time of review. <strong>A performance review does not result in an automatic pay increase.</strong> All compensation decisions are made at the discretion of the management team.</p><h2>5.3 Payroll Deductions</h2><p>RideSource makes required deductions from your paycheck for federal and state taxes, Social Security, and Medicare. Additional deductions may be made for benefit enrollments or other authorized purposes. A detailed paystub is provided for each pay period.</p><h2>5.4 Timekeeping &amp; TWE System</h2><p>All employees are required to accurately record all hours worked using the TWE system. Falsification of time records may result in disciplinary action up to and including termination.</p><h2>5.5 Overtime</h2><p>Non-exempt employees are entitled to overtime pay at one and one-half times their regular rate for hours worked beyond 40 in a work week. Overtime must be authorized in advance by your supervisor. Unauthorized overtime is subject to disciplinary action, though RideSource will compensate any overtime worked as required by law.</p>`},
  {title:'Sec 6: Benefits',content:`<h1>Section 6: Benefits &amp; Insurance</h1><h2>6.1 Benefits Overview</h2><p>RideSource offers a benefits package to eligible employees. Eligibility, waiting periods, and specific plan details are provided during onboarding and enrollment. Contact management for current benefit offerings and enrollment information. Benefits eligibility is based on your employment classification (full-time or part-time) and length of service.</p><h2>6.2 Health &amp; Wellness Benefits</h2><p>Eligible employees may have access to medical, dental, and vision insurance coverage. Details of available plans, premiums, and enrollment windows will be provided by management. Benefits begin after the applicable waiting period following your date of hire. Changes to benefits elections are generally only permitted during open enrollment periods or following a qualifying life event (such as marriage, birth of a child, or loss of other coverage).</p><h2>6.3 Retirement</h2><p>RideSource offers retirement savings options for eligible employees. Enrollment information, contribution options, and plan details are available from management. Employees are encouraged to take advantage of retirement savings opportunities early in their tenure.</p><h2>6.4 Workers' Compensation</h2><p>All RideSource employees are covered by Maine workers' compensation insurance. If you are injured on the job, report the injury to your supervisor immediately â€” no matter how minor the injury appears â€” and seek appropriate medical attention. Failure to report a work injury promptly may affect your eligibility for benefits under the workers' compensation program. Detailed procedures for filing a claim are available from management. Employees are protected from retaliation for filing a good-faith workers' compensation claim.</p><h2>6.5 Leave Policies Overview</h2><p>RideSource complies with all applicable federal and state leave laws. The following leave types may be available to eligible employees:</p><ul><li><strong>Family &amp; Medical Leave (FMLA):</strong> Eligible employees may take up to 12 weeks of unpaid, job-protected leave per year for qualifying family and medical reasons</li><li><strong>Maine State Leave:</strong> RideSource complies with applicable Maine state leave requirements</li><li><strong>Military Leave (USERRA):</strong> Employees called to active military duty are entitled to reinstatement rights in accordance with federal law</li><li><strong>Jury Duty:</strong> Employees summoned for jury duty will be granted the necessary time off; notify your supervisor immediately upon receipt of a jury summons</li><li><strong>Bereavement Leave:</strong> Employees may be granted paid or unpaid time off following the death of an immediate family member; speak with your supervisor for details</li></ul><p>All planned time off must be submitted at least two weeks in advance through the RideSource Staff Portal. For medical or emergency leave, notify your supervisor as early as possible. Specific details on eligibility, required notice, and documentation requirements are available from management. Fraudulent use of leave will result in disciplinary action up to and including termination.</p><div class="callout"><strong>Important</strong>For specific information about any benefit plan, waiting period, or leave policy, please speak directly with your supervisor or the management team. Benefit offerings may change from time to time, and the most current information will always come from management.</div>`},
  {title:'Sec 7: Safety',content:`<h1>Section 7: Workplace Safety &amp; Health</h1><h2>7.1 Safety Is Everyone's Responsibility</h2><p>RideSource is committed to maintaining a safe working environment for all employees and passengers. Every employee is responsible for following safety procedures, reporting hazards, and cooperating with safety initiatives. If you observe an unsafe condition, report it to your supervisor immediately. Failure to follow company safety guidelines or engaging in conduct that places an employee, client, or company property at risk may result in disciplinary action up to and including termination.</p><h2>7.2 Drug-Free Workplace</h2><p>RideSource is committed to a safe and productive work environment free from the influence of alcohol and drugs. The use, possession, sale, or distribution of alcohol or controlled substances on duty, on company property, or in company vehicles is strictly prohibited.</p><p>RideSource will assist and support employees who voluntarily seek help for substance-related problems before becoming subject to discipline or termination. Employees are not prohibited from the lawful use of prescribed medications; however, they must consult with their doctor about any medication's effect on their fitness for duty and promptly disclose any work restrictions to their supervisor.</p><h3>Work Rules</h3><ul><li>Using, possessing, buying, selling, manufacturing, or dispensing an illegal drug or drug paraphernalia is prohibited at any time while on duty, on company premises, or in company vehicles</li><li>Being under the influence of alcohol or an illegal drug while on duty is prohibited</li><li>The presence of any detectable amount of illegal drug or controlled substance in an employee's body while performing company business is prohibited</li><li>Any illegal drugs or drug paraphernalia will be turned over to law enforcement and may result in criminal prosecution</li></ul><h3>Required Testing</h3><ul><li><strong>Pre-employment:</strong> Applicants may be required to pass a drug test before beginning work; refusal results in disqualification</li><li><strong>Reasonable suspicion:</strong> Based on a supervisor's observations of apparent impairment; company owner(s) must be consulted before testing</li><li><strong>Post-accident:</strong> Required when an employee causes or contributes to an accident resulting in injury or significant property damage; testing must occur within two hours</li><li><strong>Follow-up:</strong> Employees who test positive or violate this policy are subject to discipline up to and including termination; last-chance agreements may include follow-up testing for up to two years</li></ul><p>Employees who refuse to cooperate with required testing will be terminated.</p><h2>7.3 Workplace Violence Prevention</h2><p>RideSource is committed to a workplace free from threats, intimidation, and violence. Threatening behavior, physical altercations, possession of weapons, or any conduct that creates fear for personal safety will not be tolerated. Threatening behavior or incidents of actual violence should be reported immediately to a supervisor or member of management. RideSource will not retaliate against employees making good-faith reports.</p><h2>7.4 Accident &amp; Incident Reporting</h2><p>All workplace accidents, injuries, near-misses, passenger incidents, and vehicle accidents must be reported to your supervisor immediately â€” no matter how minor they appear. Failure to report an incident is a policy violation.</p><p>When reporting, document: the date, time, and location; individuals involved; the nature of the incident; and any witnesses. The four basic emergency handling steps are: <strong>(1) Keep calm; (2) Contact your dispatcher; (3) Protect your passengers, yourself, and your vehicle; (4) Complete all required reports thoroughly.</strong></p><h2>7.5 Emergency Procedures</h2><p>Employees must be familiar with emergency procedures for their location and role. In the event of a medical emergency involving a passenger, pull the vehicle to safety, call 911 immediately, and contact your dispatcher. Do not leave the passenger unattended. Each vehicle is equipped with a First Aid Kit, Spill Kit, Seatbelt Cutter, and Fire Extinguisher. Familiarize yourself with the location and use of all safety equipment in your assigned vehicle.</p><h2>7.6 Vehicle Safety</h2><ul><li>All passengers must be properly secured before the vehicle is placed in motion; seat belts and wheelchair restraints must be properly fastened</li><li>Never drive over the speed limit; never pass another vehicle except on highways with a passing lane</li><li>Never transport a child without an appropriate car seat â€” contact the office if unsure</li><li>Slow down in rain or snow and use wipers and lights appropriately; maintain a safe following distance</li><li>Hands-free devices only while driving â€” never hold or text on a phone while the vehicle is in motion</li><li>Vehicle keys must be returned to the office at the end of each workday (Part-Time drivers)</li><li>Vehicles must be left with at least one-half tank of fuel; gas cards must remain in the vehicle when not in use</li></ul><h2>7.7 Smoking &amp; Tobacco</h2><p>Smoking, vaping, and using any tobacco or electronic cigarette products are prohibited in all company vehicles, on all company property, and at all company-sponsored events. This policy applies to employees, visitors, vendors, and contractors. Smoking is permitted in company parking lots only, at a minimum of 50 feet from all buildings. Violations are subject to disciplinary action up to and including immediate termination.</p>`},
  {title:'Sec 8: Operations',content:`<h1>Section 8: Transportation Operations &amp; Service Standards</h1><h2>8.1 Passenger Identity Verification</h2><p>The safety of every passenger begins with accurate identity verification. Before beginning any transport, drivers must verify that the passenger matches the individual listed on the trip manifest, confirming the member's name and scheduled drop-off location.</p><ul><li>Do not transport any individual not listed on the manifest</li><li>Do not alter the drop-off location without contacting dispatch and receiving authorization</li><li>Escorts are only permitted if listed on the manifest; any changes require prior approval</li><li>Give special attention to identity verification when transporting minors or individuals with intellectual disabilities</li></ul><p>If you inadvertently transport the wrong passenger, contact dispatch and the office immediately to begin the appropriate notification process.</p><h2>8.2 Trip Assignment &amp; Refusal of Trips</h2><p>RideSource is a transportation provider, and drivers are employed to complete trips as assigned. Refusing trips or clients is not acceptable and is inconsistent with your job responsibilities. Drivers may not pick and choose trips or clients, nor may they selectively narrow their availability based on assigned routes. Failure to comply with these expectations may result in corrective action up to and including termination.</p><h2>8.3 Trip &amp; Job Distribution</h2><p>When a cancellation occurs, RideSource Dispatchers make every effort to fill those gaps when it makes sense to do so. Dispatchers are only able to add trips that are a good logistical and financial fit â€” primarily those in your area or that align well with your existing route. If you have availability and are looking for additional trips, let your supervisor know.</p><h2>8.4 Vehicle Use Policy</h2><p>Company vehicles are provided for company business and approved transportation services only. Personal use of company vehicles is strictly prohibited without prior written authorization from management. Under no circumstances may drivers transport individuals other than those assigned by the office. RideSource monitors vehicle usage and location.</p><h2>8.5 Vehicle Inspection &amp; Cleanliness</h2><p>Drivers are required to complete a pre-trip and post-trip vehicle inspection every shift using the Daily Vehicle Maintenance Report. Vehicles must be maintained in a clean, safe, and professional condition always. Report all mechanical issues, damage, or safety concerns immediately â€” do not operate a vehicle you believe is unsafe. Vehicles must be kept free of personal belongings, food waste, and debris at all times.</p><h2>8.6 Hands-Free Mobile Device Policy</h2><p>Maine State Law prohibits drivers from holding any electronic device while operating a vehicle. RideSource provides a company Bluetooth device and phone mount to every driver â€” these must be used for all calls while driving.</p><ul><li>Never hold a phone to text, call, or use any app while driving</li><li>All calls must be made using the company-issued hands-free Bluetooth device</li><li>The phone mount must be used to safely secure the device at all times while driving</li></ul><h2>8.7 Dash Camera System</h2><p>All RideSource vehicles are equipped with dash cameras in compliance with Maine State Law and MaineCare requirements. Footage is stored for approximately 30 days and reviewed only in the event of a complaint, incident, or accident. Each vehicle is equipped with a panic button that bookmarks 10 seconds before and 20 seconds after an event; use of the panic button should always be followed by a call to the office.</p>`},
  {title:'Sec 9-10: Sep.',content:`<h1>Section 9: Professional Development</h1><h2>9.1 Training &amp; Development</h2><p>RideSource encourages ongoing learning and professional growth. Training opportunities may include on-the-job instruction, safety certifications, passenger assistance techniques, and other relevant skill development. Employees are expected to complete all required training in a timely manner. Required training is a condition of employment, and failure to complete it may result in disciplinary action.</p><h2>9.2 Professional Certifications</h2><p>Some positions at RideSource require or benefit from specific certifications or licenses. Where certifications are required for your role, maintaining them is a condition of employment. RideSource may provide support for certification costs â€” speak with your supervisor for details.</p><h1>Section 10: Employment Changes &amp; Separation</h1><h2>10.1 Promotions &amp; Transfers</h2><p>RideSource strives to promote from within when possible. Internal opportunities are posted and employees are encouraged to apply. Eligibility for promotions generally requires completion of the introductory period, satisfactory performance, and the absence of active disciplinary actions.</p><h2>10.2 Disciplinary Process</h2><p>RideSource uses a progressive discipline process to address performance and conduct concerns. RideSource reserves the right to combine or skip steps depending on the facts of each situation and the severity of the offense.</p><ul><li><strong>Verbal Warning</strong> â€” A supervisor counsels the employee about the concern; a written record is placed in the employee's personnel file</li><li><strong>Written Warning</strong> â€” Used for serious violations or when a verbal warning has not produced improvement; placed in the personnel file</li><li><strong>Final Warning / Performance Improvement Plan (PIP)</strong> â€” The employee may be placed on a PIP for up to 90 days; failure to meet PIP goals may result in termination</li></ul><p>Some violations â€” including workplace violence, theft, intoxication on duty, camera tampering, passenger confidentiality violations, and unauthorized vehicle use â€” may result in immediate termination without progressive steps.</p><h2>10.3 Resignation, Job Abandonment &amp; Termination</h2><p><strong>Resignation:</strong> Employees who choose to resign are asked to provide at least two weeks' written notice to allow for a smooth transition. If less notice is provided, the employee may be deemed ineligible for rehiring.</p><p><strong>Job Abandonment:</strong> Employees who fail to report to work or contact their supervisor for three consecutive workdays will be considered to have voluntarily abandoned their position. Employees separated due to job abandonment are ineligible for accrued benefits and ineligible for rehire.</p><p><strong>Termination &amp; Return of Property:</strong> Upon separation, employees must return all company property â€” including keys, access cards, uniforms, Bluetooth devices, and any company-owned equipment â€” on or before their last day. Failure to return company property may result in deductions from the final paycheck. Post-employment confidentiality obligations described in Section 3.2 remain in effect after separation.</p><h2>10.4 Non-Compete Agreement</h2><p>For a period of 24 months following the end of employment, former employees may not engage â€” directly or indirectly â€” in the same or similar activities as those performed for RideSource in any business operating within 50 miles of a RideSource office.</p>`},
  {title:'Sec 11: Sign',content:`<h1>Section 11: Acknowledgment</h1><p>You have completed the Employee Handbook. The policies listed below require your individual acknowledgment. Your signature confirms that you have received, read, and agree to comply with each policy. Electronic acknowledgment through the RideSource Digital Onboarding system is accepted in lieu of a wet signature.</p><div class="callout"><strong>Final Certification Language</strong>By signing below, I certify that I have received and reviewed the RideSource Inc. Employee Handbook, that I understand my responsibilities as an employee, and that I agree to comply with all policies contained herein. I acknowledge that this handbook does not constitute a contract of employment, that my employment is at-will, and that I understand my post-employment confidentiality obligations remain in effect after separation. I further understand and specifically agree that for 24 months after I am no longer employed by RideSource Inc., I will not engage, directly or indirectly, in the same or similar activities as those performed for RideSource in any business operating within 50 miles of Norway, Maine.</div><p>Please scroll down to the acknowledgment form below to provide your signature.</p>`}
];

// â”€â”€ DOCUMENT READER â”€â”€
function buildReader(type,sections){
  const tabs=document.getElementById(type+'-tabs');
  tabs.innerHTML=sections.map((s,i)=>`<div class="doc-tab ${i===0?'active':''}" id="${type}-tab-${i}" onclick="goToSection('${type}',${i})">${s.title}</div>`).join('');
  renderSection(type,0,sections);
}
function buildTraining(){buildReader('training',TRAINING_SECTIONS);}
function buildHandbook(){buildReader('handbook',HANDBOOK_SECTIONS);}

function renderSection(type,idx,sections){
  const s=sections||(type==='training'?TRAINING_SECTIONS:HANDBOOK_SECTIONS);
  document.getElementById(type+'-body').innerHTML=s[idx].content;
  document.getElementById(type+'-body').scrollTop=0;
  document.getElementById(type+'-progress-label').textContent=`Section ${idx+1} of ${s.length}`;
  document.querySelectorAll(`#${type}-tabs .doc-tab`).forEach((t,i)=>{
    t.classList.toggle('active',i===idx);
    if((type==='training'?trainingSectionRead:handbookSectionRead)[i])t.classList.add('completed');
  });
  const nextBtn=document.getElementById(type+'-next');
  const prevBtn=document.getElementById(type+'-prev');
  prevBtn.disabled=idx===0;
  const readMap=type==='training'?trainingSectionRead:handbookSectionRead;
  if(readMap[idx]){
    nextBtn.disabled=false;
    document.getElementById(type+'-scroll-note').textContent='âœ… Section read.';
  } else {
    nextBtn.disabled=true;
    document.getElementById(type+'-scroll-note').textContent='ğŸ“– Scroll to the bottom to continue.';
    setTimeout(()=>{
      const body=document.getElementById(type+'-body');
      if(body&&body.scrollHeight<=body.clientHeight+20){
        readMap[idx]=true;
        document.getElementById(type+'-next').disabled=false;
        document.getElementById(type+'-scroll-note').textContent='âœ… Section read.';
        const tab=document.getElementById(type+'-tab-'+idx);
        if(tab)tab.classList.add('completed');
        saveState();updateDashboard();
      }
    },400);
  }
  const isLast=idx===s.length-1;
  nextBtn.textContent=isLast?(type==='handbook'?'Complete & Sign â†’':'Finish Training Guide â†’'):'Next Section â†’';
}

function goToSection(type,idx){
  if(type==='training'){trainingSection=idx;renderSection('training',idx);}
  else{handbookSection=idx;renderSection('handbook',idx);}
}

function changeSection(type,dir){
  const sections=type==='training'?TRAINING_SECTIONS:HANDBOOK_SECTIONS;
  const current=type==='training'?trainingSection:handbookSection;
  const next=current+dir;
  if(next<0||next>sections.length)return;
  if(next===sections.length){
    if(type==='training'){trainingComplete=true;showTrainingComplete();saveState();updateDashboard();}
    else{showHandbookSig();}
    return;
  }
  if(type==='training'){trainingSection=next;renderSection('training',next);}
  else{handbookSection=next;renderSection('handbook',next);}
}

function checkScroll(type){
  const body=document.getElementById(type+'-body');
  const atBottom=body.scrollHeight-body.scrollTop-body.clientHeight<40;
  if(!atBottom)return;
  const idx=type==='training'?trainingSection:handbookSection;
  const readMap=type==='training'?trainingSectionRead:handbookSectionRead;
  if(!readMap[idx]){
    readMap[idx]=true;
    document.getElementById(type+'-next').disabled=false;
    document.getElementById(type+'-scroll-note').textContent='âœ… Section read.';
    const tab=document.getElementById(`${type}-tab-${idx}`);
    if(tab)tab.classList.add('completed');
    saveState();updateDashboard();
  }
}

function showTrainingComplete(){
  document.getElementById('training-complete-banner').style.display='block';
  document.getElementById('section-training').querySelector('.doc-reader').style.display='none';
}
function showHandbookSig(){
  document.getElementById('handbook-sig').style.display='block';
  handbookSection=HANDBOOK_SECTIONS.length-1;
  handbookSectionRead[HANDBOOK_SECTIONS.length-1]=true;
  saveState();
}

// â”€â”€ HANDBOOK SIG â”€â”€
function selectHandbookOpt(val){
  handbookSigChoice=val;
  document.getElementById('opt-print').classList.toggle('selected',val==='print');
  document.getElementById('opt-digital').classList.toggle('selected',val==='digital');
  document.getElementById('rb-'+val).checked=true;
  checkHbSig();
}
function checkHbSig(){
  const sig=document.getElementById('hb-sig-input')?.value.trim();
  const btn=document.getElementById('hb-submit-btn');
  if(btn)btn.disabled=!(sig&&handbookSigChoice);
}
async function submitHandbookSig(){
  const sig=document.getElementById('hb-sig-input').value.trim();
  const btn=document.getElementById('hb-submit-btn');
  btn.disabled=true;btn.textContent='Saving...';
  try{await db.from('handbook_signatures').insert([{employee_name:user.name,employee_email:user.email,county:user.county,handbook_version:'3.0',signature:sig,print_requested:handbookSigChoice==='print',signed_at:new Date().toISOString()}]);}catch(e){console.log(e);}
  handbookComplete=true;saveState();
  document.getElementById('handbook-sig').innerHTML=`<div class="success-banner"><div class="big-check">âœ…</div><h2>Handbook Acknowledged!</h2><p>${handbookSigChoice==='print'?'A printed copy has been requested.':'Your digital acknowledgment has been recorded.'}</p><button class="btn-primary" style="margin-top:16px;background:rgba(255,255,255,0.2);border:2px solid rgba(255,255,255,0.5);" onclick="showSection('policies')">Continue to Policy Sign-Offs â†’</button></div>`;
  updateDashboard();
}

// â”€â”€ POLICIES â”€â”€
function buildPolicies(){
  document.getElementById('policy-list').innerHTML=POLICIES.map((p,i)=>`<div class="policy-item" id="pol-${p.id}" data-signed="0"><div class="policy-check" id="check-${p.id}">â€“</div><div class="policy-info"><div class="policy-name">${p.name}</div><div class="policy-desc">${p.desc}</div><div class="policy-time" id="time-${p.id}"></div></div><button class="policy-btn policy-btn-read" id="pbtn-${p.id}" onclick="openPolicyModal(${i})">Read & Sign</button></div>`).join('');
  updateBadge();
}
function openPolicyModal(idx){
  currentPolicyIndex=idx;modalScrolled=false;
  const p=POLICIES[idx];
  document.getElementById('modal-title').textContent=p.name;
  document.getElementById('modal-desc').textContent='Read the full policy below, check the box, then type your name to sign.';
  document.getElementById('modal-body').innerHTML=p.content;
  document.getElementById('modal-body').scrollTop=0;
  document.getElementById('modal-sig').value='';
  document.getElementById('modal-sign-btn').disabled=true;
  const cb=document.getElementById('modal-understand-check');
  if(cb)cb.checked=false;
  const dateEl=document.getElementById('modal-date');
  if(dateEl)dateEl.value=new Date().toISOString().split('T')[0];
  const note=document.getElementById('modal-scroll-note');
  if(note)note.textContent='ğŸ“– Please scroll to the bottom of the policy before signing.';
  document.getElementById('policy-modal').classList.add('open');
  setTimeout(()=>checkModalScroll(),300);
}
function closePolicyModal(){document.getElementById('policy-modal').classList.remove('open');}
function checkModalScroll(){
  const body=document.getElementById('modal-body');
  const note=document.getElementById('modal-scroll-note');
  if(body.scrollHeight-body.scrollTop-body.clientHeight<40&&!modalScrolled){
    modalScrolled=true;
    if(note)note.textContent='âœ… Policy read. Please check the box and sign below.';
    checkModalSig();
  }
  if(!modalScrolled&&body.scrollHeight<=body.clientHeight+20){
    modalScrolled=true;
    if(note)note.textContent='âœ… Please check the box and sign below.';
    checkModalSig();
  }
}
function checkModalSig(){
  const sig=document.getElementById('modal-sig').value.trim();
  const checked=document.getElementById('modal-understand-check')?.checked;
  document.getElementById('modal-sign-btn').disabled=!(sig&&checked&&modalScrolled);
}
async function signPolicy(){
  const p=POLICIES[currentPolicyIndex];
  const sig=document.getElementById('modal-sig').value.trim();
  const btn=document.getElementById('modal-sign-btn');
  btn.disabled=true;btn.textContent='Saving...';
  const now=new Date();
  const ts=now.toLocaleString('en-US',{dateStyle:'medium',timeStyle:'short'});
  try{
    // Delete first, then insert (most reliable approach)
    await db.from('policy_signatures').delete().match({employee_email:user.email,policy_id:p.id});
    const {error:insertErr}=await db.from('policy_signatures').insert([{employee_name:user.name,employee_email:user.email,county:user.county,policy_id:p.id,policy_name:p.name,signature:sig,signed_at:now.toISOString()}]);
    if(insertErr){
      console.error('Signature insert error:',insertErr);
      // Try upsert as final fallback
      await db.from('policy_signatures').upsert([{employee_name:user.name,employee_email:user.email,county:user.county,policy_id:p.id,policy_name:p.name,signature:sig,signed_at:now.toISOString()}],{onConflict:'employee_email,policy_id'});
    }
  }catch(e){console.error('Signature save exception:',e);}
  const item=document.getElementById('pol-'+p.id);
  item.classList.add('signed');item.dataset.signed='1';
  document.getElementById('check-'+p.id).textContent='âœ“';
  document.getElementById('time-'+p.id).textContent='Signed '+ts;
  document.getElementById('pbtn-'+p.id).textContent='âœ“ Signed';
  document.getElementById('pbtn-'+p.id).className='policy-btn policy-btn-done';
  closePolicyModal();updateBadge();updateDashboard();checkAllSigned();
}
function updateBadge(){
  const done=POLICIES.filter(p=>{const el=document.getElementById('pol-'+p.id);return el&&el.dataset.signed==='1';}).length;
  document.getElementById('badge-policies').textContent=`${done}/${POLICIES.length}`;
}
function checkAllSigned(){
  const done=POLICIES.filter(p=>{const el=document.getElementById('pol-'+p.id);return el&&el.dataset.signed==='1';}).length;
  if(done===POLICIES.length){document.getElementById('all-signed-banner').style.display='block';notifyCompletion();}
}

// â”€â”€ DASHBOARD â”€â”€
function updateDashboard(){
  const docsComplete=(trainingComplete?1:0)+(handbookComplete?1:0);
  const polSigned=POLICIES.filter(p=>{const el=document.getElementById('pol-'+p.id);return el&&el.dataset.signed==='1';}).length;
  const total=2+POLICIES.length;
  const done=docsComplete+polSigned;
  const pct=Math.round((done/total)*100);
  document.getElementById('progress-fill').style.width=pct+'%';
  document.getElementById('progress-pct').textContent=pct+'%';
  document.getElementById('stat-docs').textContent=docsComplete+'/2';
  document.getElementById('stat-sigs').textContent=polSigned+'/'+POLICIES.length;
  document.getElementById('stat-remaining').textContent=total-done;
  const checks=[
    {label:'Complete online training courses (PASS, Defensive Driving, CPR)',done:true},
    {label:'Read Driver Training Guide',done:trainingComplete},
    {label:'Read Employee Handbook',done:handbookComplete},
    {label:`Sign policy acknowledgments (${polSigned}/${POLICIES.length} complete)`,done:polSigned===POLICIES.length},
  ];
  document.getElementById('dash-checklist').innerHTML=checks.map(c=>`<li><div class="check-dot ${c.done?'done':'pending'}">${c.done?'âœ“':'â—‹'}</div><span style="color:${c.done?'#27AE60':'#444'};${c.done?'text-decoration:line-through;opacity:0.7;':''}">${c.label}</span></li>`).join('');
}

// â”€â”€ TIME OFF â”€â”€
function selectReqType(type){
  currentReqType=type;
  document.querySelectorAll('.req-type-btn').forEach(b=>{b.style.background='transparent';b.style.color='var(--navy)';});
  event.target.style.background='var(--navy)';event.target.style.color='#fff';
  let html='';
  if(type==='Full Day Off'){html=`<div class="sig-field"><label>Date</label><input type="date" id="req-date1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div>`;}
  else if(type==='Multiple Days'){html=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;"><div class="sig-field"><label>Start Date</label><input type="date" id="req-date1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div><div class="sig-field"><label>End Date</label><input type="date" id="req-date2" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div></div>`;}
  else if(type==='Start Late'){html=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;"><div class="sig-field"><label>Date</label><input type="date" id="req-date1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div><div class="sig-field"><label>Arriving At</label><input type="time" id="req-time1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div></div>`;}
  else if(type==='End Early'){html=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;"><div class="sig-field"><label>Date</label><input type="date" id="req-date1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div><div class="sig-field"><label>Leaving At</label><input type="time" id="req-time1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div></div>`;}
  else if(type==='Mid-Day Appointment'){html=`<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;"><div class="sig-field"><label>Date</label><input type="date" id="req-date1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div><div class="sig-field"><label>Time Leaving</label><input type="time" id="req-time1" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div><div class="sig-field"><label>Time Returning</label><input type="time" id="req-time2" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:14px;"></div></div>`;}
  document.getElementById('req-fields').innerHTML=html;
  document.getElementById('req-form').style.display='block';
  document.getElementById('req-success').style.display='none';
}
async function submitTimeOff(){
  const date1=document.getElementById('req-date1')?.value;
  const date2=document.getElementById('req-date2')?.value||date1;
  const time1=document.getElementById('req-time1')?.value||'';
  const time2=document.getElementById('req-time2')?.value||'';
  const reason=document.getElementById('req-reason').value;
  const timeDetail=time2?`${time1} â€“ ${time2}`:time1;
  if(!date1){alert('Please select a date.');return;}
  try{
    await db.from('time_off_requests').insert([{employee_name:user.name,employee_email:user.email,county:user.county,request_type:currentReqType,start_date:date1,end_date:date2,time_detail:timeDetail,reason,status:'PENDING',submitted_at:new Date().toISOString()}]);
    if(typeof emailjs!=='undefined'){await emailjs.send(EMAILJS_SERVICE_ID,'template_26w7bfc',{employee_name:user.name,employee_email:user.email,county:user.county,request_type:currentReqType,start_date:date1,end_date:date2,time_detail:timeDetail,reason,portal_url:PORTAL_URL,to_email:SUPERVISOR_EMAIL});}
  }catch(e){console.log(e);}
  document.getElementById('req-form').style.display='none';
  document.getElementById('req-success').style.display='block';
}
function resetTimeOff(){
  currentReqType=null;
  document.getElementById('req-form').style.display='none';
  document.getElementById('req-success').style.display='none';
  document.getElementById('req-reason').value='';
  document.querySelectorAll('.req-type-btn').forEach(b=>{b.style.background='transparent';b.style.color='var(--navy)';});
}

async function loadMyRequests(){
  const myReqEl=document.getElementById('my-requests-list');
  if(!myReqEl)return;
  try{
    const {data}=await db.from('time_off_requests').select('*').eq('employee_email',user.email).order('submitted_at',{ascending:false});
    if(!data||data.length===0){myReqEl.innerHTML='<p style="color:#888;font-size:13px;">No requests submitted yet.</p>';return;}
    myReqEl.innerHTML=data.map(r=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);font-size:13px;">
      <div><strong>${r.request_type}</strong> â€” ${r.start_date}${r.end_date&&r.end_date!==r.start_date?' to '+r.end_date:''}<br><span style="color:#888;">${r.reason||''}</span></div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span class="badge badge-${r.status.toLowerCase()}">${r.status}</span>
        ${r.status==='PENDING'?`<button onclick="deleteMyRequest(${r.id})" style="background:none;border:1px solid #ccc;border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;color:#888;" title="Cancel request">âœ• Cancel</button>`:''}
      </div>
    </div>`).join('');
  }catch(e){myReqEl.innerHTML='<p style="color:#888;font-size:13px;">Unable to load requests.</p>';}
}

async function deleteMyRequest(id){
  if(!confirm('Cancel this time off request?'))return;
  try{
    await db.from('time_off_requests').delete().eq('id',id).eq('employee_email',user.email).eq('status','PENDING');
    loadMyRequests();
  }catch(e){alert('Unable to cancel request. Please contact your supervisor.');}
}

async function deleteCallOut(id){
  if(!confirm('Delete this call-out entry? This cannot be undone.'))return;
  try{
    await db.from('call_out_log').delete().eq('id',id);
    loadCallOuts();loadFlags();loadDashboard();
  }catch(e){alert('Unable to delete call-out.');}
}

// â”€â”€ CERTIFICATE â”€â”€
function generateCertificate(){
  const now=new Date();
  const dateStr=now.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
  const timeStr=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  const rows=POLICIES.map(p=>{
    const timeEl=document.getElementById('time-'+p.id);
    const signedTime=timeEl?timeEl.textContent.replace('Signed ',''):dateStr;
    return `<tr><td style="padding:10px 14px;border-bottom:1px solid #e5e7eb;font-weight:600;color:#1a2e4a;">${p.name}</td><td style="padding:10px 14px;border-bottom:1px solid #e5e7eb;color:#16a34a;text-align:center;">âœ“ Acknowledged</td><td style="padding:10px 14px;border-bottom:1px solid #e5e7eb;color:#555;font-size:13px;">${signedTime}</td></tr>`;
  }).join('');
  const certHTML=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Certificate â€” ${user.name}</title><style>body{font-family:Georgia,serif;margin:0;padding:40px;background:#f8f9fa;}.cert-wrapper{max-width:780px;margin:0 auto;background:#fff;border:3px solid #1a2e4a;border-radius:12px;padding:50px 60px;box-shadow:0 4px 24px rgba(0,0,0,.10);}.cert-header{text-align:center;border-bottom:2px solid #c0392b;padding-bottom:24px;margin-bottom:32px;}.logo{font-size:28px;font-weight:900;color:#1a2e4a;}.logo span{color:#c0392b;}.cert-title{font-size:30px;font-weight:700;color:#1a2e4a;margin:24px 0 6px;text-align:center;}.cert-body{text-align:center;font-size:16px;color:#444;line-height:1.7;margin-bottom:32px;}.cert-name{font-size:26px;font-weight:700;color:#c0392b;border-bottom:2px solid #c0392b;display:inline-block;padding:0 20px 4px;}.cert-meta{display:flex;justify-content:center;gap:40px;margin-bottom:32px;font-size:14px;color:#555;}.cert-meta div{text-align:center;}.cert-meta strong{display:block;color:#1a2e4a;}table{width:100%;border-collapse:collapse;margin-bottom:32px;font-family:Arial,sans-serif;}thead tr{background:#1a2e4a;color:#fff;}thead th{padding:12px 14px;text-align:left;font-size:13px;}.cert-footer{border-top:2px solid #1a2e4a;padding-top:24px;display:flex;justify-content:space-between;align-items:flex-end;gap:40px;}.sig-block{flex:1;}.sig-line{border-bottom:1.5px solid #1a2e4a;margin-bottom:6px;height:32px;}.sig-label{font-size:12px;color:#888;text-transform:uppercase;}.seal{width:90px;height:90px;border-radius:50%;border:3px double #1a2e4a;display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 auto;font-size:10px;font-weight:700;color:#1a2e4a;text-align:center;line-height:1.3;}.legal{font-size:11px;color:#aaa;text-align:center;margin-top:24px;line-height:1.6;}@media print{body{padding:0;background:#fff;}}</style></head><body><div class="cert-wrapper"><div class="cert-header"><div class="logo">Ride<span>Source</span> Inc.</div><div style="font-size:13px;color:#888;margin-top:4px;">Non-Emergency Medical Transportation Â· Maine</div></div><div class="cert-title">Certificate of Policy Acknowledgment</div><div class="cert-body">This certifies that<br><span class="cert-name">${user.name}</span><br>has read, reviewed, and electronically acknowledged all required RideSource Inc. employment policies as part of the new employee onboarding process.</div><div class="cert-meta"><div><strong>${user.county}</strong>County</div><div><strong>${user.email}</strong>Email</div><div><strong>${dateStr}</strong>Completed</div></div><table><thead><tr><th>Policy</th><th style="text-align:center;">Status</th><th>Date & Time</th></tr></thead><tbody>${rows}</tbody></table><div class="cert-footer"><div class="sig-block"><div class="sig-line"></div><div class="sig-label">Employee Signature (Electronic)</div><div style="font-size:13px;color:#1a2e4a;margin-top:4px;">${user.name}</div></div><div style="text-align:center;"><div class="seal">RIDE<br>SOURCE<br>âœ“<br>VERIFIED</div><div style="font-size:11px;color:#888;margin-top:6px;">Electronically Sealed</div></div><div class="sig-block" style="text-align:right;"><div class="sig-line"></div><div class="sig-label">Date Completed</div><div style="font-size:13px;color:#1a2e4a;margin-top:4px;">${dateStr} at ${timeStr}</div></div></div><div class="legal">Electronic signatures are legally binding under the E-SIGN Act and applicable Maine state law.</div></div><div style="text-align:center;margin-top:24px;"><button onclick="window.print()" style="background:#1a2e4a;color:#fff;border:none;padding:12px 32px;font-size:15px;border-radius:8px;cursor:pointer;font-weight:600;">ğŸ–¨ï¸ Print / Save as PDF</button></div></body></html>`;
  window.open(URL.createObjectURL(new Blob([certHTML],{type:'text/html'})),'_blank');
}

async function notifyCompletion(){
  if(typeof emailjs==='undefined')return;
  try{await emailjs.send(EMAILJS_SERVICE_ID,'timeoff_submission',{employee_name:user.name,employee_email:user.email,county:user.county,request_type:'ONBOARDING COMPLETE',start_date:new Date().toLocaleDateString(),end_date:'',time_detail:'All policies signed.',reason:`${user.name} has completed all onboarding acknowledgments.`,portal_url:PORTAL_URL,to_email:SUPERVISOR_EMAIL});}catch(e){console.log(e);}
}

// â”€â”€ ADMIN: MANAGER GUIDE â”€â”€
const MGR_SECTIONS=[
  {title:'Sec 1: Onboarding',content:`<h1>Section 1: Your Role in Onboarding</h1><p>As a supervisor or manager at RideSource, you are the most important part of the onboarding experience.</p><h2>Your Responsibilities</h2><ul><li>Ensure all pre-employment clearances are complete before sending a Welcome Aboard letter</li><li>Coordinate online training course enrollment</li><li>Conduct all four phases of hands-on training (Days 3â€“6)</li><li>Guide the employee through all policy acknowledgments via the Digital Onboarding Portal</li><li>Check in daily during the first solo week on the road</li></ul>`},
  {title:'Sec 2: Pre-Employment',content:`<h1>Section 2: Pre-Employment Process</h1><h2>Interview & Same-Day Screening</h2><ul><li>Conduct interview using standardized Interview Questions form</li><li>Collect driver info form and emergency contact form</li><li>Obtain consent for background check, MVR, and fingerprinting</li></ul><h2>Waiting Period (~1 Week)</h2><ul><li>Background check results</li><li>Motor vehicle record (MVR) review</li><li>Fingerprint clearance</li></ul><h2>Welcome Aboard or Rejection</h2><p>Once all clearances are confirmed, send the Welcome Aboard Letter via HR Templates. If not selected, send the Letter of Rejection within one week.</p><div class="callout"><strong>Important</strong>HR orders online training courses immediately after the Welcome Aboard Letter. Employees are NOT paid for home training.</div>`},
  {title:'Sec 3: Preparation',content:`<h1>Section 3: Preparing for Day 3</h1><h2>Pre-Day 3 Checklist</h2><ul><li>â˜ Confirm online training completed and certificates received</li><li>â˜ Assign vehicle â€” clean and fueled</li><li>â˜ Set up Android dispatch device with employee credentials</li><li>â˜ Prepare employee ID badge</li><li>â˜ Set up TWE timekeeping access</li><li>â˜ Notify dispatch of new employee training schedule</li></ul><div class="warn-box"><strong>âš ï¸ Do Not Begin Training Until:</strong>All clearances confirmed AND all online courses completed.</div>`},
  {title:'Sec 4: Time Off',content:`<h1>Section 4: Time Off Request System</h1><h2>How Requests Work</h2><ul><li>Employee submits via Employee Portal â†’ Request Time Off</li><li>You receive automatic email notification</li><li>Log in to Admin Portal â†’ Pending Requests â†’ approve or deny</li><li>Employee receives email with your decision</li></ul><h2>Logging Call-Outs</h2><p>When an employee calls out, you log it on their behalf via Call-Out Log. The system automatically flags employees with 3+ call-outs in 30 days.</p>`},
  {title:'Sec 5: Tracker',content:`<h1>Section 5: Digital Onboarding & Policy Tracker</h1><p>All new employees must complete the Employee Portal acknowledgments before the end of Week 2.</p><h2>Required Acknowledgments</h2><ul><li>At-Will Employment Policy</li><li>HIPAA & Confidentiality Policy</li><li>Employee Code of Conduct</li><li>Safety & Vehicle Policy</li><li>Attendance & Punctuality Policy</li><li>Drug-Free Workplace Policy</li><li>Non-Compete & Separation Policy</li><li>Employee Handbook</li></ul><p>Monitor progress in the <strong>Onboarding Tracker</strong> section of this Admin Portal.</p>`},
  {title:'Sec 6: Support',content:`<h1>Section 6: Supporting New Employees</h1><h2>First Week Solo</h2><p>Check in daily during the first solo week. Verify Parascope usage, trip documentation, vehicle cleanliness, and proactive communication.</p><h2>When to Contact HR Immediately</h2><ul><li>Employee reports harassment or hostile work environment</li><li>You need to issue a written warning</li><li>Employee discloses medical condition, disability, or pregnancy</li><li>Employee requests FMLA or leave of absence</li><li>Attendance concern escalates beyond a supportive conversation</li></ul><div class="callout"><strong>When in Doubt</strong>Always ask your management team before acting on sensitive situations.</div>`}
];

const HB_REF_SECTIONS=HANDBOOK_SECTIONS;

function buildMgrGuide(){
  document.getElementById('mgr-tabs').innerHTML=MGR_SECTIONS.map((s,i)=>`<div class="doc-tab ${i===0?'active':''}" onclick="goMgrSection(${i})">${s.title}</div>`).join('');
  renderMgrSection(0);
}
function buildHbRef(){
  document.getElementById('hb-ref-tabs').innerHTML=HB_REF_SECTIONS.map((s,i)=>`<div class="doc-tab ${i===0?'active':''}" onclick="goHbRefSection(${i})">${s.title}</div>`).join('');
  renderHbRefSection(0);
}
function renderMgrSection(i){mgrSection=i;document.getElementById('mgr-body').innerHTML=MGR_SECTIONS[i].content;document.querySelectorAll('#mgr-tabs .doc-tab').forEach((t,j)=>t.classList.toggle('active',i===j));}
function renderHbRefSection(i){hbRefSection=i;document.getElementById('hb-ref-body').innerHTML=HB_REF_SECTIONS[i].content;document.querySelectorAll('#hb-ref-tabs .doc-tab').forEach((t,j)=>t.classList.toggle('active',i===j));}
function goMgrSection(i){renderMgrSection(i);}
function goHbRefSection(i){renderHbRefSection(i);}
function changeMgrSection(dir){const n=mgrSection+dir;if(n>=0&&n<MGR_SECTIONS.length)renderMgrSection(n);}
function changeHbRefSection(dir){const n=hbRefSection+dir;if(n>=0&&n<HB_REF_SECTIONS.length)renderHbRefSection(n);}

// â”€â”€ ADMIN DASHBOARD â”€â”€
async function loadDashboard(){
  let reqs=[],callouts=[],sigs=[];
  try{const r=await db.from('time_off_requests').select('*').eq('status','PENDING').order('submitted_at',{ascending:false});reqs=r.data||[];}catch(e){}
  try{const r=await db.from('call_out_log').select('*').order('callout_date',{ascending:false}).limit(100);callouts=r.data||[];}catch(e){}
  try{const r=await db.from('policy_signatures').select('employee_email').order('signed_at',{ascending:false});sigs=r.data||[];}catch(e){}
  const unique=sigs?[...new Set(sigs.map(s=>s.employee_email))].length:0;
  document.getElementById('dash-stats').innerHTML=`<div class="stat-card"><div class="stat-icon" style="background:#fff3cd;">â³</div><div><div class="stat-val">${reqs?reqs.length:0}</div><div class="stat-label">Pending Requests</div></div></div><div class="stat-card"><div class="stat-icon" style="background:#fdecea;">ğŸ“</div><div><div class="stat-val">${callouts?callouts.length:0}</div><div class="stat-label">Total Call-Outs</div></div></div><div class="stat-card"><div class="stat-icon" style="background:#d4edda;">âœ…</div><div><div class="stat-val">${unique}</div><div class="stat-label">Employees w/ Signed Policies</div></div></div>`;
  const pendList=document.getElementById('dash-pending-list');
  if(!reqs||reqs.length===0){pendList.textContent='No pending requests. âœ“';}
  else{pendList.innerHTML=reqs.slice(0,5).map(r=>`<div style="padding:6px 0;border-bottom:1px solid #f0f0f0;font-size:12px;"><strong>${r.employee_name}</strong> â€” ${r.request_type} â€” ${r.start_date}</div>`).join('');}
  loadFlagsInto('dash-flags-list',callouts||[]);
}

function detectFlags(callouts){
  const groups={};
  callouts.forEach(c=>{const k=c.employee_name+'|'+c.county;if(!groups[k])groups[k]={name:c.employee_name,county:c.county,dates:[]};groups[k].dates.push(new Date(c.callout_date));});
  const flagged=[];
  Object.values(groups).forEach(g=>{
    const now=new Date();const thirtyAgo=new Date(now-30*24*60*60*1000);
    const recent=g.dates.filter(d=>d>=thirtyAgo).sort((a,b)=>a-b);
    if(recent.length>=3)flagged.push({name:g.name,county:g.county,count:recent.length,dates:recent,allDates:g.dates.sort((a,b)=>a-b)});
  });
  return flagged;
}

function loadFlagsInto(elId,callouts){
  const el=document.getElementById(elId);
  const flagged=detectFlags(callouts);
  if(flagged.length===0){el.textContent='No attendance flags. âœ“';}
  else{el.innerHTML=flagged.slice(0,5).map(f=>`<div style="padding:6px 0;border-bottom:1px solid #f0f0f0;font-size:12px;"><strong>${f.name}</strong> â€” <span style="color:var(--red);">${f.count} call-outs in 30 days</span></div>`).join('');}
  document.getElementById('badge-flags').textContent=flagged.length||'0';
}

async function loadFlags(){
  const {data:callouts}=await db.from('call_out_log').select('*').order('callout_date',{ascending:false});
  const flagged=detectFlags(callouts||[]);
  document.getElementById('badge-flags').textContent=flagged.length||'0';
  const el=document.getElementById('flagged-employees');
  if(flagged.length===0){el.innerHTML=`<div class="card" style="text-align:center;padding:32px;color:var(--success);"><div style="font-size:32px;">âœ…</div><div style="font-weight:700;margin-top:8px;">No attendance flags at this time.</div></div>`;return;}
  el.innerHTML=flagged.map(f=>{
    const dates=f.dates.map(d=>d.toLocaleDateString('en-US',{month:'short',day:'numeric'})).join(', ');
    const level=f.allDates.length>=9?'Final Written Warning':'Standard Warning';
    return `<div class="warning-employee"><div style="display:flex;gap:14px;align-items:center;"><div style="font-size:24px;">âš ï¸</div><div><div style="font-weight:700;">${f.name} <span style="font-weight:400;color:#888;">Â· ${f.county}</span></div><div style="font-size:12px;color:#666;margin-top:2px;">${f.count} call-outs in last 30 days Â· ${dates}</div></div></div><div style="display:flex;align-items:center;gap:10px;"><span class="badge badge-flag">${level}</span><button class="btn btn-red btn-sm" onclick='openWarningModal(${JSON.stringify(f).replace(/'/g,"&#39;")})'>Generate Warning</button></div></div>`;
  }).join('');
}

function openWarningModal(f){
  warningData=f;
  const dates=f.dates.map(d=>new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})).join(', ');
  const allCount=f.allDates?f.allDates.length:f.count;
  const level=allCount>=6?'final':'standard';
  document.getElementById('warn-modal-title').textContent=`Attendance Warning â€” ${f.name}`;
  document.getElementById('warn-preview').style.display='none';
  document.getElementById('warn-gen-btn').style.display='';
  document.getElementById('warn-form').innerHTML=`<div class="form-row"><div class="form-field"><label>Employee Name</label><input type="text" id="wf-name" value="${f.name}"></div><div class="form-field"><label>County</label><input type="text" id="wf-county" value="${f.county}"></div></div><div class="form-row"><div class="form-field"><label>Number of Call-Outs</label><input type="number" id="wf-count" value="${f.count}"></div><div class="form-field"><label>Warning Level</label><select id="wf-level"><option value="standard" ${level==='standard'?'selected':''}>Standard Warning</option><option value="final" ${level==='final'?'selected':''}>Final Written Warning</option><option value="manifest">Call-Out After Manifest</option></select></div></div><div class="form-field"><label>Timeframe</label><input type="text" id="wf-timeframe" value="the past 30 days"></div><div class="form-field"><label>Call-Out Dates</label><input type="text" id="wf-dates" value="${dates}"></div><div class="form-field"><label>Additional Notes (optional)</label><textarea id="wf-notes" placeholder="Any additional context..."></textarea></div>`;
  document.getElementById('warning-modal').classList.add('open');
}

function generateWarning(){
  const name=document.getElementById('wf-name').value;
  const county=document.getElementById('wf-county').value;
  const count=document.getElementById('wf-count').value;
  const timeframe=document.getElementById('wf-timeframe').value;
  const level=document.getElementById('wf-level').value;
  const dates=document.getElementById('wf-dates').value;
  const notes=document.getElementById('wf-notes').value;
  const today=new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  let subject='',opening='',body='',consequence='';
  if(level==='final'){
    subject='FINAL WRITTEN WARNING â€” ATTENDANCE';
    opening=`This letter serves as a <strong>Final Written Warning</strong> regarding your attendance record.`;
    body=`You have recorded <strong>${count} call-out(s)</strong> within ${timeframe}. The dates of these absences are:<br><br><strong>${dates}</strong><br><br>This pattern of absenteeism is unacceptable and does not meet the attendance standards required for your continued employment at RideSource Inc.`;
    consequence=`<strong>This is your final warning.</strong> Any further attendance violations may result in immediate termination of employment. No additional warnings will be issued before that action is taken.`;
  } else if(level==='manifest'){
    subject='ATTENDANCE WARNING â€” CALL-OUT AFTER TRIP ASSIGNMENT';
    opening=`This letter serves as a formal written warning regarding a call-out that occurred after your trip manifest had been finalized.`;
    body=`Your call-out(s) occurred on: <strong>${dates}</strong><br><br>Once a manifest is finalized, RideSource has already committed to client service obligations. Calling out at that stage creates significant operational disruption and may result in liquidated damages from our brokerage for missed service. This type of call-out is treated as a serious policy violation.`;
    consequence=`Continued occurrences of this nature may result in further disciplinary action, up to and including termination of employment.`;
  } else {
    subject='ATTENDANCE WARNING';
    opening=`This letter serves as a formal written warning regarding your attendance record.`;
    body=`You have accumulated <strong>${count} call-out(s)</strong> within ${timeframe}. The dates of these absences are:<br><br><strong>${dates}</strong><br><br>RideSource requires consistent and reliable attendance. Clients depend on our drivers, and each unplanned absence creates service disruptions that affect our passengers, our team, and our business relationships.`;
    consequence=`Continued attendance issues may result in further disciplinary action, up to and including termination of employment.`;
  }
  const notesBlock=notes?`<br><br><strong>Additional Notes:</strong><br>${notes}`:'';
  const letterHTML=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Attendance Warning â€” ${name}</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:40px;background:#f8f9fa;}
    .letter{max-width:720px;margin:0 auto;background:#fff;border:1px solid #ddd;border-radius:8px;padding:50px 60px;box-shadow:0 4px 16px rgba(0,0,0,.08);}
    .letter-header{border-bottom:3px solid #1B2A4A;padding-bottom:20px;margin-bottom:28px;display:flex;justify-content:space-between;align-items:flex-end;}
    .brand{font-size:26px;font-weight:900;color:#1B2A4A;letter-spacing:-.5px;line-height:1;}
    .brand span{color:#C0392B;}
    .brand-sub{font-size:11px;color:#888;text-transform:uppercase;letter-spacing:.5px;margin-top:3px;}
    .letter-meta{text-align:right;font-size:12px;color:#666;line-height:1.8;}
    .warn-badge{display:inline-block;background:#C0392B;color:#fff;font-size:11px;font-weight:700;padding:4px 12px;border-radius:4px;letter-spacing:.5px;margin-bottom:20px;}
    h2{font-size:16px;font-weight:700;color:#1B2A4A;margin:0 0 20px;text-transform:uppercase;letter-spacing:.5px;}
    .salutation{font-size:14px;margin-bottom:16px;}
    .letter-body{font-size:14px;line-height:1.8;color:#333;margin-bottom:20px;}
    .consequence-box{background:#fdecea;border-left:4px solid #C0392B;padding:14px 18px;margin:20px 0;font-size:13px;line-height:1.7;color:#333;}
    .sig-section{margin-top:40px;padding-top:24px;border-top:1px solid #ddd;display:grid;grid-template-columns:1fr 1fr;gap:40px;}
    .sig-block .sig-line{border-bottom:1px solid #333;margin-bottom:6px;height:32px;}
    .sig-block .sig-label{font-size:11px;color:#888;text-transform:uppercase;letter-spacing:.3px;}
    .receipt-box{margin-top:32px;padding:16px;background:#f8f9fa;border:1px solid #ddd;border-radius:4px;font-size:12px;color:#555;line-height:1.6;}
    @media print{body{padding:0;background:#fff;}.letter{box-shadow:none;border:none;}}
  </style></head><body>
  <div class="letter">
    <div class="letter-header">
      <div><div class="brand">Ride<span>Source</span></div><div class="brand-sub">Reliable Safe Transportation</div></div>
      <div class="letter-meta">1 Alcott Street, Suite 102<br>Norway, ME 04268<br>${today}</div>
    </div>
    <div class="warn-badge">âš  EMPLOYEE NOTICE</div>
    <h2>${subject}</h2>
    <p class="salutation">Dear ${name},</p>
    <div class="letter-body">
      <p>${opening}</p>
      <p>${body}${notesBlock}</p>
    </div>
    <div class="consequence-box">${consequence}</div>
    <div class="letter-body">
      <p>We value your contributions to the RideSource team and genuinely want to see you succeed here. We are providing this formal notice so that you have a clear understanding of where things stand and the opportunity to make the necessary improvements.</p>
      <p>If you have questions about this notice or would like to discuss the circumstances surrounding any of the absences listed above, please speak with your supervisor or a member of the management team.</p>
    </div>
    <div class="sig-section">
      <div class="sig-block"><div class="sig-line"></div><div class="sig-label">Issuing Supervisor â€” Signature</div><div style="font-size:12px;color:#555;margin-top:4px;">Management Team Â· RideSource Inc.</div></div>
      <div class="sig-block"><div class="sig-line"></div><div class="sig-label">Date Issued</div><div style="font-size:12px;color:#555;margin-top:4px;">${today}</div></div>
    </div>
    <div class="receipt-box">
      <strong>Employee Acknowledgment</strong><br>
      My signature below confirms that I have received and reviewed this written warning. It does not necessarily indicate my agreement with its contents. I understand that I may submit a written response for inclusion in my personnel file.<br><br>
      Employee Signature: _________________________________ &nbsp;&nbsp; Date: _______________<br><br>
      Employee Name (print): <strong>${name}</strong> &nbsp;&nbsp;&nbsp; Location/County: <strong>${county||'_______________'}</strong>
    </div>
  </div>
  <div style="text-align:center;margin-top:24px;"><button onclick="window.print()" style="background:#1B2A4A;color:#fff;border:none;padding:12px 32px;font-size:15px;border-radius:8px;cursor:pointer;font-weight:600;">ğŸ–¨ï¸ Print / Save as PDF</button></div>
  </body></html>`;
  document.getElementById('warn-form').style.display='none';
  document.getElementById('warn-gen-btn').style.display='none';
  const preview=document.getElementById('warn-preview');
  preview.style.display='none'; // We'll open in new window directly
  document.getElementById('warn-modal-desc').textContent='Warning letter generated â€” opening in new window for printing.';
  // Open the branded letter in a new window
  const blob=new Blob([letterHTML],{type:'text/html'});
  window.open(URL.createObjectURL(blob),'_blank');
  const existingPrint=document.getElementById('warn-print-btn');
  if(!existingPrint){
    const printBtn=document.createElement('button');
    printBtn.id='warn-print-btn';printBtn.className='btn btn-primary';printBtn.style.marginLeft='8px';
    printBtn.textContent='ğŸ–¨ï¸ Re-open Letter';
    printBtn.onclick=()=>window.open(URL.createObjectURL(blob),'_blank');
    document.querySelector('#warning-modal .btn-secondary').insertAdjacentElement('afterend',printBtn);
  }
}
function printWarning(){
  // Legacy fallback
  const preview=document.getElementById('warn-preview');
  if(preview&&preview.textContent){
    const win=window.open('','_blank');
    win.document.write('<html><head><title>Attendance Warning</title></head><body style="font-family:Arial;padding:40px;white-space:pre-wrap;">'+preview.textContent+'</body></html>');
    win.document.close();win.print();
  }
}

// â”€â”€ TIME OFF REQUESTS â”€â”€
async function loadRequests(){
  const {data}=await db.from('time_off_requests').select('*').order('submitted_at',{ascending:false});
  document.getElementById('badge-requests').textContent=(data||[]).filter(r=>r.status==='PENDING').length||'0';
  const el=document.getElementById('requests-table');
  if(!data||data.length===0){el.innerHTML='<p style="color:#888;font-size:13px;">No requests found.</p>';return;}
  el.innerHTML=`<table class="data-table"><thead><tr><th>Employee</th><th>County</th><th>Type</th><th>Date(s)</th><th>Reason</th><th>Status</th><th>Actions</th></tr></thead><tbody>`+
    data.map(r=>`<tr><td><strong>${r.employee_name}</strong></td><td>${r.county}</td><td>${r.request_type}</td><td>${r.start_date}${r.end_date&&r.end_date!==r.start_date?' â†’ '+r.end_date:''}</td><td>${r.reason||'â€”'}</td><td><span class="badge badge-${r.status.toLowerCase()}">${r.status}</span></td><td style="white-space:nowrap;">${r.status==='PENDING'?`<button class="btn btn-green btn-sm" onclick="decideRequest(${r.id},'APPROVED')">âœ“ Approve</button> <button class="btn btn-sm" style="background:#f8d7da;color:#721c24;margin-left:4px;" onclick="decideRequest(${r.id},'DENIED')">âœ— Deny</button>`:'â€”'}</td></tr>`).join('')+
    '</tbody></table>';
}
async function decideRequest(id,status){
  await db.from('time_off_requests').update({status,decided_at:new Date().toISOString(),decided_by:adminName}).eq('id',id);
  loadRequests();loadDashboard();
}

// â”€â”€ CALL-OUT LOG â”€â”€
async function loadCallOuts(){
  const {data}=await db.from('call_out_log').select('*').order('callout_date',{ascending:false}).limit(50);
  const el=document.getElementById('callout-table');
  if(!data||data.length===0){el.innerHTML='<p style="color:#888;font-size:13px;">No call-outs logged yet.</p>';return;}
  el.innerHTML=`<table class="data-table"><thead><tr><th>Employee</th><th>County</th><th>Date</th><th>Reason</th><th>Notes</th><th>Logged By</th><th>Del</th></tr></thead><tbody>`+
    data.map(c=>`<tr><td><strong>${c.employee_name}</strong></td><td>${c.county}</td><td>${c.callout_date}</td><td>${c.reason}</td><td>${c.notes||'â€”'}</td><td>${c.logged_by}</td><td><button onclick="deleteCallOut(${c.id})" style="background:none;border:1px solid #ddd;border-radius:4px;padding:2px 8px;font-size:11px;cursor:pointer;color:#c00;" title="Delete entry">âœ•</button></td></tr>`).join('')+
    '</tbody></table>';
}
async function logCallOut(){
  const name=document.getElementById('co-name').value.trim();
  const county=document.getElementById('co-county').value;
  const date=document.getElementById('co-date').value;
  const reason=document.getElementById('co-reason').value;
  const notes=document.getElementById('co-notes').value;
  if(!name||!county||!date){alert('Please fill in employee name, county, and date.');return;}
  await db.from('call_out_log').insert([{employee_name:name,county,callout_date:date,reason,notes,logged_by:adminName,logged_at:new Date().toISOString()}]);
  document.getElementById('co-name').value='';document.getElementById('co-date').value='';document.getElementById('co-notes').value='';
  const msg=document.getElementById('co-msg');msg.style.display='inline';setTimeout(()=>msg.style.display='none',3000);
  loadCallOuts();loadFlags();loadDashboard();
}

async function manualLookup(){
  const name=document.getElementById('manual-name').value.trim();
  const county=document.getElementById('manual-county').value;
  if(!name){alert('Please enter an employee name.');return;}
  let query=db.from('call_out_log').select('*').ilike('employee_name','%'+name+'%').order('callout_date',{ascending:true});
  if(county)query=query.eq('county',county);
  const {data}=await query;
  const el=document.getElementById('manual-results');
  if(!data||data.length===0){el.innerHTML=`<p style="color:#888;font-size:13px;">No call-outs found for "${name}".</p>`;return;}
  const dates=data.map(c=>new Date(c.callout_date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}));
  el.innerHTML=`<div class="warning-employee"><div><div style="font-weight:700;">${data[0].employee_name} â€” ${data[0].county}</div><div style="font-size:12px;color:#666;margin-top:4px;">${data.length} total call-out(s) Â· ${dates.join(', ')}</div></div><button class="btn btn-red btn-sm" onclick='openWarningModal(${JSON.stringify({name:data[0].employee_name,county:data[0].county,count:data.length,dates:data.map(c=>new Date(c.callout_date)),allDates:data.map(c=>new Date(c.callout_date))})})'>Generate Warning</button></div>`;
}

// â”€â”€ ONBOARDING TRACKER â”€â”€
async function loadOnboarding(){
  let sigs=[],hbSigs=[];
  try{const r=await db.from('policy_signatures').select('*').order('signed_at',{ascending:false});sigs=r.data||[];}catch(e){console.log('policy_signatures:',e);}
  try{const r=await db.from('handbook_signatures').select('*').order('signed_at',{ascending:false});hbSigs=r.data||[];}catch(e){console.log('handbook_signatures:',e);}
  const el=document.getElementById('onboarding-data');
  const printList=document.getElementById('print-requests-list');
  const byEmployee={};
  sigs.forEach(s=>{if(!byEmployee[s.employee_email])byEmployee[s.employee_email]={name:s.employee_name,email:s.employee_email,county:s.county||'â€”',policies:[],handbookSigned:false,printRequested:false};byEmployee[s.employee_email].policies.push(s.policy_name);});
  if(hbSigs){hbSigs.forEach(h=>{if(!byEmployee[h.employee_email])byEmployee[h.employee_email]={name:h.employee_name,email:h.employee_email,county:h.county||'â€”',policies:[],handbookSigned:false,printRequested:false};byEmployee[h.employee_email].handbookSigned=true;byEmployee[h.employee_email].printRequested=h.print_requested||false;});}
  if(Object.keys(byEmployee).length===0){
    el.innerHTML='<p style="color:#888;font-size:13px;">No onboarding signatures recorded yet. Once employees complete policy acknowledgments in the Employee Portal, their records will appear here.</p>';
    if(printList)printList.innerHTML='No printed copy requests yet.';
    return;
  }
  el.innerHTML=`<table class="data-table"><thead><tr><th>Employee</th><th>County</th><th>Policies Signed</th><th>Handbook</th><th>Print Requested</th></tr></thead><tbody>`+
    Object.values(byEmployee).map(e=>`<tr><td><strong>${e.name}</strong><br><span style="font-size:11px;color:#888;">${e.email}</span></td><td>${e.county}</td><td><span class="badge ${e.policies.length>=7?'badge-approved':'badge-warning'}">${e.policies.length}/7</span></td><td>${e.handbookSigned?'<span class="badge badge-approved">âœ“ Signed</span>':'<span class="badge badge-warning">Pending</span>'}</td><td>${e.printRequested?'<span class="badge badge-flag">ğŸ“¦ Yes</span>':'No'}</td></tr>`).join('')+
    '</tbody></table>';
  const printReqs=Object.values(byEmployee).filter(e=>e.printRequested);
  printList.innerHTML=printReqs.length===0?'No printed copy requests.':`<div>${printReqs.map(e=>`<div style="padding:6px 0;border-bottom:1px solid #e0e0e0;font-size:12px;"><strong>${e.name}</strong> (${e.email}) â€” ${e.county}</div>`).join('')}</div>`;
}

// â”€â”€ HR TEMPLATES â”€â”€
const MANAGERS={
  tiffany:{name:'Tiffany Gallagher',title:'Regional Operations Manager',office:'207-743-7433',direct:'207-812-5357',mobile:'207-515-3808',email:'tiffanyb@ridesourcemaine.com',address:'1 Alcott Street Suite 102, Norway, ME 04268'},
  nicole:{name:'Nicole Geel',title:'Operations Manager',office:'207-743-7433',direct:'',mobile:'',email:'Nicolegeel@ridesourcemaine.com',address:'1 Alcott Street Suite 102, Norway, ME 04268'}
};

const TEMPLATES={
  welcome:{title:'Welcome Aboard Letter',filename:'Welcome_Aboard_Letter',hasManager:true,fields:[{id:'date',label:'Date',type:'date',required:true},{id:'firstName',label:'Employee First Name',type:'text',required:true},{id:'jobTitle',label:'Job Title',type:'text',required:true},{id:'startDate',label:'Start Date',type:'date',required:true},{id:'reportTime',label:'Report Time',type:'time',required:true}]},
  rejection:{title:'Letter of Rejection',filename:'Letter_of_Rejection',hasManager:true,fields:[{id:'date',label:'Date',type:'date',required:true},{id:'appName',label:'Applicant Full Name',type:'text',required:true},{id:'address',label:'Address',type:'text',required:false},{id:'cityState',label:'City, State, ZIP',type:'text',required:false}]},
  interview:{title:'Interview Questions Form',filename:'Interview_Questions',hasManager:false,fields:[{id:'date',label:'Interview Date',type:'date',required:true},{id:'applicant',label:'Applicant Name',type:'text',required:true},{id:'location',label:'Interview Location',type:'text',required:false,placeholder:'Ellsworth Office'},{id:'posType',label:'Position Type',type:'select',required:true,options:['Full-Time Agency Driver','Part-Time Agency Driver','Volunteer']},{id:'pay',label:'Rate of Pay Discussed',type:'text',required:false}]},
  driverinfo:{title:'Driver Info Form',filename:'Driver_Info_Form',hasManager:false,fields:[{id:'firstName',label:'First Name',type:'text',required:false},{id:'lastName',label:'Last Name',type:'text',required:false},{id:'cellPhone',label:'Cell Phone',type:'text',required:false},{id:'homePhone',label:'Home Phone',type:'text',required:false},{id:'email',label:'Email Address',type:'text',required:false},{id:'ecName',label:'Emergency Contact Name',type:'text',required:false},{id:'ecNumber',label:'Emergency Contact Number',type:'text',required:false},{id:'dlState',label:'License State',type:'text',required:false},{id:'dlIssued',label:'Date Issued',type:'date',required:false},{id:'dlExpiry',label:'Expiration Date',type:'date',required:false}]},
  emergency:{title:'Emergency Contact Form',filename:'Emergency_Contact_Form',hasManager:false,fields:[{id:'empName',label:'Employee Name',type:'text',required:false},{id:'division',label:'Division / County',type:'text',required:false},{id:'ec1Name',label:'Contact #1 â€” Name',type:'text',required:false},{id:'ec1Rel',label:'Relationship',type:'text',required:false},{id:'ec1Cell',label:'Cell Phone',type:'text',required:false},{id:'ec1Home',label:'Home Phone',type:'text',required:false},{id:'ec2Name',label:'Contact #2 â€” Name',type:'text',required:false},{id:'ec2Rel',label:'Relationship',type:'text',required:false},{id:'ec2Cell',label:'Cell Phone',type:'text',required:false},{id:'ec2Home',label:'Home Phone',type:'text',required:false}]},
  consent:{title:'Consent for Certification Release',filename:'Consent_Certification_Release',hasManager:false,fields:[{id:'employee',label:'Employee Full Name',type:'text',required:true},{id:'date',label:'Date',type:'date',required:true}]},
  resignation:{title:'Voluntary Resignation Acknowledgment',filename:'Resignation_Acknowledgment',hasManager:false,fields:[{id:'date',label:'Date',type:'date',required:true},{id:'employee',label:'Employee Full Name',type:'text',required:true},{id:'position',label:'Position / Title',type:'text',required:false},{id:'county',label:'Location / County',type:'text',required:false},{id:'supervisor',label:'Supervisor',type:'text',required:false},{id:'lastDay',label:'Last Day of Work',type:'date',required:false},{id:'reason',label:'Reason for Leaving (if provided)',type:'textarea',required:false}]},
  'warn-standard':{title:'Attendance Warning â€” Standard',filename:'Attendance_Warning_Standard',hasManager:false,fields:[{id:'empName',label:'Employee Name',type:'text',required:true},{id:'warnDate',label:'Date of Warning',type:'date',required:true},{id:'position',label:'Position / Title',type:'text',required:false},{id:'county',label:'Department / County',type:'text',required:false},{id:'callCount',label:'Total Call-Outs (Last 90 Days)',type:'number',required:false},{id:'description',label:'Description of Issue',type:'textarea',required:false}]},
  'warn-callout':{title:'Attendance Warning â€” Call-Out After Trip',filename:'Attendance_Warning_CallOut',hasManager:false,fields:[{id:'empName',label:'Employee Name',type:'text',required:true},{id:'warnDate',label:'Date of Warning',type:'date',required:true},{id:'incDate',label:'Date of Incident',type:'date',required:false},{id:'description',label:'Description',type:'textarea',required:false}]},
  'warn-final':{title:'Final Written Warning',filename:'Attendance_Warning_Final',hasManager:false,fields:[{id:'empName',label:'Employee Name',type:'text',required:true},{id:'warnDate',label:'Date of Warning',type:'date',required:true},{id:'callCount',label:'Total Call-Outs (Last 90 Days)',type:'number',required:false},{id:'description',label:'Description',type:'textarea',required:false}]},
  eval30:{title:'30-Day Performance Evaluation',filename:'30_Day_Performance_Evaluation',hasManager:true,fields:[{id:'date',label:'Date',type:'date',required:true},{id:'employeeName',label:'Employee Full Name',type:'text',required:true},{id:'position',label:'Position',type:'text',required:true},{id:'startDate',label:'Start Date',type:'date',required:true},{id:'county',label:'Location/County',type:'text',required:true}]},
  eval60:{title:'60-Day Performance Evaluation',filename:'60_Day_Performance_Evaluation',hasManager:true,fields:[{id:'date',label:'Date',type:'date',required:true},{id:'employeeName',label:'Employee Full Name',type:'text',required:true},{id:'position',label:'Position',type:'text',required:true},{id:'startDate',label:'Start Date',type:'date',required:true},{id:'county',label:'Location/County',type:'text',required:true}]},
  eval90:{title:'90-Day Performance Evaluation',filename:'90_Day_Performance_Evaluation',hasManager:true,fields:[{id:'date',label:'Date',type:'date',required:true},{id:'employeeName',label:'Employee Full Name',type:'text',required:true},{id:'position',label:'Position',type:'text',required:true},{id:'startDate',label:'Start Date',type:'date',required:true},{id:'county',label:'Location/County',type:'text',required:true}]},
  pip:{title:'Performance Improvement Plan (PIP)',filename:'Performance_Improvement_Plan',hasManager:true,fields:[{id:'date',label:'Date',type:'date',required:true},{id:'employeeName',label:'Employee Full Name',type:'text',required:true},{id:'position',label:'Position',type:'text',required:true},{id:'county',label:'Location/County',type:'text',required:true},{id:'pipStart',label:'PIP Start Date',type:'date',required:true},{id:'pipEnd',label:'PIP End Date (90 days)',type:'date',required:true},{id:'concerns',label:'Performance Concerns (describe specific issues)',type:'textarea',required:true},{id:'goals',label:'Goals & Expectations During PIP Period',type:'textarea',required:true},{id:'support',label:'Support/Resources Being Provided',type:'textarea',required:false}]}
};

let currentTemplate=null;

function openTemplate(id){
  currentTemplate=id;
  const t=TEMPLATES[id];
  document.getElementById('tmpl-title').textContent=t.title;
  document.getElementById('tmpl-desc').textContent='Fill in the fields below, then click Download to get your Word document.';
  let html='';
  if(t.hasManager){html+=`<div class="form-field"><label>Hiring Manager *</label><select id="tmpl-manager">${Object.entries(MANAGERS).map(([key,m])=>`<option value="${key}">${m.name} â€” ${m.title}</option>`).join('')}</select></div>`;}
  const fields=t.fields;let i=0;
  while(i<fields.length){
    const f=fields[i],next=fields[i+1];
    const canPair=next&&f.type!=='textarea'&&next.type!=='textarea';
    if(canPair){html+=`<div class="form-row"><div class="form-field">${fieldInner(f)}</div><div class="form-field">${fieldInner(next)}</div></div>`;i+=2;}
    else{html+=`<div class="form-field">${fieldInner(f)}</div>`;i++;}
  }
  document.getElementById('tmpl-form').innerHTML=html;
  document.getElementById('template-modal').classList.add('open');
}

function fieldInner(f){
  const label=`<label>${f.label}${f.required?' *':''}</label>`;
  if(f.type==='textarea')return label+`<textarea id="tmpl-${f.id}" placeholder="${f.placeholder||f.label}..."></textarea>`;
  if(f.type==='select')return label+`<select id="tmpl-${f.id}">${f.options.map(o=>`<option>${o}</option>`).join('')}</select>`;
  return label+`<input type="${f.type}" id="tmpl-${f.id}" placeholder="${f.placeholder||''}">`;
}

function getVal(id){const el=document.getElementById('tmpl-'+id);return el?el.value.trim():'';}
function fmtDate(d){if(!d)return '';return new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});}
function fmtTime(t){if(!t)return '';return new Date('2000-01-01T'+t).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});}

async function downloadTemplate(){
  const t=TEMPLATES[currentTemplate];
  const btn=document.getElementById('tmpl-download-btn');
  let valid=true;
  t.fields.forEach(f=>{if(f.required){const el=document.getElementById('tmpl-'+f.id);if(!el||!el.value.trim()){if(el)el.style.borderColor='var(--red)';valid=false;}else if(el)el.style.borderColor='';}});
  if(!valid){alert('Please fill in all required fields (marked with *).');return;}
  btn.textContent='â³ Generating...';btn.disabled=true;
  try{
    const mgr=t.hasManager?MANAGERS[document.getElementById('tmpl-manager').value]||MANAGERS.tiffany:null;
    const blob=await buildDocx(currentTemplate,mgr);
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=t.filename+'.docx';a.click();
    URL.revokeObjectURL(url);closeModal('template-modal');
  }catch(e){console.error(e);alert('Error generating document. Please try again.');}
  btn.textContent='â¬‡ï¸ Download Word Doc';btn.disabled=false;
}

async function buildDocx(templateId,mgr){
  const docxLib=getDocx();
  if(!docxLib){throw new Error('docx library not loaded');}
  const Document=docxLib.Document,Packer=docxLib.Packer,Paragraph=docxLib.Paragraph,TextRun=docxLib.TextRun;
  const AlignmentType=docxLib.AlignmentType||{CENTER:'center',LEFT:'left'},BorderStyle=docxLib.BorderStyle||{SINGLE:'single',NONE:'none'},HeadingLevel=docxLib.HeadingLevel||{};
  // Table support (graceful fallback if not available in this build)
  const Table=docxLib.Table,TableRow=docxLib.TableRow,TableCell=docxLib.TableCell,WidthType=docxLib.WidthType,VerticalAlign=docxLib.VerticalAlign;
  // Safely handle any missing exports
  // BorderStyle already handled above with fallback
  const txt=(text,opts={})=>new TextRun({text,font:'Arial',...opts});
  const body=(text,opts={})=>new Paragraph({spacing:{after:120},children:[txt(text,{size:20,...opts})]});
  const heading=(text)=>new Paragraph({spacing:{before:240,after:120},children:[txt(text,{bold:true,size:24,color:'1B2A4A'})]});
  const sp=()=>new Paragraph({spacing:{after:80},children:[]});

  let children=[];
  const today=new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});

  children.push(new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:60},children:[txt('RideSource',{bold:true,size:40,color:'1B2A4A'}),txt(' Inc.',{bold:true,size:40,color:'C0392B'})]}));
  children.push(new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:200},children:[txt('Reliable Safe Transportation',{size:18,color:'888888',italics:true})]}));
  children.push(new Paragraph({border:{bottom:{style:'single',size:8,color:'1B2A4A'}},spacing:{after:200},children:[]}));

  if(templateId==='welcome'){
    const fn=getVal('firstName')||'[Employee]';const jt=getVal('jobTitle')||'[Job Title]';
    const sd=fmtDate(getVal('startDate'));const dt=fmtDate(getVal('date'));const rt=fmtTime(getVal('reportTime'));
    children.push(heading('WELCOME ABOARD LETTER'));
    children.push(body(dt));children.push(sp());
    children.push(body(`Dear ${fn},`));children.push(sp());
    children.push(body('On behalf of the entire RideSource team, it is our sincere pleasure to welcome you as our newest team member. We are genuinely excited to have you with us.'));
    children.push(sp());children.push(heading('Your Position & Start Details'));
    children.push(body(`Position: ${jt}`));children.push(body(`Start Date: ${sd}`));
    children.push(body(`Report Time: ${rt}`));children.push(body('Report Location: 102 Main Street, Suite C, Ellsworth, ME 04605'));
    if(mgr){children.push(body(`Your Contact: ${mgr.name}, ${mgr.title}`));children.push(body(`Phone: ${mgr.direct} | Email: ${mgr.email}`));}
    children.push(sp());children.push(heading('Before Your First Day'));
    children.push(body('Please complete the following online training courses prior to your arrival: PASS Certification, Defensive Driving, and First Aid/CPR/AED. Forward certificates to your supervisor when complete.'));
    children.push(sp());children.push(body('We look forward to seeing you on your first day. Welcome to the RideSource family!'));
    children.push(sp());children.push(body('Warmly,'));children.push(sp());children.push(sp());
    if(mgr){children.push(body(mgr.name,{bold:true}));children.push(body(mgr.title));children.push(body('RideSource Inc.'));}
  }
  else if(templateId==='rejection'){
    const dt=fmtDate(getVal('date'));const app=getVal('appName')||'[Applicant]';
    children.push(heading('LETTER OF REJECTION'));children.push(body(dt));children.push(sp());
    children.push(body(`Dear ${app},`));children.push(sp());
    children.push(body('Thank you for your interest in joining the RideSource team and for taking the time to interview for our driving position. We genuinely appreciate the time and effort you invested in our process.'));
    children.push(sp());children.push(body('After careful consideration, we have decided to move forward with another candidate whose qualifications more closely match our current needs.'));
    children.push(sp());children.push(body('We wish you the very best in your job search and future endeavors.'));
    children.push(sp());children.push(body('Sincerely,'));children.push(sp());children.push(sp());
    if(mgr){children.push(body(mgr.name,{bold:true}));children.push(body(mgr.title));children.push(body('RideSource Inc.'));}
  }
  else if(['eval30','eval60','eval90'].includes(templateId)){
    const days=templateId==='eval30'?30:templateId==='eval60'?60:90;
    const empName=getVal('employeeName')||'[Employee Name]';
    const pos=getVal('position')||'[Position]';
    const county=getVal('county')||'[Location]';
    const sd=fmtDate(getVal('startDate'));
    const dt=fmtDate(getVal('date'));
    children.push(heading(`${days}-DAY PERFORMANCE EVALUATION`));
    children.push(body(`Date: ${dt}`));
    children.push(body(`Employee: ${empName}`));
    children.push(body(`Position: ${pos}`));
    children.push(body(`Location/County: ${county}`));
    children.push(body(`Start Date: ${sd}`));
    if(mgr){children.push(body(`Evaluating Supervisor: ${mgr.name}`));}
    children.push(sp());
    const categories=[
      {label:'Attendance & Punctuality',desc:'Reports to work on time; notifies supervisor appropriately when absent.'},
      {label:'Professionalism & Conduct',desc:'Demonstrates professional demeanor with passengers, coworkers, and the public.'},
      {label:'Passenger Interaction & Service',desc:'Handles passenger boarding, assistance, and service standards correctly.'},
      {label:'Vehicle Operation & Safety',desc:'Drives safely; completes pre-trip/post-trip inspections; follows all vehicle policies.'},
      {label:'Parascope / Dispatch System Use',desc:'Uses the dispatch system accurately and in real time.'},
      {label:'Policy Compliance',desc:'Follows all RideSource policies including HIPAA, drug-free workplace, and code of conduct.'},
      {label:'Communication',desc:'Communicates effectively with dispatch, supervisor, and the office.'},
      {label:'Initiative & Attitude',desc:'Shows willingness to learn, asks questions, and contributes positively to the team.'}
    ];
    const ratingScale=new Paragraph({spacing:{after:120},children:[txt('Rating Scale: ',{bold:true,size:20}),txt('1 = Needs Improvement   2 = Developing   3 = Meets Expectations   4 = Exceeds Expectations   5 = Outstanding',{size:18,color:'555555'})]});
    children.push(ratingScale);
    categories.forEach((cat,i)=>{
      children.push(new Paragraph({spacing:{before:100,after:40},children:[txt(`${i+1}. ${cat.label}`,{bold:true,size:22,color:'1B2A4A'})]}));
      children.push(new Paragraph({spacing:{after:60},children:[txt(cat.desc,{size:18,color:'555555',italics:true})]}));
      children.push(new Paragraph({spacing:{after:20},children:[txt('Rating (circle one):  1     2     3     4     5',{size:20})]}));
      children.push(new Paragraph({spacing:{after:80},children:[txt('Comments: ___________________________________________________________',{size:20})]}));
    });
    children.push(sp());
    children.push(new Paragraph({spacing:{before:120,after:60},children:[txt('Overall Performance Rating:',{bold:true,size:22,color:'1B2A4A'})]}));
    children.push(new Paragraph({spacing:{after:80},children:[txt('Overall Rating (circle one):  1     2     3     4     5',{size:22})]}));
    children.push(new Paragraph({spacing:{after:80},children:[txt('Summary Comments: _________________________________________________',{size:20}),txt('___________________________________________________________________',{size:20})]}));
    children.push(sp());
    children.push(new Paragraph({spacing:{before:120,after:60},children:[txt(`${days}-Day Goals & Expectations`,{bold:true,size:22,color:'1B2A4A'})]}));
    children.push(new Paragraph({spacing:{after:80},children:[txt('Goals for next period: _____________________________________________',{size:20}),txt('___________________________________________________________________',{size:20})]}));
    children.push(sp());children.push(sp());
    children.push(new Paragraph({border:{bottom:{style:'single',size:4,color:'D0D9EC'}},spacing:{after:80},children:[]}));
    children.push(body('Employee Signature: _________________________________ Date: _____________'));
    children.push(body(`${mgr?mgr.name+' Signature':'Supervisor Signature'}: _________________ Date: _____________`));
    children.push(new Paragraph({spacing:{after:60},children:[txt('Employee Comments: ',{bold:true,size:18}),txt('I agree with this evaluation. / I disagree with this evaluation (please explain):',{size:18,color:'555555',italics:true})]}));
    children.push(body('________________________________________________________________________'));
  }
  else if(templateId==='pip'){
    const empName=getVal('employeeName')||'[Employee Name]';
    const pos=getVal('position')||'[Position]';
    const county=getVal('county')||'[Location]';
    const pipStart=fmtDate(getVal('pipStart'));
    const pipEnd=fmtDate(getVal('pipEnd'));
    const concerns=getVal('concerns')||'[Describe specific performance or conduct concerns]';
    const goals=getVal('goals')||'[List specific, measurable goals the employee must achieve]';
    const support=getVal('support')||'Training, coaching, and regular check-ins with supervisor.';
    const dt=fmtDate(getVal('date'));
    children.push(heading('PERFORMANCE IMPROVEMENT PLAN'));
    children.push(body(`Date Issued: ${dt}`));
    children.push(body(`Employee: ${empName}`));
    children.push(body(`Position: ${pos}`));
    children.push(body(`Location/County: ${county}`));
    children.push(body(`PIP Period: ${pipStart} through ${pipEnd} (90 days)`));
    if(mgr){children.push(body(`Issuing Supervisor: ${mgr.name}, ${mgr.title}`));}
    children.push(sp());
    children.push(heading('Purpose'));
    children.push(body('This Performance Improvement Plan (PIP) is designed to clearly outline performance expectations, identify areas requiring improvement, and provide the employee with the support and structure needed to succeed in their role at RideSource Inc. This is not a disciplinary document; it is a structured support tool.'));
    children.push(sp());
    children.push(heading('Performance Concerns'));
    children.push(body(concerns));
    children.push(sp());
    children.push(heading('Goals & Expectations During PIP Period'));
    children.push(body(goals));
    children.push(sp());
    children.push(heading('Support & Resources Being Provided'));
    children.push(body(support));
    children.push(sp());
    children.push(heading('Check-In Schedule'));
    children.push(body('The supervisor will conduct weekly check-in meetings with the employee to review progress, provide feedback, and document any concerns or improvements. Check-ins will be documented and shared with the employee.'));
    children.push(sp());
    children.push(heading('Consequences'));
    children.push(body('Failure to meet the goals and expectations outlined in this plan during the 90-day PIP period may result in further disciplinary action, up to and including termination of employment. Successful completion of the PIP will result in removal from the improvement plan and a return to regular performance monitoring.'));
    children.push(sp());children.push(sp());
    children.push(new Paragraph({border:{bottom:{style:'single',size:4,color:'D0D9EC'}},spacing:{after:80},children:[]}));
    children.push(body('Employee Signature: _________________________________ Date: _____________'));
    children.push(body(`${mgr?mgr.name+' Signature':'Supervisor Signature'}: _________________ Date: _____________`));
    children.push(body('HR Representative Signature: _________________________ Date: _____________'));
    children.push(sp());
    children.push(new Paragraph({spacing:{after:60},children:[txt('Employee Statement (optional): ',{bold:true,size:18})]}));
    children.push(body('________________________________________________________________________'));
    children.push(body('________________________________________________________________________'));
  }
  else{
    const tpl=TEMPLATES[templateId];
    children.push(heading(tpl.title.toUpperCase()));children.push(body(`Date: ${today}`));children.push(sp());
    tpl.fields.forEach(f=>{
      const val=getVal(f.id);
      if(f.type==='date'&&val){children.push(body(`${f.label}: ${fmtDate(val)}`));}
      else if(val){children.push(body(`${f.label}: ${val}`));}
      else{children.push(new Paragraph({spacing:{after:80},children:[txt(`${f.label}: `,{bold:true,size:20}),txt('_______________________________',{size:20,color:'999999'})]}));}
    });
    children.push(sp());children.push(sp());
    children.push(new Paragraph({border:{bottom:{style:'single',size:4,color:'D0D9EC'}},spacing:{after:80},children:[]}));
    children.push(body('Employee Signature: _________________________________ Date: _____________'));
    children.push(body('Supervisor Signature: _________________________________ Date: _____________'));
  }

  const doc=new Document({sections:[{properties:{page:{size:{width:12240,height:15840},margin:{top:1440,right:1440,bottom:1440,left:1440}}},children}]});
  return await Packer.toBlob(doc);
}


// â”€â”€ DOCUMENT LIBRARY â”€â”€
async function tryDownload(filename, btn){
  const base='https://ridesourcecalendar-hub.github.io/ridesource-onboarding/';
  const url=base+filename;
  const origText=btn.innerHTML;
  btn.innerHTML='â³ Checking...';btn.disabled=true;
  try{
    const r=await fetch(url,{method:'HEAD'});
    if(r.ok){
      btn.innerHTML=origText;btn.disabled=false;
      const a=document.createElement('a');a.href=url;a.download=filename;a.target='_blank';a.click();
    } else {
      btn.innerHTML='âš ï¸ Not uploaded yet';btn.disabled=false;btn.style.background='#e67e22';
      setTimeout(()=>{btn.innerHTML=origText;btn.style.background='';},3000);
      alert('This file hasn\'t been uploaded to GitHub yet.\n\nFilename needed: '+filename+'\n\nUpload this file to your GitHub repository alongside index.html to enable this download button.');
    }
  }catch(e){
    btn.innerHTML=origText;btn.disabled=false;
    const a=document.createElement('a');a.href=url;a.download=filename;a.target='_blank';a.click();
  }
}

// â”€â”€ CALENDAR â”€â”€
const COUNTY_COLORS={Hancock:'#2980B9',Washington:'#C0392B',Somerset:'#E67E22',Waldo:'#F39C12',Knox:'#16A085',Androscoggin:'#E74C3C',Cumberland:'#1ABC9C',Franklin:'#95A5A6',Kennebec:'#8E44AD',Lincoln:'#EC407A',Oxford:'#7E57C2',Penobscot:'#2471A3',Piscataquis:'#1565C0',Sagadahoc:'#D84315',York:'#F57F17',Aroostook:'#27AE60'};

function changeMonth(dir){calMonth+=dir;if(calMonth>11){calMonth=0;calYear++;}else if(calMonth<0){calMonth=11;calYear--;}renderCalendar();}

// FIX 2: Removed duplicate 'async' keyword
async function renderCalendar(){
  const titleEl=document.getElementById('cal-title');
  const monthName=new Date(calYear,calMonth).toLocaleDateString('en-US',{month:'long',year:'numeric'});
  // Update only the text part of cal-title, not the select inside it
  const filterSelect=document.getElementById('cal-county-filter');
  if(!filterSelect){return;}

  let timeoff=[],callouts=[];
  try{const r=await db.from('time_off_requests').select('*').eq('status','APPROVED');timeoff=r.data||[];}catch(e){}
  try{const r=await db.from('call_out_log').select('*');callouts=r.data||[];}catch(e){}

  const filterCounty=filterSelect.value||'ALL';

  const events={};
  (timeoff||[]).filter(r=>filterCounty==='ALL'||r.county===filterCounty).forEach(r=>{
    const start=new Date(r.start_date+'T00:00:00'),end=new Date((r.end_date||r.start_date)+'T00:00:00');
    for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)){
      if(d.getMonth()===calMonth&&d.getFullYear()===calYear){
        const k=d.getDate();if(!events[k])events[k]=[];
        events[k].push({label:r.employee_name.split(' ')[0]+' (off)',color:COUNTY_COLORS[r.county]||'#555'});
      }
    }
  });
  (callouts||[]).filter(c=>filterCounty==='ALL'||c.county===filterCounty).forEach(c=>{
    const d=new Date(c.callout_date+'T00:00:00');
    if(d.getMonth()===calMonth&&d.getFullYear()===calYear){
      const k=d.getDate();if(!events[k])events[k]=[];
      events[k].push({label:c.employee_name.split(' ')[0]+' (CO)',color:'#27AE60'});
    }
  });
  const firstDay=new Date(calYear,calMonth,1).getDay();
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  let calHtml=`<div style="text-align:center;font-size:16px;font-weight:700;color:var(--navy);margin-bottom:12px;">${monthName}</div>`;
  calHtml+=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;">`;
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>calHtml+=`<div style="text-align:center;font-size:11px;font-weight:700;color:#888;padding:6px 0;">${d}</div>`);
  for(let i=0;i<firstDay;i++)calHtml+=`<div style="min-height:80px;"></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const isToday=new Date().getDate()===d&&new Date().getMonth()===calMonth&&new Date().getFullYear()===calYear;
    const evs=events[d]||[];
    calHtml+=`<div style="min-height:80px;border:1px solid #e8e8e8;border-radius:4px;padding:4px;background:${isToday?'#EAF0FB':'#fff'};"><div style="font-size:12px;font-weight:${isToday?'800':'600'};color:${isToday?'var(--navy)':'#333'};margin-bottom:3px;">${d}</div>${evs.map(e=>`<div style="background:${e.color};color:#fff;font-size:10px;padding:2px 5px;border-radius:3px;margin-bottom:2px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">${e.label}</div>`).join('')}</div>`;
  }
  calHtml+=`</div>`;
  document.getElementById('cal-grid').innerHTML=calHtml;
  document.getElementById('cal-legend').innerHTML=
    `<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;"><span style="width:12px;height:12px;background:#27AE60;border-radius:2px;display:inline-block;"></span>Call-Out</span> `+
    Object.entries(COUNTY_COLORS).map(([c,col])=>`<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;"><span style="width:12px;height:12px;background:${col};border-radius:2px;display:inline-block;"></span>${c}</span>`).join(' ');
}
</script>
</body>
</html>
